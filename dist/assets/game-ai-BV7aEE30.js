const U={learningRate:.25,discountFactor:.9,explorationRate:.8,explorationDecay:.98,minExploration:.1,maxQTableSize:5e4},A=["SETTLE","WANDER","BUILD_RES","BUILD_RES_L2","BUILD_RES_L3","BUILD_RES_L4","BUILD_RES_L5","BUILD_RES_L6","BUILD_WELL","PASS_YEAR","BUILD_IND","BUILD_IND_L2","BUILD_IND_L3","BUILD_IND_L4","BUILD_IND_L5","BUILD_IND_L6","BUILD_COM","BUILD_COM_L2","BUILD_COM_L3","BUILD_COM_L4","BUILD_COM_L5","BUILD_COM_L6","BUILD_ROAD","WAIT","BUILD_CLAN_CHIEF","BUILD_DOCK","EXCHANGE_GOLD"],m=150,$=200;function q(t){const e=t.pop||0,n=t.food||0,o=t.wood||0,r=t.stone||0,i=t.metal||0,a=t.gold||0,l=t.year||0,c=t.housingCap||0,s=t.blds?t.blds.filter(D=>D.t==="WELL").length:0,u=t.zoneCount||0,d=t.blds?t.blds.filter(D=>D.t==="COM").length:0,f=t.blds?t.blds.filter(D=>D.t==="IND").length:0,h=t.blds?t.blds.filter(D=>D.t==="ROAD").length:0,p=t.tiles?t.tiles.flat().filter(D=>D?.path).length:0,y=s*100,L=y>0?Math.round(e/y*100):0,M=Math.ceil(e/100),x=e>0&&y<e,T=e>=c-5,O=Math.max(0,e-c+10),Y=Math.max(0,e-c),P=e>0?n/e:0,v=n<e*2,N=x,I=t.calculateRCIDemand?t.calculateRCIDemand():{r:50,c:50,i:50},w=I.r,E=I.c,S=I.i,W=w>=E&&w>=S?"R":E>=S?"C":"I",k=(t.workforce||{shortage:0}).shortage>0;return{pop:e,food:n,wood:o,stone:r,metal:i,gold:a,year:l,housingCap:c,wells:s,waterCapacity:y,waterPercent:L,resZones:u,comZones:d,indZones:f,paths:p,roadCount:h,needsWells:x,wellsNeeded:M,needsHousing:T,housingNeeded:O,foodPerPerson:P,isStarving:v,isThirsty:N,rDemand:w,cDemand:E,iDemand:S,highestDemand:W,workerShortage:k,homeless:Y}}function F(t){const e=t.pop||0,n=t.inventory?.food||0,o=t.inventory?.wood||0,r=t.thirst||100,i=t.thirstCounter||0,a=g(t),l=C(t);return{pop:e,food:n,wood:o,thirst:r,thirstCounter:i,nearWater:a,exploredTiles:l}}function g(t,e=5){if(!t.player||!t.tiles)return!1;const n=t.player.x,o=t.player.y,r=t.tiles.length,i=t.tiles[0]?.length||0;for(let a=-e;a<=e;a++)for(let l=-e;l<=e;l++){const c=n+a,s=o+l;if(c>=0&&c<r&&s>=0&&s<i){const u=t.tiles[c][s];if(u&&(u.type==="WATER"||u.type==="RIVER"||u.type==="DEEP"))return!0}}return!1}function H(t,e=20){if(!t.player||!t.tiles)return null;const n=t.player.x,o=t.player.y,r=t.tiles.length,i=t.tiles[0]?.length||0;let a=1/0,l=null;for(let c=1;c<=e;c++){for(let s=-c;s<=c;s++)for(let u=-c;u<=c;u++){if(Math.abs(s)!==c&&Math.abs(u)!==c)continue;const d=n+s,f=o+u;if(d>=0&&d<r&&f>=0&&f<i){const h=t.tiles[d][f];if(h?.explored&&(h.type==="WATER"||h.type==="RIVER")){const p=Math.abs(s)+Math.abs(u);p<a&&(a=p,l={x:d,y:f})}}}if(l)break}return l}function C(t,e=3){if(!t.player||!t.tiles)return 0;const n=t.player.x,o=t.player.y,r=t.tiles.length,i=t.tiles[0]?.length||0;let a=0;for(let l=n-e;l<=n+e;l++)for(let c=o-e;c<=o+e;c++)l>=0&&c>=0&&l<r&&c<i&&t.tiles[l][c]?.explored&&a++;return a}function Q(t,e){if(!t.blds||t.blds.length===0)return{radius:0,roadFrontier:0,quadrants:0};let n=t.settlementPos||e;if(!n)if(t.player)n={x:t.player.x,y:t.player.y};else{const a=t.blds[0];n={x:a?.x||0,y:a?.y||0}}let o=0,r=0;const i=new Set;for(const a of t.blds){if(a.x===void 0||a.y===void 0)continue;const l=a.x-n.x,c=a.y-n.y,s=Math.abs(l)+Math.abs(c);if(s>o&&(o=s),a.t==="ROAD"&&s>r&&(r=s),s>0){const u=l>=0?c>=0?"SE":"NE":c>=0?"SW":"NW";i.add(u)}}return{radius:o,roadFrontier:r,quadrants:i.size}}function V(t){const e=[];return t.pop>t.waterCapacity*.8&&e.push({issue:"water",severity:t.pop>t.waterCapacity?"critical":"warning",fix:"BUILD_WELL"}),t.pop>=t.housingCap-2&&e.push({issue:"housing",severity:t.pop>=t.housingCap?"critical":"warning",fix:"BUILD_RES"}),t.food<t.pop*5&&e.push({issue:"food",severity:t.food<t.pop*2?"critical":"warning",fix:"BUILD_COM"}),t.wood<50&&t.comZones>0&&e.push({issue:"wood",severity:"warning",fix:"BUILD_COM"}),t.indZones===0&&t.pop>=25&&t.resZones>=4&&t.comZones>=1&&e.push({issue:"no-industrial",severity:"opportunity",fix:"BUILD_IND"}),e.length>0?e:null}function j(t){return t<10?{tier:"startup",priority:"survival",waterRatio:.15,comRatio:.2,indThreshold:999,roadsPer:3,expandRate:0,hint:"Focus on first residential and well"}:t<25?{tier:"growth",priority:"population",waterRatio:.12,comRatio:.25,indThreshold:200,roadsPer:2.5,expandRate:1,hint:"Build residential, add commercial for production"}:t<50?{tier:"expansion",priority:"diversity",waterRatio:.1,comRatio:.33,indThreshold:100,roadsPer:2,expandRate:2,hint:"Balance RCI, push road frontier"}:t<100?{tier:"city",priority:"efficiency",waterRatio:.08,comRatio:.4,indThreshold:50,roadsPer:1.5,expandRate:3,hint:"Maximize industrial, expand into new quadrants"}:{tier:"metropolis",priority:"dominance",waterRatio:.06,comRatio:.5,indThreshold:25,roadsPer:1,expandRate:5,hint:"Fill all quadrants, reach Level 3+"}}function _(t,e,n){return t[e]||(t[e]={}),t[e][n]===void 0&&(t[e][n]=0),t[e][n]}function G(t,e,n,o,r,i=U){const a=_(t,e,n),l=Math.max(...A.map(s=>_(t,r,s))),c=a+i.learningRate*(o+i.discountFactor*l-a);t[e]||(t[e]={}),t[e][n]=c}function Z(t,e){const n=Object.keys(t);if(n.length<e*.9)return 0;const o=n.map(i=>{const a=t[i],l=Object.values(a),c=l.length>0?Math.max(...l):0;return{state:i,score:c}});o.sort((i,a)=>i.score-a.score);const r=Math.floor(n.length*.2);for(let i=0;i<r;i++)delete t[o[i].state];return r}function b(t,e,n){let o=n[0],r=-1/0;for(const i of n){const a=_(t,e,i);a>r&&(r=a,o=i)}return o}function z(t,e,n,o){return Math.random()<o?n[Math.floor(Math.random()*n.length)]:b(t,e,n)}function X(t,e,n,o,r){return`WANDER_S${t}_LV${e}_P${n}_F${o?1:0}_W${r?1:0}`}function J(t){return`S${t.stage}LV${t.highestUnlock}CV${Math.min(9,Math.floor(t.civLevel))}P${t.popBucket}F${t.foodBucket}W${t.woodBucket}WL${t.wellCount}R${t.resCount}I${t.indCount}C${t.comCount}RD${t.roadCount}WC${t.hasWaterCrisis?1:0}FC${t.hasFoodCrisis?1:0}EX${t.expansionBucket}RF${t.roadFrontBucket}Q${t.quadrantBucket}`}function K(t,e,n){return Math.min(n,Math.floor(t/e))}function tt(t){let e=0;return e+=t.popGained*10,e+=t.resourcesGained*.01,e+=t.yearsSurvived*2,e+=t.buildingsBuilt*5,t.died&&(e-=100,t.deathCause==="thirst"&&(e-=50),t.deathCause==="starvation"&&(e-=30)),t.balanced&&(e+=20),t.newQuadrant&&(e+=15),t.levelUp&&(e+=50),e}function et(){return{episode:0,totalReward:0,episodeRewards:[],bestScore:0,gamesPlayed:0,citiesBuilt:0,bestPopulation:0,bestSurvivalYears:0,balancedCities:0,smartSettlements:0,rewardHistory:[]}}function nt(t,e,n,o,r,i){t.episode++,t.gamesPlayed++,t.totalReward+=e,t.episodeRewards.push(e),t.episodeRewards.length>100&&t.episodeRewards.shift(),e>t.bestScore&&(t.bestScore=e),n>t.bestPopulation&&(t.bestPopulation=n),o>t.bestSurvivalYears&&(t.bestSurvivalYears=o),r&&t.balancedCities++,i&&t.smartSettlements++,t.rewardHistory.push(e),t.rewardHistory.length>20&&t.rewardHistory.shift()}function ot(t,e,n=10,o=5){return t<n?1:e<o?2:3}function rt(t,e,n){const o=(3-t)*.1,r=e*Math.pow(.99,n);return Math.max(.1,r+o)}function it(t,e,n,o,r,i=100){t.push({cause:e,year:n,pop:o,state:r}),t.length>i&&t.shift()}function st(t){const e={thirst:0,starvation:0,collapse:0,unknown:0};let n=0;for(const r of t)e[r.cause]++,n+=r.year;return{mostCommon:Object.entries(e).sort((r,i)=>i[1]-r[1])[0][0],thirstDeaths:e.thirst,starvationDeaths:e.starvation,avgYearOfDeath:t.length>0?n/t.length:0}}function at(t,e="civil_zones_qtable"){try{const n=JSON.stringify(t);localStorage.setItem(e,n)}catch(n){console.warn("Failed to save Q-table:",n)}}function ct(t="civil_zones_qtable"){try{const e=localStorage.getItem(t);if(e)return JSON.parse(e)}catch(e){console.warn("Failed to load Q-table:",e)}return null}function lt(t,e){const n={qTable:t,stats:e,exportedAt:new Date().toISOString(),version:"1.0"},o=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),r=URL.createObjectURL(o),i=document.createElement("a");i.href=r,i.download=`civil_zones_ai_brain_${Date.now()}.json`,i.click(),URL.revokeObjectURL(r)}async function ut(t){try{const e=await t.text(),n=JSON.parse(e);return n.qTable?{qTable:n.qTable,stats:n.stats}:{qTable:n}}catch(e){return console.error("Failed to import Q-table:",e),null}}const dt=[{id:"early_twin_res",name:"Twin Huts Opener",steps:[{action:"BUILD_RES"},{action:"BUILD_RES",waitYears:2},{action:"BUILD_ROAD",waitYears:1},{action:"BUILD_WELL",waitYears:2},{action:"BUILD_ROAD",waitYears:1},{action:"BUILD_RES",waitYears:2}]},{id:"water_buffer",name:"Water Buffer Start",steps:[{action:"BUILD_WELL"},{action:"BUILD_RES",waitYears:1},{action:"BUILD_RES",waitYears:2},{action:"BUILD_ROAD",waitYears:1},{action:"BUILD_RES",waitYears:2,requirePop:12},{action:"BUILD_COM",waitYears:1,minYear:3,requireDemand:"C"}]},{id:"wood_stack",name:"Wood Stockpile First",steps:[{action:"PASS_YEAR",waitYears:1},{action:"PASS_YEAR",waitYears:1},{action:"BUILD_ROAD"},{action:"BUILD_ROAD",waitYears:1},{action:"BUILD_RES",waitYears:2},{action:"BUILD_WELL",waitYears:2}]},{id:"tutorial_clone",name:"Tutorial Clone",steps:[{action:"BUILD_RES"},{action:"BUILD_ROAD"},{action:"BUILD_ROAD"},{action:"BUILD_WELL",waitYears:2},{action:"PASS_YEAR",waitYears:7},{action:"BUILD_RES"},{action:"BUILD_COM"},{action:"BUILD_ROAD"}]},{id:"satisfaction_ladder",name:"Satisfaction Ladder",steps:[{action:"BUILD_WELL",requireNeeds:["water"]},{action:"BUILD_RES",requireNeeds:["housing"],waitYears:1},{action:"BUILD_RES",requireNeeds:["housing"],waitYears:2},{action:"BUILD_COM",requireDemand:"C",waitYears:1},{action:"BUILD_ROAD",waitYears:1}]},{id:"industrial_threshold",name:"Industrial Threshold",steps:[{action:"BUILD_RES"},{action:"BUILD_COM",waitYears:2},{action:"BUILD_ROAD",waitYears:1},{action:"BUILD_IND",requirePop:25,requireFood:1e3,requireWood:1e3,waitYears:5},{action:"BUILD_ROAD",waitYears:1}]},{id:"balanced_pairing",name:"Balanced Pairing",steps:[{action:"BUILD_RES"},{action:"BUILD_ROAD"},{action:"BUILD_WELL",waitYears:1},{action:"BUILD_RES",waitYears:2},{action:"BUILD_ROAD",waitYears:1},{action:"BUILD_WELL",waitYears:1}]}],ft={name:"Starter",sequence:[{type:"RES",count:1},{type:"WELL",count:1},{type:"ROAD",count:2},{type:"WAIT",years:8},{type:"RES",count:1},{type:"WAIT",years:5},{type:"RES",count:1},{type:"WAIT",years:5},{type:"COM",count:2},{type:"ROAD",count:2},{type:"IND",count:2},{type:"ROAD",count:2}],step:0,subStep:0,waitStartYear:0},ht={name:"Balanced",ratio:{R:4,C:1,I:2},roadsPerBuilding:.5},yt={name:"Housing Heavy",ratio:{R:6,C:1,I:1},roadsPerBuilding:.3};function pt(t){const e={};for(const n of t)e[n.id]={attempts:0,successes:0,totalYears:0,maxPop:0,avgScore:0};return e}function Dt(t,e,n,o=.7){if(!t||t.length===0)return null;let r=[...t];if(Math.random()<o&&n>10){r.sort((u,d)=>{const f=e[u.id]||{attempts:0,avgScore:0,successes:0},h=e[d.id]||{attempts:0,avgScore:0,successes:0},p=f.attempts>0?f.successes/f.attempts*100+f.avgScore:50;return(h.attempts>0?h.successes/h.attempts*100+h.avgScore:50)-p});const i=r.slice(0,Math.min(5,r.length)),a=i.map((u,d)=>Math.pow(.6,d)),l=a.reduce((u,d)=>u+d,0);let c=Math.random()*l,s=0;for(let u=0;u<i.length;u++)if(s+=a[u],c<=s)return i[u]}return r[Math.floor(Math.random()*r.length)]}function Rt(t,e,n,o,r={minYear:5,minPop:10}){const i=t[e];i&&(n>=r.minYear&&o>=r.minPop&&i.successes++,i.totalYears+=n,i.maxPop=Math.max(i.maxPop,o),i.avgScore=i.attempts>0?Math.round(i.totalYears/i.attempts*10+i.maxPop):0)}function Lt(t,e){if(!t||t.minYear!==void 0&&e.year<t.minYear||t.maxYear!==void 0&&e.year>t.maxYear||t.requirePop!==void 0&&e.pop<t.requirePop||t.requireDemand&&e.highestDemand!==t.requireDemand)return!1;if(t.requireNeeds){for(const n of t.requireNeeds)if(n==="water"&&!e.isThirsty||n==="food"&&!e.isStarving||n==="housing"&&!e.needsHousing)return!1}return!(t.requireHousingNearFull&&!e.needsHousing||t.requireHomeless&&e.homeless<t.requireHomeless||t.requireWorkerShortage===!0&&!e.workerShortage||t.requireWorkerShortage===!1&&e.workerShortage||t.requireFood&&e.food<t.requireFood||t.requireWood&&e.wood<t.requireWood||t.requireFoodPerPop&&(e.pop===0||e.food/Math.max(1,e.pop)<t.requireFoodPerPop))}function _t(t,e){return t?t.action==="BUILD_DEMAND"?e.highestDemand==="R"?"BUILD_RES":e.highestDemand==="C"?"BUILD_COM":"BUILD_IND":t.action:null}function It(t,e,n,o){const r=t.R+t.C+t.I,i=t.R/r,a=t.C/r,l=e+n+o||1,c=e/l,s=n/l,u=i-c,d=a-s,f=1-i-a-(1-c-s);return u>=d&&u>=f?"RES":d>=f?"COM":"IND"}function wt(t,e,n){const o=t+e+n;if(o<6)return!1;const r=.1;return t/o>=r&&e/o>=r&&n/o>=r}const R={WATER:100,BERRY:80,ANIMAL:60,NOMAD:70,EXPLORE:20};function Et(t,e=15,n=!1){if(!t.player||!t.tiles)return null;const o=t.player.x,r=t.player.y,i=t.tiles.length,a=t.tiles[0]?.length||0;let l=null,c=-1/0;for(let s=-e;s<=e;s++)for(let u=-e;u<=e;u++){const d=o+s,f=r+u;if(d<0||d>=i||f<0||f>=a)continue;const h=t.tiles[d][f];if(!h?.explored)continue;const p=Math.abs(s)+Math.abs(u);let y=null;if((h.type==="WATER"||h.type==="RIVER")&&n?y={x:d,y:f,type:"WATER",priority:R.WATER,distance:p}:h.berry?y={x:d,y:f,type:"BERRY",priority:R.BERRY,distance:p}:h.animal?y={x:d,y:f,type:"ANIMAL",priority:R.ANIMAL,distance:p}:h.nomad&&(y={x:d,y:f,type:"NOMAD",priority:R.NOMAD,distance:p}),y){const L=y.priority-p*2;L>c&&(c=L,l=y)}}return l}function St(t,e=20,n=null){if(!t.player||!t.tiles)return null;const o=t.player.x,r=t.player.y,i=t.tiles.length,a=t.tiles[0]?.length||0;for(let l=1;l<=e;l++){const c=[];for(let s=-l;s<=l;s++)for(let u=-l;u<=l;u++){if(Math.abs(s)!==l&&Math.abs(u)!==l)continue;const d=o+s,f=r+u;if(d<0||d>=i||f<0||f>=a)continue;const h=t.tiles[d][f];if(h?.explored||h?.type==="WATER"||h?.type==="DEEP")continue;const p=`${d},${f}`;if(n?.has(p))continue;const y=Math.abs(s)+Math.abs(u);c.push({x:d,y:f,type:"EXPLORE",priority:R.EXPLORE,distance:y})}if(c.length>0)return c[Math.floor(Math.random()*c.length)]}return null}function Bt(){return{tilesVisited:new Set,totalTiles:0,resourcesCollected:0,berriesCollected:0,woodCollected:0,nomadsRecruited:0,animalsHunted:0,deaths:0,totalSteps:0,stepsThisRun:0,runsCompleted:0,deathLocations:[],dangerZones:{},startTime:null}}function xt(t,e,n){const o=`${e},${n}`;t.tilesVisited.add(o),t.totalSteps++,t.stepsThisRun++}function Ut(t,e,n,o){t.deaths++,t.runsCompleted++;const r={x:e,y:n,cause:o,steps:t.stepsThisRun};t.deathLocations.push(r);const i=`${e},${n}`;t.dangerZones[i]=(t.dangerZones[i]||0)+1,t.stepsThisRun=0}function At(t,e,n=1){switch(t.resourcesCollected+=n,e){case"berry":t.berriesCollected+=n;break;case"wood":t.woodCollected+=n;break;case"nomad":t.nomadsRecruited+=n;break;case"animal":t.animalsHunted+=n;break}}function gt(t){return t.totalTiles===0?0:t.tilesVisited.size/t.totalTiles*100}function Ct(t,e=2){const n=new Set;for(const[o,r]of Object.entries(t.dangerZones))r>=e&&n.add(o);return n}class bt{history=[];maxHistory;constructor(e=20){this.maxHistory=e}record(e,n){const o=`${e},${n}`;this.history.push(o),this.history.length>this.maxHistory&&this.history.shift()}wasRecentlyVisited(e,n,o=10){const r=`${e},${n}`;return this.history.slice(-o,-1).includes(r)}getRepetitionPenalty(e,n){const o=`${e},${n}`;let r=0;for(const i of this.history)i===o&&r++;return r}isStuck(){return this.history.length<10?!1:new Set(this.history.slice(-10)).size<=3}clear(){this.history=[]}}function B(){const t=[{dx:0,dy:-1},{dx:1,dy:0},{dx:0,dy:1},{dx:-1,dy:0}];return t[Math.floor(Math.random()*t.length)]}function Mt(t,e){if(!t.player||!t.tiles)return B();const n=t.player.x,o=t.player.y,r=t.tiles.length,i=t.tiles[0]?.length||0,a=[{dx:0,dy:-1,weight:1},{dx:1,dy:0,weight:1},{dx:0,dy:1,weight:1},{dx:-1,dy:0,weight:1}];for(const s of a){const u=n+s.dx,d=o+s.dy;if(u<0||u>=r||d<0||d>=i){s.weight=0;continue}const f=t.tiles[u][d];if(f?.type==="WATER"||f?.type==="DEEP"){s.weight=0;continue}f?.explored||(s.weight+=3),e.wasRecentlyVisited(u,d)&&(s.weight=Math.max(.1,s.weight-2))}const l=a.reduce((s,u)=>s+u.weight,0);if(l===0)return B();let c=Math.random()*l;for(const s of a)if(c-=s.weight,c<=0)return{dx:s.dx,dy:s.dy};return a[0]}const Ot=Object.freeze(Object.defineProperty({__proto__:null,AI_ACTIONS:A,AI_UPDATE_INTERVAL:m,BALANCED_STRATEGY:ht,BLUEPRINT_UPDATE_INTERVAL:$,DEFAULT_PLAYBOOKS:dt,DEFAULT_QLEARNING_PARAMS:U,HOUSING_HEAVY_STRATEGY:yt,MovementTracker:bt,STARTER_STRATEGY:ft,TARGET_PRIORITY:R,analyzeDeaths:st,bucket:K,calculateReward:tt,checkNearWater:g,chooseActionEpsilonGreedy:z,countExploredTiles:C,createExploreStats:Bt,createStats:et,determineLearningPhase:ot,diagnoseBlockers:V,encodeCityState:J,encodeWanderState:X,exportQTableToFile:lt,findBestTarget:Et,findExploreTarget:St,findNearestWater:H,getBestAction:b,getCityExpansionStats:Q,getDangerZones:Ct,getExplorationCoverage:gt,getNextBuildFromRatio:It,getPhaseExplorationRate:rt,getPopTierStrategy:j,getQ:_,getRandomDirection:B,getWeightedDirection:Mt,importQTableFromFile:ut,initTacticStats:pt,isCityBalanced:wt,loadQTable:ct,macroConditionsMet:Lt,pruneQTable:Z,readGameState:q,readWanderState:F,recordDeath:it,recordExplorationDeath:Ut,recordResourceCollection:At,recordTacticResult:Rt,recordTileVisit:xt,resolveMacroAction:_t,saveQTable:at,selectTactic:Dt,updateQ:G,updateStats:nt},Symbol.toStringTag,{value:"Module"}));export{Ot as A};
//# sourceMappingURL=game-ai-BV7aEE30.js.map
