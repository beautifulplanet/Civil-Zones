{"version":3,"file":"main-Dqpu6dKW.js","sources":["../../src/game/inventory.ts","../../src/game/player.ts","../../src/game/state.ts","../../src/game/save-load.ts","../../src/input/types.ts","../../src/input/keyboard.ts","../../src/input/mouse.ts","../../src/input/controller.ts","../../src/events/lore.ts","../../src/events/flooding.ts","../../src/world/types.ts","../../src/world/noise.ts","../../src/world/terrain.ts","../../src/world/spawning.ts","../../src/time/types.ts","../../src/time/turns.ts","../../src/time/spoilage.ts","../../src/main.ts"],"sourcesContent":["/**\r\n * Civil Zones - Inventory System\r\n * Handles resource storage, capacity, and transfers\r\n */\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TYPES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Main inventory for wandering phase */\r\nexport interface WanderInventory {\r\n    capacity: number;   // Base 150, +100 per nomad\r\n    food: number;\r\n    wood: number;\r\n    metal: number;\r\n    stone: number;\r\n}\r\n\r\n/** Pocket inventory for passive finds (separate, immutable) */\r\nexport interface PocketInventory {\r\n    metal: number;\r\n    stone: number;\r\n    capacity: number;   // Max 1000 (anti-cheat cap)\r\n}\r\n\r\n/** City resources (Epoch 1+) */\r\nexport interface CityResources {\r\n    food: number;\r\n    wood: number;\r\n    metal: number;\r\n    stone: number;\r\n    water: number;\r\n    gold: number;\r\n}\r\n\r\n/** Resource type for type-safe access */\r\nexport type ResourceType = 'food' | 'wood' | 'metal' | 'stone' | 'water' | 'gold';\r\n\r\n/** Inventory transfer result */\r\nexport interface TransferResult {\r\n    success: boolean;\r\n    amountTransferred: number;\r\n    overflow: number;\r\n    message?: string;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// DEFAULT VALUES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\nexport const DEFAULT_WANDER_INVENTORY: WanderInventory = {\r\n    capacity: 450,  // 150 base + 300 (3 extra people Ã— 100)\r\n    food: 300,      // Starting supplies for 4 people\r\n    wood: 300,      // Starting supplies for 4 people\r\n    metal: 0,\r\n    stone: 0\r\n};\r\n\r\nexport const DEFAULT_POCKET_INVENTORY: PocketInventory = {\r\n    metal: 0,\r\n    stone: 0,\r\n    capacity: 1000\r\n};\r\n\r\nexport const DEFAULT_CITY_RESOURCES: CityResources = {\r\n    food: 0,\r\n    wood: 0,\r\n    metal: 0,\r\n    stone: 0,\r\n    water: 100,\r\n    gold: 0\r\n};\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// INVENTORY OPERATIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Create a new wander inventory\r\n */\r\nexport function createWanderInventory(\r\n    nomadCount: number = 3,\r\n    startingFood: number = 300,\r\n    startingWood: number = 300\r\n): WanderInventory {\r\n    const BASE_CAPACITY = 150;\r\n    const CAPACITY_PER_NOMAD = 100;\r\n    \r\n    return {\r\n        capacity: BASE_CAPACITY + (nomadCount * CAPACITY_PER_NOMAD),\r\n        food: startingFood,\r\n        wood: startingWood,\r\n        metal: 0,\r\n        stone: 0\r\n    };\r\n}\r\n\r\n/**\r\n * Get total items in inventory\r\n */\r\nexport function getInventoryTotal(inventory: WanderInventory): number {\r\n    return inventory.food + inventory.wood + inventory.metal + inventory.stone;\r\n}\r\n\r\n/**\r\n * Get available space in inventory\r\n */\r\nexport function getAvailableSpace(inventory: WanderInventory): number {\r\n    return Math.max(0, inventory.capacity - getInventoryTotal(inventory));\r\n}\r\n\r\n/**\r\n * Check if inventory has space for amount\r\n */\r\nexport function hasSpace(inventory: WanderInventory, amount: number): boolean {\r\n    return getAvailableSpace(inventory) >= amount;\r\n}\r\n\r\n/**\r\n * Add resource to inventory with overflow handling\r\n */\r\nexport function addToInventory(\r\n    inventory: WanderInventory,\r\n    resource: keyof Omit<WanderInventory, 'capacity'>,\r\n    amount: number\r\n): TransferResult {\r\n    const space = getAvailableSpace(inventory);\r\n    \r\n    if (space <= 0) {\r\n        return {\r\n            success: false,\r\n            amountTransferred: 0,\r\n            overflow: amount,\r\n            message: 'Inventory full!'\r\n        };\r\n    }\r\n    \r\n    if (space >= amount) {\r\n        inventory[resource] += amount;\r\n        return {\r\n            success: true,\r\n            amountTransferred: amount,\r\n            overflow: 0\r\n        };\r\n    }\r\n    \r\n    // Partial pickup\r\n    inventory[resource] += space;\r\n    return {\r\n        success: true,\r\n        amountTransferred: space,\r\n        overflow: amount - space,\r\n        message: `Partial pickup: ${space}/${amount}`\r\n    };\r\n}\r\n\r\n/**\r\n * Remove resource from inventory\r\n */\r\nexport function removeFromInventory(\r\n    inventory: WanderInventory,\r\n    resource: keyof Omit<WanderInventory, 'capacity'>,\r\n    amount: number\r\n): TransferResult {\r\n    const current = inventory[resource];\r\n    \r\n    if (current >= amount) {\r\n        inventory[resource] -= amount;\r\n        return {\r\n            success: true,\r\n            amountTransferred: amount,\r\n            overflow: 0\r\n        };\r\n    }\r\n    \r\n    // Not enough resources\r\n    inventory[resource] = 0;\r\n    return {\r\n        success: false,\r\n        amountTransferred: current,\r\n        overflow: amount - current,\r\n        message: `Not enough ${resource}!`\r\n    };\r\n}\r\n\r\n/**\r\n * Check if inventory has enough resources\r\n */\r\nexport function hasResources(\r\n    inventory: WanderInventory,\r\n    food: number = 0,\r\n    wood: number = 0,\r\n    metal: number = 0,\r\n    stone: number = 0\r\n): boolean {\r\n    return (\r\n        inventory.food >= food &&\r\n        inventory.wood >= wood &&\r\n        inventory.metal >= metal &&\r\n        inventory.stone >= stone\r\n    );\r\n}\r\n\r\n/**\r\n * Increase inventory capacity (when recruiting nomads)\r\n */\r\nexport function increaseCapacity(inventory: WanderInventory, amount: number = 100): void {\r\n    inventory.capacity += amount;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// POCKET INVENTORY OPERATIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Add to pocket inventory (for passive finds)\r\n */\r\nexport function addToPocket(\r\n    pocket: PocketInventory,\r\n    resource: 'metal' | 'stone',\r\n    amount: number\r\n): TransferResult {\r\n    const total = pocket.metal + pocket.stone;\r\n    const space = pocket.capacity - total;\r\n    \r\n    if (space <= 0) {\r\n        return {\r\n            success: false,\r\n            amountTransferred: 0,\r\n            overflow: amount,\r\n            message: 'Pocket full!'\r\n        };\r\n    }\r\n    \r\n    const toAdd = Math.min(amount, space);\r\n    pocket[resource] += toAdd;\r\n    \r\n    return {\r\n        success: true,\r\n        amountTransferred: toAdd,\r\n        overflow: amount - toAdd\r\n    };\r\n}\r\n\r\n/**\r\n * Get total pocket inventory\r\n */\r\nexport function getPocketTotal(pocket: PocketInventory): number {\r\n    return pocket.metal + pocket.stone;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// CITY RESOURCE OPERATIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Create city resources from wander inventory\r\n */\r\nexport function createCityResources(\r\n    inventory: WanderInventory,\r\n    populationBonus: number = 0\r\n): CityResources {\r\n    const bonusMultiplier = 1 + (populationBonus / 100);\r\n    \r\n    return {\r\n        food: Math.floor(inventory.food * bonusMultiplier),\r\n        wood: Math.floor(inventory.wood * bonusMultiplier),\r\n        metal: inventory.metal,\r\n        stone: inventory.stone,\r\n        water: 100,\r\n        gold: 0\r\n    };\r\n}\r\n\r\n/**\r\n * Add resources to city\r\n */\r\nexport function addCityResource(\r\n    resources: CityResources,\r\n    type: ResourceType,\r\n    amount: number\r\n): void {\r\n    resources[type] += amount;\r\n}\r\n\r\n/**\r\n * Remove resources from city\r\n */\r\nexport function removeCityResource(\r\n    resources: CityResources,\r\n    type: ResourceType,\r\n    amount: number\r\n): boolean {\r\n    if (resources[type] >= amount) {\r\n        resources[type] -= amount;\r\n        return true;\r\n    }\r\n    return false;\r\n}\r\n\r\n/**\r\n * Check if city has resources for a cost\r\n */\r\nexport function canAfford(\r\n    resources: CityResources,\r\n    cost: Partial<CityResources>\r\n): boolean {\r\n    for (const [type, amount] of Object.entries(cost)) {\r\n        if (amount && resources[type as ResourceType] < amount) {\r\n            return false;\r\n        }\r\n    }\r\n    return true;\r\n}\r\n\r\n/**\r\n * Deduct cost from city resources\r\n */\r\nexport function deductCost(\r\n    resources: CityResources,\r\n    cost: Partial<CityResources>\r\n): boolean {\r\n    if (!canAfford(resources, cost)) {\r\n        return false;\r\n    }\r\n    \r\n    for (const [type, amount] of Object.entries(cost)) {\r\n        if (amount) {\r\n            resources[type as ResourceType] -= amount;\r\n        }\r\n    }\r\n    \r\n    return true;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// DISPLAY HELPERS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Format resource amount for display\r\n */\r\nexport function formatResource(amount: number): string {\r\n    if (amount >= 1000000) {\r\n        return (amount / 1000000).toFixed(1) + 'M';\r\n    }\r\n    if (amount >= 1000) {\r\n        return (amount / 1000).toFixed(1) + 'K';\r\n    }\r\n    return Math.floor(amount).toString();\r\n}\r\n\r\n/**\r\n * Get inventory fill percentage\r\n */\r\nexport function getInventoryFillPercent(inventory: WanderInventory): number {\r\n    return (getInventoryTotal(inventory) / inventory.capacity) * 100;\r\n}\r\n\r\n/**\r\n * Get resource color by type\r\n */\r\nexport function getResourceColor(type: ResourceType): string {\r\n    const colors: Record<ResourceType, string> = {\r\n        food: '#8B4513',    // Brown (meat)\r\n        wood: '#228B22',    // Forest green\r\n        metal: '#C0C0C0',   // Silver\r\n        stone: '#708090',   // Slate gray\r\n        water: '#4169E1',   // Royal blue\r\n        gold: '#FFD700'     // Gold\r\n    };\r\n    return colors[type];\r\n}\r\n\r\n/**\r\n * Get resource emoji by type\r\n */\r\nexport function getResourceEmoji(type: ResourceType): string {\r\n    const emojis: Record<ResourceType, string> = {\r\n        food: 'ğŸ–',\r\n        wood: 'ğŸªµ',\r\n        metal: 'âš™ï¸',\r\n        stone: 'ğŸª¨',\r\n        water: 'ğŸ’§',\r\n        gold: 'ğŸª™'\r\n    };\r\n    return emojis[type];\r\n}\r\n","/**\r\n * Civil Zones - Player System\r\n * Handles player state, movement, and interactions\r\n */\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TYPES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\nexport type Direction = 'up' | 'down' | 'left' | 'right';\r\n\r\n/** Player state */\r\nexport interface Player {\r\n    x: number;\r\n    y: number;\r\n    health: number;\r\n    direction: Direction;\r\n    bashTime?: number;      // Timestamp for bash animation\r\n}\r\n\r\n/** Movement result */\r\nexport interface MoveResult {\r\n    success: boolean;\r\n    newX: number;\r\n    newY: number;\r\n    message?: string;\r\n    blockedBy?: string;\r\n}\r\n\r\n/** Tile passability check result */\r\nexport interface PassabilityResult {\r\n    passable: boolean;\r\n    reason?: string;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// PLAYER CREATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Create a new player at position\r\n */\r\nexport function createPlayer(\r\n    x: number,\r\n    y: number,\r\n    health: number = 3,\r\n    direction: Direction = 'down'\r\n): Player {\r\n    return { x, y, health, direction };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// MOVEMENT\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Calculate new position after movement\r\n */\r\nexport function getNewPosition(\r\n    player: Player,\r\n    dx: number,\r\n    dy: number\r\n): { x: number; y: number } {\r\n    return {\r\n        x: player.x + dx,\r\n        y: player.y + dy\r\n    };\r\n}\r\n\r\n/**\r\n * Get direction from delta movement\r\n */\r\nexport function getDirectionFromDelta(dx: number, dy: number): Direction {\r\n    if (dx > 0) return 'right';\r\n    if (dx < 0) return 'left';\r\n    if (dy > 0) return 'down';\r\n    return 'up';\r\n}\r\n\r\n/**\r\n * Get delta from direction\r\n */\r\nexport function getDeltaFromDirection(direction: Direction): { dx: number; dy: number } {\r\n    switch (direction) {\r\n        case 'up': return { dx: 0, dy: -1 };\r\n        case 'down': return { dx: 0, dy: 1 };\r\n        case 'left': return { dx: -1, dy: 0 };\r\n        case 'right': return { dx: 1, dy: 0 };\r\n    }\r\n}\r\n\r\n/**\r\n * Check if position is within map bounds\r\n */\r\nexport function isInBounds(\r\n    x: number,\r\n    y: number,\r\n    mapWidth: number,\r\n    mapHeight: number\r\n): boolean {\r\n    return x >= 0 && x < mapWidth && y >= 0 && y < mapHeight;\r\n}\r\n\r\n/**\r\n * Check if tile type is passable\r\n */\r\nexport function isTileTypePassable(\r\n    tileType: string,\r\n    isWanderMode: boolean = true\r\n): PassabilityResult {\r\n    // Water tiles are never passable on foot\r\n    if (tileType === 'WATER' || tileType === 'DEEP' || tileType === 'RIVER') {\r\n        return { passable: false, reason: 'Water blocks path' };\r\n    }\r\n    \r\n    // Stone is only passable in city mode\r\n    if (tileType === 'STONE' && isWanderMode) {\r\n        return { passable: false, reason: 'Dense rock formation. Impassable.' };\r\n    }\r\n    \r\n    return { passable: true };\r\n}\r\n\r\n/**\r\n * Move player with validation\r\n */\r\nexport function movePlayer(\r\n    player: Player,\r\n    dx: number,\r\n    dy: number,\r\n    mapWidth: number,\r\n    mapHeight: number,\r\n    getTileType: (x: number, y: number) => string,\r\n    isWanderMode: boolean = true\r\n): MoveResult {\r\n    const newX = player.x + dx;\r\n    const newY = player.y + dy;\r\n    \r\n    // Check bounds\r\n    if (!isInBounds(newX, newY, mapWidth, mapHeight)) {\r\n        return {\r\n            success: false,\r\n            newX: player.x,\r\n            newY: player.y,\r\n            message: 'World boundary reached',\r\n            blockedBy: 'boundary'\r\n        };\r\n    }\r\n    \r\n    // Check tile passability\r\n    const tileType = getTileType(newX, newY);\r\n    const passability = isTileTypePassable(tileType, isWanderMode);\r\n    \r\n    if (!passability.passable) {\r\n        return {\r\n            success: false,\r\n            newX: player.x,\r\n            newY: player.y,\r\n            message: passability.reason,\r\n            blockedBy: tileType\r\n        };\r\n    }\r\n    \r\n    // Update player position and direction\r\n    player.x = newX;\r\n    player.y = newY;\r\n    player.direction = getDirectionFromDelta(dx, dy);\r\n    \r\n    return {\r\n        success: true,\r\n        newX,\r\n        newY\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// HEALTH & DAMAGE\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Apply damage to player\r\n */\r\nexport function damagePlayer(player: Player, amount: number): number {\r\n    player.health = Math.max(0, player.health - amount);\r\n    return player.health;\r\n}\r\n\r\n/**\r\n * Heal player\r\n */\r\nexport function healPlayer(player: Player, amount: number, maxHealth: number = 3): number {\r\n    player.health = Math.min(maxHealth, player.health + amount);\r\n    return player.health;\r\n}\r\n\r\n/**\r\n * Check if player is dead\r\n */\r\nexport function isPlayerDead(player: Player): boolean {\r\n    return player.health <= 0;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// SPAWN LOGIC\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Spawn validation result */\r\nexport interface SpawnValidation {\r\n    valid: boolean;\r\n    x: number;\r\n    y: number;\r\n    reachableTiles: number;\r\n}\r\n\r\n/**\r\n * Check if position is valid for spawning\r\n */\r\nexport function isValidSpawnTile(tileType: string): boolean {\r\n    return tileType === 'GRASS' || \r\n           tileType === 'FOREST' || \r\n           tileType === 'SAND' || \r\n           tileType === 'SNOW' || \r\n           tileType === 'ROCK';\r\n}\r\n\r\n/**\r\n * Count reachable land tiles from position using flood fill\r\n */\r\nexport function countReachableTiles(\r\n    startX: number,\r\n    startY: number,\r\n    mapWidth: number,\r\n    mapHeight: number,\r\n    getTileType: (x: number, y: number) => string,\r\n    maxTiles: number = 200\r\n): number {\r\n    const seen = new Set<string>();\r\n    const queue: [number, number][] = [[startX, startY]];\r\n    let count = 0;\r\n    \r\n    while (queue.length > 0 && count < maxTiles) {\r\n        const [x, y] = queue.shift()!;\r\n        const key = `${x},${y}`;\r\n        \r\n        if (x < 0 || y < 0 || x >= mapWidth || y >= mapHeight) continue;\r\n        if (seen.has(key)) continue;\r\n        \r\n        const tileType = getTileType(x, y);\r\n        if (tileType !== 'GRASS' && tileType !== 'FOREST' && tileType !== 'SAND') continue;\r\n        \r\n        seen.add(key);\r\n        count++;\r\n        \r\n        queue.push([x + 1, y]);\r\n        queue.push([x - 1, y]);\r\n        queue.push([x, y + 1]);\r\n        queue.push([x, y - 1]);\r\n    }\r\n    \r\n    return count;\r\n}\r\n\r\n/**\r\n * Find a valid spawn position\r\n */\r\nexport function findSpawnPosition(\r\n    mapWidth: number,\r\n    mapHeight: number,\r\n    getTileType: (x: number, y: number) => string,\r\n    minReachable: number = 60\r\n): SpawnValidation | null {\r\n    // Phase 1: Try center area (20 tile radius)\r\n    for (let attempt = 0; attempt < 100; attempt++) {\r\n        const x = Math.floor(mapWidth / 2 + (Math.random() - 0.5) * 40);\r\n        const y = Math.floor(mapHeight / 2 + (Math.random() - 0.5) * 40);\r\n        \r\n        if (isValidSpawnTile(getTileType(x, y))) {\r\n            const reachable = countReachableTiles(x, y, mapWidth, mapHeight, getTileType);\r\n            if (reachable >= minReachable) {\r\n                return { valid: true, x, y, reachableTiles: reachable };\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Phase 2: Try wider area (whole map)\r\n    for (let attempt = 0; attempt < 500; attempt++) {\r\n        const x = Math.floor(Math.random() * mapWidth);\r\n        const y = Math.floor(Math.random() * mapHeight);\r\n        \r\n        if (isValidSpawnTile(getTileType(x, y))) {\r\n            const reachable = countReachableTiles(x, y, mapWidth, mapHeight, getTileType);\r\n            if (reachable >= 30) { // Lower threshold for fallback\r\n                return { valid: true, x, y, reachableTiles: reachable };\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Phase 3: Emergency - scan entire map\r\n    for (let x = 0; x < mapWidth; x++) {\r\n        for (let y = 0; y < mapHeight; y++) {\r\n            if (isValidSpawnTile(getTileType(x, y))) {\r\n                return { valid: true, x, y, reachableTiles: 1 };\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Absolute last resort - center\r\n    return {\r\n        valid: false,\r\n        x: Math.floor(mapWidth / 2),\r\n        y: Math.floor(mapHeight / 2),\r\n        reachableTiles: 0\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// EXPLORATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Get tiles to reveal in exploration radius\r\n */\r\nexport function getExplorationTiles(\r\n    centerX: number,\r\n    centerY: number,\r\n    radius: number,\r\n    mapWidth: number,\r\n    mapHeight: number\r\n): Array<{ x: number; y: number }> {\r\n    const tiles: Array<{ x: number; y: number }> = [];\r\n    \r\n    for (let x = centerX - radius; x <= centerX + radius; x++) {\r\n        for (let y = centerY - radius; y <= centerY + radius; y++) {\r\n            if (x >= 0 && x < mapWidth && y >= 0 && y < mapHeight) {\r\n                const dist = Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2);\r\n                if (dist <= radius) {\r\n                    tiles.push({ x, y });\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    return tiles;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// THIRST SYSTEM\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\nexport interface ThirstState {\r\n    level: number;          // 0-100, dies at 0\r\n    stepCounter: number;    // Steps since last drink\r\n}\r\n\r\n/**\r\n * Create initial thirst state\r\n */\r\nexport function createThirstState(): ThirstState {\r\n    return { level: 100, stepCounter: 0 };\r\n}\r\n\r\n/**\r\n * Update thirst after movement\r\n */\r\nexport function updateThirst(state: ThirstState): ThirstState {\r\n    state.stepCounter++;\r\n    state.level = Math.max(0, 100 - state.stepCounter);\r\n    return state;\r\n}\r\n\r\n/**\r\n * Drink water to reset thirst\r\n */\r\nexport function drinkWater(state: ThirstState): ThirstState {\r\n    state.level = 100;\r\n    state.stepCounter = 0;\r\n    return state;\r\n}\r\n\r\n/**\r\n * Check if player is dying of thirst\r\n */\r\nexport function isDyingOfThirst(state: ThirstState): boolean {\r\n    return state.level <= 0;\r\n}\r\n\r\n/**\r\n * Get thirst warning level\r\n */\r\nexport function getThirstWarning(state: ThirstState): 'safe' | 'warning' | 'danger' | 'critical' {\r\n    if (state.level > 50) return 'safe';\r\n    if (state.level > 25) return 'warning';\r\n    if (state.level > 10) return 'danger';\r\n    return 'critical';\r\n}\r\n","/**\r\n * Civil Zones - Game State Management\r\n * Core game state types and transitions\r\n */\r\n\r\nimport type { WanderInventory, PocketInventory, CityResources } from './inventory.js';\r\nimport type { Player, ThirstState } from './player.js';\r\nimport type { WorkforceState } from '../systems/workforce.js';\r\nimport type { NeedsState } from '../systems/needs.js';\r\nimport type { GeologyState } from '../types/tiles.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// GAME PHASES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Game phase/epoch */\r\nexport type GamePhase = 'WANDER' | 'CITY';\r\n\r\n/** View mode for map display */\r\nexport type ViewMode = 'NORMAL' | 'POL' | 'DESIRABILITY' | 'ELEVATION';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// ENTITY TYPES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Berry entity */\r\nexport interface BerryEntity {\r\n    type: 'BERRY';\r\n    amount: number;\r\n    poison_chance: number;\r\n    is_poisonous: boolean;\r\n    locked?: boolean;\r\n}\r\n\r\n/** Nomad entity */\r\nexport interface NomadEntity {\r\n    type: 'NOMAD';\r\n    pop: number;\r\n    loot: {\r\n        food: number;\r\n        wood: number;\r\n        metal: number;\r\n        stone: number;\r\n    };\r\n    hostile_chance: number;\r\n    is_hostile: boolean;\r\n    damage: number;\r\n}\r\n\r\n/** Stone deposit */\r\nexport interface StoneDeposit {\r\n    metal: number;\r\n}\r\n\r\n/** Animal entity */\r\nexport interface Animal {\r\n    x: number;\r\n    y: number;\r\n    hits: number;\r\n    type: string;\r\n    locked?: boolean;\r\n}\r\n\r\n/** Wander well (Epoch 0) */\r\nexport interface WanderWell {\r\n    x: number;\r\n    y: number;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// BUILDING TYPES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Building in blds array */\r\nexport interface GameBuilding {\r\n    t: string;          // Type: 'WELL', 'COM', 'IND', 'RES', etc.\r\n    x: number;\r\n    y: number;\r\n    lvl: number;\r\n    pop?: number;\r\n    capacity?: number;\r\n    efficiency?: number;\r\n    age?: number;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// SITE TRAITS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\nexport type SiteTrait = 'Riverside' | 'Mineral Rich' | 'Fertile' | 'Paradise';\r\n\r\n/** Locked resources from settlement location */\r\nexport interface LockedResources {\r\n    residential: boolean;   // Berry locked\r\n    commercial: boolean;    // Tree locked\r\n    industrial: boolean;    // Animal locked\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// PROGRESSION STATE\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\nexport interface ProgressionState {\r\n    settlementUnlocked: boolean;\r\n    industrialUnlocked: boolean;\r\n    hasClanChief: boolean;\r\n    hasDock: boolean;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// COMPLETE GAME STATE\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\nexport interface GameState {\r\n    // Core state\r\n    gamePhase: GamePhase;\r\n    viewMode: ViewMode;\r\n    year: number;\r\n    age: number;\r\n    gameOver: boolean;\r\n    \r\n    // Population\r\n    pop: number;\r\n    peakPop: number;\r\n    housingCap: number;\r\n    waterCap: number;\r\n    \r\n    // Player (Epoch 0)\r\n    player: Player | null;\r\n    thirst: ThirstState;\r\n    \r\n    // Inventory (Epoch 0)\r\n    inventory: WanderInventory;\r\n    pocket: PocketInventory;\r\n    stepCounter: number;\r\n    foodStepCounter: number;\r\n    \r\n    // City resources (Epoch 1+)\r\n    resources: CityResources;\r\n    \r\n    // World entities\r\n    animals: Animal[];\r\n    wanderWells: WanderWell[];\r\n    nomadsFound: number;\r\n    \r\n    // Buildings\r\n    blds: GameBuilding[];\r\n    zoneCount: number;\r\n    roadTileCount: number;\r\n    \r\n    // Systems\r\n    workforce: WorkforceState;\r\n    needs: NeedsState;\r\n    geology: GeologyState;\r\n    \r\n    // Settlement\r\n    settlementPos: { x: number; y: number } | null;\r\n    siteTraits: SiteTrait[];\r\n    lockedResources: LockedResources;\r\n    gatheringMultiplier: number;\r\n    totalFoodCollected: number;\r\n    \r\n    // Progression\r\n    progression: ProgressionState;\r\n    \r\n    // AI/Automation\r\n    aiEnabled: boolean;\r\n    aiState: string;\r\n    aiTarget: { x: number; y: number } | null;\r\n    simcityMode: boolean;\r\n    \r\n    // Lore\r\n    loreEnabled: boolean;\r\n    loreSeen: Record<string, boolean>;\r\n    \r\n    // Event log\r\n    gameLog: string[];\r\n    \r\n    // Performance\r\n    dirtyRegions: Set<string>;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// STATE CREATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Create initial game state\r\n */\r\nexport function createInitialGameState(): GameState {\r\n    return {\r\n        // Core state\r\n        gamePhase: 'WANDER',\r\n        viewMode: 'NORMAL',\r\n        year: 0,\r\n        age: 0,\r\n        gameOver: false,\r\n        \r\n        // Population\r\n        pop: 4,\r\n        peakPop: 4,\r\n        housingCap: 0,\r\n        waterCap: 0,\r\n        \r\n        // Player\r\n        player: null,\r\n        thirst: { level: 100, stepCounter: 0 },\r\n        \r\n        // Inventory\r\n        inventory: {\r\n            capacity: 450,\r\n            food: 300,\r\n            wood: 300,\r\n            metal: 0,\r\n            stone: 0\r\n        },\r\n        pocket: {\r\n            metal: 0,\r\n            stone: 0,\r\n            capacity: 1000\r\n        },\r\n        stepCounter: 0,\r\n        foodStepCounter: 0,\r\n        \r\n        // City resources\r\n        resources: {\r\n            food: 0,\r\n            wood: 0,\r\n            metal: 0,\r\n            stone: 0,\r\n            water: 100,\r\n            gold: 0\r\n        },\r\n        \r\n        // World entities\r\n        animals: [],\r\n        wanderWells: [],\r\n        nomadsFound: 0,\r\n        \r\n        // Buildings\r\n        blds: [],\r\n        zoneCount: 0,\r\n        roadTileCount: 0,\r\n        \r\n        // Systems\r\n        workforce: {\r\n            total: 0,\r\n            wellWorkers: 0,\r\n            roadWorkers: 0,\r\n            comWorkers: 0,\r\n            indWorkers: 0,\r\n            gatherers: 0,\r\n            wellsNeeded: 0,\r\n            roadsNeeded: 0,\r\n            comNeeded: 0,\r\n            indNeeded: 0,\r\n            shortage: 0\r\n        },\r\n        needs: {\r\n            housing: { have: 0, need: 0, satisfied: 1.0 },\r\n            water: { have: 0, need: 0, satisfied: 1.0 },\r\n            food: { have: 0, need: 0, satisfied: 1.0 },\r\n            jobs: { have: 0, need: 0, satisfied: 1.0 },\r\n            paths: { have: 0, need: 0, satisfied: 1.0 },\r\n            overall: 1.0\r\n        },\r\n        geology: {\r\n            currentSeaLevel: 3,\r\n            periodIndex: 0,\r\n            centuriesInPeriod: 0,\r\n            lastUpdateYear: 0,\r\n            tilesFlooded: 0,\r\n            tilesDrained: 0,\r\n            currentPeriodName: 'Warm Interglacial'\r\n        },\r\n        \r\n        // Settlement\r\n        settlementPos: null,\r\n        siteTraits: [],\r\n        lockedResources: {\r\n            residential: false,\r\n            commercial: false,\r\n            industrial: false\r\n        },\r\n        gatheringMultiplier: 1.0,\r\n        totalFoodCollected: 0,\r\n        \r\n        // Progression\r\n        progression: {\r\n            settlementUnlocked: false,\r\n            industrialUnlocked: false,\r\n            hasClanChief: false,\r\n            hasDock: false\r\n        },\r\n        \r\n        // AI/Automation\r\n        aiEnabled: false,\r\n        aiState: 'EXPLORE',\r\n        aiTarget: null,\r\n        simcityMode: false,\r\n        \r\n        // Lore\r\n        loreEnabled: false,\r\n        loreSeen: {},\r\n        \r\n        // Event log\r\n        gameLog: [],\r\n        \r\n        // Performance\r\n        dirtyRegions: new Set()\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// STATE TRANSITIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Transition from WANDER to CITY mode\r\n */\r\nexport function transitionToCity(\r\n    state: GameState,\r\n    settlementX: number,\r\n    settlementY: number,\r\n    populationBonus: number = 0\r\n): void {\r\n    // Set game phase\r\n    state.gamePhase = 'CITY';\r\n    state.settlementPos = { x: settlementX, y: settlementY };\r\n    \r\n    // Transfer inventory to city resources\r\n    const bonusMultiplier = 1 + (populationBonus / 100);\r\n    state.resources.food = Math.floor(state.inventory.food * bonusMultiplier);\r\n    state.resources.wood = Math.floor(state.inventory.wood * bonusMultiplier);\r\n    state.resources.metal = state.inventory.metal;\r\n    state.resources.stone = state.inventory.stone;\r\n    \r\n    // Set gathering multiplier based on population\r\n    state.gatheringMultiplier = Math.min(3.0, 0.5 + (state.pop * 0.1));\r\n}\r\n\r\n/**\r\n * Log a game event\r\n */\r\nexport function logGameEvent(state: GameState, message: string): void {\r\n    const logEntry = `Year ${state.year}: ${message}`;\r\n    state.gameLog.push(logEntry);\r\n    \r\n    // Keep log size manageable\r\n    if (state.gameLog.length > 100) {\r\n        state.gameLog.shift();\r\n    }\r\n}\r\n\r\n/**\r\n * Mark region as dirty for re-rendering\r\n */\r\nexport function markDirty(state: GameState, x: number, y: number, size: number = 1): void {\r\n    for (let dx = 0; dx < size; dx++) {\r\n        for (let dy = 0; dy < size; dy++) {\r\n            state.dirtyRegions.add(`${x + dx},${y + dy}`);\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Clear dirty regions\r\n */\r\nexport function clearDirtyRegions(state: GameState): void {\r\n    state.dirtyRegions.clear();\r\n}\r\n\r\n/**\r\n * Update peak population\r\n */\r\nexport function updatePeakPop(state: GameState): void {\r\n    if (state.pop > state.peakPop) {\r\n        state.peakPop = state.pop;\r\n    }\r\n}\r\n\r\n/**\r\n * Check if game is over\r\n */\r\nexport function checkGameOver(state: GameState): string | null {\r\n    if (state.pop <= 0) {\r\n        if (state.gamePhase === 'WANDER' && state.inventory.food <= 0) {\r\n            return 'STARVATION';\r\n        }\r\n        return 'POPULATION_LOSS';\r\n    }\r\n    \r\n    if (state.player && state.player.health <= 0) {\r\n        return 'HUNTING';\r\n    }\r\n    \r\n    if (state.gamePhase === 'WANDER' && state.thirst.level <= 0) {\r\n        return 'THIRST';\r\n    }\r\n    \r\n    return null;\r\n}\r\n","/**\r\n * Civil Zones - Save/Load System\r\n * Handles game state persistence to localStorage\r\n */\r\n\r\nimport type { GameState } from './state.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TYPES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Serializable save data */\r\nexport interface SaveData {\r\n    version: string;\r\n    timestamp: number;\r\n    state: SerializableGameState;\r\n    tiles?: unknown;    // Tile data (large, may be compressed)\r\n}\r\n\r\n/** Game state without non-serializable properties */\r\nexport type SerializableGameState = Omit<GameState, 'dirtyRegions'> & {\r\n    dirtyRegions?: string[];  // Convert Set to array for JSON\r\n};\r\n\r\n/** Save slot info */\r\nexport interface SaveSlot {\r\n    id: string;\r\n    name: string;\r\n    timestamp: number;\r\n    year: number;\r\n    pop: number;\r\n    phase: string;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// CONSTANTS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\nexport const SAVE_VERSION = '48.0.0';\r\nexport const AUTOSAVE_KEY = 'civilzones_autosave';\r\nexport const SAVE_PREFIX = 'civilzones_save_';\r\nexport const MAX_SAVE_SLOTS = 5;\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// SERIALIZATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Prepare game state for serialization\r\n */\r\nexport function serializeState(state: GameState): SerializableGameState {\r\n    return {\r\n        ...state,\r\n        dirtyRegions: Array.from(state.dirtyRegions)\r\n    };\r\n}\r\n\r\n/**\r\n * Restore game state from serialized data\r\n */\r\nexport function deserializeState(data: SerializableGameState): GameState {\r\n    return {\r\n        ...data,\r\n        dirtyRegions: new Set(data.dirtyRegions || [])\r\n    };\r\n}\r\n\r\n/**\r\n * Create save data object\r\n */\r\nexport function createSaveData(state: GameState, tiles?: unknown): SaveData {\r\n    return {\r\n        version: SAVE_VERSION,\r\n        timestamp: Date.now(),\r\n        state: serializeState(state),\r\n        tiles\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// LOCAL STORAGE OPERATIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Save game to localStorage\r\n */\r\nexport function saveGame(\r\n    state: GameState,\r\n    tiles: unknown,\r\n    slotId: string = 'autosave'\r\n): boolean {\r\n    try {\r\n        const key = slotId === 'autosave' ? AUTOSAVE_KEY : `${SAVE_PREFIX}${slotId}`;\r\n        const saveData = createSaveData(state, tiles);\r\n        const json = JSON.stringify(saveData);\r\n        \r\n        localStorage.setItem(key, json);\r\n        console.log(`[Save] Game saved to ${key} (${(json.length / 1024).toFixed(1)} KB)`);\r\n        \r\n        return true;\r\n    } catch (error) {\r\n        console.error('[Save] Failed to save game:', error);\r\n        return false;\r\n    }\r\n}\r\n\r\n/**\r\n * Load game from localStorage\r\n */\r\nexport function loadGame(slotId: string = 'autosave'): SaveData | null {\r\n    try {\r\n        const key = slotId === 'autosave' ? AUTOSAVE_KEY : `${SAVE_PREFIX}${slotId}`;\r\n        const json = localStorage.getItem(key);\r\n        \r\n        if (!json) {\r\n            console.log(`[Load] No save found at ${key}`);\r\n            return null;\r\n        }\r\n        \r\n        const saveData: SaveData = JSON.parse(json);\r\n        \r\n        // Version check\r\n        if (saveData.version !== SAVE_VERSION) {\r\n            console.warn(`[Load] Save version mismatch: ${saveData.version} vs ${SAVE_VERSION}`);\r\n            // Could add migration logic here\r\n        }\r\n        \r\n        console.log(`[Load] Game loaded from ${key}`);\r\n        return saveData;\r\n    } catch (error) {\r\n        console.error('[Load] Failed to load game:', error);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Delete a save slot\r\n */\r\nexport function deleteSave(slotId: string): boolean {\r\n    try {\r\n        const key = slotId === 'autosave' ? AUTOSAVE_KEY : `${SAVE_PREFIX}${slotId}`;\r\n        localStorage.removeItem(key);\r\n        console.log(`[Save] Deleted save: ${key}`);\r\n        return true;\r\n    } catch (error) {\r\n        console.error('[Save] Failed to delete save:', error);\r\n        return false;\r\n    }\r\n}\r\n\r\n/**\r\n * Check if save exists\r\n */\r\nexport function hasSave(slotId: string = 'autosave'): boolean {\r\n    const key = slotId === 'autosave' ? AUTOSAVE_KEY : `${SAVE_PREFIX}${slotId}`;\r\n    return localStorage.getItem(key) !== null;\r\n}\r\n\r\n/**\r\n * Get list of all save slots\r\n */\r\nexport function getSaveSlots(): SaveSlot[] {\r\n    const slots: SaveSlot[] = [];\r\n    \r\n    // Check autosave\r\n    if (hasSave('autosave')) {\r\n        const data = loadGame('autosave');\r\n        if (data) {\r\n            slots.push({\r\n                id: 'autosave',\r\n                name: 'Autosave',\r\n                timestamp: data.timestamp,\r\n                year: data.state.year,\r\n                pop: data.state.pop,\r\n                phase: data.state.gamePhase\r\n            });\r\n        }\r\n    }\r\n    \r\n    // Check numbered slots\r\n    for (let i = 1; i <= MAX_SAVE_SLOTS; i++) {\r\n        const slotId = `slot${i}`;\r\n        if (hasSave(slotId)) {\r\n            const data = loadGame(slotId);\r\n            if (data) {\r\n                slots.push({\r\n                    id: slotId,\r\n                    name: `Save ${i}`,\r\n                    timestamp: data.timestamp,\r\n                    year: data.state.year,\r\n                    pop: data.state.pop,\r\n                    phase: data.state.gamePhase\r\n                });\r\n            }\r\n        }\r\n    }\r\n    \r\n    return slots;\r\n}\r\n\r\n/**\r\n * Get next available save slot\r\n */\r\nexport function getNextSaveSlot(): string {\r\n    for (let i = 1; i <= MAX_SAVE_SLOTS; i++) {\r\n        const slotId = `slot${i}`;\r\n        if (!hasSave(slotId)) {\r\n            return slotId;\r\n        }\r\n    }\r\n    // All slots full, return slot1 for overwrite\r\n    return 'slot1';\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// AUTOSAVE\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Autosave interval in milliseconds */\r\nexport const AUTOSAVE_INTERVAL = 60000; // 1 minute\r\n\r\nlet autosaveTimer: ReturnType<typeof setInterval> | null = null;\r\n\r\n/**\r\n * Start autosave timer\r\n */\r\nexport function startAutosave(\r\n    getState: () => GameState,\r\n    getTiles: () => unknown,\r\n    interval: number = AUTOSAVE_INTERVAL\r\n): void {\r\n    stopAutosave();\r\n    \r\n    autosaveTimer = setInterval(() => {\r\n        const state = getState();\r\n        const tiles = getTiles();\r\n        \r\n        if (!state.gameOver) {\r\n            saveGame(state, tiles, 'autosave');\r\n        }\r\n    }, interval);\r\n    \r\n    console.log(`[Autosave] Started with ${interval / 1000}s interval`);\r\n}\r\n\r\n/**\r\n * Stop autosave timer\r\n */\r\nexport function stopAutosave(): void {\r\n    if (autosaveTimer) {\r\n        clearInterval(autosaveTimer);\r\n        autosaveTimer = null;\r\n        console.log('[Autosave] Stopped');\r\n    }\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// EXPORT/IMPORT\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Export save to downloadable file\r\n */\r\nexport function exportSave(state: GameState, tiles: unknown): void {\r\n    const saveData = createSaveData(state, tiles);\r\n    const json = JSON.stringify(saveData, null, 2);\r\n    const blob = new Blob([json], { type: 'application/json' });\r\n    const url = URL.createObjectURL(blob);\r\n    \r\n    const link = document.createElement('a');\r\n    link.href = url;\r\n    link.download = `civilzones_save_${Date.now()}.json`;\r\n    link.click();\r\n    \r\n    URL.revokeObjectURL(url);\r\n}\r\n\r\n/**\r\n * Import save from file\r\n */\r\nexport async function importSave(file: File): Promise<SaveData | null> {\r\n    try {\r\n        const json = await file.text();\r\n        const saveData: SaveData = JSON.parse(json);\r\n        \r\n        // Basic validation\r\n        if (!saveData.version || !saveData.state) {\r\n            throw new Error('Invalid save file format');\r\n        }\r\n        \r\n        return saveData;\r\n    } catch (error) {\r\n        console.error('[Import] Failed to import save:', error);\r\n        return null;\r\n    }\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// DISPLAY HELPERS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Format save timestamp for display\r\n */\r\nexport function formatSaveTime(timestamp: number): string {\r\n    const date = new Date(timestamp);\r\n    const now = new Date();\r\n    \r\n    // Same day - show time only\r\n    if (date.toDateString() === now.toDateString()) {\r\n        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n    }\r\n    \r\n    // This year - show month/day\r\n    if (date.getFullYear() === now.getFullYear()) {\r\n        return date.toLocaleDateString([], { month: 'short', day: 'numeric' });\r\n    }\r\n    \r\n    // Different year - show full date\r\n    return date.toLocaleDateString([], { year: 'numeric', month: 'short', day: 'numeric' });\r\n}\r\n\r\n/**\r\n * Get save slot description\r\n */\r\nexport function getSaveDescription(slot: SaveSlot): string {\r\n    const time = formatSaveTime(slot.timestamp);\r\n    return `${slot.name} - Year ${slot.year}, Pop ${slot.pop} (${slot.phase}) - ${time}`;\r\n}\r\n","/**\r\n * Civil Zones - Input System Types\r\n * Type definitions for input handling\r\n */\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// CAMERA STATE\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Camera position and zoom */\r\nexport interface CameraState {\r\n    x: number;          // World X position (center)\r\n    y: number;          // World Y position (center)\r\n    z: number;          // Zoom level\r\n}\r\n\r\n/** Camera constraints */\r\nexport interface CameraBounds {\r\n    minX: number;\r\n    maxX: number;\r\n    minY: number;\r\n    maxY: number;\r\n    minZoom: number;\r\n    maxZoom: number;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// MOUSE/POINTER STATE\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Current mouse/pointer state */\r\nexport interface PointerState {\r\n    screenX: number;    // Screen coordinates\r\n    screenY: number;\r\n    worldX: number;     // World coordinates\r\n    worldY: number;\r\n    tileX: number;      // Tile coordinates\r\n    tileY: number;\r\n    isDragging: boolean;\r\n    dragStartX: number;\r\n    dragStartY: number;\r\n    button: number;     // Which button is pressed (0=left, 1=middle, 2=right)\r\n}\r\n\r\n/** Pointer event data */\r\nexport interface PointerEvent {\r\n    screenX: number;\r\n    screenY: number;\r\n    button: number;\r\n    deltaX?: number;    // For wheel events\r\n    deltaY?: number;\r\n    target: EventTarget | null;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// KEYBOARD STATE\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Direction keys for movement */\r\nexport type MovementKey = 'w' | 'a' | 's' | 'd' | 'q' | 'e' | 'z' | 'c' |\r\n                          'W' | 'A' | 'S' | 'D' | 'Q' | 'E' | 'Z' | 'C' |\r\n                          'ArrowUp' | 'ArrowDown' | 'ArrowLeft' | 'ArrowRight';\r\n\r\n/** Action keys */\r\nexport type ActionKey = 'Enter' | ' ' | 'Escape' | 'b' | 'B' | 'v' | 'V' | 'Shift';\r\n\r\n/** Keyboard modifier state */\r\nexport interface ModifierState {\r\n    shift: boolean;\r\n    ctrl: boolean;\r\n    alt: boolean;\r\n    meta: boolean;\r\n}\r\n\r\n/** Keyboard event data */\r\nexport interface KeyboardEvent {\r\n    key: string;\r\n    code: string;\r\n    modifiers: ModifierState;\r\n    repeat: boolean;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TOOL STATE\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Available tools/building modes */\r\nexport type ToolType = \r\n    | 'NONE'\r\n    | 'PAN'\r\n    | 'RES'      // Residential\r\n    | 'COM'      // Commercial\r\n    | 'IND'      // Industrial\r\n    | 'ROAD'     // Road\r\n    | 'WELL'     // Water well\r\n    | 'FARM'     // Farm\r\n    | 'MINE'     // Mine\r\n    | 'FOREST'   // Forestry\r\n    | 'DOCK'     // Dock\r\n    | 'CHIEF'    // Chief's hut\r\n    | 'STORAGE'  // Storage\r\n    | 'DELETE';  // Demolish\r\n\r\n/** Tool state for building mode */\r\nexport interface ToolState {\r\n    currentTool: ToolType;\r\n    selectedLevel: number;\r\n    isActive: boolean;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// DRAG STATE (for roads, etc.)\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Road drag state */\r\nexport interface RoadDragState {\r\n    isDragging: boolean;\r\n    builtPositions: Set<string>;  // \"x,y\" format\r\n    tileCount: number;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// INPUT HANDLER CALLBACKS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Callback for movement input */\r\nexport type MoveCallback = (dx: number, dy: number) => void;\r\n\r\n/** Callback for tool/build click */\r\nexport type BuildCallback = (tool: ToolType, x: number, y: number) => void;\r\n\r\n/** Callback for camera pan */\r\nexport type PanCallback = (dx: number, dy: number) => void;\r\n\r\n/** Callback for zoom */\r\nexport type ZoomCallback = (factor: number) => void;\r\n\r\n/** Callback for action keys */\r\nexport type ActionCallback = (action: string) => void;\r\n\r\n/** Callback for tile click */\r\nexport type TileClickCallback = (x: number, y: number, button: number) => void;\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// INPUT CONFIGURATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Input system configuration */\r\nexport interface InputConfig {\r\n    /** Tile size in pixels */\r\n    tileSize: number;\r\n    \r\n    /** Camera bounds */\r\n    bounds: CameraBounds;\r\n    \r\n    /** Zoom step multiplier */\r\n    zoomStep: number;\r\n    \r\n    /** Initial camera position */\r\n    startCamera: CameraState;\r\n    \r\n    /** Menu panel IDs to check for click-through prevention */\r\n    menuPanelIds: string[];\r\n}\r\n\r\n/** Default input configuration */\r\nexport const DEFAULT_INPUT_CONFIG: InputConfig = {\r\n    tileSize: 16,\r\n    bounds: {\r\n        minX: 0,\r\n        maxX: 6400,\r\n        minY: 0,\r\n        maxY: 6400,\r\n        minZoom: 0.5,\r\n        maxZoom: 4.0\r\n    },\r\n    zoomStep: 1.15,\r\n    startCamera: { x: 3200, y: 3200, z: 2.0 },\r\n    menuPanelIds: [\r\n        'building-menu-panel',\r\n        'industrial-menu-panel',\r\n        'commercial-menu-panel',\r\n        'storage-menu-panel',\r\n        'special-menu-panel',\r\n        'road-menu-panel',\r\n        'milestone-menu-panel'\r\n    ]\r\n};\r\n","/**\r\n * Civil Zones - Keyboard Input Handler\r\n * Handles keyboard input for player movement and actions\r\n */\r\n\r\nimport type { \r\n    KeyboardEvent as InputKeyboardEvent,\r\n    ModifierState,\r\n    MoveCallback,\r\n    ActionCallback\r\n} from './types.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// KEY MAPPINGS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Movement key to delta mapping */\r\nexport const MOVEMENT_KEYS: Record<string, [number, number]> = {\r\n    // Cardinal directions\r\n    'w': [0, -1],\r\n    'W': [0, -1],\r\n    'ArrowUp': [0, -1],\r\n    's': [0, 1],\r\n    'S': [0, 1],\r\n    'ArrowDown': [0, 1],\r\n    'a': [-1, 0],\r\n    'A': [-1, 0],\r\n    'ArrowLeft': [-1, 0],\r\n    'd': [1, 0],\r\n    'D': [1, 0],\r\n    'ArrowRight': [1, 0],\r\n    // Diagonal directions\r\n    'q': [-1, -1],\r\n    'Q': [-1, -1],\r\n    'e': [1, -1],\r\n    'E': [1, -1],\r\n    'z': [-1, 1],\r\n    'Z': [-1, 1],\r\n    'c': [1, 1],\r\n    'C': [1, 1]\r\n};\r\n\r\n/** Action keys */\r\nexport const ACTION_KEYS = ['Enter', ' ', 'Escape', 'b', 'B', 'v', 'V'] as const;\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// KEYBOARD STATE\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Current modifier key state */\r\nlet modifierState: ModifierState = {\r\n    shift: false,\r\n    ctrl: false,\r\n    alt: false,\r\n    meta: false\r\n};\r\n\r\n/** Track pressed keys for multi-key detection */\r\nconst pressedKeys = new Set<string>();\r\n\r\n/** Get current modifier state */\r\nexport function getModifierState(): ModifierState {\r\n    return { ...modifierState };\r\n}\r\n\r\n/** Check if shift is held (useful for diagonal road drawing) */\r\nexport function isShiftHeld(): boolean {\r\n    return modifierState.shift;\r\n}\r\n\r\n/** Check if a specific key is pressed */\r\nexport function isKeyPressed(key: string): boolean {\r\n    return pressedKeys.has(key.toLowerCase());\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// KEY EVENT UTILITIES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Extract modifier state from native event */\r\nexport function extractModifiers(e: globalThis.KeyboardEvent): ModifierState {\r\n    return {\r\n        shift: e.shiftKey,\r\n        ctrl: e.ctrlKey,\r\n        alt: e.altKey,\r\n        meta: e.metaKey\r\n    };\r\n}\r\n\r\n/** Check if key is a movement key */\r\nexport function isMovementKey(key: string): boolean {\r\n    return key in MOVEMENT_KEYS;\r\n}\r\n\r\n/** Get movement delta from key */\r\nexport function getMovementDelta(key: string): [number, number] | null {\r\n    return MOVEMENT_KEYS[key] || null;\r\n}\r\n\r\n/** Check if key is an action key */\r\nexport function isActionKey(key: string): boolean {\r\n    return ACTION_KEYS.includes(key as any);\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// KEYBOARD HANDLER CLASS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\nexport interface KeyboardHandlerConfig {\r\n    /** Called when movement key pressed */\r\n    onMove?: MoveCallback;\r\n    \r\n    /** Called when action key pressed */\r\n    onAction?: ActionCallback;\r\n    \r\n    /** Called when modifier state changes */\r\n    onModifierChange?: (modifiers: ModifierState) => void;\r\n    \r\n    /** Check if input should be blocked (e.g., game over) */\r\n    shouldBlockInput?: () => boolean;\r\n    \r\n    /** Check if input should be limited (e.g., death screen - allow Tab/Enter) */\r\n    isLimitedInput?: () => boolean;\r\n}\r\n\r\nexport class KeyboardHandler {\r\n    private config: KeyboardHandlerConfig;\r\n    private boundKeyDown: (e: globalThis.KeyboardEvent) => void;\r\n    private boundKeyUp: (e: globalThis.KeyboardEvent) => void;\r\n    private enabled: boolean = false;\r\n\r\n    constructor(config: KeyboardHandlerConfig = {}) {\r\n        this.config = config;\r\n        this.boundKeyDown = this.handleKeyDown.bind(this);\r\n        this.boundKeyUp = this.handleKeyUp.bind(this);\r\n    }\r\n\r\n    /** Start listening for keyboard events */\r\n    enable(): void {\r\n        if (this.enabled) return;\r\n        window.addEventListener('keydown', this.boundKeyDown);\r\n        window.addEventListener('keyup', this.boundKeyUp);\r\n        this.enabled = true;\r\n    }\r\n\r\n    /** Stop listening for keyboard events */\r\n    disable(): void {\r\n        if (!this.enabled) return;\r\n        window.removeEventListener('keydown', this.boundKeyDown);\r\n        window.removeEventListener('keyup', this.boundKeyUp);\r\n        this.enabled = false;\r\n        pressedKeys.clear();\r\n        modifierState = { shift: false, ctrl: false, alt: false, meta: false };\r\n    }\r\n\r\n    /** Update configuration */\r\n    updateConfig(config: Partial<KeyboardHandlerConfig>): void {\r\n        this.config = { ...this.config, ...config };\r\n    }\r\n\r\n    private handleKeyDown(e: globalThis.KeyboardEvent): void {\r\n        // Block all input if requested\r\n        if (this.config.shouldBlockInput?.()) {\r\n            e.preventDefault();\r\n            return;\r\n        }\r\n\r\n        // Limited input mode (death screen - only Tab/Enter allowed)\r\n        if (this.config.isLimitedInput?.()) {\r\n            if (e.key !== 'Tab' && e.key !== 'Enter') {\r\n                e.preventDefault();\r\n                return;\r\n            }\r\n            return;\r\n        }\r\n\r\n        // Update modifier state\r\n        const oldShift = modifierState.shift;\r\n        modifierState = extractModifiers(e);\r\n        if (oldShift !== modifierState.shift) {\r\n            this.config.onModifierChange?.(modifierState);\r\n        }\r\n\r\n        // Track pressed keys\r\n        pressedKeys.add(e.key.toLowerCase());\r\n\r\n        // Handle movement keys\r\n        const moveDelta = getMovementDelta(e.key);\r\n        if (moveDelta) {\r\n            this.config.onMove?.(moveDelta[0], moveDelta[1]);\r\n            e.preventDefault();\r\n            return;\r\n        }\r\n\r\n        // Handle action keys\r\n        if (isActionKey(e.key)) {\r\n            this.config.onAction?.(e.key);\r\n            e.preventDefault();\r\n            return;\r\n        }\r\n    }\r\n\r\n    private handleKeyUp(e: globalThis.KeyboardEvent): void {\r\n        // Update modifier state\r\n        const oldShift = modifierState.shift;\r\n        modifierState = extractModifiers(e);\r\n        if (oldShift !== modifierState.shift) {\r\n            this.config.onModifierChange?.(modifierState);\r\n        }\r\n\r\n        // Track key release\r\n        pressedKeys.delete(e.key.toLowerCase());\r\n    }\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// FACTORY FUNCTIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Create a keyboard handler with standard game controls */\r\nexport function createKeyboardHandler(config: KeyboardHandlerConfig = {}): KeyboardHandler {\r\n    return new KeyboardHandler(config);\r\n}\r\n\r\n/** Create movement-only keyboard handler */\r\nexport function createMovementHandler(onMove: MoveCallback): KeyboardHandler {\r\n    return new KeyboardHandler({ onMove });\r\n}\r\n","/**\r\n * Civil Zones - Mouse/Pointer Input Handler\r\n * Handles mouse clicks, drags, and wheel events\r\n */\r\n\r\nimport type {\r\n    CameraState,\r\n    CameraBounds,\r\n    PointerState,\r\n    ToolType,\r\n    RoadDragState,\r\n    InputConfig,\r\n    TileClickCallback,\r\n    PanCallback,\r\n    ZoomCallback,\r\n    BuildCallback,\r\n    DEFAULT_INPUT_CONFIG\r\n} from './types.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// COORDINATE CONVERSION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Convert screen coordinates to world coordinates */\r\nexport function screenToWorld(\r\n    screenX: number,\r\n    screenY: number,\r\n    camera: CameraState,\r\n    canvasWidth: number,\r\n    canvasHeight: number\r\n): { x: number; y: number } {\r\n    const wx = (screenX - canvasWidth / 2) / camera.z + camera.x;\r\n    const wy = (screenY - canvasHeight / 2) / camera.z + camera.y;\r\n    return { x: wx, y: wy };\r\n}\r\n\r\n/** Convert world coordinates to tile coordinates */\r\nexport function worldToTile(worldX: number, worldY: number, tileSize: number): { x: number; y: number } {\r\n    return {\r\n        x: Math.floor(worldX / tileSize),\r\n        y: Math.floor(worldY / tileSize)\r\n    };\r\n}\r\n\r\n/** Convert screen coordinates directly to tile coordinates */\r\nexport function screenToTile(\r\n    screenX: number,\r\n    screenY: number,\r\n    camera: CameraState,\r\n    canvasWidth: number,\r\n    canvasHeight: number,\r\n    tileSize: number\r\n): { x: number; y: number } {\r\n    const world = screenToWorld(screenX, screenY, camera, canvasWidth, canvasHeight);\r\n    return worldToTile(world.x, world.y, tileSize);\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// CAMERA OPERATIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Clamp camera position within bounds */\r\nexport function clampCamera(camera: CameraState, bounds: CameraBounds): CameraState {\r\n    return {\r\n        x: Math.max(bounds.minX, Math.min(bounds.maxX, camera.x)),\r\n        y: Math.max(bounds.minY, Math.min(bounds.maxY, camera.y)),\r\n        z: Math.max(bounds.minZoom, Math.min(bounds.maxZoom, camera.z))\r\n    };\r\n}\r\n\r\n/** Apply pan delta to camera */\r\nexport function panCamera(\r\n    camera: CameraState,\r\n    deltaX: number,\r\n    deltaY: number,\r\n    bounds: CameraBounds\r\n): CameraState {\r\n    const newCam = {\r\n        x: camera.x - deltaX / camera.z,\r\n        y: camera.y - deltaY / camera.z,\r\n        z: camera.z\r\n    };\r\n    return clampCamera(newCam, bounds);\r\n}\r\n\r\n/** Apply zoom to camera */\r\nexport function zoomCamera(\r\n    camera: CameraState,\r\n    factor: number,\r\n    bounds: CameraBounds\r\n): CameraState {\r\n    const newCam = {\r\n        ...camera,\r\n        z: Math.max(bounds.minZoom, Math.min(bounds.maxZoom, camera.z * factor))\r\n    };\r\n    return newCam;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// CLICK DETECTION UTILITIES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Check if click is on canvas (not UI element) */\r\nexport function isClickOnCanvas(target: EventTarget | null, canvas: HTMLCanvasElement): boolean {\r\n    return target === canvas;\r\n}\r\n\r\n/** Check if point is inside a rectangle */\r\nexport function isPointInRect(\r\n    x: number,\r\n    y: number,\r\n    rect: { left: number; right: number; top: number; bottom: number }\r\n): boolean {\r\n    return x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;\r\n}\r\n\r\n/** Check if click is blocked by open menu panel */\r\nexport function isClickBlockedByMenu(\r\n    clientX: number,\r\n    clientY: number,\r\n    menuPanelIds: string[]\r\n): boolean {\r\n    for (const panelId of menuPanelIds) {\r\n        const panel = document.getElementById(panelId);\r\n        if (panel && panel.style.display !== 'none' && panel.style.display !== '') {\r\n            const rect = panel.getBoundingClientRect();\r\n            if (isPointInRect(clientX, clientY, rect)) {\r\n                return true;\r\n            }\r\n        }\r\n    }\r\n    return false;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// ROAD DRAG STATE\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Create initial road drag state */\r\nexport function createRoadDragState(): RoadDragState {\r\n    return {\r\n        isDragging: false,\r\n        builtPositions: new Set(),\r\n        tileCount: 0\r\n    };\r\n}\r\n\r\n/** Start road drag */\r\nexport function startRoadDrag(state: RoadDragState, x: number, y: number): RoadDragState {\r\n    const newState = {\r\n        isDragging: true,\r\n        builtPositions: new Set<string>(),\r\n        tileCount: 0\r\n    };\r\n    newState.builtPositions.add(`${x},${y}`);\r\n    return newState;\r\n}\r\n\r\n/** Add position to road drag */\r\nexport function addRoadDragPosition(state: RoadDragState, x: number, y: number): RoadDragState {\r\n    const key = `${x},${y}`;\r\n    if (state.builtPositions.has(key)) {\r\n        return state;\r\n    }\r\n    const newBuilt = new Set(state.builtPositions);\r\n    newBuilt.add(key);\r\n    return {\r\n        isDragging: true,\r\n        builtPositions: newBuilt,\r\n        tileCount: state.tileCount + 1\r\n    };\r\n}\r\n\r\n/** End road drag */\r\nexport function endRoadDrag(): RoadDragState {\r\n    return createRoadDragState();\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// MOUSE HANDLER CLASS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\nexport interface MouseHandlerConfig {\r\n    /** Canvas element to attach to */\r\n    canvas: HTMLCanvasElement;\r\n    \r\n    /** Get current camera state */\r\n    getCamera: () => CameraState;\r\n    \r\n    /** Update camera state */\r\n    setCamera: (camera: CameraState) => void;\r\n    \r\n    /** Get current tool */\r\n    getTool: () => ToolType;\r\n    \r\n    /** Input configuration */\r\n    config: InputConfig;\r\n    \r\n    /** Called when tile is clicked (left click) */\r\n    onTileClick?: TileClickCallback;\r\n    \r\n    /** Called when building with tool */\r\n    onBuild?: BuildCallback;\r\n    \r\n    /** Called on zoom */\r\n    onZoom?: ZoomCallback;\r\n    \r\n    /** Place road silently (for drag building) */\r\n    placeRoadSilent?: (x: number, y: number) => boolean;\r\n    \r\n    /** Show toast message */\r\n    showToast?: (message: string) => void;\r\n    \r\n    /** Get canvas dimensions */\r\n    getCanvasDimensions: () => { width: number; height: number };\r\n}\r\n\r\nexport class MouseHandler {\r\n    private config: MouseHandlerConfig;\r\n    private pointerState: PointerState;\r\n    private roadDragState: RoadDragState;\r\n    private enabled: boolean = false;\r\n    \r\n    // Bound event handlers\r\n    private boundMouseDown: (e: MouseEvent) => void;\r\n    private boundMouseUp: (e: MouseEvent) => void;\r\n    private boundMouseMove: (e: MouseEvent) => void;\r\n    private boundWheel: (e: WheelEvent) => void;\r\n    private boundContextMenu: (e: MouseEvent) => void;\r\n\r\n    constructor(config: MouseHandlerConfig) {\r\n        this.config = config;\r\n        this.pointerState = this.createInitialPointerState();\r\n        this.roadDragState = createRoadDragState();\r\n        \r\n        this.boundMouseDown = this.handleMouseDown.bind(this);\r\n        this.boundMouseUp = this.handleMouseUp.bind(this);\r\n        this.boundMouseMove = this.handleMouseMove.bind(this);\r\n        this.boundWheel = this.handleWheel.bind(this);\r\n        this.boundContextMenu = (e) => e.preventDefault();\r\n    }\r\n\r\n    private createInitialPointerState(): PointerState {\r\n        return {\r\n            screenX: 0,\r\n            screenY: 0,\r\n            worldX: 0,\r\n            worldY: 0,\r\n            tileX: 0,\r\n            tileY: 0,\r\n            isDragging: false,\r\n            dragStartX: 0,\r\n            dragStartY: 0,\r\n            button: 0\r\n        };\r\n    }\r\n\r\n    /** Get current tile position */\r\n    getTilePosition(): { x: number; y: number } {\r\n        return { x: this.pointerState.tileX, y: this.pointerState.tileY };\r\n    }\r\n\r\n    /** Start listening for mouse events */\r\n    enable(): void {\r\n        if (this.enabled) return;\r\n        const canvas = this.config.canvas;\r\n        \r\n        canvas.addEventListener('mousedown', this.boundMouseDown);\r\n        window.addEventListener('mouseup', this.boundMouseUp);\r\n        window.addEventListener('mousemove', this.boundMouseMove);\r\n        canvas.addEventListener('wheel', this.boundWheel, { passive: false });\r\n        canvas.addEventListener('contextmenu', this.boundContextMenu);\r\n        \r\n        this.enabled = true;\r\n    }\r\n\r\n    /** Stop listening for mouse events */\r\n    disable(): void {\r\n        if (!this.enabled) return;\r\n        const canvas = this.config.canvas;\r\n        \r\n        canvas.removeEventListener('mousedown', this.boundMouseDown);\r\n        window.removeEventListener('mouseup', this.boundMouseUp);\r\n        window.removeEventListener('mousemove', this.boundMouseMove);\r\n        canvas.removeEventListener('wheel', this.boundWheel);\r\n        canvas.removeEventListener('contextmenu', this.boundContextMenu);\r\n        \r\n        this.enabled = false;\r\n    }\r\n\r\n    private updatePointerPosition(e: MouseEvent): void {\r\n        const canvas = this.config.canvas;\r\n        const rect = canvas.getBoundingClientRect();\r\n        const camera = this.config.getCamera();\r\n        const dims = this.config.getCanvasDimensions();\r\n        const tileSize = this.config.config.tileSize;\r\n        \r\n        this.pointerState.screenX = e.clientX - rect.left;\r\n        this.pointerState.screenY = e.clientY - rect.top;\r\n        \r\n        const world = screenToWorld(\r\n            this.pointerState.screenX,\r\n            this.pointerState.screenY,\r\n            camera,\r\n            dims.width,\r\n            dims.height\r\n        );\r\n        this.pointerState.worldX = world.x;\r\n        this.pointerState.worldY = world.y;\r\n        \r\n        const tile = worldToTile(world.x, world.y, tileSize);\r\n        this.pointerState.tileX = tile.x;\r\n        this.pointerState.tileY = tile.y;\r\n    }\r\n\r\n    private handleMouseDown(e: MouseEvent): void {\r\n        const canvas = this.config.canvas;\r\n        \r\n        // Check if click is on canvas\r\n        if (!isClickOnCanvas(e.target, canvas)) {\r\n            return;\r\n        }\r\n        \r\n        // Check if blocked by menu\r\n        if (isClickBlockedByMenu(e.clientX, e.clientY, this.config.config.menuPanelIds)) {\r\n            return;\r\n        }\r\n        \r\n        this.updatePointerPosition(e);\r\n        \r\n        // Left click\r\n        if (e.button === 0) {\r\n            const tool = this.config.getTool();\r\n            \r\n            if (tool !== 'NONE' && tool !== 'PAN') {\r\n                // Road drag mode\r\n                if (tool === 'ROAD') {\r\n                    this.roadDragState = startRoadDrag(\r\n                        this.roadDragState,\r\n                        this.pointerState.tileX,\r\n                        this.pointerState.tileY\r\n                    );\r\n                    \r\n                    // Place first road tile\r\n                    if (this.config.placeRoadSilent?.(\r\n                        this.pointerState.tileX,\r\n                        this.pointerState.tileY\r\n                    )) {\r\n                        this.roadDragState.tileCount++;\r\n                    }\r\n                    return;\r\n                }\r\n                \r\n                // Building mode\r\n                this.config.onBuild?.(\r\n                    tool,\r\n                    this.pointerState.tileX,\r\n                    this.pointerState.tileY\r\n                );\r\n            } else {\r\n                // Click to move/interact\r\n                this.config.onTileClick?.(\r\n                    this.pointerState.tileX,\r\n                    this.pointerState.tileY,\r\n                    0\r\n                );\r\n            }\r\n        }\r\n        // Middle or right click: pan camera\r\n        else if (e.button === 1 || e.button === 2) {\r\n            this.pointerState.isDragging = true;\r\n            this.pointerState.dragStartX = e.clientX;\r\n            this.pointerState.dragStartY = e.clientY;\r\n            this.pointerState.button = e.button;\r\n            document.body.style.cursor = 'grabbing';\r\n        }\r\n    }\r\n\r\n    private handleMouseUp(e: MouseEvent): void {\r\n        // End camera drag\r\n        this.pointerState.isDragging = false;\r\n        document.body.style.cursor = 'default';\r\n        \r\n        // End road drag with summary\r\n        if (this.roadDragState.isDragging) {\r\n            if (this.roadDragState.tileCount > 0 && this.config.showToast) {\r\n                if (this.roadDragState.tileCount === 1) {\r\n                    this.config.showToast('ğŸ›£ï¸ Road placed! (Drag to draw roads)');\r\n                } else {\r\n                    this.config.showToast(`ğŸ›£ï¸ Built ${this.roadDragState.tileCount} road tiles!`);\r\n                }\r\n            }\r\n            this.roadDragState = endRoadDrag();\r\n        }\r\n    }\r\n\r\n    private handleMouseMove(e: MouseEvent): void {\r\n        this.updatePointerPosition(e);\r\n        \r\n        // Camera pan drag\r\n        if (this.pointerState.isDragging) {\r\n            const deltaX = e.clientX - this.pointerState.dragStartX;\r\n            const deltaY = e.clientY - this.pointerState.dragStartY;\r\n            \r\n            const camera = this.config.getCamera();\r\n            const newCamera = panCamera(camera, deltaX, deltaY, this.config.config.bounds);\r\n            this.config.setCamera(newCamera);\r\n            \r\n            this.pointerState.dragStartX = e.clientX;\r\n            this.pointerState.dragStartY = e.clientY;\r\n        }\r\n        \r\n        // Road drag building\r\n        if (this.roadDragState.isDragging && this.config.getTool() === 'ROAD') {\r\n            const key = `${this.pointerState.tileX},${this.pointerState.tileY}`;\r\n            if (!this.roadDragState.builtPositions.has(key)) {\r\n                if (this.config.placeRoadSilent?.(\r\n                    this.pointerState.tileX,\r\n                    this.pointerState.tileY\r\n                )) {\r\n                    this.roadDragState = addRoadDragPosition(\r\n                        this.roadDragState,\r\n                        this.pointerState.tileX,\r\n                        this.pointerState.tileY\r\n                    );\r\n                } else {\r\n                    // Track position even if build failed to avoid spam\r\n                    this.roadDragState.builtPositions.add(key);\r\n                }\r\n            }\r\n        }\r\n        \r\n        // Update debug display (optional)\r\n        const debug = document.getElementById('debug');\r\n        if (debug) {\r\n            debug.innerText = `Pos: ${this.pointerState.tileX}, ${this.pointerState.tileY}`;\r\n        }\r\n    }\r\n\r\n    private handleWheel(e: WheelEvent): void {\r\n        e.preventDefault();\r\n        \r\n        const factor = e.deltaY < 0 \r\n            ? this.config.config.zoomStep \r\n            : 1 / this.config.config.zoomStep;\r\n        \r\n        const camera = this.config.getCamera();\r\n        const newCamera = zoomCamera(camera, factor, this.config.config.bounds);\r\n        this.config.setCamera(newCamera);\r\n        \r\n        this.config.onZoom?.(factor);\r\n    }\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// FACTORY FUNCTIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Create a mouse handler with standard game controls */\r\nexport function createMouseHandler(config: MouseHandlerConfig): MouseHandler {\r\n    return new MouseHandler(config);\r\n}\r\n","/**\r\n * Civil Zones - Input Controller\r\n * Unified input controller that combines keyboard and mouse handling\r\n */\r\n\r\nimport type {\r\n    CameraState,\r\n    CameraBounds,\r\n    ToolType,\r\n    ToolState,\r\n    InputConfig,\r\n    MoveCallback,\r\n    BuildCallback,\r\n    ActionCallback,\r\n    TileClickCallback,\r\n    DEFAULT_INPUT_CONFIG\r\n} from './types.js';\r\nimport { KeyboardHandler, isShiftHeld } from './keyboard.js';\r\nimport { MouseHandler, clampCamera, createMouseHandler } from './mouse.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// INPUT CONTROLLER\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\nexport interface InputControllerConfig {\r\n    /** Canvas element */\r\n    canvas: HTMLCanvasElement;\r\n    \r\n    /** Input configuration */\r\n    inputConfig?: InputConfig;\r\n    \r\n    /** Initial camera state */\r\n    initialCamera?: CameraState;\r\n    \r\n    // Callbacks\r\n    onMove?: MoveCallback;\r\n    onBuild?: BuildCallback;\r\n    onAction?: ActionCallback;\r\n    onTileClick?: TileClickCallback;\r\n    onCameraChange?: (camera: CameraState) => void;\r\n    \r\n    // Game state queries\r\n    shouldBlockInput?: () => boolean;\r\n    isLimitedInput?: () => boolean;\r\n    \r\n    // Road building\r\n    placeRoadSilent?: (x: number, y: number) => boolean;\r\n    \r\n    // UI feedback\r\n    showToast?: (message: string) => void;\r\n    \r\n    // Canvas dimensions\r\n    getCanvasDimensions?: () => { width: number; height: number };\r\n}\r\n\r\nexport class InputController {\r\n    private config: InputControllerConfig;\r\n    private inputConfig: InputConfig;\r\n    private camera: CameraState;\r\n    private toolState: ToolState;\r\n    private keyboardHandler: KeyboardHandler;\r\n    private mouseHandler: MouseHandler;\r\n    private enabled: boolean = false;\r\n\r\n    constructor(config: InputControllerConfig) {\r\n        this.config = config;\r\n        \r\n        // Use default config or provided\r\n        this.inputConfig = config.inputConfig || {\r\n            tileSize: 16,\r\n            bounds: {\r\n                minX: 0,\r\n                maxX: 6400,\r\n                minY: 0,\r\n                maxY: 6400,\r\n                minZoom: 0.5,\r\n                maxZoom: 4.0\r\n            },\r\n            zoomStep: 1.15,\r\n            startCamera: { x: 3200, y: 3200, z: 2.0 },\r\n            menuPanelIds: [\r\n                'building-menu-panel',\r\n                'industrial-menu-panel',\r\n                'commercial-menu-panel',\r\n                'storage-menu-panel',\r\n                'special-menu-panel',\r\n                'road-menu-panel',\r\n                'milestone-menu-panel'\r\n            ]\r\n        };\r\n        \r\n        // Initialize camera\r\n        this.camera = config.initialCamera || { ...this.inputConfig.startCamera };\r\n        \r\n        // Initialize tool state\r\n        this.toolState = {\r\n            currentTool: 'PAN',\r\n            selectedLevel: 1,\r\n            isActive: false\r\n        };\r\n        \r\n        // Create keyboard handler\r\n        this.keyboardHandler = new KeyboardHandler({\r\n            onMove: (dx, dy) => this.config.onMove?.(dx, dy),\r\n            onAction: (action) => this.config.onAction?.(action),\r\n            onModifierChange: (modifiers) => {\r\n                // Could trigger UI updates for shift-held state\r\n            },\r\n            shouldBlockInput: config.shouldBlockInput,\r\n            isLimitedInput: config.isLimitedInput\r\n        });\r\n        \r\n        // Create mouse handler\r\n        this.mouseHandler = createMouseHandler({\r\n            canvas: config.canvas,\r\n            getCamera: () => this.camera,\r\n            setCamera: (cam) => {\r\n                this.camera = cam;\r\n                this.config.onCameraChange?.(cam);\r\n            },\r\n            getTool: () => this.toolState.currentTool,\r\n            config: this.inputConfig,\r\n            onTileClick: config.onTileClick,\r\n            onBuild: config.onBuild,\r\n            placeRoadSilent: config.placeRoadSilent,\r\n            showToast: config.showToast,\r\n            getCanvasDimensions: config.getCanvasDimensions || (() => ({\r\n                width: config.canvas.width,\r\n                height: config.canvas.height\r\n            }))\r\n        });\r\n    }\r\n\r\n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n    // CAMERA CONTROL\r\n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n    /** Get current camera state */\r\n    getCamera(): CameraState {\r\n        return { ...this.camera };\r\n    }\r\n\r\n    /** Set camera position */\r\n    setCamera(camera: Partial<CameraState>): void {\r\n        this.camera = clampCamera(\r\n            { ...this.camera, ...camera },\r\n            this.inputConfig.bounds\r\n        );\r\n        this.config.onCameraChange?.(this.camera);\r\n    }\r\n\r\n    /** Center camera on world position */\r\n    centerOn(worldX: number, worldY: number): void {\r\n        this.setCamera({ x: worldX, y: worldY });\r\n    }\r\n\r\n    /** Center camera on tile */\r\n    centerOnTile(tileX: number, tileY: number): void {\r\n        const worldX = (tileX + 0.5) * this.inputConfig.tileSize;\r\n        const worldY = (tileY + 0.5) * this.inputConfig.tileSize;\r\n        this.centerOn(worldX, worldY);\r\n    }\r\n\r\n    /** Set zoom level */\r\n    setZoom(z: number): void {\r\n        this.setCamera({ z });\r\n    }\r\n\r\n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n    // TOOL CONTROL\r\n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n    /** Get current tool */\r\n    getTool(): ToolType {\r\n        return this.toolState.currentTool;\r\n    }\r\n\r\n    /** Set current tool */\r\n    setTool(tool: ToolType): void {\r\n        this.toolState.currentTool = tool;\r\n        this.toolState.isActive = tool !== 'NONE' && tool !== 'PAN';\r\n    }\r\n\r\n    /** Get selected building level */\r\n    getSelectedLevel(): number {\r\n        return this.toolState.selectedLevel;\r\n    }\r\n\r\n    /** Set selected building level */\r\n    setSelectedLevel(level: number): void {\r\n        this.toolState.selectedLevel = level;\r\n    }\r\n\r\n    /** Check if shift is held (for diagonal road drawing) */\r\n    isShiftHeld(): boolean {\r\n        return isShiftHeld();\r\n    }\r\n\r\n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n    // POINTER POSITION\r\n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n    /** Get current tile position under pointer */\r\n    getTilePosition(): { x: number; y: number } {\r\n        return this.mouseHandler.getTilePosition();\r\n    }\r\n\r\n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n    // LIFECYCLE\r\n    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n    /** Enable input handling */\r\n    enable(): void {\r\n        if (this.enabled) return;\r\n        this.keyboardHandler.enable();\r\n        this.mouseHandler.enable();\r\n        this.enabled = true;\r\n    }\r\n\r\n    /** Disable input handling */\r\n    disable(): void {\r\n        if (!this.enabled) return;\r\n        this.keyboardHandler.disable();\r\n        this.mouseHandler.disable();\r\n        this.enabled = false;\r\n    }\r\n\r\n    /** Check if input is enabled */\r\n    isEnabled(): boolean {\r\n        return this.enabled;\r\n    }\r\n\r\n    /** Update callbacks (useful for dynamic game state) */\r\n    updateCallbacks(callbacks: Partial<Pick<\r\n        InputControllerConfig,\r\n        'onMove' | 'onBuild' | 'onAction' | 'onTileClick' | 'onCameraChange'\r\n    >>): void {\r\n        Object.assign(this.config, callbacks);\r\n        \r\n        // Update keyboard handler\r\n        this.keyboardHandler.updateConfig({\r\n            onMove: callbacks.onMove,\r\n            onAction: callbacks.onAction\r\n        });\r\n    }\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// FACTORY FUNCTIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Create an input controller for the game */\r\nexport function createInputController(config: InputControllerConfig): InputController {\r\n    return new InputController(config);\r\n}\r\n\r\n/** Create input controller with minimal config */\r\nexport function createSimpleInputController(\r\n    canvas: HTMLCanvasElement,\r\n    onMove: MoveCallback,\r\n    onAction?: ActionCallback\r\n): InputController {\r\n    return new InputController({\r\n        canvas,\r\n        onMove,\r\n        onAction\r\n    });\r\n}\r\n","/**\r\n * Civil Zones - Lore Events\r\n * Story events and milestone tracking\r\n */\r\n\r\nimport type { \r\n    LoreEventId, \r\n    LoreEvent, \r\n    LoreIllustration, \r\n    LoreSeen \r\n} from './types.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// LORE EVENT DEFINITIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** All lore events in the game */\r\nexport const LORE_EVENTS: Record<LoreEventId, LoreEvent> = {\r\n    GAME_START: {\r\n        title: 'The Dream',\r\n        text: 'Early man had a dream one night... a vision of something greater than mere survival. He saw his descendants building, thriving, creating. And so, with nothing but hope and hunger, he left his people and began to wander...',\r\n        illustration: 'wanderer'\r\n    },\r\n    FIRST_WELL: {\r\n        title: 'Fresh Water!',\r\n        text: 'Digging far enough revealed what the wise ones spoke of - underground rivers! Fresh water bubbled up from the earth. No longer would the tribe be slaves to rivers and lakes. Now they could make water appear wherever they chose!',\r\n        illustration: 'well'\r\n    },\r\n    FIRST_RESIDENTIAL: {\r\n        title: 'A Proper Shelter',\r\n        text: 'Now THIS is proper living! No more sleeping under stars with wolves howling. Four walls and a roof - what luxury! The tribe looked upon their creation with pride. \"We are no longer wanderers,\" they declared. \"We are SETTLERS.\"',\r\n        illustration: 'hut'\r\n    },\r\n    FIRST_HUNTING_GROUND: {\r\n        title: 'The Hunting Grounds',\r\n        text: 'The wise hunter knows: chase the deer, catch one meal. Let the deer come to you, catch a hundred! And so the first hunting ground was established - a place where prey would wander in, never to wander out.',\r\n        illustration: 'hunting'\r\n    },\r\n    FIRST_ROAD: {\r\n        title: 'The Beaten Path',\r\n        text: 'Why walk through thorns when you can walk on dirt? The tribe\\'s smartest member (whose name has been lost to time, but was probably \"Ook\" or \"Ug\") packed down the earth to make travel easier. Revolutionary!',\r\n        illustration: 'road'\r\n    },\r\n    FIRST_KILL: {\r\n        title: 'The First Hunt',\r\n        text: 'Blood! Meat! VICTORY! The beast fell before the tribe\\'s mighty hunter. Tonight they would feast, and tomorrow... they would hunt again. The way of the predator had begun.',\r\n        illustration: 'hunt_success'\r\n    },\r\n    FIRST_SETTLEMENT: {\r\n        title: 'A Settlement is Born',\r\n        text: 'No more wandering. No more running. This patch of earth... THIS belongs to us! The tribe drove stakes into the ground and declared themselves FOUNDERS. History was about to begin.',\r\n        illustration: 'settlement'\r\n    },\r\n    FIRST_STORAGE: {\r\n        title: 'The Storage Pit',\r\n        text: 'The brilliant idea came from watching squirrels hide nuts. \"What if WE buried our food?\" And lo, the storage pit was invented. Now surplus wouldn\\'t rot in the sun - it would rot underground! Progress!',\r\n        illustration: 'storage'\r\n    },\r\n    FIRST_COMMERCIAL: {\r\n        title: 'Trading Post',\r\n        text: 'One day, Ook had three fish. Ug had three berries. Both wanted variety. After much grunting and gesturing, they discovered TRADE! The economy was born, and Ook\\'s descendants would one day invent taxes.',\r\n        illustration: 'trading'\r\n    },\r\n    FIRST_NOMAD: {\r\n        title: 'A Stranger Approaches',\r\n        text: 'From the mist emerged another... a fellow wanderer! Heart pounding, spear raised, our ancestor faced a choice. Friend or foe? The stranger raised a hand in peace. Today, the tribe grows stronger.',\r\n        illustration: 'nomad'\r\n    },\r\n    FIRST_TURTLE: {\r\n        title: 'Beach Bounty',\r\n        text: 'Upon the sandy shores, a strange shelled creature waddled slowly. \"What manner of rock moves on its own?\" wondered the hunter. Turns out, it was delicious. The beach would never go hungry again.',\r\n        illustration: 'turtle'\r\n    },\r\n    FLOOD_WARNING: {\r\n        title: 'The Waters Rise',\r\n        text: 'The elders spoke of this - the great waters that swallow the land. \"Build high,\" they warned. \"The sea remembers, and the sea returns.\" Perhaps it was time to seek higher ground...',\r\n        illustration: 'flood'\r\n    },\r\n    FIRST_BERRY: {\r\n        title: 'The Berry Bush',\r\n        text: 'Red and plump, the berries glistened in the sun. The hungry wanderer reached out... Would they bring life or death? 90% of the time, it\\'s fine! The other 10%... well, that\\'s how we learned which ones NOT to eat.',\r\n        illustration: 'berry'\r\n    }\r\n};\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// LORE EVENT FUNCTIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Get a lore event by ID */\r\nexport function getLoreEvent(eventId: LoreEventId): LoreEvent | undefined {\r\n    return LORE_EVENTS[eventId];\r\n}\r\n\r\n/** Check if a lore event has been seen */\r\nexport function hasSeenLore(loreSeen: LoreSeen, eventId: LoreEventId): boolean {\r\n    return loreSeen[eventId] === true;\r\n}\r\n\r\n/** Mark a lore event as seen */\r\nexport function markLoreSeen(loreSeen: LoreSeen, eventId: LoreEventId): LoreSeen {\r\n    return {\r\n        ...loreSeen,\r\n        [eventId]: true\r\n    };\r\n}\r\n\r\n/** Check if lore should be shown (enabled and not seen) */\r\nexport function shouldShowLore(\r\n    loreEnabled: boolean,\r\n    loreSeen: LoreSeen,\r\n    eventId: LoreEventId\r\n): boolean {\r\n    if (!loreEnabled) return false;\r\n    if (hasSeenLore(loreSeen, eventId)) return false;\r\n    return true;\r\n}\r\n\r\n/** Get all unseen lore events */\r\nexport function getUnseenLore(loreSeen: LoreSeen): LoreEventId[] {\r\n    const allEvents = Object.keys(LORE_EVENTS) as LoreEventId[];\r\n    return allEvents.filter(id => !hasSeenLore(loreSeen, id));\r\n}\r\n\r\n/** Get count of seen lore events */\r\nexport function getSeenLoreCount(loreSeen: LoreSeen): number {\r\n    return Object.values(loreSeen).filter(Boolean).length;\r\n}\r\n\r\n/** Get total lore event count */\r\nexport function getTotalLoreCount(): number {\r\n    return Object.keys(LORE_EVENTS).length;\r\n}\r\n\r\n/** Get lore progress as percentage */\r\nexport function getLoreProgress(loreSeen: LoreSeen): number {\r\n    const total = getTotalLoreCount();\r\n    if (total === 0) return 100;\r\n    return Math.round((getSeenLoreCount(loreSeen) / total) * 100);\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// LORE TRIGGER HELPERS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Check and trigger first kill lore */\r\nexport function checkFirstKillLore(loreSeen: LoreSeen): { \r\n    shouldShow: boolean; \r\n    eventId: LoreEventId \r\n} {\r\n    return {\r\n        shouldShow: !hasSeenLore(loreSeen, 'FIRST_KILL'),\r\n        eventId: 'FIRST_KILL'\r\n    };\r\n}\r\n\r\n/** Check and trigger first turtle lore */\r\nexport function checkFirstTurtleLore(loreSeen: LoreSeen): { \r\n    shouldShow: boolean; \r\n    eventId: LoreEventId \r\n} {\r\n    return {\r\n        shouldShow: !hasSeenLore(loreSeen, 'FIRST_TURTLE'),\r\n        eventId: 'FIRST_TURTLE'\r\n    };\r\n}\r\n\r\n/** Check and trigger first nomad lore */\r\nexport function checkFirstNomadLore(loreSeen: LoreSeen): { \r\n    shouldShow: boolean; \r\n    eventId: LoreEventId \r\n} {\r\n    return {\r\n        shouldShow: !hasSeenLore(loreSeen, 'FIRST_NOMAD'),\r\n        eventId: 'FIRST_NOMAD'\r\n    };\r\n}\r\n\r\n/** Check and trigger first berry lore */\r\nexport function checkFirstBerryLore(loreSeen: LoreSeen): { \r\n    shouldShow: boolean; \r\n    eventId: LoreEventId \r\n} {\r\n    return {\r\n        shouldShow: !hasSeenLore(loreSeen, 'FIRST_BERRY'),\r\n        eventId: 'FIRST_BERRY'\r\n    };\r\n}\r\n\r\n/** Check and trigger first well lore */\r\nexport function checkFirstWellLore(loreSeen: LoreSeen): { \r\n    shouldShow: boolean; \r\n    eventId: LoreEventId \r\n} {\r\n    return {\r\n        shouldShow: !hasSeenLore(loreSeen, 'FIRST_WELL'),\r\n        eventId: 'FIRST_WELL'\r\n    };\r\n}\r\n\r\n/** Check and trigger first settlement lore */\r\nexport function checkFirstSettlementLore(loreSeen: LoreSeen): { \r\n    shouldShow: boolean; \r\n    eventId: LoreEventId \r\n} {\r\n    return {\r\n        shouldShow: !hasSeenLore(loreSeen, 'FIRST_SETTLEMENT'),\r\n        eventId: 'FIRST_SETTLEMENT'\r\n    };\r\n}\r\n\r\n/** Check and trigger game start lore */\r\nexport function checkGameStartLore(\r\n    loreSeen: LoreSeen, \r\n    year: number\r\n): { \r\n    shouldShow: boolean; \r\n    eventId: LoreEventId \r\n} {\r\n    return {\r\n        shouldShow: !hasSeenLore(loreSeen, 'GAME_START') && year === 0,\r\n        eventId: 'GAME_START'\r\n    };\r\n}\r\n\r\n/** Check and trigger flood warning lore */\r\nexport function checkFloodWarningLore(loreSeen: LoreSeen): { \r\n    shouldShow: boolean; \r\n    eventId: LoreEventId \r\n} {\r\n    return {\r\n        shouldShow: !hasSeenLore(loreSeen, 'FLOOD_WARNING'),\r\n        eventId: 'FLOOD_WARNING'\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// ILLUSTRATION HELPERS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Get all illustration types */\r\nexport function getAllIllustrations(): LoreIllustration[] {\r\n    return [\r\n        'wanderer', 'well', 'hut', 'hunting', 'road',\r\n        'hunt_success', 'settlement', 'storage', 'trading',\r\n        'nomad', 'turtle', 'flood', 'berry'\r\n    ];\r\n}\r\n\r\n/** Check if illustration type is valid */\r\nexport function isValidIllustration(type: string): type is LoreIllustration {\r\n    return getAllIllustrations().includes(type as LoreIllustration);\r\n}\r\n","/**\r\n * Civil Zones - Flooding System\r\n * Sea level changes and flood mechanics\r\n */\r\n\r\nimport type { \r\n    FloodResult, \r\n    FloodedBuilding, \r\n    GeologyState,\r\n    SeaLevelConfig \r\n} from './types.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// INTERFACES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\ninterface TileLike {\r\n    type: string;\r\n    originalType?: string;\r\n    elevation: number;\r\n    building?: { type?: string; pop?: number } | null;\r\n    zone?: string | null;\r\n    bld?: any;\r\n    tree?: boolean;\r\n    road?: boolean;\r\n    stoneDeposit?: any;\r\n    berry?: boolean;\r\n}\r\n\r\ninterface BuildingLike {\r\n    t: string;          // Type: 'WELL', 'COM', 'IND', 'RES'\r\n    x: number;\r\n    y: number;\r\n    pop?: number;\r\n}\r\n\r\ninterface PlayerLike {\r\n    x: number;\r\n    y: number;\r\n}\r\n\r\ninterface ConfigLike {\r\n    W: number;\r\n    H: number;\r\n    SEA_LEVEL_MIN?: number;\r\n    SEA_LEVEL_MAX?: number;\r\n    FLOOD_WARNING_MARGIN?: number;\r\n}\r\n\r\ninterface GameLike {\r\n    tiles: TileLike[][];\r\n    blds: BuildingLike[];\r\n    player: PlayerLike;\r\n    pop: number;\r\n    geology: GeologyState;\r\n    wellCount?: number;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// DEFAULT CONFIGURATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Default sea level configuration */\r\nexport const DEFAULT_SEA_LEVEL_CONFIG: SeaLevelConfig = {\r\n    SEA_LEVEL_MIN: 1.0,\r\n    SEA_LEVEL_MAX: 6.0,\r\n    FLOOD_WARNING_MARGIN: 1\r\n};\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// SEA LEVEL HELPERS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Get building size (1x1 or 2x2) */\r\nfunction getBuildingSize(buildingType: string): number {\r\n    if (buildingType === 'WELL' || buildingType === 'COM' || buildingType === 'IND') {\r\n        return 1;\r\n    }\r\n    return 2; // RES and other buildings are 2x2\r\n}\r\n\r\n/** Check if a position is within a building's footprint */\r\nfunction isWithinBuilding(\r\n    x: number, \r\n    y: number, \r\n    building: BuildingLike\r\n): boolean {\r\n    const size = getBuildingSize(building.t);\r\n    return x >= building.x && \r\n           x < building.x + size && \r\n           y >= building.y && \r\n           y < building.y + size;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// FLOOD RISK ASSESSMENT\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Check if a tile is at flood risk */\r\nexport function isFloodRisk(\r\n    elevation: number,\r\n    currentSeaLevel: number,\r\n    warningMargin: number = DEFAULT_SEA_LEVEL_CONFIG.FLOOD_WARNING_MARGIN\r\n): 'safe' | 'warning' | 'danger' | 'flooding' {\r\n    const diff = elevation - currentSeaLevel;\r\n    \r\n    if (diff < 0) return 'flooding';          // Already underwater\r\n    if (diff <= warningMargin) return 'danger';  // Will flood soon\r\n    if (diff <= warningMargin * 2) return 'warning'; // Could flood\r\n    return 'safe';\r\n}\r\n\r\n/** Get elevation difference from sea level */\r\nexport function getElevationDiff(\r\n    elevation: number,\r\n    seaLevel: number\r\n): number {\r\n    return elevation - seaLevel;\r\n}\r\n\r\n/** Format elevation safety message */\r\nexport function formatElevationMessage(\r\n    elevation: number,\r\n    seaLevel: number\r\n): string {\r\n    const diff = getElevationDiff(elevation, seaLevel);\r\n    if (diff < 0) {\r\n        return 'FLOODING!';\r\n    }\r\n    return `+${diff.toFixed(1)} safe`;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// FLOOD PROCESSING\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Apply sea level change and process flooding */\r\nexport function applySeaLevelChange(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    markDirty?: (x: number, y: number, radius: number) => void\r\n): FloodResult {\r\n    const seaLevel = game.geology.currentSeaLevel;\r\n    let flooded = 0;\r\n    let drained = 0;\r\n    const buildingsLost: FloodedBuilding[] = [];\r\n    let populationDrowned = 0;\r\n    let wellsLost = 0;\r\n    const bldsToRemove: number[] = [];\r\n    let playerDrowned = false;\r\n    \r\n    for (let x = 0; x < config.W; x++) {\r\n        for (let y = 0; y < config.H; y++) {\r\n            const tile = game.tiles[x][y];\r\n            \r\n            // Skip tiles that are always water (deep ocean) or always land (mountains)\r\n            if (tile.elevation <= 0 || tile.elevation >= 8) continue;\r\n            \r\n            // Check if tile should be underwater at current sea level\r\n            // FRACTIONAL comparison means tiles flood gradually, not all at once!\r\n            if (tile.elevation < seaLevel && tile.type !== 'WATER' && tile.type !== 'DEEP') {\r\n                // FLOOD THIS TILE - DESTROY ALL STRUCTURES\r\n                \r\n                // Check for tile-based buildings first - KILL POPULATION IMMEDIATELY\r\n                if (tile.building || tile.zone) {\r\n                    if (tile.building && tile.building.pop) {\r\n                        populationDrowned += tile.building.pop;\r\n                    }\r\n                    buildingsLost.push({\r\n                        x, \r\n                        y, \r\n                        type: tile.building?.type || tile.zone || 'unknown',\r\n                        pop: tile.building?.pop || 0\r\n                    });\r\n                }\r\n                \r\n                // Check for blds array buildings at this location\r\n                if (game.blds) {\r\n                    for (let i = 0; i < game.blds.length; i++) {\r\n                        const b = game.blds[i];\r\n                        if (isWithinBuilding(x, y, b)) {\r\n                            if (!bldsToRemove.includes(i)) {\r\n                                bldsToRemove.push(i);\r\n                                if (b.t === 'WELL') wellsLost++;\r\n                                if (b.t === 'RES' && b.pop) {\r\n                                    populationDrowned += b.pop;\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                \r\n                // Check if player is on this tile - instant death!\r\n                if (game.player && game.player.x === x && game.player.y === y) {\r\n                    populationDrowned += game.pop;\r\n                    playerDrowned = true;\r\n                }\r\n                \r\n                // DESTROY ALL STRUCTURES ON THIS TILE\r\n                tile.type = 'WATER';\r\n                tile.tree = false;\r\n                tile.road = false;\r\n                tile.building = null;\r\n                tile.zone = null;\r\n                tile.bld = null;\r\n                tile.stoneDeposit = null;\r\n                tile.berry = false;\r\n                flooded++;\r\n                \r\n                if (markDirty) markDirty(x, y, 1);\r\n            } \r\n            else if (tile.elevation >= seaLevel && (tile.type === 'WATER' || tile.type === 'DEEP')) {\r\n                // DRAIN THIS TILE (was water, now above sea level)\r\n                // Only drain shallow water tiles (not deep ocean which has elevation 0-1)\r\n                if (tile.elevation > 1) {\r\n                    tile.type = tile.originalType || 'SAND';\r\n                    drained++;\r\n                    if (markDirty) markDirty(x, y, 1);\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Remove flooded buildings from blds array (in reverse order to maintain indices)\r\n    if (bldsToRemove.length > 0) {\r\n        bldsToRemove.sort((a, b) => b - a);\r\n        for (const idx of bldsToRemove) {\r\n            const removedBld = game.blds[idx];\r\n            buildingsLost.push({\r\n                x: removedBld.x, \r\n                y: removedBld.y, \r\n                type: removedBld.t\r\n            });\r\n            game.blds.splice(idx, 1);\r\n        }\r\n    }\r\n    \r\n    return {\r\n        flooded,\r\n        drained,\r\n        buildingsLost,\r\n        populationDrowned,\r\n        wellsLost,\r\n        playerDrowned\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// FLOOD MESSAGE GENERATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Generate flood catastrophe message */\r\nexport function generateFloodMessage(\r\n    populationDrowned: number,\r\n    periodName: string\r\n): { message: string; duration: number; severity: 'catastrophe' | 'severe' | 'minor' } {\r\n    if (populationDrowned > 100) {\r\n        return {\r\n            message: `ğŸ“° CATASTROPHE! ${populationDrowned} perished in the great flood! The ${periodName} brought destruction. Where you build matters...`,\r\n            duration: 8000,\r\n            severity: 'catastrophe'\r\n        };\r\n    } else if (populationDrowned > 20) {\r\n        return {\r\n            message: `ğŸŒŠğŸ’€ ${populationDrowned} drowned in rising waters! Some areas may be safer than others...`,\r\n            duration: 6000,\r\n            severity: 'severe'\r\n        };\r\n    } else {\r\n        return {\r\n            message: `ğŸŒŠ ${populationDrowned} lost to rising waters. Perhaps higher ground would be wiser...`,\r\n            duration: 5000,\r\n            severity: 'minor'\r\n        };\r\n    }\r\n}\r\n\r\n/** Generate wells lost message */\r\nexport function generateWellsLostMessage(wellsLost: number): string {\r\n    return `ğŸ’§ğŸŒŠ ${wellsLost} well${wellsLost > 1 ? 's' : ''} swallowed by the sea!`;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// SEA LEVEL UPDATES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Update sea level toward target */\r\nexport function updateSeaLevel(\r\n    currentLevel: number,\r\n    targetLevel: number,\r\n    riseRate: number = 0.1,\r\n    fallRate: number = 0.1,\r\n    config: SeaLevelConfig = DEFAULT_SEA_LEVEL_CONFIG\r\n): number {\r\n    if (currentLevel < targetLevel) {\r\n        // Water rising\r\n        return Math.min(config.SEA_LEVEL_MAX, currentLevel + riseRate);\r\n    } else if (currentLevel > targetLevel) {\r\n        // Water receding\r\n        return Math.max(config.SEA_LEVEL_MIN, currentLevel - fallRate);\r\n    }\r\n    return currentLevel;\r\n}\r\n\r\n/** Check if sea level is rising */\r\nexport function isSeaLevelRising(\r\n    currentLevel: number,\r\n    targetLevel: number\r\n): boolean {\r\n    return currentLevel < targetLevel;\r\n}\r\n\r\n/** Get sea level change direction */\r\nexport function getSeaLevelDirection(\r\n    currentLevel: number,\r\n    targetLevel: number\r\n): 'rising' | 'falling' | 'stable' {\r\n    if (currentLevel < targetLevel) return 'rising';\r\n    if (currentLevel > targetLevel) return 'falling';\r\n    return 'stable';\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// FLOOD STATISTICS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Update geology stats after flooding */\r\nexport function updateGeologyStats(\r\n    geology: GeologyState,\r\n    result: FloodResult\r\n): GeologyState {\r\n    return {\r\n        ...geology,\r\n        tilesFlooded: geology.tilesFlooded + result.flooded,\r\n        tilesDrained: geology.tilesDrained + result.drained,\r\n        populationDrowned: geology.populationDrowned + result.populationDrowned\r\n    };\r\n}\r\n\r\n/** Create initial geology state */\r\nexport function createInitialGeologyState(\r\n    initialSeaLevel: number = DEFAULT_SEA_LEVEL_CONFIG.SEA_LEVEL_MIN\r\n): GeologyState {\r\n    return {\r\n        currentSeaLevel: initialSeaLevel,\r\n        tilesFlooded: 0,\r\n        tilesDrained: 0,\r\n        populationDrowned: 0\r\n    };\r\n}\r\n","/**\r\n * Civil Zones - World Generation Types\r\n * Type definitions for terrain, tiles, and world creation\r\n */\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TERRAIN TYPES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** All terrain types in the game */\r\nexport type WorldTerrainType = \r\n    | 'GRASS' \r\n    | 'FOREST' \r\n    | 'SAND' \r\n    | 'WATER' \r\n    | 'DEEP' \r\n    | 'RIVER' \r\n    | 'STONE' \r\n    | 'ROCK' \r\n    | 'SNOW';\r\n\r\n/** Terrain that entities can spawn on */\r\nexport type SpawnableTerrain = 'GRASS' | 'FOREST' | 'SAND' | 'ROCK' | 'SNOW';\r\n\r\n/** Terrain that blocks player movement */\r\nexport type ImpassableTerrain = 'WATER' | 'DEEP' | 'STONE';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TILE TYPES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Resource deposit on a tile */\r\nexport interface TileResource {\r\n    type: 'STONE';\r\n    amount: number;\r\n    metal_yield: number;\r\n}\r\n\r\n/** Stone deposit (Mario-style rock with metal) */\r\nexport interface StoneDeposit {\r\n    metal: number;\r\n}\r\n\r\n/** Entity data on a tile */\r\nexport interface WorldTileEntity {\r\n    type: 'BERRY' | 'NOMAD' | 'WOLF';\r\n    [key: string]: any;\r\n}\r\n\r\n/** Building data on a tile */\r\nexport interface TileBuilding {\r\n    type?: string;\r\n    pop?: number;\r\n    level?: number;\r\n    growth?: number;\r\n    desirability?: number;\r\n}\r\n\r\n/** Complete tile data */\r\nexport interface WorldTile {\r\n    type: WorldTerrainType;\r\n    elevation: number;\r\n    originalType: WorldTerrainType;\r\n    road: boolean;\r\n    tree: boolean;\r\n    pol: number;                    // Pollution level\r\n    bld: any;                       // Legacy building reference\r\n    explored: boolean;\r\n    zone: 'R' | 'C' | 'I' | null;\r\n    building: TileBuilding | null;\r\n    resource: TileResource | null;\r\n    stoneDeposit: StoneDeposit | null;\r\n    entity: WorldTileEntity | null;\r\n    berry?: boolean;                // Legacy berry flag\r\n    nomad?: boolean;                // Legacy nomad flag\r\n    isPoison?: boolean;             // Berry poison flag\r\n    isHostile?: boolean;            // Nomad hostile flag\r\n    carriedFood?: number;           // Nomad carried food\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// GENERATION CONFIG\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** World size configuration */\r\nexport interface WorldSizeConfig {\r\n    W: number;                      // Width in tiles\r\n    H: number;                      // Height in tiles\r\n    TILE: number;                   // Tile size in pixels\r\n}\r\n\r\n/** Elevation system configuration */\r\nexport interface ElevationConfig {\r\n    SEA_LEVEL_BASE: number;         // Starting sea level\r\n    SEA_LEVEL_MIN: number;          // Minimum sea level\r\n    SEA_LEVEL_MAX: number;          // Maximum sea level\r\n}\r\n\r\n/** High ground patch */\r\nexport interface HighGroundPatch {\r\n    x: number;\r\n    y: number;\r\n}\r\n\r\n/** Terrain generation options */\r\nexport interface TerrainGenOptions {\r\n    seed: number;\r\n    width: number;\r\n    height: number;\r\n    seaLevel: number;\r\n    highGroundPatches?: HighGroundPatch[];\r\n    patchSize?: number;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// PLAYER SPAWN\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Player spawn position result */\r\nexport interface SpawnResult {\r\n    x: number;\r\n    y: number;\r\n    method: 'center' | 'wide' | 'emergency' | 'forced';\r\n    reachable: number;\r\n}\r\n\r\n/** Player entity */\r\nexport interface PlayerEntity {\r\n    x: number;\r\n    y: number;\r\n    health: number;\r\n    direction: 'up' | 'down' | 'left' | 'right';\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// NOISE CONFIG\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Noise generation parameters */\r\nexport interface NoiseParams {\r\n    frequency: number;\r\n    octaves?: number;\r\n    offsetX?: number;\r\n    offsetY?: number;\r\n}\r\n\r\n/** Default noise parameters for terrain features */\r\nexport const DEFAULT_NOISE_PARAMS = {\r\n    terrain: { frequency: 0.02, octaves: 5 },\r\n    ocean: { frequency: 0.008, octaves: 5 },\r\n    lake: { frequency: 0.08, octaves: 5, offsetX: 500, offsetY: 500 },\r\n    mountain: { frequency: 0.015, octaves: 5, offsetX: 1000, offsetY: 1000 },\r\n    river: { frequency: 0.05, octaves: 5, offsetX: 100, offsetY: 100 }\r\n};\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// WORLD GENERATION DEFAULTS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Default world generation configuration */\r\nexport const DEFAULT_WORLD_CONFIG = {\r\n    PATCH_SIZE: 8,                  // High ground patch size\r\n    PATCHES_PER_AREA: 2500,         // ~1 patch per 50x50 area\r\n    ELEVATION_BIAS: 2.5,            // Upward terrain bias\r\n    RIVER_WIDTH: 0.015,             // River threshold\r\n    MOUNTAIN_THRESHOLD: 0.68,       // Mountain noise threshold\r\n    MOUNTAIN_HEIGHT_MIN: 0.55,      // Minimum height for mountains\r\n    LAKE_THRESHOLD: 0.03,           // Lake noise threshold (very rare)\r\n    TREE_CHANCE: 0.2                // Tree spawn chance on valid terrain\r\n};\r\n","/**\r\n * Civil Zones - Noise Generation\r\n * Perlin-style noise for terrain generation\r\n */\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// NOISE STATE\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Noise generator state */\r\ninterface NoiseState {\r\n    seed: number;\r\n}\r\n\r\n/** Global noise state */\r\nconst state: NoiseState = {\r\n    seed: 1\r\n};\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// CORE NOISE FUNCTIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Initialize noise with a seed */\r\nexport function initNoise(seed: number): void {\r\n    state.seed = seed;\r\n}\r\n\r\n/** Get current seed */\r\nexport function getSeed(): number {\r\n    return state.seed;\r\n}\r\n\r\n/** Hash function for noise generation */\r\nexport function hash(x: number, y: number): number {\r\n    const h = Math.sin(x * 12.98 + y * 78.23 + state.seed) * 43758.54;\r\n    return h - Math.floor(h);\r\n}\r\n\r\n/** Linear interpolation */\r\nexport function mix(a: number, b: number, t: number): number {\r\n    return a * (1 - t) + b * t;\r\n}\r\n\r\n/** Value noise at a point */\r\nexport function valueNoise(x: number, y: number): number {\r\n    const i = Math.floor(x);\r\n    const j = Math.floor(y);\r\n    const fx = x - i;\r\n    const fy = y - j;\r\n    \r\n    // Smoothstep interpolation\r\n    const ux = fx * fx * (3 - 2 * fx);\r\n    const uy = fy * fy * (3 - 2 * fy);\r\n    \r\n    // Get corner values\r\n    const a = hash(i, j);\r\n    const b = hash(i + 1, j);\r\n    const c = hash(i, j + 1);\r\n    const d = hash(i + 1, j + 1);\r\n    \r\n    // Bilinear interpolation\r\n    return mix(mix(a, b, ux), mix(c, d, ux), uy);\r\n}\r\n\r\n/** Fractal Brownian Motion (multi-octave noise) */\r\nexport function fbm(x: number, y: number, octaves: number = 5): number {\r\n    let total = 0;\r\n    let amplitude = 0.5;\r\n    let px = x;\r\n    let py = y;\r\n    \r\n    for (let i = 0; i < octaves; i++) {\r\n        total += valueNoise(px, py) * amplitude;\r\n        px *= 2;\r\n        py *= 2;\r\n        amplitude *= 0.5;\r\n    }\r\n    \r\n    return total;\r\n}\r\n\r\n/** Normalized FBM (0-1 range) */\r\nexport function fbmNormalized(x: number, y: number, octaves: number = 5): number {\r\n    // FBM with 5 octaves produces values roughly in 0-1.8 range\r\n    return fbm(x, y, octaves) / 1.8;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TERRAIN-SPECIFIC NOISE\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Generate terrain height noise */\r\nexport function terrainNoise(x: number, y: number): number {\r\n    return fbmNormalized(x * 0.02, y * 0.02);\r\n}\r\n\r\n/** Generate ocean noise (large scale features) */\r\nexport function oceanNoise(x: number, y: number): number {\r\n    return fbmNormalized(x * 0.008, y * 0.008);\r\n}\r\n\r\n/** Generate lake noise (smaller inland bodies) */\r\nexport function lakeNoise(x: number, y: number): number {\r\n    return fbmNormalized(x * 0.08 + 500, y * 0.08 + 500);\r\n}\r\n\r\n/** Generate mountain noise */\r\nexport function mountainNoise(x: number, y: number): number {\r\n    return fbmNormalized(x * 0.015 + 1000, y * 0.015 + 1000);\r\n}\r\n\r\n/** Generate river noise */\r\nexport function riverNoise(x: number, y: number): number {\r\n    return fbmNormalized(x * 0.05 + 100, y * 0.05 + 100);\r\n}\r\n\r\n/** Check if position is a river based on noise */\r\nexport function isRiverAt(x: number, y: number, width: number = 0.015): boolean {\r\n    const r = riverNoise(x, y);\r\n    return Math.abs(r - 0.5) < width;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// UTILITY FUNCTIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Generate random seed */\r\nexport function randomSeed(): number {\r\n    return Math.floor(Math.random() * 1000000);\r\n}\r\n\r\n/** Create noise with custom parameters */\r\nexport function customNoise(\r\n    x: number, \r\n    y: number, \r\n    frequency: number,\r\n    octaves: number = 5,\r\n    offsetX: number = 0,\r\n    offsetY: number = 0\r\n): number {\r\n    return fbmNormalized(\r\n        (x + offsetX) * frequency, \r\n        (y + offsetY) * frequency, \r\n        octaves\r\n    );\r\n}\r\n","/**\r\n * Civil Zones - Terrain Generation\r\n * Generate terrain tiles with elevation and features\r\n */\r\n\r\nimport type { \r\n    WorldTile, \r\n    WorldTerrainType, \r\n    HighGroundPatch,\r\n    TerrainGenOptions,\r\n    TileResource\r\n} from './types.js';\r\nimport { \r\n    initNoise, \r\n    terrainNoise, \r\n    oceanNoise, \r\n    lakeNoise, \r\n    mountainNoise, \r\n    isRiverAt \r\n} from './noise.js';\r\nimport { DEFAULT_WORLD_CONFIG } from './types.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// HIGH GROUND PATCHES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Generate high ground patches for safe building zones */\r\nexport function generateHighGroundPatches(\r\n    width: number,\r\n    height: number,\r\n    patchSize: number = DEFAULT_WORLD_CONFIG.PATCH_SIZE,\r\n    patchesPerArea: number = DEFAULT_WORLD_CONFIG.PATCHES_PER_AREA\r\n): HighGroundPatch[] {\r\n    const patches: HighGroundPatch[] = [];\r\n    const numPatches = Math.floor((width * height) / patchesPerArea);\r\n    \r\n    for (let i = 0; i < numPatches; i++) {\r\n        // Random positions but avoid edges\r\n        const px = Math.floor(Math.random() * (width - patchSize - 10)) + 5;\r\n        const py = Math.floor(Math.random() * (height - patchSize - 10)) + 5;\r\n        patches.push({ x: px, y: py });\r\n    }\r\n    \r\n    return patches;\r\n}\r\n\r\n/** Check if position is within a high ground patch */\r\nexport function isInHighGroundPatch(\r\n    x: number, \r\n    y: number, \r\n    patches: HighGroundPatch[],\r\n    patchSize: number = DEFAULT_WORLD_CONFIG.PATCH_SIZE\r\n): boolean {\r\n    for (const patch of patches) {\r\n        if (x >= patch.x && x < patch.x + patchSize && \r\n            y >= patch.y && y < patch.y + patchSize) {\r\n            return true;\r\n        }\r\n    }\r\n    return false;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// ELEVATION CALCULATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Calculate elevation from height noise */\r\nexport function calculateElevation(\r\n    heightNoise: number,\r\n    bias: number = DEFAULT_WORLD_CONFIG.ELEVATION_BIAS\r\n): number {\r\n    // Convert height noise (0-1) to elevation (0-10) with upward bias\r\n    // bias of 2.5 means more land at higher elevations\r\n    let elevation = Math.round((heightNoise * 100 + bias * 10)) / 10;\r\n    return Math.min(10, Math.max(0, elevation));\r\n}\r\n\r\n/** Generate high ground elevation for patches */\r\nexport function generateHighGroundElevation(): number {\r\n    return 7 + Math.random() * 1.5; // 7.0 to 8.5 (always safe from flooding)\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TERRAIN TYPE DETERMINATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Determine terrain type from noise values */\r\nexport function determineTerrainType(\r\n    x: number,\r\n    y: number,\r\n    elevation: number,\r\n    seaLevel: number,\r\n    heightNoise: number,\r\n    isHighGround: boolean\r\n): { type: WorldTerrainType; elevation: number } {\r\n    const mtnNoise = mountainNoise(x, y);\r\n    const lkNoise = lakeNoise(x, y);\r\n    const isRiver = isRiverAt(x, y, DEFAULT_WORLD_CONFIG.RIVER_WIDTH);\r\n    \r\n    let type: WorldTerrainType = 'GRASS';\r\n    let finalElevation = elevation;\r\n    \r\n    // IMPASSABLE STONE MOUNTAINS (highest elevation)\r\n    if (mtnNoise > DEFAULT_WORLD_CONFIG.MOUNTAIN_THRESHOLD && \r\n        heightNoise > DEFAULT_WORLD_CONFIG.MOUNTAIN_HEIGHT_MIN) {\r\n        type = 'STONE';\r\n        finalElevation = 9 + Math.floor(Math.random() * 2); // 9-10\r\n    }\r\n    // ELEVATION-BASED WATER: Tiles below sea level are water\r\n    else if (elevation < seaLevel - 1.5) {\r\n        type = 'DEEP';\r\n        finalElevation = Math.max(0, elevation);\r\n    } \r\n    else if (elevation < seaLevel - 0.5) {\r\n        type = 'WATER';\r\n    }\r\n    // Generate inland lakes (very rare)\r\n    else if (lkNoise < DEFAULT_WORLD_CONFIG.LAKE_THRESHOLD && \r\n             elevation >= seaLevel && \r\n             elevation < seaLevel + 0.5 &&\r\n             !isHighGround) {\r\n        type = 'WATER';\r\n        finalElevation = seaLevel - 0.5;\r\n    }\r\n    // Standard elevation-based terrain\r\n    else if (elevation <= seaLevel) {\r\n        type = 'SAND'; // Beaches at sea level\r\n    } \r\n    else if (elevation < 5.5) {\r\n        type = 'GRASS'; // Lowland grass (3-5.5)\r\n    } \r\n    else if (elevation < 7) {\r\n        type = 'GRASS'; // Highland grass (5.5-7)\r\n    } \r\n    else if (elevation < 8) {\r\n        type = 'FOREST'; // Hills with forest (7-8)\r\n    } \r\n    else if (elevation < 9.5) {\r\n        type = 'ROCK'; // Mountain slopes (8-9.5)\r\n    } \r\n    else {\r\n        type = 'SNOW';\r\n    }\r\n    \r\n    // Carve Rivers (avoid deep ocean and high ground)\r\n    if (isRiver && type !== 'DEEP' && type !== 'WATER' && !isHighGround) {\r\n        type = 'RIVER';\r\n        finalElevation = seaLevel;\r\n    }\r\n    \r\n    return { type, elevation: finalElevation };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TILE GENERATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Create a single tile with all data */\r\nexport function createTile(\r\n    x: number,\r\n    y: number,\r\n    seaLevel: number,\r\n    patches: HighGroundPatch[]\r\n): WorldTile {\r\n    const heightNoise = terrainNoise(x, y);\r\n    const isHighGround = isInHighGroundPatch(x, y, patches);\r\n    \r\n    // Calculate base elevation\r\n    let elevation = calculateElevation(heightNoise);\r\n    \r\n    // Force high elevation in safe patches\r\n    if (isHighGround) {\r\n        elevation = generateHighGroundElevation();\r\n    }\r\n    \r\n    // Determine terrain type\r\n    const terrain = determineTerrainType(\r\n        x, y, elevation, seaLevel, heightNoise, isHighGround\r\n    );\r\n    \r\n    // Determine if tile has a tree\r\n    const canHaveTree = terrain.type === 'GRASS' || \r\n                        terrain.type === 'FOREST' || \r\n                        terrain.type === 'SNOW';\r\n    const hasTree = canHaveTree && Math.random() > (1 - DEFAULT_WORLD_CONFIG.TREE_CHANCE);\r\n    \r\n    // Create resource for STONE tiles\r\n    let resource: TileResource | null = null;\r\n    if (terrain.type === 'STONE') {\r\n        resource = {\r\n            type: 'STONE',\r\n            amount: 1000000 + Math.floor(Math.random() * 500000), // 1M-1.5M stone\r\n            metal_yield: 0.2\r\n        };\r\n    }\r\n    \r\n    return {\r\n        type: terrain.type,\r\n        elevation: terrain.elevation,\r\n        originalType: terrain.type,\r\n        road: false,\r\n        tree: hasTree,\r\n        pol: 0,\r\n        bld: null,\r\n        explored: false,\r\n        zone: null,\r\n        building: null,\r\n        resource,\r\n        stoneDeposit: null,\r\n        entity: null\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// WORLD GENERATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Generate complete tile grid */\r\nexport function generateTerrain(options: TerrainGenOptions): WorldTile[][] {\r\n    const { seed, width, height, seaLevel, highGroundPatches, patchSize } = options;\r\n    \r\n    // Initialize noise\r\n    initNoise(seed);\r\n    \r\n    // Generate high ground patches if not provided\r\n    const patches = highGroundPatches || generateHighGroundPatches(\r\n        width, \r\n        height, \r\n        patchSize || DEFAULT_WORLD_CONFIG.PATCH_SIZE\r\n    );\r\n    \r\n    // Create tile grid\r\n    const tiles: WorldTile[][] = [];\r\n    \r\n    for (let x = 0; x < width; x++) {\r\n        tiles[x] = [];\r\n        for (let y = 0; y < height; y++) {\r\n            tiles[x][y] = createTile(x, y, seaLevel, patches);\r\n        }\r\n    }\r\n    \r\n    return tiles;\r\n}\r\n\r\n/** Get terrain statistics for a generated world */\r\nexport function getTerrainStats(tiles: WorldTile[][]): Record<WorldTerrainType, number> {\r\n    const stats: Partial<Record<WorldTerrainType, number>> = {};\r\n    \r\n    for (let x = 0; x < tiles.length; x++) {\r\n        for (let y = 0; y < tiles[x].length; y++) {\r\n            const type = tiles[x][y].type;\r\n            stats[type] = (stats[type] || 0) + 1;\r\n        }\r\n    }\r\n    \r\n    return stats as Record<WorldTerrainType, number>;\r\n}\r\n\r\n/** Calculate percentage of land vs water */\r\nexport function getLandWaterRatio(tiles: WorldTile[][]): { land: number; water: number } {\r\n    let land = 0;\r\n    let water = 0;\r\n    \r\n    for (let x = 0; x < tiles.length; x++) {\r\n        for (let y = 0; y < tiles[x].length; y++) {\r\n            const type = tiles[x][y].type;\r\n            if (type === 'WATER' || type === 'DEEP' || type === 'RIVER') {\r\n                water++;\r\n            } else {\r\n                land++;\r\n            }\r\n        }\r\n    }\r\n    \r\n    const total = land + water;\r\n    return {\r\n        land: Math.round((land / total) * 100),\r\n        water: Math.round((water / total) * 100)\r\n    };\r\n}\r\n","/**\r\n * Civil Zones - Player Spawning\r\n * Find safe spawn locations for the player\r\n */\r\n\r\nimport type { \r\n    WorldTile, \r\n    SpawnResult, \r\n    PlayerEntity,\r\n    SpawnableTerrain \r\n} from './types.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// SPAWN VALIDATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Valid terrain types for player spawning */\r\nconst VALID_SPAWN_TERRAIN: SpawnableTerrain[] = ['GRASS', 'FOREST', 'SAND', 'ROCK', 'SNOW'];\r\n\r\n/** Valid terrain types for flood fill counting */\r\nconst REACHABLE_TERRAIN: SpawnableTerrain[] = ['GRASS', 'FOREST', 'SAND'];\r\n\r\n/** Check if a position is valid for spawning */\r\nexport function isValidSpawnPosition(\r\n    tiles: WorldTile[][],\r\n    x: number,\r\n    y: number\r\n): boolean {\r\n    if (x < 0 || x >= tiles.length || y < 0 || y >= tiles[0].length) {\r\n        return false;\r\n    }\r\n    const type = tiles[x][y].type;\r\n    return VALID_SPAWN_TERRAIN.includes(type as SpawnableTerrain);\r\n}\r\n\r\n/** Check if terrain is reachable for flood fill */\r\nfunction isReachableTerrain(type: string): boolean {\r\n    return REACHABLE_TERRAIN.includes(type as SpawnableTerrain);\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// FLOOD FILL COUNTING\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Count reachable land tiles from a position using flood fill */\r\nexport function countReachableTiles(\r\n    tiles: WorldTile[][],\r\n    startX: number,\r\n    startY: number,\r\n    maxTiles: number = 200\r\n): number {\r\n    const W = tiles.length;\r\n    const H = tiles[0].length;\r\n    const seen: boolean[][] = Array.from({ length: W }, () => Array(H).fill(false));\r\n    const queue: [number, number][] = [[startX, startY]];\r\n    let count = 0;\r\n    \r\n    while (queue.length > 0 && count < maxTiles) {\r\n        const [cx, cy] = queue.shift()!;\r\n        \r\n        if (cx < 0 || cy < 0 || cx >= W || cy >= H) continue;\r\n        if (seen[cx][cy]) continue;\r\n        \r\n        const type = tiles[cx][cy].type;\r\n        if (!isReachableTerrain(type)) continue;\r\n        \r\n        seen[cx][cy] = true;\r\n        count++;\r\n        \r\n        // Add neighbors\r\n        queue.push([cx + 1, cy]);\r\n        queue.push([cx - 1, cy]);\r\n        queue.push([cx, cy + 1]);\r\n        queue.push([cx, cy - 1]);\r\n    }\r\n    \r\n    return count;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// SPAWN LOCATION FINDING\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Try to find spawn in center area */\r\nfunction findCenterSpawn(\r\n    tiles: WorldTile[][],\r\n    centerX: number,\r\n    centerY: number,\r\n    radius: number = 40,\r\n    minReachable: number = 60,\r\n    maxAttempts: number = 100\r\n): SpawnResult | null {\r\n    for (let attempt = 0; attempt < maxAttempts; attempt++) {\r\n        const x = Math.floor(centerX + (Math.random() - 0.5) * radius);\r\n        const y = Math.floor(centerY + (Math.random() - 0.5) * radius);\r\n        \r\n        if (isValidSpawnPosition(tiles, x, y)) {\r\n            const reachable = countReachableTiles(tiles, x, y, 200);\r\n            if (reachable >= minReachable) {\r\n                return { x, y, method: 'center', reachable };\r\n            }\r\n        }\r\n    }\r\n    return null;\r\n}\r\n\r\n/** Try to find spawn anywhere on map */\r\nfunction findWideSpawn(\r\n    tiles: WorldTile[][],\r\n    minReachable: number = 30,\r\n    maxAttempts: number = 500\r\n): SpawnResult | null {\r\n    const W = tiles.length;\r\n    const H = tiles[0].length;\r\n    \r\n    for (let attempt = 0; attempt < maxAttempts; attempt++) {\r\n        const x = Math.floor(Math.random() * W);\r\n        const y = Math.floor(Math.random() * H);\r\n        \r\n        if (isValidSpawnPosition(tiles, x, y)) {\r\n            const reachable = countReachableTiles(tiles, x, y, 200);\r\n            if (reachable >= minReachable) {\r\n                return { x, y, method: 'wide', reachable };\r\n            }\r\n        }\r\n    }\r\n    return null;\r\n}\r\n\r\n/** Emergency scan for ANY valid land tile */\r\nfunction findEmergencySpawn(tiles: WorldTile[][]): SpawnResult | null {\r\n    for (let x = 0; x < tiles.length; x++) {\r\n        for (let y = 0; y < tiles[0].length; y++) {\r\n            if (isValidSpawnPosition(tiles, x, y)) {\r\n                return { x, y, method: 'emergency', reachable: 1 };\r\n            }\r\n        }\r\n    }\r\n    return null;\r\n}\r\n\r\n/** Forced spawn at center (last resort) */\r\nfunction forceCenterSpawn(width: number, height: number): SpawnResult {\r\n    return {\r\n        x: Math.floor(width / 2),\r\n        y: Math.floor(height / 2),\r\n        method: 'forced',\r\n        reachable: 0\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// MAIN SPAWN FUNCTION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Find the best spawn location for player */\r\nexport function findSpawnLocation(tiles: WorldTile[][]): SpawnResult {\r\n    const W = tiles.length;\r\n    const H = tiles[0].length;\r\n    const centerX = Math.floor(W / 2);\r\n    const centerY = Math.floor(H / 2);\r\n    \r\n    // Phase 1: Try center area (best experience)\r\n    const centerSpawn = findCenterSpawn(tiles, centerX, centerY);\r\n    if (centerSpawn) {\r\n        console.log('âœ… Player spawn at', centerSpawn.x, centerSpawn.y, '(center search)');\r\n        return centerSpawn;\r\n    }\r\n    \r\n    // Phase 2: Try wider area\r\n    const wideSpawn = findWideSpawn(tiles);\r\n    if (wideSpawn) {\r\n        console.log('âœ… Player spawn at', wideSpawn.x, wideSpawn.y, '(wide search)');\r\n        return wideSpawn;\r\n    }\r\n    \r\n    // Phase 3: Emergency - scan entire map\r\n    console.warn('âš ï¸ Emergency spawn search...');\r\n    const emergencySpawn = findEmergencySpawn(tiles);\r\n    if (emergencySpawn) {\r\n        console.log('âœ… Player spawn at', emergencySpawn.x, emergencySpawn.y, '(emergency)');\r\n        return emergencySpawn;\r\n    }\r\n    \r\n    // Phase 4: Absolute last resort\r\n    console.error('âŒ No valid spawn found! Forcing center spawn.');\r\n    return forceCenterSpawn(W, H);\r\n}\r\n\r\n/** Create player entity at spawn location */\r\nexport function createPlayer(spawn: SpawnResult): PlayerEntity {\r\n    return {\r\n        x: spawn.x,\r\n        y: spawn.y,\r\n        health: 3,\r\n        direction: 'down'\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// EXPLORE AREA\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Mark tiles as explored in a radius */\r\nexport function exploreArea(\r\n    tiles: WorldTile[][],\r\n    centerX: number,\r\n    centerY: number,\r\n    radius: number\r\n): number {\r\n    let explored = 0;\r\n    const W = tiles.length;\r\n    const H = tiles[0].length;\r\n    \r\n    for (let dx = -radius; dx <= radius; dx++) {\r\n        for (let dy = -radius; dy <= radius; dy++) {\r\n            const x = centerX + dx;\r\n            const y = centerY + dy;\r\n            \r\n            if (x >= 0 && x < W && y >= 0 && y < H) {\r\n                if (!tiles[x][y].explored) {\r\n                    tiles[x][y].explored = true;\r\n                    explored++;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    return explored;\r\n}\r\n\r\n/** Check if tile is explored */\r\nexport function isTileExplored(tiles: WorldTile[][], x: number, y: number): boolean {\r\n    if (x < 0 || x >= tiles.length || y < 0 || y >= tiles[0].length) {\r\n        return false;\r\n    }\r\n    return tiles[x][y].explored;\r\n}\r\n\r\n/** Get count of explored tiles */\r\nexport function getExploredCount(tiles: WorldTile[][]): number {\r\n    let count = 0;\r\n    for (let x = 0; x < tiles.length; x++) {\r\n        for (let y = 0; y < tiles[x].length; y++) {\r\n            if (tiles[x][y].explored) count++;\r\n        }\r\n    }\r\n    return count;\r\n}\r\n","/**\r\n * Civil Zones - Time System Types\r\n * Type definitions for game time, turns, and year progression\r\n */\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TIME STATE\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Game time state */\r\nexport interface TimeState {\r\n    year: number;\r\n    age: number;              // Epoch/era (0 = Paleolithic, 1 = City)\r\n    paused: boolean;\r\n    speed: number;            // Game speed multiplier\r\n}\r\n\r\n/** Turn result */\r\nexport interface TurnResult {\r\n    year: number;\r\n    success: boolean;\r\n    events: TurnEvent[];\r\n    gameOver: boolean;\r\n    gameOverReason?: string;\r\n}\r\n\r\n/** Turn event that occurred */\r\nexport interface TurnEvent {\r\n    type: TurnEventType;\r\n    message: string;\r\n    value?: number;\r\n    severity: 'info' | 'warning' | 'danger' | 'success';\r\n}\r\n\r\n/** Types of events that can occur during a turn */\r\nexport type TurnEventType = \r\n    | 'YEAR_ADVANCE'\r\n    | 'FOOD_SPOILAGE'\r\n    | 'STARVATION'\r\n    | 'GROWTH'\r\n    | 'WATER_SHORTAGE'\r\n    | 'OVERCROWDING'\r\n    | 'PLAGUE'\r\n    | 'FLOOD'\r\n    | 'GEOLOGICAL'\r\n    | 'BUILDING_ABANDON'\r\n    | 'UPKEEP';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// PRODUCTION & CONSUMPTION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Resource production rates */\r\nexport interface ProductionRates {\r\n    foodPerPerson: number;\r\n    woodPerGatherer: number;\r\n    stonePerMiner: number;\r\n    metalPerSmelter: number;\r\n}\r\n\r\n/** Resource consumption rates */\r\nexport interface ConsumptionRates {\r\n    foodPerPerson: number;\r\n    woodUpkeepPerBuilding: number;\r\n}\r\n\r\n/** Spoilage/rot rates */\r\nexport interface SpoilageRates {\r\n    food: number;           // Default 0.20 (20%)\r\n    foodWithStorage: number; // 0.10 with Nuts Storage\r\n    wood: number;           // 0.10 (10%)\r\n    stone: number;          // 0.05 (5%)\r\n    metal: number;          // 0.03 (3%)\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// POPULATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Population change result */\r\nexport interface PopulationChange {\r\n    growth: number;\r\n    deaths: number;\r\n    births: number;\r\n    net: number;\r\n    reason?: string;\r\n}\r\n\r\n/** Death causes */\r\nexport type DeathCause = \r\n    | 'STARVATION'\r\n    | 'DEHYDRATION'\r\n    | 'PLAGUE'\r\n    | 'FLOOD'\r\n    | 'EXPOSURE'\r\n    | 'OVERCROWDING';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// GAME OVER\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Game over reasons */\r\nexport type GameOverReason = \r\n    | 'NO_FOOD'\r\n    | 'NO_WATER'\r\n    | 'NO_POPULATION'\r\n    | 'FLOOD'\r\n    | 'PLAGUE';\r\n\r\n/** Game over result */\r\nexport interface GameOverResult {\r\n    reason: GameOverReason;\r\n    year: number;\r\n    peakPopulation: number;\r\n    finalPopulation: number;\r\n    message: string;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// CONFIGURATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Time system configuration */\r\nexport interface TimeConfig {\r\n    startYear: number;\r\n    startAge: number;\r\n    yearsPerGeologicalUpdate: number;\r\n}\r\n\r\n/** Default time configuration */\r\nexport const DEFAULT_TIME_CONFIG: TimeConfig = {\r\n    startYear: 0,\r\n    startAge: 0,\r\n    yearsPerGeologicalUpdate: 100\r\n};\r\n\r\n/** Default spoilage rates */\r\nexport const DEFAULT_SPOILAGE_RATES: SpoilageRates = {\r\n    food: 0.20,\r\n    foodWithStorage: 0.10,\r\n    wood: 0.10,\r\n    stone: 0.05,\r\n    metal: 0.03\r\n};\r\n\r\n/** Default population constants */\r\nexport const DEFAULT_POPULATION_CONFIG = {\r\n    GROWTH_RATE: 0.05,           // 5% growth when well-fed\r\n    STARVATION_DEATH_RATE: 0.20, // 20% die when starving\r\n    EXPOSURE_DEATH_RATE: 0.15,   // 15% homeless die per year\r\n    PLAGUE_DEATH_RATE: 0.30,     // 30% die in plague\r\n    PLAGUE_CHANCE_MULTIPLIER: 2, // 2x homeless % = plague chance\r\n    DEHYDRATION_DEATH_RATE: 0.20, // 20% without water die\r\n    WATER_PER_WELL: 100          // Each well supports 100 people\r\n};\r\n","/**\r\n * Civil Zones - Turn Processing\r\n * Year advancement and turn resolution\r\n */\r\n\r\nimport type { \r\n    TimeState, \r\n    TurnResult, \r\n    TurnEvent,\r\n    TurnEventType,\r\n    PopulationChange,\r\n    GameOverReason \r\n} from './types.js';\r\nimport { DEFAULT_TIME_CONFIG } from './types.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TIME STATE MANAGEMENT\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Create initial time state */\r\nexport function createTimeState(\r\n    startYear: number = DEFAULT_TIME_CONFIG.startYear,\r\n    startAge: number = DEFAULT_TIME_CONFIG.startAge\r\n): TimeState {\r\n    return {\r\n        year: startYear,\r\n        age: startAge,\r\n        paused: false,\r\n        speed: 1\r\n    };\r\n}\r\n\r\n/** Advance year by one */\r\nexport function advanceYear(state: TimeState): TimeState {\r\n    return {\r\n        ...state,\r\n        year: state.year + 1\r\n    };\r\n}\r\n\r\n/** Set game age/epoch */\r\nexport function setAge(state: TimeState, age: number): TimeState {\r\n    return {\r\n        ...state,\r\n        age\r\n    };\r\n}\r\n\r\n/** Toggle pause state */\r\nexport function togglePause(state: TimeState): TimeState {\r\n    return {\r\n        ...state,\r\n        paused: !state.paused\r\n    };\r\n}\r\n\r\n/** Set game speed */\r\nexport function setSpeed(state: TimeState, speed: number): TimeState {\r\n    return {\r\n        ...state,\r\n        speed: Math.max(0.1, Math.min(10, speed))\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TURN EVENT HELPERS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Create a turn event */\r\nexport function createTurnEvent(\r\n    type: TurnEventType,\r\n    message: string,\r\n    severity: TurnEvent['severity'] = 'info',\r\n    value?: number\r\n): TurnEvent {\r\n    return { type, message, severity, value };\r\n}\r\n\r\n/** Create year advance event */\r\nexport function yearAdvanceEvent(year: number): TurnEvent {\r\n    return createTurnEvent(\r\n        'YEAR_ADVANCE',\r\n        `Year ${year}`,\r\n        'info',\r\n        year\r\n    );\r\n}\r\n\r\n/** Create food spoilage event */\r\nexport function foodSpoilageEvent(amount: number, hasStorage: boolean): TurnEvent {\r\n    const msg = hasStorage \r\n        ? `ğŸ‚ ${amount} food rotted! (10% rate with storage)`\r\n        : `ğŸ‚ ${amount} food rotted! Need storage buildings!`;\r\n    return createTurnEvent('FOOD_SPOILAGE', msg, 'warning', amount);\r\n}\r\n\r\n/** Create starvation event */\r\nexport function starvationEvent(deaths: number): TurnEvent {\r\n    return createTurnEvent(\r\n        'STARVATION',\r\n        `ğŸ’€ FAMINE! ${deaths} people starved to death!`,\r\n        'danger',\r\n        deaths\r\n    );\r\n}\r\n\r\n/** Create growth event */\r\nexport function growthEvent(births: number): TurnEvent {\r\n    return createTurnEvent(\r\n        'GROWTH',\r\n        `ğŸ‘¶ ${births} new tribe members born!`,\r\n        'success',\r\n        births\r\n    );\r\n}\r\n\r\n/** Create water shortage event */\r\nexport function waterShortageEvent(deaths: number, wells: number, capacity: number, pop: number): TurnEvent {\r\n    return createTurnEvent(\r\n        'WATER_SHORTAGE',\r\n        `ğŸ’§ Water shortage! ${deaths} died. Have ${wells} wells (${capacity} capacity), pop: ${pop}`,\r\n        'danger',\r\n        deaths\r\n    );\r\n}\r\n\r\n/** Create overcrowding event */\r\nexport function overcrowdingEvent(homeless: number, deaths: number, foodStolen: number): TurnEvent {\r\n    return createTurnEvent(\r\n        'OVERCROWDING',\r\n        `ğŸšï¸ OVERCROWDED! ${homeless} homeless: -${deaths} died, -${foodStolen} food stolen!`,\r\n        'warning',\r\n        deaths\r\n    );\r\n}\r\n\r\n/** Create plague event */\r\nexport function plagueEvent(deaths: number, economicLoss: number): TurnEvent {\r\n    return createTurnEvent(\r\n        'PLAGUE',\r\n        `â˜ ï¸ PLAGUE OUTBREAK! ${deaths} dead! Economy Collapsed!`,\r\n        'danger',\r\n        deaths\r\n    );\r\n}\r\n\r\n/** Create building abandon event */\r\nexport function buildingAbandonEvent(count: number): TurnEvent {\r\n    return createTurnEvent(\r\n        'BUILDING_ABANDON',\r\n        `ğŸ’€ ${count} settlement${count > 1 ? 's' : ''} abandoned due to neglect!`,\r\n        'warning',\r\n        count\r\n    );\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TURN RESULT HELPERS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Create successful turn result */\r\nexport function createTurnResult(\r\n    year: number,\r\n    events: TurnEvent[] = []\r\n): TurnResult {\r\n    return {\r\n        year,\r\n        success: true,\r\n        events,\r\n        gameOver: false\r\n    };\r\n}\r\n\r\n/** Create game over turn result */\r\nexport function createGameOverResult(\r\n    year: number,\r\n    reason: string,\r\n    events: TurnEvent[] = []\r\n): TurnResult {\r\n    return {\r\n        year,\r\n        success: false,\r\n        events,\r\n        gameOver: true,\r\n        gameOverReason: reason\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// POPULATION CALCULATIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Calculate population growth */\r\nexport function calculateGrowth(\r\n    currentPop: number,\r\n    housingCapacity: number,\r\n    food: number,\r\n    foodConsumed: number,\r\n    growthRate: number = 0.05\r\n): PopulationChange {\r\n    // Only grow if surplus food and under capacity\r\n    if (food <= foodConsumed * 1.5 || currentPop >= housingCapacity) {\r\n        return { growth: 0, deaths: 0, births: 0, net: 0 };\r\n    }\r\n    \r\n    const births = Math.max(1, Math.ceil(currentPop * growthRate));\r\n    const cappedBirths = Math.min(births, housingCapacity - currentPop);\r\n    \r\n    return {\r\n        growth: cappedBirths,\r\n        deaths: 0,\r\n        births: cappedBirths,\r\n        net: cappedBirths,\r\n        reason: 'Well-fed population'\r\n    };\r\n}\r\n\r\n/** Calculate starvation deaths */\r\nexport function calculateStarvation(\r\n    currentPop: number,\r\n    deathRate: number = 0.20\r\n): PopulationChange {\r\n    const deaths = Math.ceil(currentPop * deathRate);\r\n    return {\r\n        growth: 0,\r\n        deaths,\r\n        births: 0,\r\n        net: -deaths,\r\n        reason: 'Starvation'\r\n    };\r\n}\r\n\r\n/** Calculate water shortage deaths */\r\nexport function calculateDehydration(\r\n    currentPop: number,\r\n    waterCapacity: number,\r\n    deathRate: number = 0.20\r\n): PopulationChange {\r\n    const peopleWithoutWater = Math.max(0, currentPop - waterCapacity);\r\n    if (peopleWithoutWater === 0) {\r\n        return { growth: 0, deaths: 0, births: 0, net: 0 };\r\n    }\r\n    \r\n    const deaths = Math.ceil(peopleWithoutWater * deathRate);\r\n    return {\r\n        growth: 0,\r\n        deaths,\r\n        births: 0,\r\n        net: -deaths,\r\n        reason: 'Dehydration'\r\n    };\r\n}\r\n\r\n/** Calculate overcrowding effects */\r\nexport function calculateOvercrowding(\r\n    currentPop: number,\r\n    housingCapacity: number,\r\n    exposureRate: number = 0.15\r\n): PopulationChange {\r\n    const homeless = Math.max(0, currentPop - housingCapacity);\r\n    if (homeless === 0) {\r\n        return { growth: 0, deaths: 0, births: 0, net: 0 };\r\n    }\r\n    \r\n    const deaths = Math.ceil(homeless * exposureRate);\r\n    return {\r\n        growth: 0,\r\n        deaths,\r\n        births: 0,\r\n        net: -deaths,\r\n        reason: 'Exposure'\r\n    };\r\n}\r\n\r\n/** Calculate plague outbreak */\r\nexport function calculatePlague(\r\n    currentPop: number,\r\n    homeless: number,\r\n    plagueChanceMultiplier: number = 2,\r\n    plagueDeathRate: number = 0.30\r\n): { triggered: boolean; change: PopulationChange } {\r\n    const overcrowdingPct = homeless / currentPop;\r\n    const plagueChance = overcrowdingPct * plagueChanceMultiplier;\r\n    \r\n    if (Math.random() >= plagueChance) {\r\n        return { \r\n            triggered: false, \r\n            change: { growth: 0, deaths: 0, births: 0, net: 0 } \r\n        };\r\n    }\r\n    \r\n    const deaths = Math.ceil(currentPop * plagueDeathRate);\r\n    return {\r\n        triggered: true,\r\n        change: {\r\n            growth: 0,\r\n            deaths,\r\n            births: 0,\r\n            net: -deaths,\r\n            reason: 'Plague'\r\n        }\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// GAME OVER HELPERS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Get game over reason string */\r\nexport function getGameOverMessage(reason: GameOverReason): string {\r\n    switch (reason) {\r\n        case 'NO_FOOD':\r\n            return 'Your people starved to death!';\r\n        case 'NO_WATER':\r\n            return 'Your people died of thirst!';\r\n        case 'NO_POPULATION':\r\n            return 'Your civilization has perished!';\r\n        case 'FLOOD':\r\n            return 'Rising waters drowned your people!';\r\n        case 'PLAGUE':\r\n            return 'A great plague wiped out your people!';\r\n        default:\r\n            return 'Your civilization has ended.';\r\n    }\r\n}\r\n\r\n/** Check if game should end */\r\nexport function shouldGameEnd(\r\n    population: number,\r\n    food: number,\r\n    hasWater: boolean\r\n): { end: boolean; reason?: GameOverReason } {\r\n    if (population <= 0) {\r\n        return { end: true, reason: 'NO_POPULATION' };\r\n    }\r\n    if (food <= 0 && population > 0) {\r\n        return { end: true, reason: 'NO_FOOD' };\r\n    }\r\n    if (!hasWater && population > 0) {\r\n        return { end: true, reason: 'NO_WATER' };\r\n    }\r\n    return { end: false };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TIME FORMATTING\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Format year for display */\r\nexport function formatYear(year: number): string {\r\n    if (year < 0) {\r\n        return `${Math.abs(year)} BCE`;\r\n    }\r\n    return `Year ${year}`;\r\n}\r\n\r\n/** Get epoch name */\r\nexport function getEpochName(age: number): string {\r\n    switch (age) {\r\n        case 0: return 'Paleolithic';\r\n        case 1: return 'City Age';\r\n        case 2: return 'Industrial Age';\r\n        default: return `Age ${age}`;\r\n    }\r\n}\r\n\r\n/** Check if milestone year */\r\nexport function isMilestoneYear(year: number, interval: number = 10): boolean {\r\n    return year % interval === 0;\r\n}\r\n","/**\r\n * Civil Zones - Resource Spoilage\r\n * Food rot, wood decay, and resource degradation\r\n */\r\n\r\nimport type { SpoilageRates, TurnEvent } from './types.js';\r\nimport { DEFAULT_SPOILAGE_RATES } from './types.js';\r\nimport { createTurnEvent } from './turns.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// SPOILAGE CALCULATIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Calculate resource spoilage */\r\nexport function calculateSpoilage(\r\n    current: number,\r\n    capacity: number,\r\n    rate: number\r\n): { spoiled: number; remaining: number } {\r\n    if (current <= capacity) {\r\n        return { spoiled: 0, remaining: current };\r\n    }\r\n    \r\n    const excess = current - capacity;\r\n    const spoiled = Math.floor(excess * rate);\r\n    const remaining = Math.max(0, current - spoiled);\r\n    \r\n    return { spoiled, remaining };\r\n}\r\n\r\n/** Calculate food spoilage */\r\nexport function calculateFoodSpoilage(\r\n    food: number,\r\n    storageCapacity: number,\r\n    hasAdvancedStorage: boolean = false,\r\n    rates: SpoilageRates = DEFAULT_SPOILAGE_RATES\r\n): { spoiled: number; remaining: number; event?: TurnEvent } {\r\n    const rate = hasAdvancedStorage ? rates.foodWithStorage : rates.food;\r\n    const result = calculateSpoilage(food, storageCapacity, rate);\r\n    \r\n    // Only create event if significant spoilage\r\n    let event: TurnEvent | undefined;\r\n    if (result.spoiled > 100 && Math.random() < 0.3) {\r\n        event = createTurnEvent(\r\n            'FOOD_SPOILAGE',\r\n            hasAdvancedStorage \r\n                ? `ğŸ‚ ${result.spoiled} food rotted! (10% rate with Nuts Storage Reed House)`\r\n                : `ğŸ‚ ${result.spoiled} food rotted! Need storage buildings!`,\r\n            'warning',\r\n            result.spoiled\r\n        );\r\n    }\r\n    \r\n    return { ...result, event };\r\n}\r\n\r\n/** Calculate wood decay */\r\nexport function calculateWoodDecay(\r\n    wood: number,\r\n    storageCapacity: number,\r\n    rates: SpoilageRates = DEFAULT_SPOILAGE_RATES\r\n): { decayed: number; remaining: number; event?: TurnEvent } {\r\n    const result = calculateSpoilage(wood, storageCapacity, rates.wood);\r\n    \r\n    let event: TurnEvent | undefined;\r\n    if (result.spoiled > 50 && Math.random() < 0.2) {\r\n        event = createTurnEvent(\r\n            'FOOD_SPOILAGE', // Using same type for simplicity\r\n            `ğŸªµ ${result.spoiled} wood rotted!`,\r\n            'warning',\r\n            result.spoiled\r\n        );\r\n    }\r\n    \r\n    return { decayed: result.spoiled, remaining: result.remaining, event };\r\n}\r\n\r\n/** Calculate stone loss */\r\nexport function calculateStoneLoss(\r\n    stone: number,\r\n    storageCapacity: number,\r\n    rates: SpoilageRates = DEFAULT_SPOILAGE_RATES\r\n): { lost: number; remaining: number; event?: TurnEvent } {\r\n    const result = calculateSpoilage(stone, storageCapacity, rates.stone);\r\n    \r\n    let event: TurnEvent | undefined;\r\n    if (result.spoiled > 20 && Math.random() < 0.1) {\r\n        event = createTurnEvent(\r\n            'FOOD_SPOILAGE',\r\n            `ğŸª¨ ${result.spoiled} stone scattered!`,\r\n            'warning',\r\n            result.spoiled\r\n        );\r\n    }\r\n    \r\n    return { lost: result.spoiled, remaining: result.remaining, event };\r\n}\r\n\r\n/** Calculate metal rust */\r\nexport function calculateMetalRust(\r\n    metal: number,\r\n    storageCapacity: number,\r\n    rates: SpoilageRates = DEFAULT_SPOILAGE_RATES\r\n): { rusted: number; remaining: number; event?: TurnEvent } {\r\n    const result = calculateSpoilage(metal, storageCapacity, rates.metal);\r\n    \r\n    let event: TurnEvent | undefined;\r\n    if (result.spoiled > 10 && Math.random() < 0.1) {\r\n        event = createTurnEvent(\r\n            'FOOD_SPOILAGE',\r\n            `âš™ï¸ ${result.spoiled} metal rusted! Build Metal Pit!`,\r\n            'warning',\r\n            result.spoiled\r\n        );\r\n    }\r\n    \r\n    return { rusted: result.spoiled, remaining: result.remaining, event };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// BATCH SPOILAGE PROCESSING\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Resource amounts */\r\nexport interface ResourceAmounts {\r\n    food: number;\r\n    wood: number;\r\n    stone: number;\r\n    metal: number;\r\n}\r\n\r\n/** Storage capacities */\r\nexport interface StorageCapacities {\r\n    food: number;\r\n    wood: number;\r\n    stone: number;\r\n    metal: number;\r\n}\r\n\r\n/** Spoilage result for all resources */\r\nexport interface AllSpoilageResult {\r\n    remaining: ResourceAmounts;\r\n    spoiled: ResourceAmounts;\r\n    events: TurnEvent[];\r\n}\r\n\r\n/** Process all resource spoilage */\r\nexport function processAllSpoilage(\r\n    resources: ResourceAmounts,\r\n    capacities: StorageCapacities,\r\n    hasAdvancedFoodStorage: boolean = false,\r\n    rates: SpoilageRates = DEFAULT_SPOILAGE_RATES\r\n): AllSpoilageResult {\r\n    const events: TurnEvent[] = [];\r\n    \r\n    const foodResult = calculateFoodSpoilage(\r\n        resources.food, \r\n        capacities.food, \r\n        hasAdvancedFoodStorage, \r\n        rates\r\n    );\r\n    if (foodResult.event) events.push(foodResult.event);\r\n    \r\n    const woodResult = calculateWoodDecay(resources.wood, capacities.wood, rates);\r\n    if (woodResult.event) events.push(woodResult.event);\r\n    \r\n    const stoneResult = calculateStoneLoss(resources.stone, capacities.stone, rates);\r\n    if (stoneResult.event) events.push(stoneResult.event);\r\n    \r\n    const metalResult = calculateMetalRust(resources.metal, capacities.metal, rates);\r\n    if (metalResult.event) events.push(metalResult.event);\r\n    \r\n    return {\r\n        remaining: {\r\n            food: foodResult.remaining,\r\n            wood: woodResult.remaining,\r\n            stone: stoneResult.remaining,\r\n            metal: metalResult.remaining\r\n        },\r\n        spoiled: {\r\n            food: foodResult.spoiled,\r\n            wood: woodResult.decayed,\r\n            stone: stoneResult.lost,\r\n            metal: metalResult.rusted\r\n        },\r\n        events\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// UPKEEP CALCULATIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Calculate building upkeep */\r\nexport function calculateBuildingUpkeep(\r\n    buildingCount: number,\r\n    abandonedCount: number,\r\n    normalRate: number = 0.5,\r\n    abandonedRate: number = 1.0\r\n): number {\r\n    const normalBuildings = buildingCount - abandonedCount;\r\n    const normalUpkeep = normalBuildings * normalRate;\r\n    const abandonedUpkeep = abandonedCount * abandonedRate;\r\n    return Math.ceil(normalUpkeep + abandonedUpkeep);\r\n}\r\n\r\n/** Process upkeep deduction */\r\nexport function processUpkeep(\r\n    wood: number,\r\n    upkeepCost: number\r\n): { remaining: number; shortage: number } {\r\n    if (wood >= upkeepCost) {\r\n        return { remaining: wood - upkeepCost, shortage: 0 };\r\n    }\r\n    return { remaining: 0, shortage: upkeepCost - wood };\r\n}\r\n","/**\r\n * Civil Zones v48.0 - Main Entry Point\r\n * \r\n * This is the modern TypeScript entry point that initializes\r\n * the game using properly bundled modules.\r\n * \r\n * Architecture:\r\n * - Clean separation of concerns\r\n * - Proper module imports (no inline JS)\r\n * - Performance-optimized (30 FPS cap, throttled systems)\r\n * - Hot Module Replacement support in development\r\n */\r\n\r\n// Import all game modules\r\nimport * as Types from './types/index.js';\r\nimport * as Config from './config/index.js';\r\nimport * as Core from './core/index.js';\r\nimport * as Systems from './systems/index.js';\r\nimport * as Rendering from './rendering/index.js';\r\nimport * as GameModule from './game/index.js';\r\nimport * as Input from './input/index.js';\r\nimport * as UI from './ui/index.js';\r\nimport * as AI from './ai/index.js';\r\nimport * as Buildings from './buildings/index.js';\r\nimport * as Entities from './entities/index.js';\r\nimport * as Events from './events/index.js';\r\nimport * as World from './world/index.js';\r\nimport * as Time from './time/index.js';\r\n\r\n// Import specific type from the game module (not types/)\r\nimport type { GameState } from './game/state.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// PERFORMANCE CONSTANTS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\nconst TARGET_FPS = 30;\r\nconst FRAME_TIME = 1000 / TARGET_FPS;\r\nconst AI_UPDATE_INTERVAL = 500; // AI updates every 500ms\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// GAME ENGINE CLASS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\nclass CivilZonesEngine {\r\n    canvas: HTMLCanvasElement;\r\n    ctx: CanvasRenderingContext2D;\r\n    gameState: GameState | null = null;\r\n    camera: Rendering.Camera;\r\n    inputController: Input.InputController | null = null;\r\n    lastFrameTime: number = 0;\r\n    lastAIUpdate: number = 0;\r\n    running: boolean = false;\r\n    frameCount: number = 0;\r\n    \r\n    constructor(canvasId: string) {\r\n        const canvas = document.getElementById(canvasId) as HTMLCanvasElement;\r\n        if (!canvas) {\r\n            throw new Error(`Canvas element '${canvasId}' not found`);\r\n        }\r\n        \r\n        const ctx = canvas.getContext('2d');\r\n        if (!ctx) {\r\n            throw new Error('Could not get 2D context');\r\n        }\r\n        \r\n        this.canvas = canvas;\r\n        this.ctx = ctx;\r\n        \r\n        // Initialize camera with default zoom\r\n        this.camera = Rendering.createCamera(1600, 1600, 1.0);\r\n        \r\n        // Set up canvas size\r\n        this.resizeCanvas();\r\n        window.addEventListener('resize', () => this.resizeCanvas());\r\n    }\r\n    \r\n    private resizeCanvas(): void {\r\n        this.canvas.width = window.innerWidth;\r\n        this.canvas.height = window.innerHeight;\r\n    }\r\n    \r\n    async init(): Promise<void> {\r\n        console.log('ğŸ›ï¸ Civil Zones v48.0 - Initializing...');\r\n        \r\n        // Update loading status\r\n        this.updateLoadingStatus('Initializing game state...');\r\n        \r\n        // Create initial game state\r\n        this.gameState = GameModule.createInitialGameState();\r\n        \r\n        this.updateLoadingStatus('Setting up input handlers...');\r\n        \r\n        // Set up input controller\r\n        this.inputController = Input.createSimpleInputController(\r\n            this.canvas,\r\n            (dx: number, dy: number) => this.handleMove(dx, dy),\r\n            (action: string) => this.handleAction(action)\r\n        );\r\n        \r\n        this.updateLoadingStatus('Loading assets...');\r\n        \r\n        // Initialize UI\r\n        UI.initToast();\r\n        \r\n        this.updateLoadingStatus('Ready!');\r\n        \r\n        // Hide loading screen\r\n        document.body.classList.add('game-ready');\r\n        \r\n        console.log('âœ… Civil Zones initialized successfully');\r\n        \r\n        // Show welcome toast\r\n        UI.showToast('ğŸ›ï¸ Welcome to Civil Zones v48.0!', { duration: 3000 });\r\n    }\r\n    \r\n    private updateLoadingStatus(message: string): void {\r\n        const statusEl = document.querySelector('#loading-screen .status');\r\n        if (statusEl) {\r\n            statusEl.textContent = message;\r\n        }\r\n    }\r\n    \r\n    start(): void {\r\n        if (this.running) return;\r\n        \r\n        this.running = true;\r\n        this.lastFrameTime = performance.now();\r\n        this.inputController?.enable();\r\n        this.gameLoop(this.lastFrameTime);\r\n    }\r\n    \r\n    stop(): void {\r\n        this.running = false;\r\n        this.inputController?.disable();\r\n    }\r\n    \r\n    private gameLoop(timestamp: number): void {\r\n        if (!this.running) return;\r\n        \r\n        const deltaTime = timestamp - this.lastFrameTime;\r\n        \r\n        // Throttle to target FPS\r\n        if (deltaTime >= FRAME_TIME) {\r\n            this.lastFrameTime = timestamp - (deltaTime % FRAME_TIME);\r\n            this.frameCount++;\r\n            \r\n            // Update game logic\r\n            this.update(deltaTime);\r\n            \r\n            // Render frame\r\n            this.render();\r\n        }\r\n        \r\n        requestAnimationFrame((t) => this.gameLoop(t));\r\n    }\r\n    \r\n    private update(deltaTime: number): void {\r\n        if (!this.gameState) return;\r\n        \r\n        // Update AI systems (throttled)\r\n        const now = performance.now();\r\n        if (now - this.lastAIUpdate >= AI_UPDATE_INTERVAL) {\r\n            this.lastAIUpdate = now;\r\n            this.updateAI();\r\n        }\r\n        \r\n        // Update game systems\r\n        this.updateSystems(deltaTime);\r\n    }\r\n    \r\n    private updateAI(): void {\r\n        // AI updates here (placeholder for now)\r\n    }\r\n    \r\n    private updateSystems(_deltaTime: number): void {\r\n        if (!this.gameState) return;\r\n        \r\n        // Population system\r\n        // Demand system\r\n        // Needs system\r\n        // etc.\r\n    }\r\n    \r\n    private render(): void {\r\n        const ctx = this.ctx;\r\n        const cam = this.camera;\r\n        const viewport: Rendering.Viewport = {\r\n            width: this.canvas.width,\r\n            height: this.canvas.height\r\n        };\r\n        \r\n        // Clear canvas\r\n        ctx.fillStyle = '#1a1a2a';\r\n        ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);\r\n        \r\n        // Apply camera transform\r\n        Rendering.applyCameraTransform(ctx, cam, viewport);\r\n        \r\n        // Render game world\r\n        this.renderWorld();\r\n        \r\n        // Restore transform\r\n        Rendering.restoreCameraTransform(ctx);\r\n        \r\n        // Render UI (screen space)\r\n        this.renderUI();\r\n    }\r\n    \r\n    private renderWorld(): void {\r\n        const ctx = this.ctx;\r\n        \r\n        // Placeholder - render a grid to show it's working\r\n        const gridSize = 32;\r\n        ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';\r\n        ctx.lineWidth = 1;\r\n        \r\n        for (let x = 0; x < 100; x++) {\r\n            for (let y = 0; y < 100; y++) {\r\n                ctx.strokeRect(x * gridSize, y * gridSize, gridSize, gridSize);\r\n            }\r\n        }\r\n        \r\n        // Draw center marker\r\n        ctx.fillStyle = '#D4A040';\r\n        ctx.beginPath();\r\n        ctx.arc(50 * gridSize, 50 * gridSize, 10, 0, Math.PI * 2);\r\n        ctx.fill();\r\n    }\r\n    \r\n    private renderUI(): void {\r\n        const ctx = this.ctx;\r\n        \r\n        // FPS counter\r\n        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';\r\n        ctx.fillRect(10, 10, 100, 30);\r\n        ctx.fillStyle = '#4CAF50';\r\n        ctx.font = '14px monospace';\r\n        ctx.fillText(`FPS: ${TARGET_FPS}`, 20, 30);\r\n    }\r\n    \r\n    // Input handlers\r\n    private handleMove(dx: number, dy: number): void {\r\n        console.log('Move:', dx, dy);\r\n        // Pan camera with keyboard\r\n        Rendering.panCamera(this.camera, dx * 10, dy * 10);\r\n    }\r\n    \r\n    private handleAction(action: string): void {\r\n        console.log('Action:', action);\r\n    }\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// BOOTSTRAP\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\nasync function bootstrap(): Promise<void> {\r\n    try {\r\n        const engine = new CivilZonesEngine('game-canvas');\r\n        await engine.init();\r\n        engine.start();\r\n        \r\n        // Expose engine for debugging\r\n        (window as unknown as Record<string, unknown>).CivilZones = engine;\r\n        (window as unknown as Record<string, unknown>).GameModules = {\r\n            Types,\r\n            Config,\r\n            Core,\r\n            Systems,\r\n            Rendering,\r\n            GameModule,\r\n            Input,\r\n            UI,\r\n            AI,\r\n            Buildings,\r\n            Entities,\r\n            Events,\r\n            World,\r\n            Time\r\n        };\r\n        \r\n    } catch (error) {\r\n        console.error('âŒ Failed to initialize Civil Zones:', error);\r\n        \r\n        const loadingScreen = document.getElementById('loading-screen');\r\n        if (loadingScreen) {\r\n            const status = loadingScreen.querySelector('.status');\r\n            if (status) {\r\n                status.textContent = `Error: ${error}`;\r\n                status.setAttribute('style', 'color: #ff6b6b;');\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n// Start when DOM is ready\r\nif (document.readyState === 'loading') {\r\n    document.addEventListener('DOMContentLoaded', bootstrap);\r\n} else {\r\n    bootstrap();\r\n}\r\n\r\n// Hot Module Replacement support\r\nif (import.meta.hot) {\r\n    import.meta.hot.accept();\r\n}\r\n"],"names":["DEFAULT_WANDER_INVENTORY","DEFAULT_POCKET_INVENTORY","DEFAULT_CITY_RESOURCES","createWanderInventory","nomadCount","startingFood","startingWood","getInventoryTotal","inventory","getAvailableSpace","hasSpace","amount","addToInventory","resource","space","removeFromInventory","current","hasResources","food","wood","metal","stone","increaseCapacity","addToPocket","pocket","total","toAdd","getPocketTotal","createCityResources","populationBonus","bonusMultiplier","addCityResource","resources","type","removeCityResource","canAfford","cost","deductCost","formatResource","getInventoryFillPercent","getResourceColor","getResourceEmoji","createPlayer","x","y","health","direction","getNewPosition","player","dx","dy","getDirectionFromDelta","getDeltaFromDirection","isInBounds","mapWidth","mapHeight","isTileTypePassable","tileType","isWanderMode","movePlayer","getTileType","newX","newY","passability","damagePlayer","healPlayer","maxHealth","isPlayerDead","isValidSpawnTile","countReachableTiles","startX","startY","maxTiles","seen","queue","count","key","findSpawnPosition","minReachable","attempt","reachable","getExplorationTiles","centerX","centerY","radius","tiles","createThirstState","updateThirst","state","drinkWater","isDyingOfThirst","getThirstWarning","createInitialGameState","transitionToCity","settlementX","settlementY","logGameEvent","message","logEntry","markDirty","size","clearDirtyRegions","updatePeakPop","checkGameOver","SAVE_VERSION","AUTOSAVE_KEY","SAVE_PREFIX","MAX_SAVE_SLOTS","serializeState","deserializeState","data","createSaveData","saveGame","slotId","saveData","json","error","loadGame","deleteSave","hasSave","getSaveSlots","slots","i","getNextSaveSlot","AUTOSAVE_INTERVAL","autosaveTimer","startAutosave","getState","getTiles","interval","stopAutosave","exportSave","blob","url","link","importSave","file","formatSaveTime","timestamp","date","now","getSaveDescription","slot","time","DEFAULT_INPUT_CONFIG","MOVEMENT_KEYS","ACTION_KEYS","modifierState","pressedKeys","getModifierState","isShiftHeld","isKeyPressed","extractModifiers","isMovementKey","getMovementDelta","isActionKey","KeyboardHandler","config","e","oldShift","moveDelta","createKeyboardHandler","createMovementHandler","onMove","screenToWorld","screenX","screenY","camera","canvasWidth","canvasHeight","wx","wy","worldToTile","worldX","worldY","tileSize","screenToTile","world","clampCamera","bounds","panCamera","deltaX","deltaY","newCam","zoomCamera","factor","isClickOnCanvas","target","canvas","isPointInRect","rect","isClickBlockedByMenu","clientX","clientY","menuPanelIds","panelId","panel","createRoadDragState","startRoadDrag","newState","addRoadDragPosition","newBuilt","endRoadDrag","MouseHandler","dims","tile","tool","newCamera","debug","createMouseHandler","InputController","action","modifiers","cam","tileX","tileY","z","level","callbacks","createInputController","createSimpleInputController","onAction","LORE_EVENTS","getLoreEvent","eventId","hasSeenLore","loreSeen","markLoreSeen","shouldShowLore","loreEnabled","getUnseenLore","id","getSeenLoreCount","getTotalLoreCount","getLoreProgress","checkFirstKillLore","checkFirstTurtleLore","checkFirstNomadLore","checkFirstBerryLore","checkFirstWellLore","checkFirstSettlementLore","checkGameStartLore","year","checkFloodWarningLore","getAllIllustrations","isValidIllustration","DEFAULT_SEA_LEVEL_CONFIG","getBuildingSize","buildingType","isWithinBuilding","building","isFloodRisk","elevation","currentSeaLevel","warningMargin","diff","getElevationDiff","seaLevel","formatElevationMessage","applySeaLevelChange","game","flooded","drained","buildingsLost","populationDrowned","wellsLost","bldsToRemove","playerDrowned","b","a","idx","removedBld","generateFloodMessage","periodName","generateWellsLostMessage","updateSeaLevel","currentLevel","targetLevel","riseRate","fallRate","isSeaLevelRising","getSeaLevelDirection","updateGeologyStats","geology","result","createInitialGeologyState","initialSeaLevel","DEFAULT_NOISE_PARAMS","DEFAULT_WORLD_CONFIG","initNoise","seed","getSeed","hash","h","mix","t","valueNoise","j","fx","fy","ux","uy","d","fbm","octaves","amplitude","px","py","fbmNormalized","terrainNoise","oceanNoise","lakeNoise","mountainNoise","riverNoise","isRiverAt","width","r","randomSeed","customNoise","frequency","offsetX","offsetY","generateHighGroundPatches","height","patchSize","patchesPerArea","patches","numPatches","isInHighGroundPatch","patch","calculateElevation","heightNoise","bias","generateHighGroundElevation","determineTerrainType","isHighGround","mtnNoise","lkNoise","isRiver","finalElevation","createTile","terrain","hasTree","generateTerrain","options","highGroundPatches","getTerrainStats","stats","getLandWaterRatio","land","water","VALID_SPAWN_TERRAIN","REACHABLE_TERRAIN","isValidSpawnPosition","isReachableTerrain","W","H","cx","cy","findCenterSpawn","maxAttempts","findWideSpawn","findEmergencySpawn","forceCenterSpawn","findSpawnLocation","centerSpawn","wideSpawn","emergencySpawn","spawn","exploreArea","explored","isTileExplored","getExploredCount","DEFAULT_TIME_CONFIG","DEFAULT_SPOILAGE_RATES","DEFAULT_POPULATION_CONFIG","createTimeState","startYear","startAge","advanceYear","setAge","age","togglePause","setSpeed","speed","createTurnEvent","severity","value","yearAdvanceEvent","foodSpoilageEvent","hasStorage","msg","starvationEvent","deaths","growthEvent","births","waterShortageEvent","wells","capacity","pop","overcrowdingEvent","homeless","foodStolen","plagueEvent","economicLoss","buildingAbandonEvent","createTurnResult","events","createGameOverResult","reason","calculateGrowth","currentPop","housingCapacity","foodConsumed","growthRate","cappedBirths","calculateStarvation","deathRate","calculateDehydration","waterCapacity","peopleWithoutWater","calculateOvercrowding","exposureRate","calculatePlague","plagueChanceMultiplier","plagueDeathRate","plagueChance","getGameOverMessage","shouldGameEnd","population","hasWater","formatYear","getEpochName","isMilestoneYear","calculateSpoilage","rate","excess","spoiled","remaining","calculateFoodSpoilage","storageCapacity","hasAdvancedStorage","rates","event","calculateWoodDecay","calculateStoneLoss","calculateMetalRust","processAllSpoilage","capacities","hasAdvancedFoodStorage","foodResult","woodResult","stoneResult","metalResult","calculateBuildingUpkeep","buildingCount","abandonedCount","normalRate","abandonedRate","normalUpkeep","abandonedUpkeep","processUpkeep","upkeepCost","TARGET_FPS","FRAME_TIME","AI_UPDATE_INTERVAL","CivilZonesEngine","canvasId","ctx","Rendering.createCamera","GameModule.createInitialGameState","Input.createSimpleInputController","UI.initToast","UI.showToast","statusEl","deltaTime","_deltaTime","viewport","Rendering.applyCameraTransform","Rendering.restoreCameraTransform","gridSize","Rendering.panCamera","bootstrap","engine","Types","Config","Core","Systems","Rendering","GameModule","Input","UI","AI","Buildings","Entities","Events","World","Time","loadingScreen","status"],"mappings":"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"}