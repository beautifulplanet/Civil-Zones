{"version":3,"file":"game-ai-BV7aEE30.js","sources":["../../src/ai/types.ts","../../src/ai/state.ts","../../src/ai/qlearning.ts","../../src/ai/strategies.ts","../../src/ai/exploration.ts"],"sourcesContent":["/**\r\n * Civil Zones - AI Types\r\n * Type definitions for AI systems\r\n */\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// AI STATE\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** AI-readable game state from UI */\r\nexport interface AIGameState {\r\n    // Population & Resources\r\n    pop: number;\r\n    food: number;\r\n    wood: number;\r\n    stone: number;\r\n    metal: number;\r\n    gold: number;\r\n    year: number;\r\n    \r\n    // Housing & Water\r\n    housingCap: number;\r\n    wells: number;\r\n    waterCapacity: number;\r\n    waterPercent: number;\r\n    \r\n    // Building counts\r\n    resZones: number;\r\n    comZones: number;\r\n    indZones: number;\r\n    paths: number;\r\n    roadCount: number;\r\n    \r\n    // Derived needs\r\n    needsWells: boolean;\r\n    wellsNeeded: number;\r\n    needsHousing: boolean;\r\n    housingNeeded: number;\r\n    foodPerPerson: number;\r\n    isStarving: boolean;\r\n    isThirsty: boolean;\r\n    \r\n    // RCI Demand\r\n    rDemand: number;\r\n    cDemand: number;\r\n    iDemand: number;\r\n    highestDemand: 'R' | 'C' | 'I';\r\n    \r\n    // Workforce\r\n    workerShortage: boolean;\r\n    homeless: number;\r\n}\r\n\r\n/** Wander mode state */\r\nexport interface AIWanderState {\r\n    pop: number;\r\n    food: number;\r\n    wood: number;\r\n    thirst: number;\r\n    thirstCounter: number;\r\n    nearWater: boolean;\r\n    exploredTiles: number;\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// AI ACTIONS\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Basic AI actions */\r\nexport type AIAction = \r\n    | 'SETTLE'\r\n    | 'WANDER'\r\n    | 'BUILD_RES'\r\n    | 'BUILD_RES_L2'\r\n    | 'BUILD_RES_L3'\r\n    | 'BUILD_RES_L4'\r\n    | 'BUILD_RES_L5'\r\n    | 'BUILD_RES_L6'\r\n    | 'BUILD_WELL'\r\n    | 'BUILD_IND'\r\n    | 'BUILD_IND_L2'\r\n    | 'BUILD_IND_L3'\r\n    | 'BUILD_IND_L4'\r\n    | 'BUILD_IND_L5'\r\n    | 'BUILD_IND_L6'\r\n    | 'BUILD_COM'\r\n    | 'BUILD_COM_L2'\r\n    | 'BUILD_COM_L3'\r\n    | 'BUILD_COM_L4'\r\n    | 'BUILD_COM_L5'\r\n    | 'BUILD_COM_L6'\r\n    | 'BUILD_ROAD'\r\n    | 'BUILD_CLAN_CHIEF'\r\n    | 'BUILD_DOCK'\r\n    | 'EXCHANGE_GOLD'\r\n    | 'PASS_YEAR'\r\n    | 'WAIT';\r\n\r\n/** AI target for pathfinding */\r\nexport interface AITarget {\r\n    x: number;\r\n    y: number;\r\n    type: 'BERRY' | 'ANIMAL' | 'NOMAD' | 'WATER' | 'EXPLORE' | 'BUILD';\r\n    priority: number;\r\n    distance?: number;\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// STRATEGIES\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Build ratio configuration */\r\nexport interface BuildRatio {\r\n    R: number;  // Residential\r\n    C: number;  // Commercial\r\n    I: number;  // Industrial\r\n}\r\n\r\n/** Strategy step for sequence-based strategies */\r\nexport interface StrategyStep {\r\n    type: 'RES' | 'COM' | 'IND' | 'WELL' | 'ROAD' | 'WAIT';\r\n    count?: number;\r\n    years?: number;\r\n}\r\n\r\n/** Sequence-based build strategy */\r\nexport interface SequenceStrategy {\r\n    name: string;\r\n    sequence: StrategyStep[];\r\n    step: number;\r\n    subStep: number;\r\n    waitStartYear: number;\r\n}\r\n\r\n/** Ratio-based build strategy */\r\nexport interface RatioStrategy {\r\n    name: string;\r\n    ratio: BuildRatio;\r\n    roadsPerBuilding: number;\r\n}\r\n\r\n/** Strategy type identifier */\r\nexport type StrategyType = 'STARTER' | 'BALANCED' | 'HOUSING_HEAVY';\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// Q-LEARNING\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Q-Table: state -> action -> value */\r\nexport type QTable = Record<string, Record<string, number>>;\r\n\r\n/** Q-Learning hyperparameters */\r\nexport interface QLearningParams {\r\n    learningRate: number;\r\n    discountFactor: number;\r\n    explorationRate: number;\r\n    explorationDecay: number;\r\n    minExploration: number;\r\n    maxQTableSize: number;\r\n}\r\n\r\n/** Q-Learning training stats */\r\nexport interface QLearningStats {\r\n    episode: number;\r\n    totalReward: number;\r\n    episodeRewards: number[];\r\n    bestScore: number;\r\n    gamesPlayed: number;\r\n    citiesBuilt: number;\r\n    bestPopulation: number;\r\n    bestSurvivalYears: number;\r\n    balancedCities: number;\r\n    smartSettlements: number;\r\n    rewardHistory: number[];\r\n}\r\n\r\n/** Learning phase for curriculum learning */\r\nexport type LearningPhase = 1 | 2 | 3;\r\n\r\n/** Death cause tracking */\r\nexport type DeathCause = 'thirst' | 'starvation' | 'collapse' | 'unknown';\r\n\r\n/** Death record */\r\nexport interface DeathRecord {\r\n    cause: DeathCause;\r\n    year: number;\r\n    pop: number;\r\n    state: string;\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// PLAYBOOKS & MACROS\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Macro step condition */\r\nexport interface MacroStepCondition {\r\n    minYear?: number;\r\n    maxYear?: number;\r\n    requirePop?: number;\r\n    requireDemand?: 'R' | 'C' | 'I';\r\n    requireNeeds?: ('water' | 'food' | 'housing')[];\r\n    requireHousingNearFull?: boolean;\r\n    requireHomeless?: number;\r\n    requireWorkerShortage?: boolean;\r\n    requireFood?: number;\r\n    requireWood?: number;\r\n    requireFoodPerPop?: number;\r\n    waitYears?: number;\r\n}\r\n\r\n/** Macro playbook step */\r\nexport interface MacroStep extends MacroStepCondition {\r\n    action: AIAction | 'BUILD_DEMAND';\r\n}\r\n\r\n/** Macro playbook */\r\nexport interface MacroPlaybook {\r\n    id: string;\r\n    name: string;\r\n    steps: MacroStep[];\r\n}\r\n\r\n/** Tactic statistics */\r\nexport interface TacticStats {\r\n    attempts: number;\r\n    successes: number;\r\n    totalYears: number;\r\n    maxPop: number;\r\n    avgScore: number;\r\n}\r\n\r\n/** Saved playbook from player watching */\r\nexport interface SavedPlaybook {\r\n    id: string;\r\n    timestamp: number;\r\n    startYear: number;\r\n    endYear: number;\r\n    maxPop: number;\r\n    playbook: PlaybookStep[];\r\n}\r\n\r\n/** Playbook step recorded from player */\r\nexport interface PlaybookStep {\r\n    action: AIAction;\r\n    year: number;\r\n    pop: number;\r\n    yearsSinceLastBuild: number;\r\n    context: Partial<AIGameState>;\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// EXPLORATION TEST\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Exploration statistics */\r\nexport interface ExploreStats {\r\n    tilesVisited: Set<string>;\r\n    totalTiles: number;\r\n    resourcesCollected: number;\r\n    berriesCollected: number;\r\n    woodCollected: number;\r\n    nomadsRecruited: number;\r\n    animalsHunted: number;\r\n    deaths: number;\r\n    totalSteps: number;\r\n    stepsThisRun: number;\r\n    runsCompleted: number;\r\n    deathLocations: DeathLocation[];\r\n    dangerZones: Record<string, number>;\r\n    startTime: number | null;\r\n}\r\n\r\n/** Death location record */\r\nexport interface DeathLocation {\r\n    x: number;\r\n    y: number;\r\n    cause: string;\r\n    steps: number;\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// CITY EXPANSION\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** City expansion statistics */\r\nexport interface ExpansionStats {\r\n    radius: number;\r\n    roadFrontier: number;\r\n    quadrants: number;\r\n}\r\n\r\n/** Population tier strategy */\r\nexport interface PopTierStrategy {\r\n    tier: 'startup' | 'growth' | 'expansion' | 'city' | 'metropolis';\r\n    priority: string;\r\n    waterRatio: number;\r\n    comRatio: number;\r\n    indThreshold: number;\r\n    roadsPer: number;\r\n    expandRate: number;\r\n    hint: string;\r\n}\r\n\r\n/** Blocker diagnosis */\r\nexport interface BlockerDiagnosis {\r\n    issue: 'water' | 'housing' | 'food' | 'wood' | 'no-industrial' | 'cramped';\r\n    severity: 'critical' | 'warning' | 'opportunity';\r\n    fix: AIAction;\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// AI CONFIGURATION\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Default Q-Learning parameters */\r\nexport const DEFAULT_QLEARNING_PARAMS: QLearningParams = {\r\n    learningRate: 0.25,\r\n    discountFactor: 0.9,\r\n    explorationRate: 0.8,\r\n    explorationDecay: 0.98,\r\n    minExploration: 0.1,\r\n    maxQTableSize: 50000\r\n};\r\n\r\n/** All available AI actions */\r\nexport const AI_ACTIONS: AIAction[] = [\r\n    'SETTLE', 'WANDER',\r\n    'BUILD_RES', 'BUILD_RES_L2', 'BUILD_RES_L3', 'BUILD_RES_L4', 'BUILD_RES_L5', 'BUILD_RES_L6',\r\n    'BUILD_WELL', 'PASS_YEAR',\r\n    'BUILD_IND', 'BUILD_IND_L2', 'BUILD_IND_L3', 'BUILD_IND_L4', 'BUILD_IND_L5', 'BUILD_IND_L6',\r\n    'BUILD_COM', 'BUILD_COM_L2', 'BUILD_COM_L3', 'BUILD_COM_L4', 'BUILD_COM_L5', 'BUILD_COM_L6',\r\n    'BUILD_ROAD', 'WAIT', 'BUILD_CLAN_CHIEF', 'BUILD_DOCK', 'EXCHANGE_GOLD'\r\n];\r\n\r\n/** AI update interval in milliseconds */\r\nexport const AI_UPDATE_INTERVAL = 150;\r\n\r\n/** Blueprint AI update interval */\r\nexport const BLUEPRINT_UPDATE_INTERVAL = 200;\r\n","/**\r\n * Civil Zones - AI State Reader\r\n * Reads game state for AI decision making\r\n */\r\n\r\nimport type { AIGameState, AIWanderState, ExpansionStats, BlockerDiagnosis } from './types.js';\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// GAME STATE INTERFACE (for type safety without circular deps)\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\ninterface GameLike {\r\n    pop?: number;\r\n    food?: number;\r\n    wood?: number;\r\n    stone?: number;\r\n    metal?: number;\r\n    gold?: number;\r\n    year?: number;\r\n    housingCap?: number;\r\n    wellCount?: number;\r\n    zoneCount?: number;\r\n    thirst?: number;\r\n    thirstCounter?: number;\r\n    gameState?: 'WANDER' | 'CITY';\r\n    inventory?: { food: number; wood: number };\r\n    player?: { x: number; y: number };\r\n    tiles?: any[][];\r\n    blds?: Array<{ t: string; x?: number; y?: number }>;\r\n    calculateRCIDemand?: () => { r: number; c: number; i: number };\r\n    workforce?: { gatherers: number; shortage: number };\r\n    settlementPos?: { x: number; y: number };\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// STATE READING\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Read full game state for AI decision making */\r\nexport function readGameState(game: GameLike): AIGameState {\r\n    const pop = game.pop || 0;\r\n    const food = game.food || 0;\r\n    const wood = game.wood || 0;\r\n    const stone = game.stone || 0;\r\n    const metal = game.metal || 0;\r\n    const gold = game.gold || 0;\r\n    const year = game.year || 0;\r\n    const housingCap = game.housingCap || 0;\r\n    \r\n    // Building counts\r\n    const wells = game.blds ? game.blds.filter(b => b.t === 'WELL').length : 0;\r\n    const resZones = game.zoneCount || 0;\r\n    const comZones = game.blds ? game.blds.filter(b => b.t === 'COM').length : 0;\r\n    const indZones = game.blds ? game.blds.filter(b => b.t === 'IND').length : 0;\r\n    const roadCount = game.blds ? game.blds.filter(b => b.t === 'ROAD').length : 0;\r\n    const paths = game.tiles ? game.tiles.flat().filter((t: any) => t?.path).length : 0;\r\n    \r\n    // Water calculations\r\n    const waterCapacity = wells * 100;\r\n    const waterPercent = waterCapacity > 0 ? Math.round((pop / waterCapacity) * 100) : 0;\r\n    const wellsNeeded = Math.ceil(pop / 100);\r\n    const needsWells = pop > 0 && waterCapacity < pop;\r\n    \r\n    // Housing calculations\r\n    const needsHousing = pop >= housingCap - 5;\r\n    const housingNeeded = Math.max(0, pop - housingCap + 10);\r\n    const homeless = Math.max(0, pop - housingCap);\r\n    \r\n    // Food calculations\r\n    const foodPerPerson = pop > 0 ? food / pop : 0;\r\n    const isStarving = food < pop * 2;\r\n    const isThirsty = needsWells;\r\n    \r\n    // RCI Demand\r\n    const rci = game.calculateRCIDemand ? game.calculateRCIDemand() : { r: 50, c: 50, i: 50 };\r\n    const rDemand = rci.r;\r\n    const cDemand = rci.c;\r\n    const iDemand = rci.i;\r\n    const highestDemand: 'R' | 'C' | 'I' = \r\n        rDemand >= cDemand && rDemand >= iDemand ? 'R' : \r\n        (cDemand >= iDemand ? 'C' : 'I');\r\n    \r\n    // Workforce\r\n    const workforce = game.workforce || { gatherers: 0, shortage: 0 };\r\n    const workerShortage = workforce.shortage > 0;\r\n    \r\n    return {\r\n        pop, food, wood, stone, metal, gold, year,\r\n        housingCap, wells, waterCapacity, waterPercent,\r\n        resZones, comZones, indZones, paths, roadCount,\r\n        needsWells, wellsNeeded, needsHousing, housingNeeded,\r\n        foodPerPerson, isStarving, isThirsty,\r\n        rDemand, cDemand, iDemand, highestDemand,\r\n        workerShortage, homeless\r\n    };\r\n}\r\n\r\n/** Read wander mode state */\r\nexport function readWanderState(game: GameLike): AIWanderState {\r\n    const pop = game.pop || 0;\r\n    const food = game.inventory?.food || 0;\r\n    const wood = game.inventory?.wood || 0;\r\n    const thirst = game.thirst || 100;\r\n    const thirstCounter = game.thirstCounter || 0;\r\n    \r\n    // Check if near water\r\n    const nearWater = checkNearWater(game);\r\n    \r\n    // Count explored tiles\r\n    const exploredTiles = countExploredTiles(game);\r\n    \r\n    return { pop, food, wood, thirst, thirstCounter, nearWater, exploredTiles };\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// WATER DETECTION\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Check if player is near water (within settlement distance) */\r\nexport function checkNearWater(game: GameLike, distance: number = 5): boolean {\r\n    if (!game.player || !game.tiles) return false;\r\n    \r\n    const px = game.player.x;\r\n    const py = game.player.y;\r\n    const width = game.tiles.length;\r\n    const height = game.tiles[0]?.length || 0;\r\n    \r\n    for (let dx = -distance; dx <= distance; dx++) {\r\n        for (let dy = -distance; dy <= distance; dy++) {\r\n            const x = px + dx;\r\n            const y = py + dy;\r\n            \r\n            if (x >= 0 && x < width && y >= 0 && y < height) {\r\n                const tile = game.tiles[x][y];\r\n                if (tile && (tile.type === 'WATER' || tile.type === 'RIVER' || tile.type === 'DEEP')) {\r\n                    return true;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    return false;\r\n}\r\n\r\n/** Find nearest water source */\r\nexport function findNearestWater(game: GameLike, maxRadius: number = 20): { x: number; y: number } | null {\r\n    if (!game.player || !game.tiles) return null;\r\n    \r\n    const px = game.player.x;\r\n    const py = game.player.y;\r\n    const width = game.tiles.length;\r\n    const height = game.tiles[0]?.length || 0;\r\n    \r\n    let bestDist = Infinity;\r\n    let bestPos: { x: number; y: number } | null = null;\r\n    \r\n    for (let radius = 1; radius <= maxRadius; radius++) {\r\n        for (let dx = -radius; dx <= radius; dx++) {\r\n            for (let dy = -radius; dy <= radius; dy++) {\r\n                // Only check perimeter\r\n                if (Math.abs(dx) !== radius && Math.abs(dy) !== radius) continue;\r\n                \r\n                const x = px + dx;\r\n                const y = py + dy;\r\n                \r\n                if (x >= 0 && x < width && y >= 0 && y < height) {\r\n                    const tile = game.tiles[x][y];\r\n                    if (tile?.explored && (tile.type === 'WATER' || tile.type === 'RIVER')) {\r\n                        const dist = Math.abs(dx) + Math.abs(dy);\r\n                        if (dist < bestDist) {\r\n                            bestDist = dist;\r\n                            bestPos = { x, y };\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        if (bestPos) break;\r\n    }\r\n    \r\n    return bestPos;\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// EXPLORATION\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Count explored tiles around player */\r\nexport function countExploredTiles(game: GameLike, radius: number = 3): number {\r\n    if (!game.player || !game.tiles) return 0;\r\n    \r\n    const cx = game.player.x;\r\n    const cy = game.player.y;\r\n    const width = game.tiles.length;\r\n    const height = game.tiles[0]?.length || 0;\r\n    \r\n    let count = 0;\r\n    for (let x = cx - radius; x <= cx + radius; x++) {\r\n        for (let y = cy - radius; y <= cy + radius; y++) {\r\n            if (x >= 0 && y >= 0 && x < width && y < height) {\r\n                const tile = game.tiles[x][y];\r\n                if (tile?.explored) count++;\r\n            }\r\n        }\r\n    }\r\n    return count;\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// CITY EXPANSION\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Get city expansion statistics */\r\nexport function getCityExpansionStats(game: GameLike, aiSettlementPos?: { x: number; y: number }): ExpansionStats {\r\n    if (!game.blds || game.blds.length === 0) {\r\n        return { radius: 0, roadFrontier: 0, quadrants: 0 };\r\n    }\r\n    \r\n    // Determine origin point\r\n    let origin = game.settlementPos || aiSettlementPos;\r\n    if (!origin) {\r\n        if (game.player) {\r\n            origin = { x: game.player.x, y: game.player.y };\r\n        } else {\r\n            const first = game.blds[0];\r\n            origin = { x: first?.x || 0, y: first?.y || 0 };\r\n        }\r\n    }\r\n    \r\n    let maxDist = 0;\r\n    let roadFrontier = 0;\r\n    const quadrants = new Set<string>();\r\n    \r\n    for (const b of game.blds) {\r\n        if (b.x === undefined || b.y === undefined) continue;\r\n        \r\n        const dx = b.x - origin.x;\r\n        const dy = b.y - origin.y;\r\n        const manhattan = Math.abs(dx) + Math.abs(dy);\r\n        \r\n        if (manhattan > maxDist) maxDist = manhattan;\r\n        if (b.t === 'ROAD' && manhattan > roadFrontier) roadFrontier = manhattan;\r\n        \r\n        if (manhattan > 0) {\r\n            const quad = dx >= 0 \r\n                ? (dy >= 0 ? 'SE' : 'NE')\r\n                : (dy >= 0 ? 'SW' : 'NW');\r\n            quadrants.add(quad);\r\n        }\r\n    }\r\n    \r\n    return { radius: maxDist, roadFrontier, quadrants: quadrants.size };\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// DIAGNOSTICS\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Diagnose what's blocking city progress */\r\nexport function diagnoseBlockers(state: AIGameState): BlockerDiagnosis[] | null {\r\n    const blockers: BlockerDiagnosis[] = [];\r\n    \r\n    // Check water\r\n    if (state.pop > state.waterCapacity * 0.8) {\r\n        blockers.push({\r\n            issue: 'water',\r\n            severity: state.pop > state.waterCapacity ? 'critical' : 'warning',\r\n            fix: 'BUILD_WELL'\r\n        });\r\n    }\r\n    \r\n    // Check housing\r\n    if (state.pop >= state.housingCap - 2) {\r\n        blockers.push({\r\n            issue: 'housing',\r\n            severity: state.pop >= state.housingCap ? 'critical' : 'warning',\r\n            fix: 'BUILD_RES'\r\n        });\r\n    }\r\n    \r\n    // Check food production\r\n    if (state.food < state.pop * 5) {\r\n        blockers.push({\r\n            issue: 'food',\r\n            severity: state.food < state.pop * 2 ? 'critical' : 'warning',\r\n            fix: 'BUILD_COM'\r\n        });\r\n    }\r\n    \r\n    // Check wood production\r\n    if (state.wood < 50 && state.comZones > 0) {\r\n        blockers.push({\r\n            issue: 'wood',\r\n            severity: 'warning',\r\n            fix: 'BUILD_COM'\r\n        });\r\n    }\r\n    \r\n    // Check industrial readiness\r\n    if (state.indZones === 0 && state.pop >= 25 && state.resZones >= 4 && state.comZones >= 1) {\r\n        blockers.push({\r\n            issue: 'no-industrial',\r\n            severity: 'opportunity',\r\n            fix: 'BUILD_IND'\r\n        });\r\n    }\r\n    \r\n    return blockers.length > 0 ? blockers : null;\r\n}\r\n\r\n/** Get population tier strategy advice */\r\nexport function getPopTierStrategy(pop: number): {\r\n    tier: string;\r\n    priority: string;\r\n    waterRatio: number;\r\n    comRatio: number;\r\n    indThreshold: number;\r\n    roadsPer: number;\r\n    expandRate: number;\r\n    hint: string;\r\n} {\r\n    if (pop < 10) {\r\n        return {\r\n            tier: 'startup',\r\n            priority: 'survival',\r\n            waterRatio: 0.15,\r\n            comRatio: 0.2,\r\n            indThreshold: 999,\r\n            roadsPer: 3,\r\n            expandRate: 0,\r\n            hint: 'Focus on first residential and well'\r\n        };\r\n    } else if (pop < 25) {\r\n        return {\r\n            tier: 'growth',\r\n            priority: 'population',\r\n            waterRatio: 0.12,\r\n            comRatio: 0.25,\r\n            indThreshold: 200,\r\n            roadsPer: 2.5,\r\n            expandRate: 1,\r\n            hint: 'Build residential, add commercial for production'\r\n        };\r\n    } else if (pop < 50) {\r\n        return {\r\n            tier: 'expansion',\r\n            priority: 'diversity',\r\n            waterRatio: 0.1,\r\n            comRatio: 0.33,\r\n            indThreshold: 100,\r\n            roadsPer: 2,\r\n            expandRate: 2,\r\n            hint: 'Balance RCI, push road frontier'\r\n        };\r\n    } else if (pop < 100) {\r\n        return {\r\n            tier: 'city',\r\n            priority: 'efficiency',\r\n            waterRatio: 0.08,\r\n            comRatio: 0.4,\r\n            indThreshold: 50,\r\n            roadsPer: 1.5,\r\n            expandRate: 3,\r\n            hint: 'Maximize industrial, expand into new quadrants'\r\n        };\r\n    } else {\r\n        return {\r\n            tier: 'metropolis',\r\n            priority: 'dominance',\r\n            waterRatio: 0.06,\r\n            comRatio: 0.5,\r\n            indThreshold: 25,\r\n            roadsPer: 1,\r\n            expandRate: 5,\r\n            hint: 'Fill all quadrants, reach Level 3+'\r\n        };\r\n    }\r\n}\r\n","/**\r\n * Civil Zones - Q-Learning System\r\n * Core Q-Learning algorithm for AI training\r\n */\r\n\r\nimport type { \r\n    QTable, \r\n    QLearningParams, \r\n    QLearningStats, \r\n    AIAction,\r\n    LearningPhase,\r\n    DeathCause,\r\n    DeathRecord \r\n} from './types.js';\r\nimport { DEFAULT_QLEARNING_PARAMS, AI_ACTIONS } from './types.js';\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// Q-TABLE MANAGEMENT\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Get Q-value for state-action pair */\r\nexport function getQ(qTable: QTable, state: string, action: string): number {\r\n    if (!qTable[state]) qTable[state] = {};\r\n    if (qTable[state][action] === undefined) qTable[state][action] = 0;\r\n    return qTable[state][action];\r\n}\r\n\r\n/** Update Q-value using Bellman equation */\r\nexport function updateQ(\r\n    qTable: QTable, \r\n    state: string, \r\n    action: string, \r\n    reward: number, \r\n    nextState: string,\r\n    params: QLearningParams = DEFAULT_QLEARNING_PARAMS\r\n): void {\r\n    const currentQ = getQ(qTable, state, action);\r\n    const maxNextQ = Math.max(...AI_ACTIONS.map(a => getQ(qTable, nextState, a)));\r\n    const newQ = currentQ + params.learningRate * (reward + params.discountFactor * maxNextQ - currentQ);\r\n    \r\n    if (!qTable[state]) qTable[state] = {};\r\n    qTable[state][action] = newQ;\r\n}\r\n\r\n/** Prune Q-table to prevent memory explosion */\r\nexport function pruneQTable(qTable: QTable, maxSize: number): number {\r\n    const states = Object.keys(qTable);\r\n    if (states.length < maxSize * 0.9) return 0;\r\n    \r\n    // Calculate average Q-value per state\r\n    const stateScores = states.map(s => {\r\n        const actions = qTable[s];\r\n        const values = Object.values(actions);\r\n        const maxQ = values.length > 0 ? Math.max(...values) : 0;\r\n        return { state: s, score: maxQ };\r\n    });\r\n    \r\n    // Sort by score (lowest first) and remove bottom 20%\r\n    stateScores.sort((a, b) => a.score - b.score);\r\n    const removeCount = Math.floor(states.length * 0.2);\r\n    \r\n    for (let i = 0; i < removeCount; i++) {\r\n        delete qTable[stateScores[i].state];\r\n    }\r\n    \r\n    return removeCount;\r\n}\r\n\r\n/** Get best action for a state (exploitation) */\r\nexport function getBestAction(qTable: QTable, state: string, availableActions: AIAction[]): AIAction {\r\n    let bestAction = availableActions[0];\r\n    let bestQ = -Infinity;\r\n    \r\n    for (const action of availableActions) {\r\n        const q = getQ(qTable, state, action);\r\n        if (q > bestQ) {\r\n            bestQ = q;\r\n            bestAction = action;\r\n        }\r\n    }\r\n    \r\n    return bestAction;\r\n}\r\n\r\n/** Choose action using epsilon-greedy policy */\r\nexport function chooseActionEpsilonGreedy(\r\n    qTable: QTable,\r\n    state: string,\r\n    availableActions: AIAction[],\r\n    explorationRate: number\r\n): AIAction {\r\n    // Explore: random action\r\n    if (Math.random() < explorationRate) {\r\n        return availableActions[Math.floor(Math.random() * availableActions.length)];\r\n    }\r\n    \r\n    // Exploit: best known action\r\n    return getBestAction(qTable, state, availableActions);\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// STATE ENCODING\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Encode wander state to string */\r\nexport function encodeWanderState(\r\n    stage: number,\r\n    highestUnlock: number,\r\n    popBucket: number,\r\n    foodOK: boolean,\r\n    woodOK: boolean\r\n): string {\r\n    return `WANDER_S${stage}_LV${highestUnlock}_P${popBucket}_F${foodOK ? 1 : 0}_W${woodOK ? 1 : 0}`;\r\n}\r\n\r\n/** Encode city state to string */\r\nexport function encodeCityState(params: {\r\n    stage: number;\r\n    highestUnlock: number;\r\n    civLevel: number;\r\n    popBucket: number;\r\n    foodBucket: number;\r\n    woodBucket: number;\r\n    wellCount: number;\r\n    resCount: number;\r\n    indCount: number;\r\n    comCount: number;\r\n    roadCount: number;\r\n    hasWaterCrisis: boolean;\r\n    hasFoodCrisis: boolean;\r\n    expansionBucket: number;\r\n    roadFrontBucket: number;\r\n    quadrantBucket: number;\r\n}): string {\r\n    return `S${params.stage}` +\r\n        `LV${params.highestUnlock}` +\r\n        `CV${Math.min(9, Math.floor(params.civLevel))}` +\r\n        `P${params.popBucket}` +\r\n        `F${params.foodBucket}` +\r\n        `W${params.woodBucket}` +\r\n        `WL${params.wellCount}` +\r\n        `R${params.resCount}` +\r\n        `I${params.indCount}` +\r\n        `C${params.comCount}` +\r\n        `RD${params.roadCount}` +\r\n        `WC${params.hasWaterCrisis ? 1 : 0}` +\r\n        `FC${params.hasFoodCrisis ? 1 : 0}` +\r\n        `EX${params.expansionBucket}` +\r\n        `RF${params.roadFrontBucket}` +\r\n        `Q${params.quadrantBucket}`;\r\n}\r\n\r\n/** Bucket a value into discrete ranges */\r\nexport function bucket(value: number, bucketSize: number, maxBuckets: number): number {\r\n    return Math.min(maxBuckets, Math.floor(value / bucketSize));\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// REWARD CALCULATION\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Calculate reward for state transition */\r\nexport function calculateReward(params: {\r\n    popGained: number;\r\n    resourcesGained: number;\r\n    yearsSurvived: number;\r\n    buildingsBuilt: number;\r\n    died: boolean;\r\n    deathCause?: DeathCause;\r\n    balanced: boolean;\r\n    newQuadrant: boolean;\r\n    levelUp: boolean;\r\n}): number {\r\n    let reward = 0;\r\n    \r\n    // Population growth is good\r\n    reward += params.popGained * 10;\r\n    \r\n    // Resource accumulation\r\n    reward += params.resourcesGained * 0.01;\r\n    \r\n    // Survival bonus\r\n    reward += params.yearsSurvived * 2;\r\n    \r\n    // Building construction\r\n    reward += params.buildingsBuilt * 5;\r\n    \r\n    // Death penalty\r\n    if (params.died) {\r\n        reward -= 100;\r\n        if (params.deathCause === 'thirst') reward -= 50; // Extra penalty for thirst death\r\n        if (params.deathCause === 'starvation') reward -= 30;\r\n    }\r\n    \r\n    // Balance bonus\r\n    if (params.balanced) reward += 20;\r\n    \r\n    // Expansion bonus\r\n    if (params.newQuadrant) reward += 15;\r\n    \r\n    // Level up bonus\r\n    if (params.levelUp) reward += 50;\r\n    \r\n    return reward;\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// TRAINING STATISTICS\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Create initial training stats */\r\nexport function createStats(): QLearningStats {\r\n    return {\r\n        episode: 0,\r\n        totalReward: 0,\r\n        episodeRewards: [],\r\n        bestScore: 0,\r\n        gamesPlayed: 0,\r\n        citiesBuilt: 0,\r\n        bestPopulation: 0,\r\n        bestSurvivalYears: 0,\r\n        balancedCities: 0,\r\n        smartSettlements: 0,\r\n        rewardHistory: []\r\n    };\r\n}\r\n\r\n/** Update stats after episode */\r\nexport function updateStats(\r\n    stats: QLearningStats,\r\n    episodeReward: number,\r\n    finalPop: number,\r\n    yearsSurvived: number,\r\n    wasBalanced: boolean,\r\n    wasSmartSettlement: boolean\r\n): void {\r\n    stats.episode++;\r\n    stats.gamesPlayed++;\r\n    stats.totalReward += episodeReward;\r\n    stats.episodeRewards.push(episodeReward);\r\n    \r\n    // Keep only last 100 episode rewards\r\n    if (stats.episodeRewards.length > 100) {\r\n        stats.episodeRewards.shift();\r\n    }\r\n    \r\n    // Update best scores\r\n    if (episodeReward > stats.bestScore) {\r\n        stats.bestScore = episodeReward;\r\n    }\r\n    if (finalPop > stats.bestPopulation) {\r\n        stats.bestPopulation = finalPop;\r\n    }\r\n    if (yearsSurvived > stats.bestSurvivalYears) {\r\n        stats.bestSurvivalYears = yearsSurvived;\r\n    }\r\n    \r\n    // Track special achievements\r\n    if (wasBalanced) stats.balancedCities++;\r\n    if (wasSmartSettlement) stats.smartSettlements++;\r\n    \r\n    // Update reward history for graphing\r\n    stats.rewardHistory.push(episodeReward);\r\n    if (stats.rewardHistory.length > 20) {\r\n        stats.rewardHistory.shift();\r\n    }\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// CURRICULUM LEARNING\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Determine learning phase based on progress */\r\nexport function determineLearningPhase(\r\n    citiesBuilt: number,\r\n    balancedCities: number,\r\n    phase1Threshold: number = 10,\r\n    phase2Threshold: number = 5\r\n): LearningPhase {\r\n    // Phase 1: Learn to survive WANDER and settle\r\n    if (citiesBuilt < phase1Threshold) return 1;\r\n    \r\n    // Phase 2: Learn to build balanced cities\r\n    if (balancedCities < phase2Threshold) return 2;\r\n    \r\n    // Phase 3: Advanced optimization\r\n    return 3;\r\n}\r\n\r\n/** Get exploration rate for current phase */\r\nexport function getPhaseExplorationRate(\r\n    phase: LearningPhase,\r\n    baseRate: number,\r\n    episode: number\r\n): number {\r\n    // Higher exploration in early phases\r\n    const phaseBonus = (3 - phase) * 0.1;\r\n    const decayedRate = baseRate * Math.pow(0.99, episode);\r\n    return Math.max(0.1, decayedRate + phaseBonus);\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// DEATH TRACKING\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Track death cause */\r\nexport function recordDeath(\r\n    deaths: DeathRecord[],\r\n    cause: DeathCause,\r\n    year: number,\r\n    pop: number,\r\n    state: string,\r\n    maxRecords: number = 100\r\n): void {\r\n    deaths.push({ cause, year, pop, state });\r\n    \r\n    if (deaths.length > maxRecords) {\r\n        deaths.shift();\r\n    }\r\n}\r\n\r\n/** Analyze death patterns */\r\nexport function analyzeDeaths(deaths: DeathRecord[]): {\r\n    mostCommon: DeathCause;\r\n    thirstDeaths: number;\r\n    starvationDeaths: number;\r\n    avgYearOfDeath: number;\r\n} {\r\n    const counts: Record<DeathCause, number> = {\r\n        thirst: 0,\r\n        starvation: 0,\r\n        collapse: 0,\r\n        unknown: 0\r\n    };\r\n    \r\n    let totalYears = 0;\r\n    \r\n    for (const death of deaths) {\r\n        counts[death.cause]++;\r\n        totalYears += death.year;\r\n    }\r\n    \r\n    const mostCommon = (Object.entries(counts) as [DeathCause, number][])\r\n        .sort((a, b) => b[1] - a[1])[0][0];\r\n    \r\n    return {\r\n        mostCommon,\r\n        thirstDeaths: counts.thirst,\r\n        starvationDeaths: counts.starvation,\r\n        avgYearOfDeath: deaths.length > 0 ? totalYears / deaths.length : 0\r\n    };\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// PERSISTENCE\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Save Q-table to localStorage */\r\nexport function saveQTable(qTable: QTable, key: string = 'civil_zones_qtable'): void {\r\n    try {\r\n        const json = JSON.stringify(qTable);\r\n        localStorage.setItem(key, json);\r\n    } catch (e) {\r\n        console.warn('Failed to save Q-table:', e);\r\n    }\r\n}\r\n\r\n/** Load Q-table from localStorage */\r\nexport function loadQTable(key: string = 'civil_zones_qtable'): QTable | null {\r\n    try {\r\n        const json = localStorage.getItem(key);\r\n        if (json) {\r\n            return JSON.parse(json);\r\n        }\r\n    } catch (e) {\r\n        console.warn('Failed to load Q-table:', e);\r\n    }\r\n    return null;\r\n}\r\n\r\n/** Export Q-table to JSON file */\r\nexport function exportQTableToFile(qTable: QTable, stats: QLearningStats): void {\r\n    const data = {\r\n        qTable,\r\n        stats,\r\n        exportedAt: new Date().toISOString(),\r\n        version: '1.0'\r\n    };\r\n    \r\n    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });\r\n    const url = URL.createObjectURL(blob);\r\n    \r\n    const a = document.createElement('a');\r\n    a.href = url;\r\n    a.download = `civil_zones_ai_brain_${Date.now()}.json`;\r\n    a.click();\r\n    \r\n    URL.revokeObjectURL(url);\r\n}\r\n\r\n/** Import Q-table from file */\r\nexport async function importQTableFromFile(file: File): Promise<{ qTable: QTable; stats?: QLearningStats } | null> {\r\n    try {\r\n        const text = await file.text();\r\n        const data = JSON.parse(text);\r\n        \r\n        if (data.qTable) {\r\n            return { qTable: data.qTable, stats: data.stats };\r\n        }\r\n        \r\n        // Legacy format: just the Q-table\r\n        return { qTable: data };\r\n    } catch (e) {\r\n        console.error('Failed to import Q-table:', e);\r\n        return null;\r\n    }\r\n}\r\n","/**\r\n * Civil Zones - AI Strategies\r\n * Build strategies and macro playbooks for AI\r\n */\r\n\r\nimport type { \r\n    MacroPlaybook, \r\n    MacroStep, \r\n    TacticStats, \r\n    AIAction,\r\n    AIGameState,\r\n    SequenceStrategy,\r\n    RatioStrategy,\r\n    BuildRatio\r\n} from './types.js';\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// MACRO PLAYBOOKS\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Default macro playbooks for city building */\r\nexport const DEFAULT_PLAYBOOKS: MacroPlaybook[] = [\r\n    {\r\n        id: 'early_twin_res',\r\n        name: 'Twin Huts Opener',\r\n        steps: [\r\n            { action: 'BUILD_RES' },\r\n            { action: 'BUILD_RES', waitYears: 2 },\r\n            { action: 'BUILD_ROAD', waitYears: 1 },\r\n            { action: 'BUILD_WELL', waitYears: 2 },\r\n            { action: 'BUILD_ROAD', waitYears: 1 },\r\n            { action: 'BUILD_RES', waitYears: 2 }\r\n        ]\r\n    },\r\n    {\r\n        id: 'water_buffer',\r\n        name: 'Water Buffer Start',\r\n        steps: [\r\n            { action: 'BUILD_WELL' },\r\n            { action: 'BUILD_RES', waitYears: 1 },\r\n            { action: 'BUILD_RES', waitYears: 2 },\r\n            { action: 'BUILD_ROAD', waitYears: 1 },\r\n            { action: 'BUILD_RES', waitYears: 2, requirePop: 12 },\r\n            { action: 'BUILD_COM', waitYears: 1, minYear: 3, requireDemand: 'C' }\r\n        ]\r\n    },\r\n    {\r\n        id: 'wood_stack',\r\n        name: 'Wood Stockpile First',\r\n        steps: [\r\n            { action: 'PASS_YEAR', waitYears: 1 },\r\n            { action: 'PASS_YEAR', waitYears: 1 },\r\n            { action: 'BUILD_ROAD' },\r\n            { action: 'BUILD_ROAD', waitYears: 1 },\r\n            { action: 'BUILD_RES', waitYears: 2 },\r\n            { action: 'BUILD_WELL', waitYears: 2 }\r\n        ]\r\n    },\r\n    {\r\n        id: 'tutorial_clone',\r\n        name: 'Tutorial Clone',\r\n        steps: [\r\n            { action: 'BUILD_RES' },\r\n            { action: 'BUILD_ROAD' },\r\n            { action: 'BUILD_ROAD' },\r\n            { action: 'BUILD_WELL', waitYears: 2 },\r\n            { action: 'PASS_YEAR', waitYears: 7 },\r\n            { action: 'BUILD_RES' },\r\n            { action: 'BUILD_COM' },\r\n            { action: 'BUILD_ROAD' }\r\n        ]\r\n    },\r\n    {\r\n        id: 'satisfaction_ladder',\r\n        name: 'Satisfaction Ladder',\r\n        steps: [\r\n            { action: 'BUILD_WELL', requireNeeds: ['water'] },\r\n            { action: 'BUILD_RES', requireNeeds: ['housing'], waitYears: 1 },\r\n            { action: 'BUILD_RES', requireNeeds: ['housing'], waitYears: 2 },\r\n            { action: 'BUILD_COM', requireDemand: 'C', waitYears: 1 },\r\n            { action: 'BUILD_ROAD', waitYears: 1 }\r\n        ]\r\n    },\r\n    {\r\n        id: 'industrial_threshold',\r\n        name: 'Industrial Threshold',\r\n        steps: [\r\n            { action: 'BUILD_RES' },\r\n            { action: 'BUILD_COM', waitYears: 2 },\r\n            { action: 'BUILD_ROAD', waitYears: 1 },\r\n            { action: 'BUILD_IND', requirePop: 25, requireFood: 1000, requireWood: 1000, waitYears: 5 },\r\n            { action: 'BUILD_ROAD', waitYears: 1 }\r\n        ]\r\n    },\r\n    {\r\n        id: 'balanced_pairing',\r\n        name: 'Balanced Pairing',\r\n        steps: [\r\n            { action: 'BUILD_RES' },\r\n            { action: 'BUILD_ROAD' },\r\n            { action: 'BUILD_WELL', waitYears: 1 },\r\n            { action: 'BUILD_RES', waitYears: 2 },\r\n            { action: 'BUILD_ROAD', waitYears: 1 },\r\n            { action: 'BUILD_WELL', waitYears: 1 }\r\n        ]\r\n    }\r\n];\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// SEQUENCE STRATEGIES\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Starter sequence strategy */\r\nexport const STARTER_STRATEGY: SequenceStrategy = {\r\n    name: 'Starter',\r\n    sequence: [\r\n        { type: 'RES', count: 1 },\r\n        { type: 'WELL', count: 1 },\r\n        { type: 'ROAD', count: 2 },\r\n        { type: 'WAIT', years: 8 },\r\n        { type: 'RES', count: 1 },\r\n        { type: 'WAIT', years: 5 },\r\n        { type: 'RES', count: 1 },\r\n        { type: 'WAIT', years: 5 },\r\n        { type: 'COM', count: 2 },\r\n        { type: 'ROAD', count: 2 },\r\n        { type: 'IND', count: 2 },\r\n        { type: 'ROAD', count: 2 }\r\n    ],\r\n    step: 0,\r\n    subStep: 0,\r\n    waitStartYear: 0\r\n};\r\n\r\n/** Balanced ratio strategy */\r\nexport const BALANCED_STRATEGY: RatioStrategy = {\r\n    name: 'Balanced',\r\n    ratio: { R: 4, C: 1, I: 2 },\r\n    roadsPerBuilding: 0.5\r\n};\r\n\r\n/** Housing-heavy ratio strategy */\r\nexport const HOUSING_HEAVY_STRATEGY: RatioStrategy = {\r\n    name: 'Housing Heavy',\r\n    ratio: { R: 6, C: 1, I: 1 },\r\n    roadsPerBuilding: 0.3\r\n};\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// TACTIC SELECTION\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Initialize tactic stats for playbooks */\r\nexport function initTacticStats(playbooks: MacroPlaybook[]): Record<string, TacticStats> {\r\n    const stats: Record<string, TacticStats> = {};\r\n    for (const pb of playbooks) {\r\n        stats[pb.id] = {\r\n            attempts: 0,\r\n            successes: 0,\r\n            totalYears: 0,\r\n            maxPop: 0,\r\n            avgScore: 0\r\n        };\r\n    }\r\n    return stats;\r\n}\r\n\r\n/** Select a tactic using weighted random based on success rate */\r\nexport function selectTactic(\r\n    playbooks: MacroPlaybook[],\r\n    tacticStats: Record<string, TacticStats>,\r\n    episode: number,\r\n    strategicChance: number = 0.7\r\n): MacroPlaybook | null {\r\n    if (!playbooks || playbooks.length === 0) return null;\r\n    \r\n    let candidates = [...playbooks];\r\n    \r\n    // After 10 episodes, 70% chance to pick strategically\r\n    if (Math.random() < strategicChance && episode > 10) {\r\n        // Sort by success rate + average score\r\n        candidates.sort((a, b) => {\r\n            const statsA = tacticStats[a.id] || { attempts: 0, avgScore: 0, successes: 0 };\r\n            const statsB = tacticStats[b.id] || { attempts: 0, avgScore: 0, successes: 0 };\r\n            const scoreA = statsA.attempts > 0 \r\n                ? (statsA.successes / statsA.attempts * 100 + statsA.avgScore) \r\n                : 50;\r\n            const scoreB = statsB.attempts > 0 \r\n                ? (statsB.successes / statsB.attempts * 100 + statsB.avgScore) \r\n                : 50;\r\n            return scoreB - scoreA;\r\n        });\r\n        \r\n        // Pick from top 5 with weighted random\r\n        const topN = candidates.slice(0, Math.min(5, candidates.length));\r\n        const weights = topN.map((_, i) => Math.pow(0.6, i));\r\n        const totalWeight = weights.reduce((a, b) => a + b, 0);\r\n        \r\n        let r = Math.random() * totalWeight;\r\n        let cumulative = 0;\r\n        \r\n        for (let i = 0; i < topN.length; i++) {\r\n            cumulative += weights[i];\r\n            if (r <= cumulative) {\r\n                return topN[i];\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Random exploration\r\n    return candidates[Math.floor(Math.random() * candidates.length)];\r\n}\r\n\r\n/** Record tactic success/failure */\r\nexport function recordTacticResult(\r\n    tacticStats: Record<string, TacticStats>,\r\n    tacticId: string,\r\n    year: number,\r\n    pop: number,\r\n    successThreshold: { minYear: number; minPop: number } = { minYear: 5, minPop: 10 }\r\n): void {\r\n    const stats = tacticStats[tacticId];\r\n    if (!stats) return;\r\n    \r\n    // Count as success if survived threshold\r\n    if (year >= successThreshold.minYear && pop >= successThreshold.minPop) {\r\n        stats.successes++;\r\n    }\r\n    \r\n    stats.totalYears += year;\r\n    stats.maxPop = Math.max(stats.maxPop, pop);\r\n    stats.avgScore = stats.attempts > 0 \r\n        ? Math.round((stats.totalYears / stats.attempts) * 10 + stats.maxPop) \r\n        : 0;\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// MACRO STEP EVALUATION\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Check if macro step conditions are met */\r\nexport function macroConditionsMet(step: MacroStep, context: AIGameState & { year: number }): boolean {\r\n    if (!step) return false;\r\n    \r\n    if (step.minYear !== undefined && context.year < step.minYear) return false;\r\n    if (step.maxYear !== undefined && context.year > step.maxYear) return false;\r\n    if (step.requirePop !== undefined && context.pop < step.requirePop) return false;\r\n    if (step.requireDemand && context.highestDemand !== step.requireDemand) return false;\r\n    \r\n    if (step.requireNeeds) {\r\n        for (const need of step.requireNeeds) {\r\n            if (need === 'water' && !context.isThirsty) return false;\r\n            if (need === 'food' && !context.isStarving) return false;\r\n            if (need === 'housing' && !context.needsHousing) return false;\r\n        }\r\n    }\r\n    \r\n    if (step.requireHousingNearFull && !context.needsHousing) return false;\r\n    if (step.requireHomeless && context.homeless < step.requireHomeless) return false;\r\n    if (step.requireWorkerShortage === true && !context.workerShortage) return false;\r\n    if (step.requireWorkerShortage === false && context.workerShortage) return false;\r\n    if (step.requireFood && context.food < step.requireFood) return false;\r\n    if (step.requireWood && context.wood < step.requireWood) return false;\r\n    if (step.requireFoodPerPop && (context.pop === 0 || (context.food / Math.max(1, context.pop)) < step.requireFoodPerPop)) return false;\r\n    \r\n    return true;\r\n}\r\n\r\n/** Resolve BUILD_DEMAND to actual action */\r\nexport function resolveMacroAction(step: MacroStep, context: AIGameState): AIAction | null {\r\n    if (!step) return null;\r\n    \r\n    if (step.action === 'BUILD_DEMAND') {\r\n        if (context.highestDemand === 'R') return 'BUILD_RES';\r\n        if (context.highestDemand === 'C') return 'BUILD_COM';\r\n        return 'BUILD_IND';\r\n    }\r\n    \r\n    return step.action as AIAction;\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// RATIO STRATEGY\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Get next build type based on ratio strategy */\r\nexport function getNextBuildFromRatio(\r\n    ratio: BuildRatio,\r\n    resCount: number,\r\n    comCount: number,\r\n    indCount: number\r\n): 'RES' | 'COM' | 'IND' {\r\n    const total = ratio.R + ratio.C + ratio.I;\r\n    const targetR = ratio.R / total;\r\n    const targetC = ratio.C / total;\r\n    \r\n    const currentTotal = resCount + comCount + indCount || 1;\r\n    const currentR = resCount / currentTotal;\r\n    const currentC = comCount / currentTotal;\r\n    \r\n    // Build what's most below target ratio\r\n    const rDelta = targetR - currentR;\r\n    const cDelta = targetC - currentC;\r\n    const iDelta = (1 - targetR - targetC) - (1 - currentR - currentC);\r\n    \r\n    if (rDelta >= cDelta && rDelta >= iDelta) return 'RES';\r\n    if (cDelta >= iDelta) return 'COM';\r\n    return 'IND';\r\n}\r\n\r\n/** Check if city is balanced (all 3 zone types present in reasonable ratio) */\r\nexport function isCityBalanced(resCount: number, comCount: number, indCount: number): boolean {\r\n    const total = resCount + comCount + indCount;\r\n    if (total < 6) return false; // Need at least 6 buildings\r\n    \r\n    const minRatio = 0.1; // Each type should be at least 10%\r\n    return (\r\n        resCount / total >= minRatio &&\r\n        comCount / total >= minRatio &&\r\n        indCount / total >= minRatio\r\n    );\r\n}\r\n","/**\r\n * Civil Zones - AI Exploration\r\n * Exploration and pathfinding helpers for AI\r\n */\r\n\r\nimport type { AITarget, ExploreStats, DeathLocation } from './types.js';\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// TARGET FINDING\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\ninterface GameLike {\r\n    player?: { x: number; y: number };\r\n    tiles?: any[][];\r\n}\r\n\r\n/** Priority values for different targets */\r\nexport const TARGET_PRIORITY = {\r\n    WATER: 100,   // Water is critical when thirsty\r\n    BERRY: 80,    // Berries are high priority\r\n    ANIMAL: 60,   // Animals provide food but cost pop\r\n    NOMAD: 70,    // Recruiting nomads\r\n    EXPLORE: 20   // Default exploration\r\n};\r\n\r\n/** Find best target in range */\r\nexport function findBestTarget(\r\n    game: GameLike,\r\n    searchRadius: number = 15,\r\n    isThirsty: boolean = false\r\n): AITarget | null {\r\n    if (!game.player || !game.tiles) return null;\r\n    \r\n    const px = game.player.x;\r\n    const py = game.player.y;\r\n    const width = game.tiles.length;\r\n    const height = game.tiles[0]?.length || 0;\r\n    \r\n    let bestTarget: AITarget | null = null;\r\n    let bestScore = -Infinity;\r\n    \r\n    for (let dx = -searchRadius; dx <= searchRadius; dx++) {\r\n        for (let dy = -searchRadius; dy <= searchRadius; dy++) {\r\n            const x = px + dx;\r\n            const y = py + dy;\r\n            \r\n            if (x < 0 || x >= width || y < 0 || y >= height) continue;\r\n            \r\n            const tile = game.tiles[x][y];\r\n            if (!tile?.explored) continue;\r\n            \r\n            const distance = Math.abs(dx) + Math.abs(dy);\r\n            let target: AITarget | null = null;\r\n            \r\n            // Check for water (high priority when thirsty)\r\n            if ((tile.type === 'WATER' || tile.type === 'RIVER') && isThirsty) {\r\n                target = { x, y, type: 'WATER', priority: TARGET_PRIORITY.WATER, distance };\r\n            }\r\n            // Check for berries\r\n            else if (tile.berry) {\r\n                target = { x, y, type: 'BERRY', priority: TARGET_PRIORITY.BERRY, distance };\r\n            }\r\n            // Check for animals\r\n            else if (tile.animal) {\r\n                target = { x, y, type: 'ANIMAL', priority: TARGET_PRIORITY.ANIMAL, distance };\r\n            }\r\n            // Check for nomads\r\n            else if (tile.nomad) {\r\n                target = { x, y, type: 'NOMAD', priority: TARGET_PRIORITY.NOMAD, distance };\r\n            }\r\n            \r\n            if (target) {\r\n                // Score based on priority and distance (closer is better)\r\n                const score = target.priority - distance * 2;\r\n                if (score > bestScore) {\r\n                    bestScore = score;\r\n                    bestTarget = target;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    return bestTarget;\r\n}\r\n\r\n/** Find unexplored tile to explore */\r\nexport function findExploreTarget(\r\n    game: GameLike,\r\n    searchRadius: number = 20,\r\n    avoidDanger: Set<string> | null = null\r\n): AITarget | null {\r\n    if (!game.player || !game.tiles) return null;\r\n    \r\n    const px = game.player.x;\r\n    const py = game.player.y;\r\n    const width = game.tiles.length;\r\n    const height = game.tiles[0]?.length || 0;\r\n    \r\n    // Find nearest unexplored tile\r\n    for (let radius = 1; radius <= searchRadius; radius++) {\r\n        const candidates: AITarget[] = [];\r\n        \r\n        for (let dx = -radius; dx <= radius; dx++) {\r\n            for (let dy = -radius; dy <= radius; dy++) {\r\n                // Only check perimeter\r\n                if (Math.abs(dx) !== radius && Math.abs(dy) !== radius) continue;\r\n                \r\n                const x = px + dx;\r\n                const y = py + dy;\r\n                \r\n                if (x < 0 || x >= width || y < 0 || y >= height) continue;\r\n                \r\n                const tile = game.tiles[x][y];\r\n                \r\n                // Skip explored tiles\r\n                if (tile?.explored) continue;\r\n                \r\n                // Skip water tiles (can't walk on them)\r\n                if (tile?.type === 'WATER' || tile?.type === 'DEEP') continue;\r\n                \r\n                // Avoid danger zones if provided\r\n                const key = `${x},${y}`;\r\n                if (avoidDanger?.has(key)) continue;\r\n                \r\n                const distance = Math.abs(dx) + Math.abs(dy);\r\n                candidates.push({\r\n                    x, y,\r\n                    type: 'EXPLORE',\r\n                    priority: TARGET_PRIORITY.EXPLORE,\r\n                    distance\r\n                });\r\n            }\r\n        }\r\n        \r\n        if (candidates.length > 0) {\r\n            // Pick random from candidates at this radius\r\n            return candidates[Math.floor(Math.random() * candidates.length)];\r\n        }\r\n    }\r\n    \r\n    return null;\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// EXPLORATION STATISTICS\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Create initial exploration stats */\r\nexport function createExploreStats(): ExploreStats {\r\n    return {\r\n        tilesVisited: new Set(),\r\n        totalTiles: 0,\r\n        resourcesCollected: 0,\r\n        berriesCollected: 0,\r\n        woodCollected: 0,\r\n        nomadsRecruited: 0,\r\n        animalsHunted: 0,\r\n        deaths: 0,\r\n        totalSteps: 0,\r\n        stepsThisRun: 0,\r\n        runsCompleted: 0,\r\n        deathLocations: [],\r\n        dangerZones: {},\r\n        startTime: null\r\n    };\r\n}\r\n\r\n/** Record tile visit */\r\nexport function recordTileVisit(stats: ExploreStats, x: number, y: number): void {\r\n    const key = `${x},${y}`;\r\n    stats.tilesVisited.add(key);\r\n    stats.totalSteps++;\r\n    stats.stepsThisRun++;\r\n}\r\n\r\n/** Record death during exploration */\r\nexport function recordExplorationDeath(\r\n    stats: ExploreStats,\r\n    x: number,\r\n    y: number,\r\n    cause: string\r\n): void {\r\n    stats.deaths++;\r\n    stats.runsCompleted++;\r\n    \r\n    const location: DeathLocation = {\r\n        x, y,\r\n        cause,\r\n        steps: stats.stepsThisRun\r\n    };\r\n    stats.deathLocations.push(location);\r\n    \r\n    // Track danger zone\r\n    const key = `${x},${y}`;\r\n    stats.dangerZones[key] = (stats.dangerZones[key] || 0) + 1;\r\n    \r\n    // Reset steps for next run\r\n    stats.stepsThisRun = 0;\r\n}\r\n\r\n/** Record resource collection */\r\nexport function recordResourceCollection(\r\n    stats: ExploreStats,\r\n    type: 'berry' | 'wood' | 'nomad' | 'animal',\r\n    amount: number = 1\r\n): void {\r\n    stats.resourcesCollected += amount;\r\n    \r\n    switch (type) {\r\n        case 'berry':\r\n            stats.berriesCollected += amount;\r\n            break;\r\n        case 'wood':\r\n            stats.woodCollected += amount;\r\n            break;\r\n        case 'nomad':\r\n            stats.nomadsRecruited += amount;\r\n            break;\r\n        case 'animal':\r\n            stats.animalsHunted += amount;\r\n            break;\r\n    }\r\n}\r\n\r\n/** Get exploration coverage percentage */\r\nexport function getExplorationCoverage(stats: ExploreStats): number {\r\n    if (stats.totalTiles === 0) return 0;\r\n    return (stats.tilesVisited.size / stats.totalTiles) * 100;\r\n}\r\n\r\n/** Get danger zones for avoidance */\r\nexport function getDangerZones(stats: ExploreStats, threshold: number = 2): Set<string> {\r\n    const dangers = new Set<string>();\r\n    \r\n    for (const [key, count] of Object.entries(stats.dangerZones)) {\r\n        if (count >= threshold) {\r\n            dangers.add(key);\r\n        }\r\n    }\r\n    \r\n    return dangers;\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// MOVEMENT TRACKING\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Track movement history to detect stuck states */\r\nexport class MovementTracker {\r\n    private history: string[] = [];\r\n    private maxHistory: number;\r\n    \r\n    constructor(maxHistory: number = 20) {\r\n        this.maxHistory = maxHistory;\r\n    }\r\n    \r\n    /** Record a move */\r\n    record(x: number, y: number): void {\r\n        const key = `${x},${y}`;\r\n        this.history.push(key);\r\n        \r\n        if (this.history.length > this.maxHistory) {\r\n            this.history.shift();\r\n        }\r\n    }\r\n    \r\n    /** Check if position was recently visited */\r\n    wasRecentlyVisited(x: number, y: number, lookback: number = 10): boolean {\r\n        const key = `${x},${y}`;\r\n        const recent = this.history.slice(-lookback, -1);\r\n        return recent.includes(key);\r\n    }\r\n    \r\n    /** Get repetition penalty for current position */\r\n    getRepetitionPenalty(x: number, y: number): number {\r\n        const key = `${x},${y}`;\r\n        let count = 0;\r\n        \r\n        for (const pos of this.history) {\r\n            if (pos === key) count++;\r\n        }\r\n        \r\n        return count;\r\n    }\r\n    \r\n    /** Check if stuck in a loop */\r\n    isStuck(): boolean {\r\n        if (this.history.length < 10) return false;\r\n        \r\n        // Check if last 10 moves are all the same few tiles\r\n        const recent = new Set(this.history.slice(-10));\r\n        return recent.size <= 3;\r\n    }\r\n    \r\n    /** Clear history */\r\n    clear(): void {\r\n        this.history = [];\r\n    }\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════════════════\r\n// RANDOM EXPLORATION\r\n// ═══════════════════════════════════════════════════════════════════\r\n\r\n/** Get random adjacent direction */\r\nexport function getRandomDirection(): { dx: number; dy: number } {\r\n    const directions = [\r\n        { dx: 0, dy: -1 },  // North\r\n        { dx: 1, dy: 0 },   // East\r\n        { dx: 0, dy: 1 },   // South\r\n        { dx: -1, dy: 0 }   // West\r\n    ];\r\n    return directions[Math.floor(Math.random() * directions.length)];\r\n}\r\n\r\n/** Get weighted random direction (prefers unexplored) */\r\nexport function getWeightedDirection(\r\n    game: GameLike,\r\n    tracker: MovementTracker\r\n): { dx: number; dy: number } {\r\n    if (!game.player || !game.tiles) {\r\n        return getRandomDirection();\r\n    }\r\n    \r\n    const px = game.player.x;\r\n    const py = game.player.y;\r\n    const width = game.tiles.length;\r\n    const height = game.tiles[0]?.length || 0;\r\n    \r\n    const directions = [\r\n        { dx: 0, dy: -1, weight: 1 },  // North\r\n        { dx: 1, dy: 0, weight: 1 },   // East\r\n        { dx: 0, dy: 1, weight: 1 },   // South\r\n        { dx: -1, dy: 0, weight: 1 }   // West\r\n    ];\r\n    \r\n    // Adjust weights based on tile state\r\n    for (const dir of directions) {\r\n        const nx = px + dir.dx;\r\n        const ny = py + dir.dy;\r\n        \r\n        if (nx < 0 || nx >= width || ny < 0 || ny >= height) {\r\n            dir.weight = 0;\r\n            continue;\r\n        }\r\n        \r\n        const tile = game.tiles[nx][ny];\r\n        \r\n        // Can't walk on water\r\n        if (tile?.type === 'WATER' || tile?.type === 'DEEP') {\r\n            dir.weight = 0;\r\n            continue;\r\n        }\r\n        \r\n        // Prefer unexplored\r\n        if (!tile?.explored) {\r\n            dir.weight += 3;\r\n        }\r\n        \r\n        // Avoid recently visited\r\n        if (tracker.wasRecentlyVisited(nx, ny)) {\r\n            dir.weight = Math.max(0.1, dir.weight - 2);\r\n        }\r\n    }\r\n    \r\n    // Weighted random selection\r\n    const totalWeight = directions.reduce((sum, d) => sum + d.weight, 0);\r\n    if (totalWeight === 0) return getRandomDirection();\r\n    \r\n    let r = Math.random() * totalWeight;\r\n    for (const dir of directions) {\r\n        r -= dir.weight;\r\n        if (r <= 0) {\r\n            return { dx: dir.dx, dy: dir.dy };\r\n        }\r\n    }\r\n    \r\n    return directions[0];\r\n}\r\n"],"names":["DEFAULT_QLEARNING_PARAMS","AI_ACTIONS","AI_UPDATE_INTERVAL","BLUEPRINT_UPDATE_INTERVAL","readGameState","game","pop","food","wood","stone","metal","gold","year","housingCap","wells","b","resZones","comZones","indZones","roadCount","paths","t","waterCapacity","waterPercent","wellsNeeded","needsWells","needsHousing","housingNeeded","homeless","foodPerPerson","isStarving","isThirsty","rci","rDemand","cDemand","iDemand","highestDemand","workerShortage","readWanderState","thirst","thirstCounter","nearWater","checkNearWater","exploredTiles","countExploredTiles","distance","px","py","width","height","dx","dy","x","y","tile","findNearestWater","maxRadius","bestDist","bestPos","radius","dist","cx","cy","count","getCityExpansionStats","aiSettlementPos","origin","first","maxDist","roadFrontier","quadrants","manhattan","quad","diagnoseBlockers","state","blockers","getPopTierStrategy","getQ","qTable","action","updateQ","reward","nextState","params","currentQ","maxNextQ","a","newQ","pruneQTable","maxSize","states","stateScores","s","actions","values","maxQ","removeCount","getBestAction","availableActions","bestAction","bestQ","q","chooseActionEpsilonGreedy","explorationRate","encodeWanderState","stage","highestUnlock","popBucket","foodOK","woodOK","encodeCityState","bucket","value","bucketSize","maxBuckets","calculateReward","createStats","updateStats","stats","episodeReward","finalPop","yearsSurvived","wasBalanced","wasSmartSettlement","determineLearningPhase","citiesBuilt","balancedCities","phase1Threshold","phase2Threshold","getPhaseExplorationRate","phase","baseRate","episode","phaseBonus","decayedRate","recordDeath","deaths","cause","maxRecords","analyzeDeaths","counts","totalYears","death","saveQTable","key","json","e","loadQTable","exportQTableToFile","data","blob","url","importQTableFromFile","file","text","DEFAULT_PLAYBOOKS","STARTER_STRATEGY","BALANCED_STRATEGY","HOUSING_HEAVY_STRATEGY","initTacticStats","playbooks","pb","selectTactic","tacticStats","strategicChance","candidates","statsA","statsB","scoreA","topN","weights","_","i","totalWeight","r","cumulative","recordTacticResult","tacticId","successThreshold","macroConditionsMet","step","context","need","resolveMacroAction","getNextBuildFromRatio","ratio","resCount","comCount","indCount","total","targetR","targetC","currentTotal","currentR","currentC","rDelta","cDelta","iDelta","isCityBalanced","minRatio","TARGET_PRIORITY","findBestTarget","searchRadius","bestTarget","bestScore","target","score","findExploreTarget","avoidDanger","createExploreStats","recordTileVisit","recordExplorationDeath","location","recordResourceCollection","type","amount","getExplorationCoverage","getDangerZones","threshold","dangers","MovementTracker","maxHistory","lookback","pos","getRandomDirection","directions","getWeightedDirection","tracker","dir","nx","ny","sum","d"],"mappings":"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"}