function We(e,t){const o=[];for(let r=0;r<e.tiles.length;r++)for(let i=0;i<e.tiles[0].length;i++){const s=e.tiles[r][i];if(s.zone==="R"&&s.building){const l=s.building.level||1,c=t[l]||t[1],a=c?.capacity||20,d=c?.overflowCapacity||a+5;o.push({tile:s,cap:a,overflowCap:d})}}let n=e.pop;for(const r of o)r.tile?.building&&(r.tile.building.pop=0);o.sort((r,i)=>i.cap-r.cap);for(const r of o){const i=Math.min(r.cap,n);if(r.tile?.building&&(r.tile.building.pop=i),n-=i,n<=0)break}if(n>0)for(const r of o){const i=r.tile?.building?.pop||0,s=(r.overflowCap||r.cap)-i;if(s>0){const l=Math.min(s,n);if(r.tile?.building&&(r.tile.building.pop=(r.tile.building.pop||0)+l),n-=l,n<=0)break}}return n}function Be(e,t,o,n){const r=[],i=[];if(e.blds&&e.blds.length>0)for(const s of e.blds){if(s.t==="COM"){const l=s.lvl||1,a=o?.[l]?.capacity||s.capacity||l*10;r.push({bld:s,cap:a})}if(s.t==="IND"){const l=s.lvl||1,a=n?.[l]?.capacity||s.capacity||l*15;i.push({bld:s,cap:a})}}for(let s=0;s<e.tiles.length;s++)for(let l=0;l<e.tiles[0].length;l++){const c=e.tiles[s][l];if(c.zone==="C"&&c.building){const a=c.building.level||1,f=o?.[a]?.capacity||10;r.push({tile:c,cap:f})}if(c.zone==="I"&&c.building){const a=c.building.level||1,f=n?.[a]?.capacity||10;i.push({tile:c,cap:f})}}for(const s of r)s.bld&&(s.bld.pop=0),s.tile?.building&&(s.tile.building.pop=0);for(const s of i)s.bld&&(s.bld.pop=0),s.tile?.building&&(s.tile.building.pop=0);for(const s of r){const l=Math.min(s.cap,t);if(s.bld&&(s.bld.pop=l),s.tile?.building&&(s.tile.building.pop=l),t-=l,t<=0)break}for(const s of i){const l=Math.min(s.cap,t);if(s.bld&&(s.bld.pop=l),s.tile?.building&&(s.tile.building.pop=l),t-=l,t<=0)break}}function Pe(e,t,o,n,r){const l=t*2,c=Math.ceil(o/10)*1,a=e,d=Math.min(l,a);let f=a-d;const p=Math.min(c,f);f-=p;const N=Math.min(n,f);f-=N;const S=Math.min(r,f);f-=S;const h=f,R=l+c+n+r,u=Math.max(0,R-a);return{total:a,wellWorkers:d,roadWorkers:p,comWorkers:N,indWorkers:S,gatherers:h,wellsNeeded:l,roadsNeeded:c,comNeeded:n,indNeeded:r,shortage:u}}function $e(e,t,o){if(t===0)return 0;if(o&&o.length>=4){for(let r=o.length-1;r>=0;r--){const i=o[r];if(e>=i.min&&e<=i.max)return r}return 0}const n=e/t;return n===0?0:n<=.33?1:n<=.66?2:3}function ke(e,t){if(t&&t.length>=4){for(let o=t.length-1;o>=0;o--){const n=t[o];if(e>=n.min&&e<=n.max)return o}return 0}return e===0?0:e<=.3?1:e<=.7?2:3}const Ue=10,He=15,Ge=.5,xe=.5;function ge(e,t){const{residential:o,commercial:n,industrial:r}=e,{population:i,housingCapacity:s}=t,l=o+n+r,c=n*Ue+r*He,a=Math.max(0,i-c),d=s>0?(s-i)/s:0,f=Ye(l,o,n,r,i,s,d,c),p=Ve(o,n,r),N=je(o,n,r,i,a);return{r:U(f,0,100),c:U(p,0,100),i:U(N,0,100)}}function Ye(e,t,o,n,r,i,s,l){return e===0?100:s<.2&&l>r*.5?80:o+n>t*.5?60:r<i*.5?40:Math.max(10,50-t/Math.max(1,o+n)*10)}function Ve(e,t,o){if(e===0)return 10;if(t===0&&e>0)return 90;const n=t/e,r=o>0?t/o:0;if(n<.3&&o>0)return 70;if(r>2)return 20;const i=t/e;return Math.max(10,Math.min(80,(Ge-i)*100+50))}function je(e,t,o,n,r){if(e===0)return 10;if(o===0&&e>0)return 80;if(t>o*2)return 90;if(r>n*.3)return 70;const i=o/e;return Math.max(10,Math.min(80,(xe-i)*100+50))}const Ke={residential:"#4CAF50",commercial:"#2196F3",industrial:"#FF9800"};function ze(e,t=100){return U(e,0,100)/100*t}function Xe(e,t){const o=t>70?"High":t>40?"Medium":t>10?"Low":"None";return`${{r:"Residential",c:"Commercial",i:"Industrial"}[e]} Demand: ${o} (${Math.round(t)}%)`}function U(e,t,o){return Math.max(t,Math.min(o,e))}const Z=[{name:"Warm Interglacial",duration:100,seaLevel:3},{name:"Early Glaciation",duration:50,seaLevel:2.5},{name:"Ice Age Peak",duration:80,seaLevel:1.5},{name:"Glacial Melt",duration:30,seaLevel:3.5},{name:"Flood Period",duration:20,seaLevel:4},{name:"Stabilization",duration:50,seaLevel:3}],J={ENABLED:!0,UPDATE_INTERVAL_YEARS:100,SEA_LEVEL_MIN:1,SEA_LEVEL_MAX:6,FLOOD_WARNING_MARGIN:1,COST_THRESHOLD:4,COST_INCREASE_PER_LEVEL:.1,GEOLOGICAL_PERIODS:Z};function Ze(e=J){const t=e.GEOLOGICAL_PERIODS[0];return{currentSeaLevel:t.seaLevel,periodIndex:0,centuriesInPeriod:0,lastUpdateYear:0,tilesFlooded:0,tilesDrained:0,currentPeriodName:t.name,populationDrowned:0}}function Je(e,t,o){return e-t>=o}function qe(e,t){e.centuriesInPeriod++;const o=t[e.periodIndex];if(e.centuriesInPeriod>=o.duration){e.periodIndex=(e.periodIndex+1)%t.length,e.centuriesInPeriod=0;const n=t[e.periodIndex];return e.currentPeriodName=n.name,n}return null}function Qe(e,t,o){return e<t?Math.min(o.SEA_LEVEL_MAX,e+.1)-e:e>t?Math.max(o.SEA_LEVEL_MIN,e-.1)-e:0}function et(e,t,o){return e<=t+o&&e>t}function tt(e,t){return e>0&&e<t}function nt(e,t,o){return e>=t&&(o==="WATER"||o==="DEEP")&&e>1}function ot(e,t,o){let n,r;return e<t?(n="underwater",r="Underwater"):e<t+o?(n="danger",r="Flood risk! Build higher."):e<t+o*2?(n="warning",r="Low elevation - monitor water levels"):(n="safe",r="Safe elevation"),{elevation:e,seaLevel:t,status:n,description:r,floodRisk:n==="danger"||n==="warning"}}function rt(e,t,o){const n=Math.floor(e);return n<t?1:1+(n-t)*o}function st(e,t){const o=t.seaLevel;return o>e?{icon:"üåä",message:`${t.name} begins! Waters are rising as ice melts...`}:o<e?{icon:"‚ùÑÔ∏è",message:`${t.name} begins! Waters recede as glaciers grow...`}:{icon:"üåç",message:`${t.name} begins.`}}function it(e,t){return e>100?`üì∞ CATASTROPHE! ${e} perished in the great flood! The ${t} brought destruction. Where you build matters...`:e>20?`üåäüíÄ ${e} drowned in rising waters! Some areas may be safer than others...`:`üåä ${e} lost to rising waters. Perhaps higher ground would be wiser...`}function lt(e){switch(e.status){case"underwater":return"#1565C0";case"danger":return"#F44336";case"warning":return"#FF9800";case"safe":return"#4CAF50";default:return"#9E9E9E"}}const q={workersPerWell:2,workersPerRoadTile:.1,roadTilesPerWorker:10};function Q(){return{total:0,wellWorkers:0,roadWorkers:0,comWorkers:0,indWorkers:0,gatherers:0,wellsNeeded:0,roadsNeeded:0,comNeeded:0,indNeeded:0,shortage:0}}function at(e,t,o=q){const n=Q();n.wellsNeeded=t.wells*o.workersPerWell,n.roadsNeeded=Math.ceil(t.roadTiles/o.roadTilesPerWorker),n.comNeeded=t.commercialCapacity,n.indNeeded=t.industrialCapacity,n.total=e;let r=e;n.wellWorkers=Math.min(n.wellsNeeded,r),r-=n.wellWorkers,n.roadWorkers=Math.min(n.roadsNeeded,r),r-=n.roadWorkers,n.comWorkers=Math.min(n.comNeeded,r),r-=n.comWorkers,n.indWorkers=Math.min(n.indNeeded,r),r-=n.indWorkers,n.gatherers=r;const i=n.wellsNeeded+n.roadsNeeded+n.comNeeded+n.indNeeded;return n.shortage=Math.max(0,i-e),n}function ct(e){const t=e.wellsNeeded>0?e.wellWorkers/e.wellsNeeded:1,o=e.roadsNeeded>0?e.roadWorkers/e.roadsNeeded:1,n=e.comNeeded>0?e.comWorkers/e.comNeeded:1,r=e.indNeeded>0?e.indWorkers/e.indNeeded:1,i=e.wellsNeeded+e.roadsNeeded+e.comNeeded+e.indNeeded,s=e.wellWorkers+e.roadWorkers+e.comWorkers+e.indWorkers,l=i>0?s/i:1;return{wells:Math.min(1,t),roads:Math.min(1,o),commercial:Math.min(1,n),industrial:Math.min(1,r),overall:Math.min(1,l)}}function dt(e,t=1,o=1){const s=t*o;return{foodPerYear:e*5*s,woodPerYear:e*3*s,metalPerYear:e*.5*s}}function ft(e){return e.shortage>0?`Need ${e.shortage} more workers!`:e.gatherers===0&&e.total>0?"All workers assigned - no gatherers":e.gatherers>0?`${e.gatherers} gatherers available`:"No workers"}function ut(e){return e>=.9?"#4CAF50":e>=.7?"#8BC34A":e>=.5?"#FFC107":e>=.3?"#FF9800":"#F44336"}function pt(e){const t=[];return(e.wellWorkers>0||e.wellsNeeded>0)&&t.push(`Wells: ${e.wellWorkers}/${e.wellsNeeded}`),(e.roadWorkers>0||e.roadsNeeded>0)&&t.push(`Roads: ${e.roadWorkers}/${e.roadsNeeded}`),(e.comWorkers>0||e.comNeeded>0)&&t.push(`Commerce: ${e.comWorkers}/${e.comNeeded}`),(e.indWorkers>0||e.indNeeded>0)&&t.push(`Industry: ${e.indWorkers}/${e.indNeeded}`),e.gatherers>0&&t.push(`Gatherers: ${e.gatherers}`),t}const G={foodPerPop:1,waterPerPop:2},b={housing:.3,water:.25,food:.25,jobs:.15,paths:.05};function ht(){return{housing:{have:0,need:0,satisfied:1},water:{have:0,need:0,satisfied:1},food:{have:0,need:0,satisfied:1},jobs:{have:0,need:0,satisfied:1},paths:{have:0,need:0,satisfied:1},overall:1}}function ee(e,t){const o=e,n=Math.min(t,e),r=o>0?n/o:1;return{have:n,need:o,satisfied:Math.min(1,r)}}function te(e,t,o=G){const n=e*o.waterPerPop,r=Math.min(t,n),i=n>0?r/n:1;return{have:r,need:n,satisfied:Math.min(1,i)}}function ne(e,t,o=G){const n=e*o.foodPerPop,r=Math.min(t,n),i=n>0?r/n:1;return{have:r,need:n,satisfied:Math.min(1,i)}}function oe(e,t){const o=e,n=Math.min(t,e),r=o>0?n/o:1;return{have:n,need:o,satisfied:Math.min(1,r)}}function re(e,t,o=4){const n=e*o,r=t,i=n>0?Math.min(1,r/n):1;return{have:r,need:n,satisfied:i}}function se(e){const t=e.housing.satisfied*b.housing+e.water.satisfied*b.water+e.food.satisfied*b.food+e.jobs.satisfied*b.jobs+e.paths.satisfied*b.paths;return Math.min(1,Math.max(0,t))}function Et(e,t,o,n,r,i,s,l=G){const c={housing:ee(e,t),water:te(e,o,l),food:ne(e,n,l),jobs:oe(e,r),paths:re(i,s),overall:0};return c.overall=se(c),c}function Nt(e,t,o=.02,n=.05,r=.03){const i=t.overall;if(i>=.8){const s=o+(i-.8)*(n-o)/.2;return Math.floor(e*s)}else if(i>=.5){const s=o*(i-.5)/.3;return Math.floor(e*s)}else{if(i>=.3)return 0;{const s=r*(.3-i)/.3;return-Math.ceil(e*s)}}}function At(e){return e>=.9?"Excellent":e>=.7?"Good":e>=.5?"Fair":e>=.3?"Poor":"Critical"}function St(e){return e>=.9?"#4CAF50":e>=.7?"#8BC34A":e>=.5?"#FFC107":e>=.3?"#FF9800":"#F44336"}function Rt(e){const t=[["Housing",e.housing],["Water",e.water],["Food",e.food],["Jobs",e.jobs],["Paths",e.paths]];let o=null,n=1;for(const[r,i]of t)i.satisfied<n&&i.satisfied<.8&&(n=i.satisfied,o=[r,i]);return o?{name:o[0],need:o[1]}:null}function Ot(e){return`${Math.round(e.satisfied*100)}%`}function Mt(e){return e>=.9?"‚úÖ":e>=.7?"üü¢":e>=.5?"üü°":e>=.3?"üü†":"üî¥"}const Tn=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_ELEVATION_CONFIG:J,DEFAULT_GEOLOGICAL_PERIODS:Z,DEFAULT_RESOURCE_RATES:G,DEFAULT_WORKFORCE_CONFIG:q,DEMAND_COLORS:Ke,advanceGeologicalPeriod:qe,assignPopulationToResidential:We,assignPopulationToZones:Be,calculateActivityVariant:ke,calculateAllNeeds:Et,calculateBuildingVariant:$e,calculateFoodNeed:ne,calculateGathererProduction:dt,calculateHousingNeed:ee,calculateJobNeed:oe,calculateOverallSatisfaction:se,calculatePathNeed:re,calculatePopulationChange:Nt,calculateRCIDemand:ge,calculateSeaLevelChange:Qe,calculateWaterNeed:te,calculateWorkforce:Pe,calculateWorkforceAllocation:at,calculateWorkforceEfficiency:ct,createGeologyState:Ze,createNeedsState:ht,createWorkforceState:Q,formatNeedPercentage:Ot,formatWorkforceBreakdown:pt,getCriticalNeed:Rt,getDemandBarHeight:ze,getDemandDescription:Xe,getEfficiencyColor:ut,getElevationColor:lt,getElevationCostMultiplier:rt,getFloodWarningMessage:it,getNeedEmoji:Mt,getPeriodTransitionMessage:st,getSatisfactionColor:St,getSatisfactionLevel:At,getTileElevationInfo:ot,getWorkforceStatusText:ft,isFloodRisk:et,shouldDrain:nt,shouldFlood:tt,shouldUpdateGeology:Je},Symbol.toStringTag,{value:"Module"})),V={RES:{w:1,h:1},COM:{w:1,h:1},IND:{w:1,h:1},ROAD:{w:1,h:1},WELL:{w:1,h:1},CHIEF:{w:2,h:2},CLAN_CHIEF:{w:2,h:2},DOCK:{w:3,h:2},BASKET:{w:2,h:2},POTTERY:{w:2,h:2},GRANARY:{w:2,h:2},PALACE:{w:2,h:2},BULL:{w:1,h:1}},ie=["WELL","COM","IND","RES","ROAD"],_t=["CHIEF","CLAN_CHIEF","BASKET","POTTERY","GRANARY","PALACE"],It={MIN:.3,MAX:3,NO_ROAD_PENALTY:.5,DECAY_RATE:.01,WATER_BONUS_MAX:.3,FOREST_BONUS:.2},le={ROAD_ACCESS_BONUS:.3,NO_ROAD_PENALTY:.3,RES_WATER_BONUS:.2,RES_WELL_BONUS:.15,RES_TREE_BONUS:.1,RES_CLUSTER_BONUS:.05,RES_INDUSTRIAL_PENALTY:.2,COM_ROAD_JUNCTION_BONUS:.15,COM_RES_NEARBY_BONUS:.2,COM_ISOLATION_PENALTY:.2,COM_INDUSTRIAL_NEARBY:.1,IND_WATER_BONUS:.15,IND_FOREST_BONUS:.2,IND_STONE_BONUS:.25,IND_CLUSTER_BONUS:.1,IND_RES_NEARBY_PENALTY:.15,CHIEF_CULTURE_RADIUS:50,CHIEF_BONUS:.3};function ae(e){return V[e]||{w:1,h:1}}function ce(e){return ie.includes(e)}function mt(e,t){return t?.[e.t]?.size?t[e.t].size:ce(e.t)?{w:1,h:1}:e.t==="DOCK"?{w:3,h:2}:{w:2,h:2}}function de(e){const t=e.type;return t==="WATER"||t==="DEEP"||t==="RIVER"||t==="STONE"}function fe(e){return!e.explored}function Ct(e){return!!(e.zone||e.building||e.road)}function yt(e,t,o,n,r,i){return e>=0&&t>=0&&e+o<=r&&t+n<=i}function Tt(e,t,o,n,r,i){for(const s of r){const l=mt(s,i);if(e<s.x+l.w&&e+o>s.x&&t<s.y+l.h&&t+n>s.y)return!0}return!1}function Lt(e,t,o,n,r){const i=ae(r);if(!yt(o,n,i.w,i.h,t.W,t.H))return{valid:!1,reason:"Out of bounds"};for(let s=o;s<o+i.w;s++)for(let l=n;l<n+i.h;l++){const c=e.tiles[s][l];if(de(c))return{valid:!1,reason:"Can't build on water/stone"};if(fe(c))return{valid:!1,reason:"Cannot build in fog - explore first!"};if(c.stoneDeposit&&r!=="IND")return{valid:!1,reason:"Stone deposit blocking"};if(Ct(c))return{valid:!1,reason:"Space occupied"}}return Tt(o,n,i.w,i.h,e.blds,t.BUILDING_DB)?{valid:!1,reason:"Building overlap"}:{valid:!0}}function wt(e,t,o,n){if(o<0||o>=t.W||n<0||n>=t.H)return{valid:!1,reason:"Out of bounds"};const r=e.tiles[o]?.[n];return r?de(r)?{valid:!1,reason:"Can't build on water/stone"}:fe(r)?{valid:!1,reason:"Cannot build in fog - explore first!"}:r.stoneDeposit?{valid:!1,reason:"Stone deposit blocking"}:r.road?{valid:!1,reason:"Road already exists"}:{valid:!0}:{valid:!1,reason:"Invalid tile"}}function vt(e,t,o=!1){if(o){const n=(t.food||0)+(t.wood||0)+(t.stone||0)+(t.metal||0);return(e.res||0)>=n}return!(t.food&&e.food<t.food||t.wood&&e.wood<t.wood||t.stone&&(e.stone||0)<t.stone||t.metal&&(e.metal||0)<t.metal||t.gold&&(e.gold||0)<t.gold)}function bt(e,t){return t.food&&e.food<t.food?`Need ${t.food} Food`:t.wood&&e.wood<t.wood?`Need ${t.wood} Wood`:t.stone&&(e.stone||0)<t.stone?`Need ${t.stone} Stone`:t.metal&&(e.metal||0)<t.metal?`Need ${t.metal} Metal`:t.gold&&(e.gold||0)<t.gold?`Need ${t.gold} Gold`:null}function Dt(e,t,o=!1){if(o){const n=(t.food||0)+(t.wood||0)+(t.stone||0)+(t.metal||0);e.res=(e.res||0)-n}else t.food&&(e.food-=t.food),t.wood&&(e.wood-=t.wood),t.stone&&(e.stone=(e.stone||0)-t.stone),t.metal&&(e.metal=(e.metal||0)-t.metal),t.gold&&(e.gold=(e.gold||0)-t.gold)}function ue(e,t){if(!t?.ELEVATION_SYSTEM?.ENABLED)return 1;const o=t.ELEVATION_SYSTEM.COST_THRESHOLD||4,n=t.ELEVATION_SYSTEM.COST_INCREASE_PER_LEVEL||.1,r=Math.floor(e.elevation||0);return r<o?1:1+(r-o)*n}function Ft(e,t){const o=ue(e,t),n=Math.floor(e.elevation||0);return{multiplier:o,text:"",elevation:n}}function Wt(e,t){return{food:e.food?Math.ceil(e.food*t):void 0,wood:e.wood?Math.ceil(e.wood*t):void 0,stone:e.stone?Math.ceil(e.stone*t):void 0,metal:e.metal?Math.ceil(e.metal*t):void 0,gold:e.gold}}function Bt(e,t){const o=e.elevation||0;let n="safe",r="";return o<t?(n="underwater",r="Underwater"):o<t+1?(n="danger",r="Flood Risk! (coastal)"):o<t+2?(n="warning",r="Low ground"):o>=8?(n="high",r="Mountain peaks"):(n="safe",r="Safe elevation"),{elevation:o,seaLevel:Math.floor(t),status:n,description:r,heightAboveSea:o-Math.floor(t)}}function Pt(e,t){if(t==="DOCK"){if(!e.hasClanChief)return{met:!1,reason:"Build Clan Chief's Hut first!"};if(e.hasDock)return{met:!1,reason:"First Dock already built!"}}return t==="CLAN_CHIEF"&&e.hasClanChief?{met:!1,reason:"Clan Chief's Hut already built!"}:{met:!0}}function $t(e,t){return(e.pop||0)<t?{met:!1,reason:`Need ${t} Population`}:{met:!0}}function T(e,t,o,n,r,i,s){let l=0;for(let c=-n;c<=n;c++)for(let a=-n;a<=n;a++){if(c===0&&a===0)continue;const d=t+c,f=o+a;d>=0&&d<i&&f>=0&&f<s&&r(e[d][f])&&l++}return l}function F(e,t,o,n,r,i,s){return T(e,t,o,n,r,i,s)>0}function D(e,t,o,n){return Math.abs(e.x-t)+Math.abs(e.y-o)<=n}function j(e,t,o,n){return Math.sqrt(Math.pow(e.x-t,2)+Math.pow(e.y-o,2))<=n}function W(e,t,o,n,r){const i=t.ZONE_BONUSES||le;let s=1;const{tiles:l,blds:c}=e,{W:a,H:d}=t,f=T(l,o,n,1,u=>!!u.road,a,d);f>0?(s+=i.ROAD_ACCESS_BONUS,f>=3&&r==="C"&&(s+=i.COM_ROAD_JUNCTION_BONUS)):F(l,o,n,3,E=>!!E.road,a,d)||(s-=i.NO_ROAD_PENALTY),F(l,o,n,3,u=>u.type==="WATER"||u.type==="RIVER",a,d)&&(r==="R"?s+=i.RES_WATER_BONUS:r==="I"&&(s+=i.IND_WATER_BONUS)),c.some(u=>u.t==="WELL"&&D(u,o,n,3))&&r==="R"&&(s+=i.RES_WELL_BONUS);const S=T(l,o,n,2,u=>!!(u.tree||u.type==="FOREST"),a,d);if(S>0&&(r==="R"?s+=i.RES_TREE_BONUS:r==="I"&&(s+=i.IND_FOREST_BONUS*Math.min(S/3,1))),F(l,o,n,3,u=>u.type==="STONE"||!!u.stoneDeposit,a,d)&&r==="I"&&(s+=i.IND_STONE_BONUS),r==="R"){const u=T(l,o,n,1,A=>A.zone==="R",a,d);s+=u*i.RES_CLUSTER_BONUS,c.some(A=>A.t==="IND"&&D(A,o,n,2))&&(s-=i.RES_INDUSTRIAL_PENALTY)}if(r==="C"){const u=T(l,o,n,5,A=>A.zone==="R",a,d);u>=3?s+=i.COM_RES_NEARBY_BONUS:u===0&&(s-=i.COM_ISOLATION_PENALTY),c.some(A=>A.t==="IND"&&D(A,o,n,5))&&(s+=i.COM_INDUSTRIAL_NEARBY)}if(r==="I"){const u=c.filter(A=>A.t==="IND"&&D(A,o,n,2)).length;s+=u*i.IND_CLUSTER_BONUS,T(l,o,n,2,A=>A.zone==="R",a,d)>0&&(s-=i.IND_RES_NEARBY_PENALTY)}return c.some(u=>u.t==="CHIEF"&&j(u,o,n,i.CHIEF_CULTURE_RADIUS))&&(s+=i.CHIEF_BONUS),e.lockedResources&&(r==="R"&&e.lockedResources.residential&&(s+=.25),r==="C"&&e.lockedResources.commercial&&(s+=.25),r==="I"&&e.lockedResources.industrial&&(s+=.25)),Math.max(.3,Math.min(2.5,s))}function x(e,t,o,n,r){const{tiles:i}=e,{W:s,H:l}=t,c=[],a=[];T(i,o,n,1,h=>!!h.road,s,l)>0?c.push("üõ£Ô∏è Road Access"):a.push("‚ùå No Road"),F(i,o,n,3,h=>h.type==="WATER"||h.type==="RIVER",s,l)&&c.push("üíß Near Water");const p=W(e,t,o,n,r),N=Math.round((p-1)*100),S=N>=0?"+":"";return{bonuses:c,penalties:a,total:p,text:`${S}${N}% Efficiency`}}function kt(e,t,o,n,r=1,i=50,s=1.5){const{tiles:l,blds:c}=e,{W:a,H:d}=t;let f=1,p=0,N=!1,S=!1,h=!1;for(let M=-1;M<=r;M++)for(let _=-1;_<=r;_++){if(M===0&&_===0)continue;const I=o+M,m=n+_;if(I>=0&&I<a&&m>=0&&m<d){const L=l[I][m];L.zone==="R"&&p++,(L.tree||L.type==="FOREST")&&(N=!0)}}for(let M=-3;M<=3+r;M++)for(let _=-3;_<=3+r;_++){const I=o+M,m=n+_;if(I>=0&&I<a&&m>=0&&m<d){const L=l[I][m];(L.type==="WATER"||L.type==="RIVER")&&(S=!0)}}for(const M of c.filter(_=>_.t==="CHIEF"))if(j(M,o,n,i)){h=!0;break}const R=.15,u=.25,E=.35,A=.3;f+=p*R,N&&(f+=u),S&&(f+=E),h&&(f*=s);let O=!0;for(let M=-2;M<=2+r;M++){for(let _=-2;_<=2+r;_++){if(M===0&&_===0)continue;const I=o+M,m=n+_;if(I>=0&&I<a&&m>=0&&m<d&&l[I][m].zone){O=!1;break}if(c.find($=>I>=$.x&&I<$.x+2&&m>=$.y&&m<$.y+2)){O=!1;break}}if(!O)break}return O&&(f-=A),Math.max(.5,f)}function Ut(e){return e===0?.3:e===1?.5:e===2?.8:e===3?1:1.5}function Ht(e,t,o,n,r){let i=0;for(let s=-1;s<=1;s++)for(let l=-1;l<=1;l++){if(s===0&&l===0)continue;const c=t+s,a=o+l;c>=0&&c<n&&a>=0&&a<r&&e[c][a].zone==="R"&&i++}return i}function pe(e){return e.type==="WATER"||e.type==="DEEP"||e.type==="RIVER"||e.type==="STONE"}function B(e){return!(pe(e)||!e.explored||e.zone||e.building||e.road)}function Gt(e){return!(pe(e)||!e.explored||e.stoneDeposit||e.road)}function K(e,t=4,o=.1){const n=e.elevation??0;return n<=t?1:1+(n-t)*o}function he(e,t,o,n){const r=[],i=Math.abs(o-e),s=Math.abs(n-t),l=e<o?1:-1,c=t<n?1:-1;let a=i-s,d=e,f=t;for(;r.push({x:d,y:f}),!(d===o&&f===n);){const p=2*a;p>-s&&(a-=s,d+=l),p<i&&(a+=i,f+=c)}return r}function Ee(e,t,o,n,r=!1){if(o<0||o>=t.W||n<0||n>=t.H)return{success:!1,message:"Out of bounds"};const i=e.tiles[o]?.[n];if(!i)return{success:!1,message:"Invalid tile"};if(!Gt(i))return i.type==="WATER"||i.type==="DEEP"||i.type==="RIVER"||i.type==="STONE"?{success:!1,message:"Can't build on water/stone"}:i.explored?i.stoneDeposit?{success:!1,message:"Stone deposit blocking"}:i.road?{success:!1,message:"Road already exists"}:{success:!1,message:"Invalid spot for road"}:{success:!1,message:"Cannot build in fog - explore first!"};const s=t.COST.ROAD||1;return e.simcityMode&&(e.res||0)<s?{success:!1,message:`Need $${s} funds`}:!e.simcityMode&&e.food<s?{success:!1,message:`Need ${s} food`}:(i.road=!0,i.tree=!1,i.entity&&(i.entity=null),e.roadTileCount=(e.roadTileCount||0)+1,e.simcityMode?e.res=(e.res||0)-s:e.food-=s,{success:!0,message:"üõ£Ô∏è Road built",cost:{food:s,wood:0,stone:0}})}function xt(e,t,o,n,r,i){const s=he(o,n,r,i);let l=0;for(const a of s)Ee(e,t,a.x,a.y,!1).success&&l++;const c=l>0?`üõ£Ô∏è ${l} road tiles placed`:"‚ùå No roads placed";return{placed:l,total:s.length,message:c}}function gt(e,t,o,n,r=0){const i=e.tiles[o]?.[n];if(!i)return{success:!1,message:"‚ùå Invalid tile"};if(!B(i))return i.type==="WATER"||i.type==="DEEP"||i.type==="RIVER"?{success:!1,message:"‚ùå Can't build on water!"}:i.type==="STONE"?{success:!1,message:"‚ùå Can't build on stone mountains!"}:i.zone||i.building?{success:!1,message:"‚ùå Tile already has a building!"}:i.road?{success:!1,message:"‚ùå Can't build on roads!"}:{success:!1,message:"‚ùå Invalid Spot"};const s=t.BUILDING_LEVELS?.[r];if(!s)return{success:!1,message:"‚ùå Invalid building level!"};const l=K(i,4,.1),c=Math.ceil(s.food*l),a=Math.ceil((s.wood||0)*l),d=Math.ceil((s.stone||0)*l);if(e.food<c)return{success:!1,message:`Need ${c} Food for ${s.name}`};if(a>0&&e.wood<a)return{success:!1,message:`Need ${a} Wood for ${s.name}`};if(d>0&&e.stone<d)return{success:!1,message:`Need ${d} Stone for ${s.name}`};e.food-=c,a>0&&(e.wood-=a),d>0&&(e.stone-=d);const f=W(e,t,o,n,"R"),p=x(e,t,o,n,"R");return i.zone="R",i.building={level:r,growth:0,desirability:f,age:0,lastBirthYear:e.year||0,pop:0,capacity:s.capacity,variant:1},i.tree=!1,{success:!0,message:`üè† ${s.name} built! ${p.text} Cap: ${s.capacity}`,cost:{food:c,wood:a,stone:d},bonusText:p.text}}function Yt(e,t,o,n,r=0){const i=e.tiles[o]?.[n];if(!i)return{success:!1,message:"‚ùå Invalid tile"};if(!B(i))return{success:!1,message:"‚ùå Invalid placement"};const s=t.BUILDING_LEVELS?.[r];if(!s)return{success:!1,message:"‚ùå Invalid building level!"};const l=K(i,4,.1),c=Math.ceil(s.food*l),a=Math.ceil((s.wood||0)*l),d=Math.ceil((s.stone||0)*l);if(e.food<c)return{success:!1,message:`Need ${c} Food`};if(a>0&&e.wood<a)return{success:!1,message:`Need ${a} Wood`};if(d>0&&e.stone<d)return{success:!1,message:`Need ${d} Stone`};const f=W(e,t,o,n,"C"),p=x(e,t,o,n,"C");e.food-=c,a>0&&(e.wood-=a),d>0&&(e.stone-=d),i.tree=!1,e.blds.push({t:"COM",x:o,y:n,lvl:r,efficiency:f,age:0,variant:1});let N=`-${c} food, -${a} wood`;return d>0&&(N+=`, -${d} stone`),{success:!0,message:`üè™ ${s.name} built! ${p.text} (${N})`,cost:{food:c,wood:a,stone:d},bonusText:p.text}}function Vt(e,t,o,n,r=0){const i=e.tiles[o]?.[n];if(!i)return{success:!1,message:"‚ùå Invalid tile"};if(!B(i))return{success:!1,message:"‚ùå Invalid placement"};const s=t.BUILDING_LEVELS?.[r];if(!s)return{success:!1,message:"‚ùå Invalid building level!"};const l=K(i,4,.1),c=Math.ceil(s.food*l),a=Math.ceil((s.wood||0)*l),d=Math.ceil((s.stone||0)*l);if(e.food<c)return{success:!1,message:`Need ${c} Food`};if(a>0&&e.wood<a)return{success:!1,message:`Need ${a} Wood`};if(d>0&&e.stone<d)return{success:!1,message:`Need ${d} Stone`};const f=W(e,t,o,n,"I"),p=x(e,t,o,n,"I");e.food-=c,a>0&&(e.wood-=a),d>0&&(e.stone-=d),i.tree=!1,e.blds.push({t:"IND",x:o,y:n,lvl:r,efficiency:f,age:0,variant:1});let N=`-${c} food, -${a} wood`;return d>0&&(N+=`, -${d} stone`),{success:!0,message:`üè≠ ${s.name} built! ${p.text} (${N})`,cost:{food:c,wood:a,stone:d},bonusText:p.text}}function jt(e,t,o,n){const r=e.tiles[o]?.[n];if(!r)return{success:!1,message:"‚ùå Invalid tile"};if(!B(r))return{success:!1,message:"‚ùå Invalid placement"};const i=t.COST.WELL||5;return e.food<i?{success:!1,message:`Need ${i} Food for Well`}:(e.food-=i,r.tree=!1,e.blds.push({t:"WELL",x:o,y:n}),{success:!0,message:`üíß Well built! (-${i} food)`,cost:{food:i,wood:0,stone:0}})}function Kt(e,t,o,n,r,i,s=0,l=0){for(let a=0;a<2;a++)for(let d=0;d<2;d++){const f=o+a,p=n+d;if(f>=t.W||p>=t.H)return{success:!1,message:"‚ùå Building would extend beyond map!"};const N=e.tiles[f]?.[p];if(!N||!B(N))return{success:!1,message:"‚ùå Invalid placement for one or more tiles!"}}if(e.food<i)return{success:!1,message:`Need ${i} Food`};if(s>0&&e.wood<s)return{success:!1,message:`Need ${s} Wood`};if(l>0&&e.stone<l)return{success:!1,message:`Need ${l} Stone`};e.food-=i,s>0&&(e.wood-=s),l>0&&(e.stone-=l);for(let a=0;a<2;a++)for(let d=0;d<2;d++)e.tiles[o+a][n+d].tree=!1;e.blds.push({t:r,x:o,y:n});let c=`-${i} food`;return s>0&&(c+=`, -${s} wood`),l>0&&(c+=`, -${l} stone`),{success:!0,message:`${r} built! (${c})`,cost:{food:i,wood:s,stone:l}}}function zt(e,t,o,n){const r=e.tiles[o]?.[n];if(!r)return{success:!1,message:"Invalid tile"};if(r.road)return r.road=!1,e.roadTileCount=Math.max(0,(e.roadTileCount||0)-1),{success:!0,message:"üõ£Ô∏è Road demolished"};let i=-1;for(let s=0;s<e.blds.length;s++){const l=e.blds[s],c=l.t==="WELL"||l.t==="COM"||l.t==="IND"?1:2;if(o>=l.x&&o<l.x+c&&n>=l.y&&n<l.y+c){i=s;break}}if(i!==-1){const s=e.blds[i];return e.blds.splice(i,1),{success:!0,message:`üî® ${s.t} demolished`}}if(r.zone||r.building){const s=r.building;let l={food:0,wood:0,stone:0};if(s&&s.level!==void 0&&t.BUILDING_LEVELS){const a=t.BUILDING_LEVELS[s.level];a&&(l.food=Math.floor(a.food*.1),l.wood=Math.floor((a.wood||0)*.1),l.stone=Math.floor((a.stone||0)*.1),e.food+=l.food,e.wood+=l.wood,e.stone+=l.stone)}if(r.zone=null,r.building=null,l.food>0||l.wood>0||l.stone>0){const a=[];return l.food>0&&a.push(`${l.food} food`),l.wood>0&&a.push(`${l.wood} wood`),l.stone>0&&a.push(`${l.stone} stone`),{success:!0,message:`‚ôªÔ∏è Salvaged 10%: ${a.join(", ")}`,refund:l}}return{success:!0,message:"üî® Demolished (no salvage value)"}}return{success:!1,message:"Nothing to demolish here"}}function Ne(e){const t=e.toUpperCase();return V[t]||{w:1,h:1}}function Xt(e,t,o,n=1,r=1){for(const i of e){const s=Ne(i.t);if(t<i.x+s.w&&t+n>i.x&&o<i.y+s.h&&o+r>i.y)return i}return null}const H={ABANDONED:.1,LOW:.4,MEDIUM:.7};function Y(e){return e<H.ABANDONED?0:e<H.LOW?1:e<H.MEDIUM?2:3}function Ae(e,t,o){const n=e.BUILDING_LEVELS?.[t];return n?.variants&&n.variants[o]?n.variants[o].name:"Building"}const Zt=["üï≥Ô∏è","üèöÔ∏è","üè†","üèòÔ∏è"];function Se(e,t,o,n){const{tiles:r,blds:i,workforce:s}=e,{W:l,H:c}=t;let a=.25,d=999;e:for(let h=-5;h<=5;h++)for(let R=-5;R<=5;R++){const u=o+h,E=n+R;if(u<0||u>=l||E<0||E>=c)continue;const A=r[u][E];if(A.type==="WATER"||A.type==="RIVER"||A.water){const O=Math.abs(h)+Math.abs(R);if(d=Math.min(d,O),O===0)break e}}d<=3?a+=.15:d<=5&&(a+=.08);let f=!1;for(let h=-1;h<=1&&!f;h++)for(let R=-1;R<=1&&!f;R++){if(h===0&&R===0)continue;const u=o+h,E=n+R;u<0||u>=l||E<0||E>=c||r[u][E].road&&(f=!0)}if(f){let h=1;s&&s.roadsNeeded&&s.roadsNeeded>0&&(h=Math.min(1,(s.roadWorkers||0)/s.roadsNeeded)),a+=.1*h}i.some(h=>h.t==="COM"&&Math.abs(h.x-o)+Math.abs(h.y-n)<=8)&&(a+=.08),i.some(h=>h.t==="IND"&&Math.abs(h.x-o)+Math.abs(h.y-n)<=8)&&(a+=.15);let S=0;for(let h=-3;h<=3;h++)for(let R=-3;R<=3;R++){const u=o+h,E=n+R;u<0||u>=l||E<0||E>=c||r[u][E].type==="BERRY"&&S++}return S>=1&&(a+=.2),Math.max(0,Math.min(1,a))}function Re(e,t,o,n,r){if(r===1)return Se(e,t,o,n);const{tiles:i,blds:s}=e,{W:l,H:c}=t;let a=.35,d=999;e:for(let u=-5;u<=5;u++)for(let E=-5;E<=5;E++){const A=o+u,O=n+E;if(A>=0&&A<l&&O>=0&&O<c){const M=i[A][O];if(M.type==="WATER"||M.type==="RIVER"||M.water){const _=Math.abs(u)+Math.abs(E);if(d=Math.min(d,_),_===0)break e}}}d<=5&&(a+=.3*(1-d/6));let f=999;for(const u of s){if(u.t!=="WELL")continue;const E=Math.abs(o-u.x)+Math.abs(n-u.y);if(!(E>8)&&(f=Math.min(f,E),E===0))break}f<=8&&(a+=.25*(1-f/9));let p=999;e:for(let u=-2;u<=2;u++)for(let E=-2;E<=2;E++){const A=o+u,O=n+E;if(A>=0&&A<l&&O>=0&&O<c&&i[A][O].road){const M=Math.abs(u)+Math.abs(E);if(p=Math.min(p,M),M===0)break e}}p<=2&&(a+=.2*(1-p/3));let N=999;for(const u of s){if(u.t!=="COM")continue;const E=Math.abs(o-u.x)+Math.abs(n-u.y);if(!(E>10)&&(N=Math.min(N,E),E===0))break}N<=10&&(a+=.12*(1-N/11));let S=999;for(const u of s){if(u.t!=="IND")continue;const E=Math.abs(o-u.x)+Math.abs(n-u.y);E>=15||(S=Math.min(S,E))}if(S<15){const u=S<3?-.2:-.2*(1-(S-3)/12);a+=u}let h=0;for(let u=-2;u<=2&&h<=10;u++)for(let E=-2;E<=2&&h<=10;E++){if(u===0&&E===0)continue;const A=o+u,O=n+E;A>=0&&A<l&&O>=0&&O<c&&i[A][O].zone==="R"&&h++}h>=2&&h<=6?a+=.08:h>6?a-=Math.min(.1,(h-6)*.02):h===0&&(a-=.15);let R=0;for(let u=-1;u<=1;u++)for(let E=-1;E<=1;E++){const A=o+u,O=n+E;A>=0&&A<l&&O>=0&&O<c&&i[A][O].tree&&R++}return a+=Math.min(.05,R*.015),Math.max(0,Math.min(1,a))}function Oe(e,t){let o;return t===0?o=0:t===1?o=1+Math.floor((e-.1)/.3*4):t===2?o=6+Math.floor((e-.4)/.3*4):o=11+Math.floor((e-.7)/.3*4),Math.max(0,Math.min(15,o))}function Jt(e,t,o=20){const n=[],{tiles:r}=e,{W:i,H:s}=t;if(e.evolutionFrameCounter||(e.evolutionFrameCounter=0),e.evolutionFrameCounter++,e.evolutionFrameCounter<300||(e.evolutionFrameCounter=0,e.gameState!=="CITY"))return n;let l=0;for(let c=0;c<i&&l<o;c++)for(let a=0;a<s&&l<o;a++){const d=r[c][a];if(d.zone!=="R"||!d.building)continue;l++;const f=d.building,p=Re(e,t,c,a,f.level);f.desirability=p;const N=f.variant||0;let S;if(f.level===1?(S=Y(p),f.population=Oe(p,S)):S=Y(p),S!==N){f.variant=S;const h=Ae(t,f.level||1,S);n.push({x:c,y:a,oldVariant:N,newVariant:S,upgraded:S>N,variantName:h})}}return n}function qt(e){switch(e){case 0:return 0;case 1:return .5;case 2:return 1;case 3:return 1.5;default:return 1}}function Qt(e){switch(e){case 0:return 0;case 1:return .5;case 2:return 1;case 3:return 1.5;default:return 1}}function en(e){switch(e){case 0:return 0;case 1:return 0;case 2:return 1;case 3:return 2;default:return 0}}const Ln=Object.freeze(Object.defineProperty({__proto__:null,BUILDING_SIZES:V,DEFAULT_EFFICIENCY:It,DEFAULT_ZONE_BONUSES:le,LARGE_BUILDINGS:_t,SMALL_BUILDINGS:ie,VARIANT_ICONS:Zt,VARIANT_THRESHOLDS:H,applyElevationCost:Wt,buildingCanAfford:vt,buildingDeductCost:Dt,buildingGetElevationCostMultiplier:ue,buildingGetTileElevationInfo:Bt,calculateDesirability:kt,calculateLevel1Desirability:Se,calculateLevel1Population:Oe,calculateTileDesirability:Re,calculateZoneBonus:W,checkBuildingOverlap:Xt,checkMilestonePrereq:Pt,checkPopulationReq:$t,countNearbyTiles:T,countResidentialNeighbors:Ht,demolish:zt,getBuildingSize:Ne,getClusterMultiplier:Ut,getElevationCostInfo:Ft,getLineTiles:he,getMissingResource:bt,getVariantBonusMultiplier:qt,getVariantFromDesirability:Y,getVariantIncomeMultiplier:Qt,getVariantLifespanBonus:en,getVariantName:Ae,getZoneBonusDescription:x,hasNearbyTile:F,isBuildingInRadius:j,isBuildingNearby:D,isSmallBuilding:ce,isValidPlacement:Lt,isValidRoadPlacement:wt,placeCommercial:Yt,placeIndustrial:Vt,placeLargeBuilding:Kt,placeResidential:gt,placeRoadLine:xt,placeRoadTile:Ee,placeWell:jt,updateBuildingEvolution:Jt,validationGetBuildingSize:ae},Symbol.toStringTag,{value:"Module"})),v=[{name:"DEER",hitToKill:2,foodReward:[1,30],popCost:0,color:"#C89858",speed:1,spawnRate:.45,terrain:["GRASS","FOREST"]},{name:"BISON",hitToKill:3,foodReward:[5,30],popCost:0,color:"#A06830",speed:.5,spawnRate:.3,terrain:["GRASS","FOREST"]},{name:"MAMMOTH",hitToKill:5,foodReward:[15,30],popCost:0,color:"#806040",speed:.3,spawnRate:.1,terrain:["GRASS","FOREST"]},{name:"TURTLE",hitToKill:1,foodReward:[3,15],popCost:0,color:"#4A7A4A",speed:.1,spawnRate:.15,terrain:["SAND"]},{name:"WOLF",hitToKill:2,foodReward:5,popCost:1,color:"#666666",speed:1.5,spawnRate:0,terrain:["GRASS","FOREST"]}],w={SPAWN_COUNT:1064,PACK_DAMAGE:1,BEACH_SPAWN_COUNT:150},C={SPAWN_COUNT:1500,FRIENDLY_CHANCE:.84,HOSTILE_CHANCE:.16,POP_GAIN:1,HOSTILE_DAMAGE:{min:1,max:3},LOOT_FOOD:{min:5,max:25},LOOT_WOOD:{min:0,max:15},LOOT_STONE:{min:0,max:5},MAP_REVEAL_RADIUS:15},y={SPAWN_COUNT:400,FOOD_VALUE:10,POISON_CHANCE:.1,POISON_DAMAGE:1};function P(e){return{x:Math.floor(Math.random()*e.W),y:Math.floor(Math.random()*e.H)}}function tn(e,t,o,n,r={}){const{minDistanceFromPlayer:i=10,allowOverlap:s=!1,terrainFilter:l}=r;if(o<0||o>=t.W||n<0||n>=t.H)return{x:o,y:n,valid:!1};const c=e.tiles[o]?.[n];if(!c)return{x:o,y:n,valid:!1};if(Math.abs(o-e.player.x)+Math.abs(n-e.player.y)<=i)return{x:o,y:n,valid:!1};const d=c.type;return l&&!l.includes(d)?{x:o,y:n,valid:!1}:!s&&e.animals.some(p=>p.x===o&&p.y===n)?{x:o,y:n,valid:!1}:{x:o,y:n,valid:!0,terrain:d}}function nn(e,t=v){const o=t.find(n=>n.name===e);return o?.terrain?o.terrain:["GRASS","FOREST"]}function Me(e){if(e.length===0)return"DEER";const t=e.reduce((r,i)=>r+i.spawnRate,0),o=Math.random()*t;let n=0;for(const r of e)if(n+=r.spawnRate,o<n)return r.name;return e[0].name}function _e(e,t=v){return t.filter(o=>o.terrain?o.terrain.includes(e):e==="GRASS"||e==="FOREST")}function Ie(e,t,o=w.SPAWN_COUNT){const n=t.ANIMALS?.TYPES||v;let r=0;const i=o*20;for(let s=0;s<i&&r<o;s++){const l=P(t),c=e.tiles[l.x]?.[l.y];if(!c)continue;const a=c.type,d=Math.abs(l.x-e.player.x)+Math.abs(l.y-e.player.y),f=e.animals.some(N=>N.x===l.x&&N.y===l.y),p=_e(a,n);if(p.length>0&&d>10&&!f){const N=Me(p);e.animals.push({x:l.x,y:l.y,hits:0,type:N}),r++}}return r}function me(e,t,o=w.BEACH_SPAWN_COUNT){let n=0;const r=o*30;for(let i=0;i<r&&n<o;i++){const s=P(t),l=e.tiles[s.x]?.[s.y];!l||l.type!=="SAND"||e.animals.some(d=>d.x===s.x&&d.y===s.y)||Math.abs(s.x-e.player.x)+Math.abs(s.y-e.player.y)<=5||(e.animals.push({x:s.x,y:s.y,hits:0,type:"TURTLE"}),n++)}return n}function on(e,t){e.animals=[];const o=t.ANIMALS?.SPAWN_COUNT||w.SPAWN_COUNT,n=Ie(e,t,o),r=t.ANIMALS?.BEACH_SPAWN_COUNT||w.BEACH_SPAWN_COUNT,i=me(e,t,r);return{total:n+i,turtles:i}}function rn(e,t,o){e.nomads||(e.nomads=[]);let n=0;const r=o*20;for(let i=0;i<r&&n<o;i++){const s=P(t),l=e.tiles[s.x]?.[s.y];!l||l.type==="WATER"||l.type==="DEEP"||l.type==="RIVER"||l.type==="STONE"||Math.abs(s.x-e.player.x)+Math.abs(s.y-e.player.y)<=10||e.nomads.some(d=>d.x===s.x&&d.y===s.y)||(e.nomads.push({x:s.x,y:s.y,encountered:!1}),n++)}return n}function sn(e,t,o){let n=0;const r=o*20;for(let i=0;i<r&&n<o;i++){const s=P(t),l=e.tiles[s.x]?.[s.y];!l||l.type!=="GRASS"&&l.type!=="FOREST"||l.entity||Math.abs(s.x-e.player.x)+Math.abs(s.y-e.player.y)<=5||(l.entity={type:"BERRY",depleted:!1},n++)}return n}function ln(e,t,o){const n=e.findIndex(r=>r.x===t&&r.y===o);return n===-1?null:{animal:e[n],index:n}}function g(e,t,o,n){return e.filter((r,i)=>{if(n!==void 0&&i===n)return!1;const s=Math.abs(r.x-t),l=Math.abs(r.y-o);return s<=1&&l<=1})}function z(e,t,o,n){return g(e,t,o,n).length>0}function an(e){const t={};for(const o of e)t[o.type]=(t[o.type]||0)+1;return t}function X(e,t){return(t?.ANIMALS?.TYPES||v).find(n=>n.name===e)}function Ce(e){return e.charAt(0)+e.slice(1).toLowerCase()}function ye(e){const t=e.foodReward;if(Array.isArray(t)){const[o,n]=t;return o+Math.floor(Math.random()*(n-o+1))}return t}function Te(e){e.hits++;const o=v.find(n=>n.name===e.type)?.hitToKill||2;return{hits:e.hits,defeated:e.hits>=o,hitsToKill:o}}function cn(e,t,o){const n=e.animals[t];return!n||e.gameState!=="WANDER"||g(e.animals,n.x,n.y,t).length===0?0:(o?.ANIMALS?.PACK_DAMAGE||w.PACK_DAMAGE)+Math.floor(Math.random()*3)}function dn(e,t,o){const n=e.animals[t];if(!n)return{defeated:!1,foodGained:0,popLost:0,herdDamage:0,message:"‚ùå No animal found",isHerd:!1};const r=X(n.type,o);if(!r)return{defeated:!1,foodGained:0,popLost:0,herdDamage:0,message:"‚ùå Unknown animal type",isHerd:!1};const i=Ce(n.type),s=Te(n);if(!s.defeated)return{defeated:!1,foodGained:0,popLost:0,herdDamage:0,message:`üí• Hit ${i.toLowerCase()}! (${s.hits}/${s.hitsToKill})`,isHerd:!1};const l=z(e.animals,n.x,n.y,t);let c=0,a=r.popCost||0,d=ye(r),f=0,p=!1;if(l&&e.gameState==="WANDER"&&(c=1+Math.floor(Math.random()*3),e.pop=Math.max(0,e.pop-c),e.pop===0))return e.animals.splice(t,1),{defeated:!0,foodGained:0,popLost:c,herdDamage:c,message:"üíÄ Your tribe has perished attacking a herd!",isHerd:!0,gameOver:!0};a>0&&e.pop>0&&(e.pop=Math.max(0,e.pop-a),e.pop===0&&(p=!0));const N=a+c;if(e.gameState==="WANDER"){const h=e.inventory.food+e.inventory.wood+e.inventory.metal+e.inventory.stone,R=e.inventory.capacity-h;R>=d?(e.inventory.food+=d,f=d):R>0&&(e.inventory.food+=R,f=R)}else e.food+=d,f=d;e.totalFoodCollected+=f,e.animals.splice(t,1);let S=`üéØ ${i} defeated!`;return N>0&&(S+=` (-${N} Pop)`),f>0?S+=` +${f} Food`:f<d&&(S+=" Food lost - Inventory Full!"),l||(S+=" (Safe hunt!)"),S+=" üçñ",{defeated:!0,foodGained:f,popLost:N,herdDamage:c,message:S,isHerd:l,gameOver:p}}function fn(e,t){return e.loreSeen||(e.loreSeen={}),e.loreSeen.FIRST_KILL?t==="TURTLE"&&!e.loreSeen.FIRST_TURTLE?(e.loreSeen.FIRST_TURTLE=!0,{trigger:"FIRST_TURTLE"}):{trigger:null}:(e.loreSeen.FIRST_KILL=!0,{trigger:"FIRST_KILL"})}function un(e){return e.pop>0}function pn(e,t,o){const n=g(e,t,o);return n.length===0?"safe":n.length<=2?"herd":"dangerous"}function hn(e,t,o){const n=e.animals[t];if(!n)return null;const r=X(n.type,o);if(!r)return null;const i=z(e.animals,n.x,n.y,t),s=r.hitToKill-n.hits,l=r.foodReward,c=Array.isArray(l)?l:[l,l];return{animal:n,hitsRemaining:s,potentialHerdDamage:i?[1,3]:[0,0],potentialFood:c,isHerd:i}}function k(e){return e.min+Math.floor(Math.random()*(e.max-e.min+1))}function Le(e){const t=e?.NOMAD?.HOSTILE_CHANCE||C.HOSTILE_CHANCE;return Math.random()<t}function En(e){const t=e?.NOMAD||C;if(Le(e))return{type:"NOMAD",is_hostile:!0,damage:k(t.HOSTILE_DAMAGE||C.HOSTILE_DAMAGE),pop:0,loot:{food:0,wood:0,metal:0,stone:0}};const n=t.LOOT_FOOD||C.LOOT_FOOD,r=t.LOOT_WOOD||C.LOOT_WOOD,i=t.LOOT_STONE||C.LOOT_STONE;return{type:"NOMAD",is_hostile:!1,damage:0,pop:t.POP_GAIN||C.POP_GAIN,loot:{food:k(n),wood:k(r),metal:Math.floor(Math.random()*10),stone:k(i)}}}function we(e,t){return e.pop=Math.max(0,e.pop-t),{type:"HOSTILE",popGained:0,popLost:t,loot:{food:0,wood:0,stone:0},mapReveal:!1,message:`‚öîÔ∏è HOSTILE NOMAD! Ambush! -${t} Population`}}function ve(e,t,o){e.nomadsFound++,e.pop+=t.pop;const n=t.loot.food+t.loot.wood+t.loot.metal+(t.loot.stone||0),r=e.inventory.food+e.inventory.wood+e.inventory.metal+e.inventory.stone,i=e.inventory.capacity-r;let s=0,l=0,c=0,a=0;if(i>=n)e.inventory.food+=t.loot.food,e.totalFoodCollected+=t.loot.food,e.inventory.wood+=t.loot.wood,e.inventory.metal+=t.loot.metal,e.inventory.stone+=t.loot.stone||0,s=t.loot.food,l=t.loot.wood,c=t.loot.metal,a=t.loot.stone||0;else if(i>0){let p=i;s=Math.min(t.loot.food,p),e.inventory.food+=s,e.totalFoodCollected+=s,p-=s,p>0&&(l=Math.min(t.loot.wood,p),e.inventory.wood+=l,p-=l),p>0&&(c=Math.min(t.loot.metal,p),e.inventory.metal+=c,p-=c),p>0&&(a=Math.min(t.loot.stone||0,p),e.inventory.stone+=a)}const d=o?.NOMAD?.CAPACITY_GAIN||100;e.inventory.capacity+=d;const f=i>=n?`+${s}F +${l}W +${c}M +${a}S`:`+${s}F +${l}W +${c}M +${a}S (Inventory was full!)`;return{type:"FRIENDLY",popGained:t.pop,popLost:0,loot:{food:s,wood:l,stone:a},mapReveal:!0,message:`üë§ OOGA BOOGA! Nomad joined! +${t.pop} Pop, ${f}, Capacity: ${e.inventory.capacity}`}}function Nn(e,t,o){return t.is_hostile?we(e,t.damage):ve(e,t,o)}function An(e){return e.loreSeen||(e.loreSeen={}),e.loreSeen.FIRST_NOMAD?{trigger:null}:(e.loreSeen.FIRST_NOMAD=!0,{trigger:"FIRST_NOMAD"})}function Sn(e){switch(e){case"FRIENDLY":return"A friendly wanderer approaches";case"HOSTILE":return"An aggressive stranger appears!";case"NEUTRAL":return"A mysterious figure watches";default:return"An unknown presence"}}function Rn(e,t){const o=t?.NOMAD||C;if(e){const r=o.HOSTILE_DAMAGE||C.HOSTILE_DAMAGE;return{type:"HOSTILE",potentialPopChange:[-r.max,-r.min],potentialLoot:!1,danger:"risky"}}const n=o.POP_GAIN||C.POP_GAIN;return{type:"FRIENDLY",potentialPopChange:[n,n],potentialLoot:!0,danger:"safe"}}function On(e){const t=e?.NOMAD?.FRIENDLY_CHANCE||C.FRIENDLY_CHANCE,o=e?.NOMAD?.HOSTILE_CHANCE||C.HOSTILE_CHANCE;return{friendlyPercent:Math.round(t*100),hostilePercent:Math.round(o*100)}}function be(e){const t=e?.BERRIES?.POISON_CHANCE||y.POISON_CHANCE;return Math.random()<t}function Mn(e){const t=e?.BERRIES||y,o=be(e);return{type:"BERRY",amount:t.FOOD_VALUE||y.FOOD_VALUE,is_poisonous:o}}function De(e,t){const o=t?.BERRIES?.POISON_DAMAGE||y.POISON_DAMAGE;return e.pop=Math.max(0,e.pop-o),{success:!1,poisoned:!0,foodGained:0,popLost:o,message:`‚ò†Ô∏è POISON BERRY! -${o} Population - YUCK!`}}function Fe(e,t){const o=e.inventory.food+e.inventory.wood+e.inventory.metal+e.inventory.stone,n=e.inventory.capacity-o;if(n<=0)return{success:!1,poisoned:!1,foodGained:0,popLost:0,message:`‚ö†Ô∏è Inventory full! (${Math.floor(o)}/${e.inventory.capacity}) - Cannot collect berry`};const r=Math.min(t,n);e.inventory.food+=r,e.totalFoodCollected+=r;const i=r===t?`ü´ê Found Berry! +${t} food (${Math.floor(e.inventory.food)}/${e.inventory.capacity}) - YUM!`:`ü´ê Found Berry! +${r}/${t} food (Inventory Full!) - YUM!`;return{success:!0,poisoned:!1,foodGained:r,popLost:0,message:i}}function _n(e,t,o){return t.is_poisonous?De(e,o):Fe(e,t.amount)}function In(e){return e.loreSeen||(e.loreSeen={}),e.loreSeen.FIRST_BERRY?{trigger:null}:(e.loreSeen.FIRST_BERRY=!0,{trigger:"FIRST_BERRY"})}function mn(e){const t=e.inventory.food+e.inventory.wood+e.inventory.metal+e.inventory.stone;return e.inventory.capacity>t}function Cn(e,t,o){const n=t.inventory.food+t.inventory.wood+t.inventory.metal+t.inventory.stone,r=t.inventory.capacity-n,i=o?.BERRIES?.POISON_CHANCE||y.POISON_CHANCE;return{potentialFood:e.amount,poisonRisk:Math.round(i*100),spaceAvailable:r,willFit:r>=e.amount}}function yn(e){const t=e?.BERRIES||y,o=t.POISON_CHANCE||y.POISON_CHANCE;return{safePercent:Math.round((1-o)*100),poisonPercent:Math.round(o*100),foodValue:t.FOOD_VALUE||y.FOOD_VALUE,poisonDamage:t.POISON_DAMAGE||y.POISON_DAMAGE}}const wn=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_ANIMAL_CONFIG:w,DEFAULT_ANIMAL_TYPES:v,DEFAULT_BERRY_CONFIG:y,DEFAULT_NOMAD_CONFIG:C,attackAnimal:dn,calculateFoodReward:ye,calculateHerdDamage:cn,canAttack:un,canGatherBerry:mn,checkFirstBerryLore:In,checkFirstKillLore:fn,checkFirstNomadLore:An,countAnimalsByType:an,encounterNomad:Nn,formatAnimalName:Ce,gatherBerry:_n,generateBerryEntity:Mn,generateNomadEncounter:En,getAdjacentAnimals:g,getAnimalAt:ln,getAnimalConfig:X,getAttackDangerLevel:pn,getBerryOdds:yn,getEncounterTypeDescription:Sn,getNomadOdds:On,getRandomPosition:P,getValidAnimalTypes:_e,getValidTerrain:nn,hitAnimal:Te,initializeAnimals:on,isBerryPoisonous:be,isHerdLocation:z,isNomadHostile:Le,isValidSpawnPosition:tn,previewBerryGather:Cn,previewCombat:hn,previewNomadEncounter:Rn,processFriendlyEncounter:ve,processHostileEncounter:we,processPoisonBerry:De,processSafeBerry:Fe,selectAnimalType:Me,spawnAnimals:Ie,spawnBeachTurtles:me,spawnBerries:sn,spawnNomads:rn},Symbol.toStringTag,{value:"Module"}));export{Ln as B,wn as E,Tn as S};
//# sourceMappingURL=game-systems-CO48tvuv.js.map
