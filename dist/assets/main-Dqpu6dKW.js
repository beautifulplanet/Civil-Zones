import{C as Ke,a as Ve,T as je}from"./game-core-DTqyYw7Y.js";import{E as Ze,B as qe,S as Je}from"./game-systems-CO48tvuv.js";import{U as Qe,R as et,c as tt,i as nt,s as ot,a as rt,r as it,p as at}from"./game-rendering-BJK6da9S.js";import{A as st}from"./game-ai-BV7aEE30.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();const lt={capacity:450,food:300,wood:300,metal:0,stone:0},ut={metal:0,stone:0,capacity:1e3},ct={food:0,wood:0,metal:0,stone:0,water:100,gold:0};function dt(e=3,t=300,n=300){return{capacity:150+e*100,food:t,wood:n,metal:0,stone:0}}function U(e){return e.food+e.wood+e.metal+e.stone}function Y(e){return Math.max(0,e.capacity-U(e))}function ht(e,t){return Y(e)>=t}function ft(e,t,n){const o=Y(e);return o<=0?{success:!1,amountTransferred:0,overflow:n,message:"Inventory full!"}:o>=n?(e[t]+=n,{success:!0,amountTransferred:n,overflow:0}):(e[t]+=o,{success:!0,amountTransferred:o,overflow:n-o,message:`Partial pickup: ${o}/${n}`})}function gt(e,t,n){const o=e[t];return o>=n?(e[t]-=n,{success:!0,amountTransferred:n,overflow:0}):(e[t]=0,{success:!1,amountTransferred:o,overflow:n-o,message:`Not enough ${t}!`})}function mt(e,t=0,n=0,o=0,r=0){return e.food>=t&&e.wood>=n&&e.metal>=o&&e.stone>=r}function pt(e,t=100){e.capacity+=t}function St(e,t,n){const o=e.metal+e.stone,r=e.capacity-o;if(r<=0)return{success:!1,amountTransferred:0,overflow:n,message:"Pocket full!"};const i=Math.min(n,r);return e[t]+=i,{success:!0,amountTransferred:i,overflow:n-i}}function wt(e){return e.metal+e.stone}function vt(e,t=0){const n=1+t/100;return{food:Math.floor(e.food*n),wood:Math.floor(e.wood*n),metal:e.metal,stone:e.stone,water:100,gold:0}}function yt(e,t,n){e[t]+=n}function Tt(e,t,n){return e[t]>=n?(e[t]-=n,!0):!1}function ee(e,t){for(const[n,o]of Object.entries(t))if(o&&e[n]<o)return!1;return!0}function Et(e,t){if(!ee(e,t))return!1;for(const[n,o]of Object.entries(t))o&&(e[n]-=o);return!0}function bt(e){return e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":Math.floor(e).toString()}function At(e){return U(e)/e.capacity*100}function Rt(e){return{food:"#8B4513",wood:"#228B22",metal:"#C0C0C0",stone:"#708090",water:"#4169E1",gold:"#FFD700"}[e]}function Mt(e){return{food:"üçñ",wood:"ü™µ",metal:"‚öôÔ∏è",stone:"ü™®",water:"üíß",gold:"ü™ô"}[e]}function It(e,t,n=3,o="down"){return{x:e,y:t,health:n,direction:o}}function Ct(e,t,n){return{x:e.x+t,y:e.y+n}}function te(e,t){return e>0?"right":e<0?"left":t>0?"down":"up"}function Ot(e){switch(e){case"up":return{dx:0,dy:-1};case"down":return{dx:0,dy:1};case"left":return{dx:-1,dy:0};case"right":return{dx:1,dy:0}}}function Lt(e,t,n,o){return e>=0&&e<n&&t>=0&&t<o}function ne(e,t=!0){return e==="WATER"||e==="DEEP"||e==="RIVER"?{passable:!1,reason:"Water blocks path"}:e==="STONE"&&t?{passable:!1,reason:"Dense rock formation. Impassable."}:{passable:!0}}function Dt(e,t,n,o,r,i,a=!0){const s=e.x+t,u=e.y+n;if(!Lt(s,u,o,r))return{success:!1,newX:e.x,newY:e.y,message:"World boundary reached",blockedBy:"boundary"};const l=i(s,u),c=ne(l,a);return c.passable?(e.x=s,e.y=u,e.direction=te(t,n),{success:!0,newX:s,newY:u}):{success:!1,newX:e.x,newY:e.y,message:c.reason,blockedBy:l}}function _t(e,t){return e.health=Math.max(0,e.health-t),e.health}function Nt(e,t,n=3){return e.health=Math.min(n,e.health+t),e.health}function Pt(e){return e.health<=0}function R(e){return e==="GRASS"||e==="FOREST"||e==="SAND"||e==="SNOW"||e==="ROCK"}function F(e,t,n,o,r,i=200){const a=new Set,s=[[e,t]];let u=0;for(;s.length>0&&u<i;){const[l,c]=s.shift(),h=`${l},${c}`;if(l<0||c<0||l>=n||c>=o||a.has(h))continue;const f=r(l,c);f!=="GRASS"&&f!=="FOREST"&&f!=="SAND"||(a.add(h),u++,s.push([l+1,c]),s.push([l-1,c]),s.push([l,c+1]),s.push([l,c-1]))}return u}function xt(e,t,n,o=60){for(let r=0;r<100;r++){const i=Math.floor(e/2+(Math.random()-.5)*40),a=Math.floor(t/2+(Math.random()-.5)*40);if(R(n(i,a))){const s=F(i,a,e,t,n);if(s>=o)return{valid:!0,x:i,y:a,reachableTiles:s}}}for(let r=0;r<500;r++){const i=Math.floor(Math.random()*e),a=Math.floor(Math.random()*t);if(R(n(i,a))){const s=F(i,a,e,t,n);if(s>=30)return{valid:!0,x:i,y:a,reachableTiles:s}}}for(let r=0;r<e;r++)for(let i=0;i<t;i++)if(R(n(r,i)))return{valid:!0,x:r,y:i,reachableTiles:1};return{valid:!1,x:Math.floor(e/2),y:Math.floor(t/2),reachableTiles:0}}function Ft(e,t,n,o,r){const i=[];for(let a=e-n;a<=e+n;a++)for(let s=t-n;s<=t+n;s++)a>=0&&a<o&&s>=0&&s<r&&Math.sqrt((a-e)**2+(s-t)**2)<=n&&i.push({x:a,y:s});return i}function kt(){return{level:100,stepCounter:0}}function Wt(e){return e.stepCounter++,e.level=Math.max(0,100-e.stepCounter),e}function $t(e){return e.level=100,e.stepCounter=0,e}function Ut(e){return e.level<=0}function Yt(e){return e.level>50?"safe":e.level>25?"warning":e.level>10?"danger":"critical"}function oe(){return{gamePhase:"WANDER",viewMode:"NORMAL",year:0,age:0,gameOver:!1,pop:4,peakPop:4,housingCap:0,waterCap:0,player:null,thirst:{level:100,stepCounter:0},inventory:{capacity:450,food:300,wood:300,metal:0,stone:0},pocket:{metal:0,stone:0,capacity:1e3},stepCounter:0,foodStepCounter:0,resources:{food:0,wood:0,metal:0,stone:0,water:100,gold:0},animals:[],wanderWells:[],nomadsFound:0,blds:[],zoneCount:0,roadTileCount:0,workforce:{total:0,wellWorkers:0,roadWorkers:0,comWorkers:0,indWorkers:0,gatherers:0,wellsNeeded:0,roadsNeeded:0,comNeeded:0,indNeeded:0,shortage:0},needs:{housing:{have:0,need:0,satisfied:1},water:{have:0,need:0,satisfied:1},food:{have:0,need:0,satisfied:1},jobs:{have:0,need:0,satisfied:1},paths:{have:0,need:0,satisfied:1},overall:1},geology:{currentSeaLevel:3,periodIndex:0,centuriesInPeriod:0,lastUpdateYear:0,tilesFlooded:0,tilesDrained:0,currentPeriodName:"Warm Interglacial"},settlementPos:null,siteTraits:[],lockedResources:{residential:!1,commercial:!1,industrial:!1},gatheringMultiplier:1,totalFoodCollected:0,progression:{settlementUnlocked:!1,industrialUnlocked:!1,hasClanChief:!1,hasDock:!1},aiEnabled:!1,aiState:"EXPLORE",aiTarget:null,simcityMode:!1,loreEnabled:!1,loreSeen:{},gameLog:[],dirtyRegions:new Set}}function Gt(e,t,n,o=0){e.gamePhase="CITY",e.settlementPos={x:t,y:n};const r=1+o/100;e.resources.food=Math.floor(e.inventory.food*r),e.resources.wood=Math.floor(e.inventory.wood*r),e.resources.metal=e.inventory.metal,e.resources.stone=e.inventory.stone,e.gatheringMultiplier=Math.min(3,.5+e.pop*.1)}function Ht(e,t){const n=`Year ${e.year}: ${t}`;e.gameLog.push(n),e.gameLog.length>100&&e.gameLog.shift()}function Bt(e,t,n,o=1){for(let r=0;r<o;r++)for(let i=0;i<o;i++)e.dirtyRegions.add(`${t+r},${n+i}`)}function zt(e){e.dirtyRegions.clear()}function Xt(e){e.pop>e.peakPop&&(e.peakPop=e.pop)}function Kt(e){return e.pop<=0?e.gamePhase==="WANDER"&&e.inventory.food<=0?"STARVATION":"POPULATION_LOSS":e.player&&e.player.health<=0?"HUNTING":e.gamePhase==="WANDER"&&e.thirst.level<=0?"THIRST":null}const O="48.0.0",b="civilzones_autosave",D="civilzones_save_",G=5;function re(e){return{...e,dirtyRegions:Array.from(e.dirtyRegions)}}function Vt(e){return{...e,dirtyRegions:new Set(e.dirtyRegions||[])}}function H(e,t){return{version:O,timestamp:Date.now(),state:re(e),tiles:t}}function ie(e,t,n="autosave"){try{const o=n==="autosave"?b:`${D}${n}`,r=H(e,t),i=JSON.stringify(r);return localStorage.setItem(o,i),console.log(`[Save] Game saved to ${o} (${(i.length/1024).toFixed(1)} KB)`),!0}catch(o){return console.error("[Save] Failed to save game:",o),!1}}function k(e="autosave"){try{const t=e==="autosave"?b:`${D}${e}`,n=localStorage.getItem(t);if(!n)return console.log(`[Load] No save found at ${t}`),null;const o=JSON.parse(n);return o.version!==O&&console.warn(`[Load] Save version mismatch: ${o.version} vs ${O}`),console.log(`[Load] Game loaded from ${t}`),o}catch(t){return console.error("[Load] Failed to load game:",t),null}}function jt(e){try{const t=e==="autosave"?b:`${D}${e}`;return localStorage.removeItem(t),console.log(`[Save] Deleted save: ${t}`),!0}catch(t){return console.error("[Save] Failed to delete save:",t),!1}}function L(e="autosave"){const t=e==="autosave"?b:`${D}${e}`;return localStorage.getItem(t)!==null}function Zt(){const e=[];if(L("autosave")){const t=k("autosave");t&&e.push({id:"autosave",name:"Autosave",timestamp:t.timestamp,year:t.state.year,pop:t.state.pop,phase:t.state.gamePhase})}for(let t=1;t<=G;t++){const n=`slot${t}`;if(L(n)){const o=k(n);o&&e.push({id:n,name:`Save ${t}`,timestamp:o.timestamp,year:o.state.year,pop:o.state.pop,phase:o.state.gamePhase})}}return e}function qt(){for(let e=1;e<=G;e++){const t=`slot${e}`;if(!L(t))return t}return"slot1"}const ae=6e4;let M=null;function Jt(e,t,n=ae){se(),M=setInterval(()=>{const o=e(),r=t();o.gameOver||ie(o,r,"autosave")},n),console.log(`[Autosave] Started with ${n/1e3}s interval`)}function se(){M&&(clearInterval(M),M=null,console.log("[Autosave] Stopped"))}function Qt(e,t){const n=H(e,t),o=JSON.stringify(n,null,2),r=new Blob([o],{type:"application/json"}),i=URL.createObjectURL(r),a=document.createElement("a");a.href=i,a.download=`civilzones_save_${Date.now()}.json`,a.click(),URL.revokeObjectURL(i)}async function en(e){try{const t=await e.text(),n=JSON.parse(t);if(!n.version||!n.state)throw new Error("Invalid save file format");return n}catch(t){return console.error("[Import] Failed to import save:",t),null}}function le(e){const t=new Date(e),n=new Date;return t.toDateString()===n.toDateString()?t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):t.getFullYear()===n.getFullYear()?t.toLocaleDateString([],{month:"short",day:"numeric"}):t.toLocaleDateString([],{year:"numeric",month:"short",day:"numeric"})}function tn(e){const t=le(e.timestamp);return`${e.name} - Year ${e.year}, Pop ${e.pop} (${e.phase}) - ${t}`}const nn=Object.freeze(Object.defineProperty({__proto__:null,AUTOSAVE_INTERVAL:ae,AUTOSAVE_KEY:b,DEFAULT_CITY_RESOURCES:ct,DEFAULT_POCKET_INVENTORY:ut,DEFAULT_WANDER_INVENTORY:lt,MAX_SAVE_SLOTS:G,SAVE_VERSION:O,addCityResource:yt,addToInventory:ft,addToPocket:St,canAfford:ee,checkGameOver:Kt,clearDirtyRegions:zt,countReachableTiles:F,createCityResources:vt,createInitialGameState:oe,createPlayer:It,createSaveData:H,createThirstState:kt,createWanderInventory:dt,damagePlayer:_t,deductCost:Et,deleteSave:jt,deserializeState:Vt,drinkWater:$t,exportSave:Qt,findSpawnPosition:xt,formatResource:bt,formatSaveTime:le,getAvailableSpace:Y,getDeltaFromDirection:Ot,getDirectionFromDelta:te,getExplorationTiles:Ft,getInventoryFillPercent:At,getInventoryTotal:U,getNewPosition:Ct,getNextSaveSlot:qt,getPocketTotal:wt,getResourceColor:Rt,getResourceEmoji:Mt,getSaveDescription:tn,getSaveSlots:Zt,getThirstWarning:Yt,hasResources:mt,hasSave:L,hasSpace:ht,healPlayer:Nt,importSave:en,increaseCapacity:pt,isDyingOfThirst:Ut,isPlayerDead:Pt,isTileTypePassable:ne,isValidSpawnTile:R,loadGame:k,logGameEvent:Ht,markDirty:Bt,movePlayer:Dt,removeCityResource:Tt,removeFromInventory:gt,saveGame:ie,serializeState:re,startAutosave:Jt,stopAutosave:se,transitionToCity:Gt,updatePeakPop:Xt,updateThirst:Wt},Symbol.toStringTag,{value:"Module"})),on={tileSize:16,bounds:{minX:0,maxX:6400,minY:0,maxY:6400,minZoom:.5,maxZoom:4},zoomStep:1.15,startCamera:{x:3200,y:3200,z:2},menuPanelIds:["building-menu-panel","industrial-menu-panel","commercial-menu-panel","storage-menu-panel","special-menu-panel","road-menu-panel","milestone-menu-panel"]},B={w:[0,-1],W:[0,-1],ArrowUp:[0,-1],s:[0,1],S:[0,1],ArrowDown:[0,1],a:[-1,0],A:[-1,0],ArrowLeft:[-1,0],d:[1,0],D:[1,0],ArrowRight:[1,0],q:[-1,-1],Q:[-1,-1],e:[1,-1],E:[1,-1],z:[-1,1],Z:[-1,1],c:[1,1],C:[1,1]},ue=["Enter"," ","Escape","b","B","v","V"];let m={shift:!1,ctrl:!1,alt:!1,meta:!1};const I=new Set;function rn(){return{...m}}function ce(){return m.shift}function an(e){return I.has(e.toLowerCase())}function W(e){return{shift:e.shiftKey,ctrl:e.ctrlKey,alt:e.altKey,meta:e.metaKey}}function sn(e){return e in B}function de(e){return B[e]||null}function he(e){return ue.includes(e)}class _{config;boundKeyDown;boundKeyUp;enabled=!1;constructor(t={}){this.config=t,this.boundKeyDown=this.handleKeyDown.bind(this),this.boundKeyUp=this.handleKeyUp.bind(this)}enable(){this.enabled||(window.addEventListener("keydown",this.boundKeyDown),window.addEventListener("keyup",this.boundKeyUp),this.enabled=!0)}disable(){this.enabled&&(window.removeEventListener("keydown",this.boundKeyDown),window.removeEventListener("keyup",this.boundKeyUp),this.enabled=!1,I.clear(),m={shift:!1,ctrl:!1,alt:!1,meta:!1})}updateConfig(t){this.config={...this.config,...t}}handleKeyDown(t){if(this.config.shouldBlockInput?.()){t.preventDefault();return}if(this.config.isLimitedInput?.()){if(t.key!=="Tab"&&t.key!=="Enter"){t.preventDefault();return}return}const n=m.shift;m=W(t),n!==m.shift&&this.config.onModifierChange?.(m),I.add(t.key.toLowerCase());const o=de(t.key);if(o){this.config.onMove?.(o[0],o[1]),t.preventDefault();return}if(he(t.key)){this.config.onAction?.(t.key),t.preventDefault();return}}handleKeyUp(t){const n=m.shift;m=W(t),n!==m.shift&&this.config.onModifierChange?.(m),I.delete(t.key.toLowerCase())}}function ln(e={}){return new _(e)}function un(e){return new _({onMove:e})}function z(e,t,n,o,r){const i=(e-o/2)/n.z+n.x,a=(t-r/2)/n.z+n.y;return{x:i,y:a}}function X(e,t,n){return{x:Math.floor(e/n),y:Math.floor(t/n)}}function cn(e,t,n,o,r,i){const a=z(e,t,n,o,r);return X(a.x,a.y,i)}function K(e,t){return{x:Math.max(t.minX,Math.min(t.maxX,e.x)),y:Math.max(t.minY,Math.min(t.maxY,e.y)),z:Math.max(t.minZoom,Math.min(t.maxZoom,e.z))}}function fe(e,t,n,o){const r={x:e.x-t/e.z,y:e.y-n/e.z,z:e.z};return K(r,o)}function ge(e,t,n){return{...e,z:Math.max(n.minZoom,Math.min(n.maxZoom,e.z*t))}}function me(e,t){return e===t}function pe(e,t,n){return e>=n.left&&e<=n.right&&t>=n.top&&t<=n.bottom}function Se(e,t,n){for(const o of n){const r=document.getElementById(o);if(r&&r.style.display!=="none"&&r.style.display!==""){const i=r.getBoundingClientRect();if(pe(e,t,i))return!0}}return!1}function V(){return{isDragging:!1,builtPositions:new Set,tileCount:0}}function we(e,t,n){const o={isDragging:!0,builtPositions:new Set,tileCount:0};return o.builtPositions.add(`${t},${n}`),o}function ve(e,t,n){const o=`${t},${n}`;if(e.builtPositions.has(o))return e;const r=new Set(e.builtPositions);return r.add(o),{isDragging:!0,builtPositions:r,tileCount:e.tileCount+1}}function ye(){return V()}class Te{config;pointerState;roadDragState;enabled=!1;boundMouseDown;boundMouseUp;boundMouseMove;boundWheel;boundContextMenu;constructor(t){this.config=t,this.pointerState=this.createInitialPointerState(),this.roadDragState=V(),this.boundMouseDown=this.handleMouseDown.bind(this),this.boundMouseUp=this.handleMouseUp.bind(this),this.boundMouseMove=this.handleMouseMove.bind(this),this.boundWheel=this.handleWheel.bind(this),this.boundContextMenu=n=>n.preventDefault()}createInitialPointerState(){return{screenX:0,screenY:0,worldX:0,worldY:0,tileX:0,tileY:0,isDragging:!1,dragStartX:0,dragStartY:0,button:0}}getTilePosition(){return{x:this.pointerState.tileX,y:this.pointerState.tileY}}enable(){if(this.enabled)return;const t=this.config.canvas;t.addEventListener("mousedown",this.boundMouseDown),window.addEventListener("mouseup",this.boundMouseUp),window.addEventListener("mousemove",this.boundMouseMove),t.addEventListener("wheel",this.boundWheel,{passive:!1}),t.addEventListener("contextmenu",this.boundContextMenu),this.enabled=!0}disable(){if(!this.enabled)return;const t=this.config.canvas;t.removeEventListener("mousedown",this.boundMouseDown),window.removeEventListener("mouseup",this.boundMouseUp),window.removeEventListener("mousemove",this.boundMouseMove),t.removeEventListener("wheel",this.boundWheel),t.removeEventListener("contextmenu",this.boundContextMenu),this.enabled=!1}updatePointerPosition(t){const o=this.config.canvas.getBoundingClientRect(),r=this.config.getCamera(),i=this.config.getCanvasDimensions(),a=this.config.config.tileSize;this.pointerState.screenX=t.clientX-o.left,this.pointerState.screenY=t.clientY-o.top;const s=z(this.pointerState.screenX,this.pointerState.screenY,r,i.width,i.height);this.pointerState.worldX=s.x,this.pointerState.worldY=s.y;const u=X(s.x,s.y,a);this.pointerState.tileX=u.x,this.pointerState.tileY=u.y}handleMouseDown(t){const n=this.config.canvas;if(me(t.target,n)&&!Se(t.clientX,t.clientY,this.config.config.menuPanelIds))if(this.updatePointerPosition(t),t.button===0){const o=this.config.getTool();if(o!=="NONE"&&o!=="PAN"){if(o==="ROAD"){this.roadDragState=we(this.roadDragState,this.pointerState.tileX,this.pointerState.tileY),this.config.placeRoadSilent?.(this.pointerState.tileX,this.pointerState.tileY)&&this.roadDragState.tileCount++;return}this.config.onBuild?.(o,this.pointerState.tileX,this.pointerState.tileY)}else this.config.onTileClick?.(this.pointerState.tileX,this.pointerState.tileY,0)}else(t.button===1||t.button===2)&&(this.pointerState.isDragging=!0,this.pointerState.dragStartX=t.clientX,this.pointerState.dragStartY=t.clientY,this.pointerState.button=t.button,document.body.style.cursor="grabbing")}handleMouseUp(t){this.pointerState.isDragging=!1,document.body.style.cursor="default",this.roadDragState.isDragging&&(this.roadDragState.tileCount>0&&this.config.showToast&&(this.roadDragState.tileCount===1?this.config.showToast("üõ£Ô∏è Road placed! (Drag to draw roads)"):this.config.showToast(`üõ£Ô∏è Built ${this.roadDragState.tileCount} road tiles!`)),this.roadDragState=ye())}handleMouseMove(t){if(this.updatePointerPosition(t),this.pointerState.isDragging){const o=t.clientX-this.pointerState.dragStartX,r=t.clientY-this.pointerState.dragStartY,i=this.config.getCamera(),a=fe(i,o,r,this.config.config.bounds);this.config.setCamera(a),this.pointerState.dragStartX=t.clientX,this.pointerState.dragStartY=t.clientY}if(this.roadDragState.isDragging&&this.config.getTool()==="ROAD"){const o=`${this.pointerState.tileX},${this.pointerState.tileY}`;this.roadDragState.builtPositions.has(o)||(this.config.placeRoadSilent?.(this.pointerState.tileX,this.pointerState.tileY)?this.roadDragState=ve(this.roadDragState,this.pointerState.tileX,this.pointerState.tileY):this.roadDragState.builtPositions.add(o))}const n=document.getElementById("debug");n&&(n.innerText=`Pos: ${this.pointerState.tileX}, ${this.pointerState.tileY}`)}handleWheel(t){t.preventDefault();const n=t.deltaY<0?this.config.config.zoomStep:1/this.config.config.zoomStep,o=this.config.getCamera(),r=ge(o,n,this.config.config.bounds);this.config.setCamera(r),this.config.onZoom?.(n)}}function Ee(e){return new Te(e)}class j{config;inputConfig;camera;toolState;keyboardHandler;mouseHandler;enabled=!1;constructor(t){this.config=t,this.inputConfig=t.inputConfig||{tileSize:16,bounds:{minX:0,maxX:6400,minY:0,maxY:6400,minZoom:.5,maxZoom:4},zoomStep:1.15,startCamera:{x:3200,y:3200,z:2},menuPanelIds:["building-menu-panel","industrial-menu-panel","commercial-menu-panel","storage-menu-panel","special-menu-panel","road-menu-panel","milestone-menu-panel"]},this.camera=t.initialCamera||{...this.inputConfig.startCamera},this.toolState={currentTool:"PAN",selectedLevel:1,isActive:!1},this.keyboardHandler=new _({onMove:(n,o)=>this.config.onMove?.(n,o),onAction:n=>this.config.onAction?.(n),onModifierChange:n=>{},shouldBlockInput:t.shouldBlockInput,isLimitedInput:t.isLimitedInput}),this.mouseHandler=Ee({canvas:t.canvas,getCamera:()=>this.camera,setCamera:n=>{this.camera=n,this.config.onCameraChange?.(n)},getTool:()=>this.toolState.currentTool,config:this.inputConfig,onTileClick:t.onTileClick,onBuild:t.onBuild,placeRoadSilent:t.placeRoadSilent,showToast:t.showToast,getCanvasDimensions:t.getCanvasDimensions||(()=>({width:t.canvas.width,height:t.canvas.height}))})}getCamera(){return{...this.camera}}setCamera(t){this.camera=K({...this.camera,...t},this.inputConfig.bounds),this.config.onCameraChange?.(this.camera)}centerOn(t,n){this.setCamera({x:t,y:n})}centerOnTile(t,n){const o=(t+.5)*this.inputConfig.tileSize,r=(n+.5)*this.inputConfig.tileSize;this.centerOn(o,r)}setZoom(t){this.setCamera({z:t})}getTool(){return this.toolState.currentTool}setTool(t){this.toolState.currentTool=t,this.toolState.isActive=t!=="NONE"&&t!=="PAN"}getSelectedLevel(){return this.toolState.selectedLevel}setSelectedLevel(t){this.toolState.selectedLevel=t}isShiftHeld(){return ce()}getTilePosition(){return this.mouseHandler.getTilePosition()}enable(){this.enabled||(this.keyboardHandler.enable(),this.mouseHandler.enable(),this.enabled=!0)}disable(){this.enabled&&(this.keyboardHandler.disable(),this.mouseHandler.disable(),this.enabled=!1)}isEnabled(){return this.enabled}updateCallbacks(t){Object.assign(this.config,t),this.keyboardHandler.updateConfig({onMove:t.onMove,onAction:t.onAction})}}function dn(e){return new j(e)}function be(e,t,n){return new j({canvas:e,onMove:t,onAction:n})}const hn=Object.freeze(Object.defineProperty({__proto__:null,ACTION_KEYS:ue,DEFAULT_INPUT_CONFIG:on,InputController:j,KeyboardHandler:_,MOVEMENT_KEYS:B,MouseHandler:Te,addRoadDragPosition:ve,clampCamera:K,createInputController:dn,createKeyboardHandler:ln,createMouseHandler:Ee,createMovementHandler:un,createRoadDragState:V,createSimpleInputController:be,endRoadDrag:ye,extractModifiers:W,getModifierState:rn,getMovementDelta:de,inputPanCamera:fe,inputScreenToTile:cn,inputScreenToWorld:z,inputZoomCamera:ge,isActionKey:he,isClickBlockedByMenu:Se,isClickOnCanvas:me,isKeyPressed:an,isMovementKey:sn,isPointInRect:pe,isShiftHeld:ce,startRoadDrag:we,worldToTile:X},Symbol.toStringTag,{value:"Module"})),N={GAME_START:{title:"The Dream",text:"Early man had a dream one night... a vision of something greater than mere survival. He saw his descendants building, thriving, creating. And so, with nothing but hope and hunger, he left his people and began to wander...",illustration:"wanderer"},FIRST_WELL:{title:"Fresh Water!",text:"Digging far enough revealed what the wise ones spoke of - underground rivers! Fresh water bubbled up from the earth. No longer would the tribe be slaves to rivers and lakes. Now they could make water appear wherever they chose!",illustration:"well"},FIRST_RESIDENTIAL:{title:"A Proper Shelter",text:'Now THIS is proper living! No more sleeping under stars with wolves howling. Four walls and a roof - what luxury! The tribe looked upon their creation with pride. "We are no longer wanderers," they declared. "We are SETTLERS."',illustration:"hut"},FIRST_HUNTING_GROUND:{title:"The Hunting Grounds",text:"The wise hunter knows: chase the deer, catch one meal. Let the deer come to you, catch a hundred! And so the first hunting ground was established - a place where prey would wander in, never to wander out.",illustration:"hunting"},FIRST_ROAD:{title:"The Beaten Path",text:`Why walk through thorns when you can walk on dirt? The tribe's smartest member (whose name has been lost to time, but was probably "Ook" or "Ug") packed down the earth to make travel easier. Revolutionary!`,illustration:"road"},FIRST_KILL:{title:"The First Hunt",text:"Blood! Meat! VICTORY! The beast fell before the tribe's mighty hunter. Tonight they would feast, and tomorrow... they would hunt again. The way of the predator had begun.",illustration:"hunt_success"},FIRST_SETTLEMENT:{title:"A Settlement is Born",text:"No more wandering. No more running. This patch of earth... THIS belongs to us! The tribe drove stakes into the ground and declared themselves FOUNDERS. History was about to begin.",illustration:"settlement"},FIRST_STORAGE:{title:"The Storage Pit",text:`The brilliant idea came from watching squirrels hide nuts. "What if WE buried our food?" And lo, the storage pit was invented. Now surplus wouldn't rot in the sun - it would rot underground! Progress!`,illustration:"storage"},FIRST_COMMERCIAL:{title:"Trading Post",text:"One day, Ook had three fish. Ug had three berries. Both wanted variety. After much grunting and gesturing, they discovered TRADE! The economy was born, and Ook's descendants would one day invent taxes.",illustration:"trading"},FIRST_NOMAD:{title:"A Stranger Approaches",text:"From the mist emerged another... a fellow wanderer! Heart pounding, spear raised, our ancestor faced a choice. Friend or foe? The stranger raised a hand in peace. Today, the tribe grows stronger.",illustration:"nomad"},FIRST_TURTLE:{title:"Beach Bounty",text:'Upon the sandy shores, a strange shelled creature waddled slowly. "What manner of rock moves on its own?" wondered the hunter. Turns out, it was delicious. The beach would never go hungry again.',illustration:"turtle"},FLOOD_WARNING:{title:"The Waters Rise",text:'The elders spoke of this - the great waters that swallow the land. "Build high," they warned. "The sea remembers, and the sea returns." Perhaps it was time to seek higher ground...',illustration:"flood"},FIRST_BERRY:{title:"The Berry Bush",text:"Red and plump, the berries glistened in the sun. The hungry wanderer reached out... Would they bring life or death? 90% of the time, it's fine! The other 10%... well, that's how we learned which ones NOT to eat.",illustration:"berry"}};function fn(e){return N[e]}function S(e,t){return e[t]===!0}function gn(e,t){return{...e,[t]:!0}}function mn(e,t,n){return!(!e||S(t,n))}function pn(e){return Object.keys(N).filter(n=>!S(e,n))}function Ae(e){return Object.values(e).filter(Boolean).length}function Re(){return Object.keys(N).length}function Sn(e){const t=Re();return t===0?100:Math.round(Ae(e)/t*100)}function wn(e){return{shouldShow:!S(e,"FIRST_KILL"),eventId:"FIRST_KILL"}}function vn(e){return{shouldShow:!S(e,"FIRST_TURTLE"),eventId:"FIRST_TURTLE"}}function yn(e){return{shouldShow:!S(e,"FIRST_NOMAD"),eventId:"FIRST_NOMAD"}}function Tn(e){return{shouldShow:!S(e,"FIRST_BERRY"),eventId:"FIRST_BERRY"}}function En(e){return{shouldShow:!S(e,"FIRST_WELL"),eventId:"FIRST_WELL"}}function bn(e){return{shouldShow:!S(e,"FIRST_SETTLEMENT"),eventId:"FIRST_SETTLEMENT"}}function An(e,t){return{shouldShow:!S(e,"GAME_START")&&t===0,eventId:"GAME_START"}}function Rn(e){return{shouldShow:!S(e,"FLOOD_WARNING"),eventId:"FLOOD_WARNING"}}function Me(){return["wanderer","well","hut","hunting","road","hunt_success","settlement","storage","trading","nomad","turtle","flood","berry"]}function Mn(e){return Me().includes(e)}const P={SEA_LEVEL_MIN:1,SEA_LEVEL_MAX:6,FLOOD_WARNING_MARGIN:1};function In(e){return e==="WELL"||e==="COM"||e==="IND"?1:2}function Cn(e,t,n){const o=In(n.t);return e>=n.x&&e<n.x+o&&t>=n.y&&t<n.y+o}function On(e,t,n=P.FLOOD_WARNING_MARGIN){const o=e-t;return o<0?"flooding":o<=n?"danger":o<=n*2?"warning":"safe"}function Ie(e,t){return e-t}function Ln(e,t){const n=Ie(e,t);return n<0?"FLOODING!":`+${n.toFixed(1)} safe`}function Dn(e,t,n){const o=e.geology.currentSeaLevel;let r=0,i=0;const a=[];let s=0,u=0;const l=[];let c=!1;for(let h=0;h<t.W;h++)for(let f=0;f<t.H;f++){const d=e.tiles[h][f];if(!(d.elevation<=0||d.elevation>=8))if(d.elevation<o&&d.type!=="WATER"&&d.type!=="DEEP"){if((d.building||d.zone)&&(d.building&&d.building.pop&&(s+=d.building.pop),a.push({x:h,y:f,type:d.building?.type||d.zone||"unknown",pop:d.building?.pop||0})),e.blds)for(let y=0;y<e.blds.length;y++){const T=e.blds[y];Cn(h,f,T)&&(l.includes(y)||(l.push(y),T.t==="WELL"&&u++,T.t==="RES"&&T.pop&&(s+=T.pop)))}e.player&&e.player.x===h&&e.player.y===f&&(s+=e.pop,c=!0),d.type="WATER",d.tree=!1,d.road=!1,d.building=null,d.zone=null,d.bld=null,d.stoneDeposit=null,d.berry=!1,r++,n&&n(h,f,1)}else d.elevation>=o&&(d.type==="WATER"||d.type==="DEEP")&&d.elevation>1&&(d.type=d.originalType||"SAND",i++,n&&n(h,f,1))}if(l.length>0){l.sort((h,f)=>f-h);for(const h of l){const f=e.blds[h];a.push({x:f.x,y:f.y,type:f.t}),e.blds.splice(h,1)}}return{flooded:r,drained:i,buildingsLost:a,populationDrowned:s,wellsLost:u,playerDrowned:c}}function _n(e,t){return e>100?{message:`üì∞ CATASTROPHE! ${e} perished in the great flood! The ${t} brought destruction. Where you build matters...`,duration:8e3,severity:"catastrophe"}:e>20?{message:`üåäüíÄ ${e} drowned in rising waters! Some areas may be safer than others...`,duration:6e3,severity:"severe"}:{message:`üåä ${e} lost to rising waters. Perhaps higher ground would be wiser...`,duration:5e3,severity:"minor"}}function Nn(e){return`üíßüåä ${e} well${e>1?"s":""} swallowed by the sea!`}function Pn(e,t,n=.1,o=.1,r=P){return e<t?Math.min(r.SEA_LEVEL_MAX,e+n):e>t?Math.max(r.SEA_LEVEL_MIN,e-o):e}function xn(e,t){return e<t}function Fn(e,t){return e<t?"rising":e>t?"falling":"stable"}function kn(e,t){return{...e,tilesFlooded:e.tilesFlooded+t.flooded,tilesDrained:e.tilesDrained+t.drained,populationDrowned:e.populationDrowned+t.populationDrowned}}function Wn(e=P.SEA_LEVEL_MIN){return{currentSeaLevel:e,tilesFlooded:0,tilesDrained:0,populationDrowned:0}}const $n=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_SEA_LEVEL_CONFIG:P,LORE_EVENTS:N,applySeaLevelChange:Dn,checkFirstSettlementLore:bn,checkFirstWellLore:En,checkFloodWarningLore:Rn,checkGameStartLore:An,createInitialGeologyState:Wn,eventCheckFirstBerryLore:Tn,eventCheckFirstKillLore:wn,eventCheckFirstNomadLore:yn,eventCheckFirstTurtleLore:vn,eventIsFloodRisk:On,formatElevationMessage:Ln,generateFloodMessage:_n,generateWellsLostMessage:Nn,getAllIllustrations:Me,getElevationDiff:Ie,getLoreEvent:fn,getLoreProgress:Sn,getSeaLevelDirection:Fn,getSeenLoreCount:Ae,getTotalLoreCount:Re,getUnseenLore:pn,hasSeenLore:S,isSeaLevelRising:xn,isValidIllustration:Mn,markLoreSeen:gn,shouldShowLore:mn,updateGeologyStats:kn,updateSeaLevel:Pn},Symbol.toStringTag,{value:"Module"})),Un={terrain:{frequency:.02,octaves:5},ocean:{frequency:.008,octaves:5},lake:{frequency:.08,octaves:5,offsetX:500,offsetY:500},mountain:{frequency:.015,octaves:5,offsetX:1e3,offsetY:1e3},river:{frequency:.05,octaves:5,offsetX:100,offsetY:100}},p={PATCH_SIZE:8,PATCHES_PER_AREA:2500,ELEVATION_BIAS:2.5,RIVER_WIDTH:.015,MOUNTAIN_THRESHOLD:.68,MOUNTAIN_HEIGHT_MIN:.55,LAKE_THRESHOLD:.03,TREE_CHANCE:.2},Z={seed:1};function Ce(e){Z.seed=e}function Yn(){return Z.seed}function E(e,t){const n=Math.sin(e*12.98+t*78.23+Z.seed)*43758.54;return n-Math.floor(n)}function C(e,t,n){return e*(1-n)+t*n}function Oe(e,t){const n=Math.floor(e),o=Math.floor(t),r=e-n,i=t-o,a=r*r*(3-2*r),s=i*i*(3-2*i),u=E(n,o),l=E(n+1,o),c=E(n,o+1),h=E(n+1,o+1);return C(C(u,l,a),C(c,h,a),s)}function Le(e,t,n=5){let o=0,r=.5,i=e,a=t;for(let s=0;s<n;s++)o+=Oe(i,a)*r,i*=2,a*=2,r*=.5;return o}function w(e,t,n=5){return Le(e,t,n)/1.8}function De(e,t){return w(e*.02,t*.02)}function Gn(e,t){return w(e*.008,t*.008)}function _e(e,t){return w(e*.08+500,t*.08+500)}function Ne(e,t){return w(e*.015+1e3,t*.015+1e3)}function Pe(e,t){return w(e*.05+100,t*.05+100)}function xe(e,t,n=.015){const o=Pe(e,t);return Math.abs(o-.5)<n}function Hn(){return Math.floor(Math.random()*1e6)}function Bn(e,t,n,o=5,r=0,i=0){return w((e+r)*n,(t+i)*n,o)}function Fe(e,t,n=p.PATCH_SIZE,o=p.PATCHES_PER_AREA){const r=[],i=Math.floor(e*t/o);for(let a=0;a<i;a++){const s=Math.floor(Math.random()*(e-n-10))+5,u=Math.floor(Math.random()*(t-n-10))+5;r.push({x:s,y:u})}return r}function ke(e,t,n,o=p.PATCH_SIZE){for(const r of n)if(e>=r.x&&e<r.x+o&&t>=r.y&&t<r.y+o)return!0;return!1}function We(e,t=p.ELEVATION_BIAS){let n=Math.round(e*100+t*10)/10;return Math.min(10,Math.max(0,n))}function $e(){return 7+Math.random()*1.5}function Ue(e,t,n,o,r,i){const a=Ne(e,t),s=_e(e,t),u=xe(e,t,p.RIVER_WIDTH);let l="GRASS",c=n;return a>p.MOUNTAIN_THRESHOLD&&r>p.MOUNTAIN_HEIGHT_MIN?(l="STONE",c=9+Math.floor(Math.random()*2)):n<o-1.5?(l="DEEP",c=Math.max(0,n)):n<o-.5?l="WATER":s<p.LAKE_THRESHOLD&&n>=o&&n<o+.5&&!i?(l="WATER",c=o-.5):n<=o?l="SAND":n<5.5||n<7?l="GRASS":n<8?l="FOREST":n<9.5?l="ROCK":l="SNOW",u&&l!=="DEEP"&&l!=="WATER"&&!i&&(l="RIVER",c=o),{type:l,elevation:c}}function Ye(e,t,n,o){const r=De(e,t),i=ke(e,t,o);let a=We(r);i&&(a=$e());const s=Ue(e,t,a,n,r,i),l=(s.type==="GRASS"||s.type==="FOREST"||s.type==="SNOW")&&Math.random()>1-p.TREE_CHANCE;let c=null;return s.type==="STONE"&&(c={type:"STONE",amount:1e6+Math.floor(Math.random()*5e5),metal_yield:.2}),{type:s.type,elevation:s.elevation,originalType:s.type,road:!1,tree:l,pol:0,bld:null,explored:!1,zone:null,building:null,resource:c,stoneDeposit:null,entity:null}}function zn(e){const{seed:t,width:n,height:o,seaLevel:r,highGroundPatches:i,patchSize:a}=e;Ce(t);const s=i||Fe(n,o,a||p.PATCH_SIZE),u=[];for(let l=0;l<n;l++){u[l]=[];for(let c=0;c<o;c++)u[l][c]=Ye(l,c,r,s)}return u}function Xn(e){const t={};for(let n=0;n<e.length;n++)for(let o=0;o<e[n].length;o++){const r=e[n][o].type;t[r]=(t[r]||0)+1}return t}function Kn(e){let t=0,n=0;for(let r=0;r<e.length;r++)for(let i=0;i<e[r].length;i++){const a=e[r][i].type;a==="WATER"||a==="DEEP"||a==="RIVER"?n++:t++}const o=t+n;return{land:Math.round(t/o*100),water:Math.round(n/o*100)}}const Vn=["GRASS","FOREST","SAND","ROCK","SNOW"],jn=["GRASS","FOREST","SAND"];function x(e,t,n){if(t<0||t>=e.length||n<0||n>=e[0].length)return!1;const o=e[t][n].type;return Vn.includes(o)}function Zn(e){return jn.includes(e)}function q(e,t,n,o=200){const r=e.length,i=e[0].length,a=Array.from({length:r},()=>Array(i).fill(!1)),s=[[t,n]];let u=0;for(;s.length>0&&u<o;){const[l,c]=s.shift();if(l<0||c<0||l>=r||c>=i||a[l][c])continue;const h=e[l][c].type;Zn(h)&&(a[l][c]=!0,u++,s.push([l+1,c]),s.push([l-1,c]),s.push([l,c+1]),s.push([l,c-1]))}return u}function qn(e,t,n,o=40,r=60,i=100){for(let a=0;a<i;a++){const s=Math.floor(t+(Math.random()-.5)*o),u=Math.floor(n+(Math.random()-.5)*o);if(x(e,s,u)){const l=q(e,s,u,200);if(l>=r)return{x:s,y:u,method:"center",reachable:l}}}return null}function Jn(e,t=30,n=500){const o=e.length,r=e[0].length;for(let i=0;i<n;i++){const a=Math.floor(Math.random()*o),s=Math.floor(Math.random()*r);if(x(e,a,s)){const u=q(e,a,s,200);if(u>=t)return{x:a,y:s,method:"wide",reachable:u}}}return null}function Qn(e){for(let t=0;t<e.length;t++)for(let n=0;n<e[0].length;n++)if(x(e,t,n))return{x:t,y:n,method:"emergency",reachable:1};return null}function eo(e,t){return{x:Math.floor(e/2),y:Math.floor(t/2),method:"forced",reachable:0}}function to(e){const t=e.length,n=e[0].length,o=Math.floor(t/2),r=Math.floor(n/2),i=qn(e,o,r);if(i)return console.log("‚úÖ Player spawn at",i.x,i.y,"(center search)"),i;const a=Jn(e);if(a)return console.log("‚úÖ Player spawn at",a.x,a.y,"(wide search)"),a;console.warn("‚ö†Ô∏è Emergency spawn search...");const s=Qn(e);return s?(console.log("‚úÖ Player spawn at",s.x,s.y,"(emergency)"),s):(console.error("‚ùå No valid spawn found! Forcing center spawn."),eo(t,n))}function no(e){return{x:e.x,y:e.y,health:3,direction:"down"}}function oo(e,t,n,o){let r=0;const i=e.length,a=e[0].length;for(let s=-o;s<=o;s++)for(let u=-o;u<=o;u++){const l=t+s,c=n+u;l>=0&&l<i&&c>=0&&c<a&&(e[l][c].explored||(e[l][c].explored=!0,r++))}return r}function ro(e,t,n){return t<0||t>=e.length||n<0||n>=e[0].length?!1:e[t][n].explored}function io(e){let t=0;for(let n=0;n<e.length;n++)for(let o=0;o<e[n].length;o++)e[n][o].explored&&t++;return t}const ao=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_NOISE_PARAMS:Un,DEFAULT_WORLD_CONFIG:p,calculateElevation:We,createTile:Ye,customNoise:Bn,determineTerrainType:Ue,exploreArea:oo,fbm:Le,fbmNormalized:w,findSpawnLocation:to,generateHighGroundElevation:$e,generateHighGroundPatches:Fe,generateTerrain:zn,getExploredCount:io,getLandWaterRatio:Kn,getSeed:Yn,getTerrainStats:Xn,hash:E,initNoise:Ce,isInHighGroundPatch:ke,isRiverAt:xe,isTileExplored:ro,lakeNoise:_e,mix:C,mountainNoise:Ne,oceanNoise:Gn,randomSeed:Hn,riverNoise:Pe,terrainNoise:De,valueNoise:Oe,worldCountReachableTiles:q,worldCreatePlayer:no,worldIsValidSpawnPosition:x},Symbol.toStringTag,{value:"Module"})),$={startYear:0,startAge:0,yearsPerGeologicalUpdate:100},v={food:.2,foodWithStorage:.1,wood:.1,stone:.05,metal:.03},so={GROWTH_RATE:.05,STARVATION_DEATH_RATE:.2,EXPOSURE_DEATH_RATE:.15,PLAGUE_DEATH_RATE:.3,PLAGUE_CHANCE_MULTIPLIER:2,DEHYDRATION_DEATH_RATE:.2,WATER_PER_WELL:100};function lo(e=$.startYear,t=$.startAge){return{year:e,age:t,paused:!1,speed:1}}function uo(e){return{...e,year:e.year+1}}function co(e,t){return{...e,age:t}}function ho(e){return{...e,paused:!e.paused}}function fo(e,t){return{...e,speed:Math.max(.1,Math.min(10,t))}}function g(e,t,n="info",o){return{type:e,message:t,severity:n,value:o}}function go(e){return g("YEAR_ADVANCE",`Year ${e}`,"info",e)}function mo(e,t){const n=t?`üçÇ ${e} food rotted! (10% rate with storage)`:`üçÇ ${e} food rotted! Need storage buildings!`;return g("FOOD_SPOILAGE",n,"warning",e)}function po(e){return g("STARVATION",`üíÄ FAMINE! ${e} people starved to death!`,"danger",e)}function So(e){return g("GROWTH",`üë∂ ${e} new tribe members born!`,"success",e)}function wo(e,t,n,o){return g("WATER_SHORTAGE",`üíß Water shortage! ${e} died. Have ${t} wells (${n} capacity), pop: ${o}`,"danger",e)}function vo(e,t,n){return g("OVERCROWDING",`üèöÔ∏è OVERCROWDED! ${e} homeless: -${t} died, -${n} food stolen!`,"warning",t)}function yo(e,t){return g("PLAGUE",`‚ò†Ô∏è PLAGUE OUTBREAK! ${e} dead! Economy Collapsed!`,"danger",e)}function To(e){return g("BUILDING_ABANDON",`üíÄ ${e} settlement${e>1?"s":""} abandoned due to neglect!`,"warning",e)}function Eo(e,t=[]){return{year:e,success:!0,events:t,gameOver:!1}}function bo(e,t,n=[]){return{year:e,success:!1,events:n,gameOver:!0,gameOverReason:t}}function Ao(e,t,n,o,r=.05){if(n<=o*1.5||e>=t)return{growth:0,deaths:0,births:0,net:0};const i=Math.max(1,Math.ceil(e*r)),a=Math.min(i,t-e);return{growth:a,deaths:0,births:a,net:a,reason:"Well-fed population"}}function Ro(e,t=.2){const n=Math.ceil(e*t);return{growth:0,deaths:n,births:0,net:-n,reason:"Starvation"}}function Mo(e,t,n=.2){const o=Math.max(0,e-t);if(o===0)return{growth:0,deaths:0,births:0,net:0};const r=Math.ceil(o*n);return{growth:0,deaths:r,births:0,net:-r,reason:"Dehydration"}}function Io(e,t,n=.15){const o=Math.max(0,e-t);if(o===0)return{growth:0,deaths:0,births:0,net:0};const r=Math.ceil(o*n);return{growth:0,deaths:r,births:0,net:-r,reason:"Exposure"}}function Co(e,t,n=2,o=.3){const i=t/e*n;if(Math.random()>=i)return{triggered:!1,change:{growth:0,deaths:0,births:0,net:0}};const a=Math.ceil(e*o);return{triggered:!0,change:{growth:0,deaths:a,births:0,net:-a,reason:"Plague"}}}function Oo(e){switch(e){case"NO_FOOD":return"Your people starved to death!";case"NO_WATER":return"Your people died of thirst!";case"NO_POPULATION":return"Your civilization has perished!";case"FLOOD":return"Rising waters drowned your people!";case"PLAGUE":return"A great plague wiped out your people!";default:return"Your civilization has ended."}}function Lo(e,t,n){return e<=0?{end:!0,reason:"NO_POPULATION"}:t<=0&&e>0?{end:!0,reason:"NO_FOOD"}:!n&&e>0?{end:!0,reason:"NO_WATER"}:{end:!1}}function Do(e){return e<0?`${Math.abs(e)} BCE`:`Year ${e}`}function _o(e){switch(e){case 0:return"Paleolithic";case 1:return"City Age";case 2:return"Industrial Age";default:return`Age ${e}`}}function No(e,t=10){return e%t===0}function A(e,t,n){if(e<=t)return{spoiled:0,remaining:e};const o=e-t,r=Math.floor(o*n),i=Math.max(0,e-r);return{spoiled:r,remaining:i}}function Ge(e,t,n=!1,o=v){const r=n?o.foodWithStorage:o.food,i=A(e,t,r);let a;return i.spoiled>100&&Math.random()<.3&&(a=g("FOOD_SPOILAGE",n?`üçÇ ${i.spoiled} food rotted! (10% rate with Nuts Storage Reed House)`:`üçÇ ${i.spoiled} food rotted! Need storage buildings!`,"warning",i.spoiled)),{...i,event:a}}function He(e,t,n=v){const o=A(e,t,n.wood);let r;return o.spoiled>50&&Math.random()<.2&&(r=g("FOOD_SPOILAGE",`ü™µ ${o.spoiled} wood rotted!`,"warning",o.spoiled)),{decayed:o.spoiled,remaining:o.remaining,event:r}}function Be(e,t,n=v){const o=A(e,t,n.stone);let r;return o.spoiled>20&&Math.random()<.1&&(r=g("FOOD_SPOILAGE",`ü™® ${o.spoiled} stone scattered!`,"warning",o.spoiled)),{lost:o.spoiled,remaining:o.remaining,event:r}}function ze(e,t,n=v){const o=A(e,t,n.metal);let r;return o.spoiled>10&&Math.random()<.1&&(r=g("FOOD_SPOILAGE",`‚öôÔ∏è ${o.spoiled} metal rusted! Build Metal Pit!`,"warning",o.spoiled)),{rusted:o.spoiled,remaining:o.remaining,event:r}}function Po(e,t,n=!1,o=v){const r=[],i=Ge(e.food,t.food,n,o);i.event&&r.push(i.event);const a=He(e.wood,t.wood,o);a.event&&r.push(a.event);const s=Be(e.stone,t.stone,o);s.event&&r.push(s.event);const u=ze(e.metal,t.metal,o);return u.event&&r.push(u.event),{remaining:{food:i.remaining,wood:a.remaining,stone:s.remaining,metal:u.remaining},spoiled:{food:i.spoiled,wood:a.decayed,stone:s.lost,metal:u.rusted},events:r}}function xo(e,t,n=.5,o=1){const i=(e-t)*n,a=t*o;return Math.ceil(i+a)}function Fo(e,t){return e>=t?{remaining:e-t,shortage:0}:{remaining:0,shortage:t-e}}const ko=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_POPULATION_CONFIG:so,DEFAULT_SPOILAGE_RATES:v,DEFAULT_TIME_CONFIG:$,advanceYear:uo,buildingAbandonEvent:To,calculateBuildingUpkeep:xo,calculateDehydration:Mo,calculateFoodSpoilage:Ge,calculateGrowth:Ao,calculateMetalRust:ze,calculateOvercrowding:Io,calculatePlague:Co,calculateSpoilage:A,calculateStarvation:Ro,calculateStoneLoss:Be,calculateWoodDecay:He,createGameOverResult:bo,createTimeState:lo,createTurnEvent:g,createTurnResult:Eo,foodSpoilageEvent:mo,formatYear:Do,getEpochName:_o,getGameOverMessage:Oo,growthEvent:So,isMilestoneYear:No,overcrowdingEvent:vo,plagueEvent:yo,processAllSpoilage:Po,processUpkeep:Fo,setAge:co,setSpeed:fo,shouldGameEnd:Lo,starvationEvent:po,togglePause:ho,waterShortageEvent:wo,yearAdvanceEvent:go},Symbol.toStringTag,{value:"Module"})),Xe=30,J=1e3/Xe,Wo=500;class $o{canvas;ctx;gameState=null;camera;inputController=null;lastFrameTime=0;lastAIUpdate=0;running=!1;frameCount=0;constructor(t){const n=document.getElementById(t);if(!n)throw new Error(`Canvas element '${t}' not found`);const o=n.getContext("2d");if(!o)throw new Error("Could not get 2D context");this.canvas=n,this.ctx=o,this.camera=tt(1600,1600,1),this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}resizeCanvas(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight}async init(){console.log("üèõÔ∏è Civil Zones v48.0 - Initializing..."),this.updateLoadingStatus("Initializing game state..."),this.gameState=oe(),this.updateLoadingStatus("Setting up input handlers..."),this.inputController=be(this.canvas,(t,n)=>this.handleMove(t,n),t=>this.handleAction(t)),this.updateLoadingStatus("Loading assets..."),nt(),this.updateLoadingStatus("Ready!"),document.body.classList.add("game-ready"),console.log("‚úÖ Civil Zones initialized successfully"),ot("üèõÔ∏è Welcome to Civil Zones v48.0!",{duration:3e3})}updateLoadingStatus(t){const n=document.querySelector("#loading-screen .status");n&&(n.textContent=t)}start(){this.running||(this.running=!0,this.lastFrameTime=performance.now(),this.inputController?.enable(),this.gameLoop(this.lastFrameTime))}stop(){this.running=!1,this.inputController?.disable()}gameLoop(t){if(!this.running)return;const n=t-this.lastFrameTime;n>=J&&(this.lastFrameTime=t-n%J,this.frameCount++,this.update(n),this.render()),requestAnimationFrame(o=>this.gameLoop(o))}update(t){if(!this.gameState)return;const n=performance.now();n-this.lastAIUpdate>=Wo&&(this.lastAIUpdate=n,this.updateAI()),this.updateSystems(t)}updateAI(){}updateSystems(t){this.gameState}render(){const t=this.ctx,n=this.camera,o={width:this.canvas.width,height:this.canvas.height};t.fillStyle="#1a1a2a",t.fillRect(0,0,this.canvas.width,this.canvas.height),rt(t,n,o),this.renderWorld(),it(t),this.renderUI()}renderWorld(){const t=this.ctx,n=32;t.strokeStyle="rgba(255, 255, 255, 0.1)",t.lineWidth=1;for(let o=0;o<100;o++)for(let r=0;r<100;r++)t.strokeRect(o*n,r*n,n,n);t.fillStyle="#D4A040",t.beginPath(),t.arc(50*n,50*n,10,0,Math.PI*2),t.fill()}renderUI(){const t=this.ctx;t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(10,10,100,30),t.fillStyle="#4CAF50",t.font="14px monospace",t.fillText(`FPS: ${Xe}`,20,30)}handleMove(t,n){console.log("Move:",t,n),at(this.camera,t*10,n*10)}handleAction(t){console.log("Action:",t)}}async function Q(){try{const e=new $o("game-canvas");await e.init(),e.start(),window.CivilZones=e,window.GameModules={Types:je,Config:Ve,Core:Ke,Systems:Je,Rendering:et,GameModule:nn,Input:hn,UI:Qe,AI:st,Buildings:qe,Entities:Ze,Events:$n,World:ao,Time:ko}}catch(e){console.error("‚ùå Failed to initialize Civil Zones:",e);const t=document.getElementById("loading-screen");if(t){const n=t.querySelector(".status");n&&(n.textContent=`Error: ${e}`,n.setAttribute("style","color: #ff6b6b;"))}}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Q):Q();
//# sourceMappingURL=main-Dqpu6dKW.js.map
