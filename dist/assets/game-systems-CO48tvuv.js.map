{"version":3,"file":"game-systems-CO48tvuv.js","sources":["../../src/systems/population.ts","../../src/systems/demand.ts","../../src/systems/geology.ts","../../src/systems/workforce.ts","../../src/systems/needs.ts","../../src/buildings/types.ts","../../src/buildings/validation.ts","../../src/buildings/zones.ts","../../src/buildings/placement.ts","../../src/buildings/evolution.ts","../../src/entities/types.ts","../../src/entities/spawning.ts","../../src/entities/combat.ts","../../src/entities/nomads.ts","../../src/entities/berries.ts"],"sourcesContent":["/**\r\n * Civil Zones - Population System\r\n * Handles population assignment to buildings and workforce management\r\n */\r\n\r\nimport type { Tile, TileBuilding } from '../types/index.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TYPES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Building with population tracking */\r\ninterface PopulatedBuilding {\r\n    tile?: Tile;\r\n    bld?: BuildingInstance;\r\n    cap: number;\r\n    overflowCap?: number;\r\n}\r\n\r\n/** Building instance from blds array */\r\ninterface BuildingInstance {\r\n    t: 'RES' | 'COM' | 'IND';\r\n    x: number;\r\n    y: number;\r\n    lvl: number;\r\n    pop: number;\r\n    capacity?: number;\r\n}\r\n\r\n/** Level configuration (expected from CFG) */\r\ninterface LevelConfig {\r\n    capacity: number;\r\n    overflowCapacity?: number;\r\n}\r\n\r\n/** Game state interface (minimal for population system) */\r\ninterface PopulationGameState {\r\n    tiles: Tile[][];\r\n    blds: BuildingInstance[];\r\n    pop: number;\r\n    BUILDING_LEVELS?: LevelConfig[];\r\n    COMMERCIAL_LEVELS?: LevelConfig[];\r\n    INDUSTRIAL_LEVELS?: LevelConfig[];\r\n}\r\n\r\n/** Workforce tracking */\r\nexport interface WorkforceState {\r\n    total: number;\r\n    wellWorkers: number;\r\n    roadWorkers: number;\r\n    comWorkers: number;\r\n    indWorkers: number;\r\n    gatherers: number;\r\n    wellsNeeded: number;\r\n    roadsNeeded: number;\r\n    comNeeded: number;\r\n    indNeeded: number;\r\n    shortage: number;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// POPULATION ASSIGNMENT\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Assign population to residential buildings\r\n * Fills largest buildings first, allows overflow when needed\r\n */\r\nexport function assignPopulationToResidential(\r\n    game: PopulationGameState,\r\n    buildingLevels: LevelConfig[]\r\n): number {\r\n    const residentials: PopulatedBuilding[] = [];\r\n    \r\n    // Find all residential zones\r\n    for (let x = 0; x < game.tiles.length; x++) {\r\n        for (let y = 0; y < game.tiles[0].length; y++) {\r\n            const tile = game.tiles[x][y];\r\n            if (tile.zone === 'R' && tile.building) {\r\n                const buildingLevel = tile.building.level || 1;\r\n                const levelConfig = buildingLevels[buildingLevel] || buildingLevels[1];\r\n                const capacity = levelConfig?.capacity || 20;\r\n                const overflowCapacity = levelConfig?.overflowCapacity || (capacity + 5);\r\n                \r\n                residentials.push({\r\n                    tile,\r\n                    cap: capacity,\r\n                    overflowCap: overflowCapacity\r\n                });\r\n            }\r\n        }\r\n    }\r\n    \r\n    let totalPop = game.pop;\r\n    \r\n    // Reset all building populations\r\n    for (const res of residentials) {\r\n        if (res.tile?.building) {\r\n            res.tile.building.pop = 0;\r\n        }\r\n    }\r\n    \r\n    // Sort by capacity (largest first)\r\n    residentials.sort((a, b) => b.cap - a.cap);\r\n    \r\n    // First pass: fill to normal capacity\r\n    for (const res of residentials) {\r\n        const assign = Math.min(res.cap, totalPop);\r\n        if (res.tile?.building) {\r\n            res.tile.building.pop = assign;\r\n        }\r\n        totalPop -= assign;\r\n        if (totalPop <= 0) break;\r\n    }\r\n    \r\n    // Second pass: allow overflow if needed\r\n    if (totalPop > 0) {\r\n        for (const res of residentials) {\r\n            const currentPop = res.tile?.building?.pop || 0;\r\n            const extraSpace = (res.overflowCap || res.cap) - currentPop;\r\n            \r\n            if (extraSpace > 0) {\r\n                const assign = Math.min(extraSpace, totalPop);\r\n                if (res.tile?.building) {\r\n                    res.tile.building.pop = (res.tile.building.pop || 0) + assign;\r\n                }\r\n                totalPop -= assign;\r\n                if (totalPop <= 0) break;\r\n            }\r\n        }\r\n    }\r\n    \r\n    return totalPop; // Return remaining population (workers available)\r\n}\r\n\r\n/**\r\n * Assign workers to commercial and industrial buildings\r\n */\r\nexport function assignPopulationToZones(\r\n    game: PopulationGameState,\r\n    availablePop: number,\r\n    commercialLevels?: LevelConfig[],\r\n    industrialLevels?: LevelConfig[]\r\n): void {\r\n    const commercials: PopulatedBuilding[] = [];\r\n    const industrials: PopulatedBuilding[] = [];\r\n    \r\n    // Check blds array for COM and IND buildings\r\n    if (game.blds && game.blds.length > 0) {\r\n        for (const bld of game.blds) {\r\n            if (bld.t === 'COM') {\r\n                const buildingLevel = bld.lvl || 1;\r\n                const levelConfig = commercialLevels?.[buildingLevel];\r\n                const capacity = levelConfig?.capacity || bld.capacity || (buildingLevel * 10);\r\n                commercials.push({ bld, cap: capacity });\r\n            }\r\n            if (bld.t === 'IND') {\r\n                const buildingLevel = bld.lvl || 1;\r\n                const levelConfig = industrialLevels?.[buildingLevel];\r\n                const capacity = levelConfig?.capacity || bld.capacity || (buildingLevel * 15);\r\n                industrials.push({ bld, cap: capacity });\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Also check tiles for zone-based commercial/industrial\r\n    for (let x = 0; x < game.tiles.length; x++) {\r\n        for (let y = 0; y < game.tiles[0].length; y++) {\r\n            const tile = game.tiles[x][y];\r\n            \r\n            if ((tile.zone === 'C') && tile.building) {\r\n                const buildingLevel = tile.building.level || 1;\r\n                const levelConfig = commercialLevels?.[buildingLevel];\r\n                const capacity = levelConfig?.capacity || 10;\r\n                commercials.push({ tile, cap: capacity });\r\n            }\r\n            \r\n            if ((tile.zone === 'I') && tile.building) {\r\n                const buildingLevel = tile.building.level || 1;\r\n                const levelConfig = industrialLevels?.[buildingLevel];\r\n                const capacity = levelConfig?.capacity || 10;\r\n                industrials.push({ tile, cap: capacity });\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Reset all building populations\r\n    for (const com of commercials) {\r\n        if (com.bld) com.bld.pop = 0;\r\n        if (com.tile?.building) com.tile.building.pop = 0;\r\n    }\r\n    for (const ind of industrials) {\r\n        if (ind.bld) ind.bld.pop = 0;\r\n        if (ind.tile?.building) ind.tile.building.pop = 0;\r\n    }\r\n    \r\n    // Assign workers to commercial first\r\n    for (const com of commercials) {\r\n        const assign = Math.min(com.cap, availablePop);\r\n        if (com.bld) com.bld.pop = assign;\r\n        if (com.tile?.building) com.tile.building.pop = assign;\r\n        availablePop -= assign;\r\n        if (availablePop <= 0) break;\r\n    }\r\n    \r\n    // Then industrial\r\n    for (const ind of industrials) {\r\n        const assign = Math.min(ind.cap, availablePop);\r\n        if (ind.bld) ind.bld.pop = assign;\r\n        if (ind.tile?.building) ind.tile.building.pop = assign;\r\n        availablePop -= assign;\r\n        if (availablePop <= 0) break;\r\n    }\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// WORKFORCE CALCULATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Calculate workforce distribution and needs\r\n */\r\nexport function calculateWorkforce(\r\n    population: number,\r\n    wellCount: number,\r\n    roadTileCount: number,\r\n    commercialCapacity: number,\r\n    industrialCapacity: number\r\n): WorkforceState {\r\n    // Workers per infrastructure type\r\n    const WORKERS_PER_WELL = 2;\r\n    const WORKERS_PER_10_ROADS = 1;\r\n    \r\n    const wellsNeeded = wellCount * WORKERS_PER_WELL;\r\n    const roadsNeeded = Math.ceil(roadTileCount / 10) * WORKERS_PER_10_ROADS;\r\n    \r\n    // Total workforce is population (simplified - could be % of pop)\r\n    const total = population;\r\n    \r\n    // Assign workers in priority order\r\n    const wellWorkers = Math.min(wellsNeeded, total);\r\n    let remaining = total - wellWorkers;\r\n    \r\n    const roadWorkers = Math.min(roadsNeeded, remaining);\r\n    remaining -= roadWorkers;\r\n    \r\n    const comWorkers = Math.min(commercialCapacity, remaining);\r\n    remaining -= comWorkers;\r\n    \r\n    const indWorkers = Math.min(industrialCapacity, remaining);\r\n    remaining -= indWorkers;\r\n    \r\n    const gatherers = remaining;\r\n    \r\n    // Calculate shortage\r\n    const totalNeeded = wellsNeeded + roadsNeeded + commercialCapacity + industrialCapacity;\r\n    const shortage = Math.max(0, totalNeeded - total);\r\n    \r\n    return {\r\n        total,\r\n        wellWorkers,\r\n        roadWorkers,\r\n        comWorkers,\r\n        indWorkers,\r\n        gatherers,\r\n        wellsNeeded,\r\n        roadsNeeded,\r\n        comNeeded: commercialCapacity,\r\n        indNeeded: industrialCapacity,\r\n        shortage\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// BUILDING VARIANT CALCULATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** State threshold configuration */\r\ninterface StateThreshold {\r\n    min: number;\r\n    max: number;\r\n}\r\n\r\n/**\r\n * Calculate building variant based on population/activity ratio\r\n * Returns 0-3 for abandoned/low/medium/high states\r\n */\r\nexport function calculateBuildingVariant(\r\n    currentPop: number,\r\n    capacity: number,\r\n    stateThresholds?: StateThreshold[]\r\n): number {\r\n    if (capacity === 0) return 0;\r\n    \r\n    // If thresholds provided, use them\r\n    if (stateThresholds && stateThresholds.length >= 4) {\r\n        for (let i = stateThresholds.length - 1; i >= 0; i--) {\r\n            const threshold = stateThresholds[i];\r\n            if (currentPop >= threshold.min && currentPop <= threshold.max) {\r\n                return i;\r\n            }\r\n        }\r\n        // If below all thresholds, return 0 (abandoned)\r\n        return 0;\r\n    }\r\n    \r\n    // Default ratio-based calculation\r\n    const ratio = currentPop / capacity;\r\n    \r\n    if (ratio === 0) return 0;      // Abandoned\r\n    if (ratio <= 0.33) return 1;    // Low\r\n    if (ratio <= 0.66) return 2;    // Medium\r\n    return 3;                        // High\r\n}\r\n\r\n/**\r\n * Get variant for commercial/industrial based on activity ratio (0.0-1.0)\r\n */\r\nexport function calculateActivityVariant(\r\n    activityRatio: number,\r\n    stateThresholds?: StateThreshold[]\r\n): number {\r\n    if (stateThresholds && stateThresholds.length >= 4) {\r\n        for (let i = stateThresholds.length - 1; i >= 0; i--) {\r\n            const threshold = stateThresholds[i];\r\n            if (activityRatio >= threshold.min && activityRatio <= threshold.max) {\r\n                return i;\r\n            }\r\n        }\r\n        return 0;\r\n    }\r\n    \r\n    // Default thresholds\r\n    if (activityRatio === 0) return 0;\r\n    if (activityRatio <= 0.3) return 1;\r\n    if (activityRatio <= 0.7) return 2;\r\n    return 3;\r\n}\r\n","/**\r\n * Civil Zones - RCI Demand System\r\n * SimCity-style interdependent zone demand calculation\r\n * \r\n * R demand: People want to live where there are jobs (C+I)\r\n * C demand: Commerce needs customers (R) AND goods to sell (I)\r\n * I demand: Industry needs workers (R) AND buyers for goods (C)\r\n */\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TYPES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** RCI demand values (0-100 scale, higher = more needed) */\r\nexport interface RCIDemand {\r\n    r: number;  // Residential demand\r\n    c: number;  // Commercial demand\r\n    i: number;  // Industrial demand\r\n}\r\n\r\n/** Zone counts for demand calculation */\r\nexport interface ZoneCounts {\r\n    residential: number;\r\n    commercial: number;\r\n    industrial: number;\r\n}\r\n\r\n/** Population/housing data for demand calculation */\r\nexport interface DemandPopulationData {\r\n    population: number;\r\n    housingCapacity: number;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// DEMAND CALCULATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Workers per commercial zone */\r\nconst JOBS_PER_COMMERCIAL = 10;\r\n\r\n/** Workers per industrial zone */\r\nconst JOBS_PER_INDUSTRIAL = 15;\r\n\r\n/** Ideal ratio of commercial to residential */\r\nconst IDEAL_COMMERCIAL_RATIO = 0.5;\r\n\r\n/** Ideal ratio of industrial to residential */\r\nconst IDEAL_INDUSTRIAL_RATIO = 0.5;\r\n\r\n/**\r\n * Calculate RCI demand based on zone counts and population\r\n * Returns demand values 0-100 where higher = more of that zone type needed\r\n */\r\nexport function calculateRCIDemand(\r\n    zones: ZoneCounts,\r\n    popData: DemandPopulationData\r\n): RCIDemand {\r\n    const { residential: resCount, commercial: comCount, industrial: indCount } = zones;\r\n    const { population: pop, housingCapacity: housingCap } = popData;\r\n    \r\n    const totalZones = resCount + comCount + indCount;\r\n    \r\n    // Jobs come from Commercial (10 each) and Industrial (15 each)\r\n    const jobCapacity = (comCount * JOBS_PER_COMMERCIAL) + (indCount * JOBS_PER_INDUSTRIAL);\r\n    const unemployed = Math.max(0, pop - jobCapacity);\r\n    const housingNeed = housingCap > 0 ? (housingCap - pop) / housingCap : 0;\r\n    \r\n    // === RESIDENTIAL DEMAND ===\r\n    const rDemand = calculateResidentialDemand(\r\n        totalZones, resCount, comCount, indCount, pop, housingCap, housingNeed, jobCapacity\r\n    );\r\n    \r\n    // === COMMERCIAL DEMAND ===\r\n    const cDemand = calculateCommercialDemand(resCount, comCount, indCount);\r\n    \r\n    // === INDUSTRIAL DEMAND ===\r\n    const iDemand = calculateIndustrialDemand(resCount, comCount, indCount, pop, unemployed);\r\n    \r\n    // Clamp all demands 0-100\r\n    return {\r\n        r: clamp(rDemand, 0, 100),\r\n        c: clamp(cDemand, 0, 100),\r\n        i: clamp(iDemand, 0, 100)\r\n    };\r\n}\r\n\r\n/**\r\n * Calculate residential demand\r\n * High when: jobs available but housing full, or C+I exist but R doesn't\r\n */\r\nfunction calculateResidentialDemand(\r\n    totalZones: number,\r\n    resCount: number,\r\n    comCount: number,\r\n    indCount: number,\r\n    pop: number,\r\n    housingCap: number,\r\n    housingNeed: number,\r\n    jobCapacity: number\r\n): number {\r\n    if (totalZones === 0) {\r\n        return 100; // Nothing built - need residential first!\r\n    }\r\n    \r\n    if (housingNeed < 0.2 && jobCapacity > pop * 0.5) {\r\n        return 80; // Housing nearly full but jobs available\r\n    }\r\n    \r\n    if (comCount + indCount > resCount * 0.5) {\r\n        return 60; // More industry than people to work it\r\n    }\r\n    \r\n    if (pop < housingCap * 0.5) {\r\n        return 40; // Room to grow\r\n    }\r\n    \r\n    return Math.max(10, 50 - (resCount / Math.max(1, comCount + indCount)) * 10);\r\n}\r\n\r\n/**\r\n * Calculate commercial demand\r\n * Needs BOTH residential (customers) AND industrial (goods to sell)\r\n */\r\nfunction calculateCommercialDemand(\r\n    resCount: number,\r\n    comCount: number,\r\n    indCount: number\r\n): number {\r\n    if (resCount === 0) {\r\n        return 10; // No customers yet\r\n    }\r\n    \r\n    if (comCount === 0 && resCount > 0) {\r\n        return 90; // People but no shops!\r\n    }\r\n    \r\n    const customersPerCom = comCount / resCount;\r\n    const goodsSupply = indCount > 0 ? comCount / indCount : 0;\r\n    \r\n    if (customersPerCom < 0.3 && indCount > 0) {\r\n        return 70; // Not enough shops for the people\r\n    }\r\n    \r\n    if (goodsSupply > 2) {\r\n        return 20; // Too many shops, not enough goods\r\n    }\r\n    \r\n    // Calculate based on ideal ratio\r\n    const actualRatio = comCount / resCount;\r\n    return Math.max(10, Math.min(80, (IDEAL_COMMERCIAL_RATIO - actualRatio) * 100 + 50));\r\n}\r\n\r\n/**\r\n * Calculate industrial demand\r\n * Industry provides: jobs for R, goods for C\r\n */\r\nfunction calculateIndustrialDemand(\r\n    resCount: number,\r\n    comCount: number,\r\n    indCount: number,\r\n    pop: number,\r\n    unemployed: number\r\n): number {\r\n    if (resCount === 0) {\r\n        return 10; // No workers yet\r\n    }\r\n    \r\n    if (indCount === 0 && resCount > 0) {\r\n        return 80; // People but no industry!\r\n    }\r\n    \r\n    if (comCount > indCount * 2) {\r\n        return 90; // Commerce needs goods to sell!\r\n    }\r\n    \r\n    if (unemployed > pop * 0.3) {\r\n        return 70; // People need jobs\r\n    }\r\n    \r\n    // Calculate based on ideal ratio\r\n    const actualRatio = indCount / resCount;\r\n    return Math.max(10, Math.min(80, (IDEAL_INDUSTRIAL_RATIO - actualRatio) * 100 + 50));\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// DEMAND BAR VISUALIZATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Demand bar colors */\r\nexport const DEMAND_COLORS = {\r\n    residential: '#4CAF50',  // Green\r\n    commercial: '#2196F3',   // Blue\r\n    industrial: '#FF9800'    // Orange\r\n} as const;\r\n\r\n/**\r\n * Get demand bar height (0-100 scale)\r\n * Used for UI visualization\r\n */\r\nexport function getDemandBarHeight(demand: number, maxHeight: number = 100): number {\r\n    return (clamp(demand, 0, 100) / 100) * maxHeight;\r\n}\r\n\r\n/**\r\n * Get demand description for tooltip\r\n */\r\nexport function getDemandDescription(type: 'r' | 'c' | 'i', demand: number): string {\r\n    const level = demand > 70 ? 'High' : demand > 40 ? 'Medium' : demand > 10 ? 'Low' : 'None';\r\n    \r\n    const labels: Record<string, string> = {\r\n        r: 'Residential',\r\n        c: 'Commercial',\r\n        i: 'Industrial'\r\n    };\r\n    \r\n    return `${labels[type]} Demand: ${level} (${Math.round(demand)}%)`;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// UTILITY\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\nfunction clamp(value: number, min: number, max: number): number {\r\n    return Math.max(min, Math.min(max, value));\r\n}\r\n","/**\r\n * Civil Zones - Geological System\r\n * Handles sea level changes, ice ages, and flooding mechanics\r\n */\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TYPES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Geological period configuration */\r\nexport interface GeologicalPeriod {\r\n    name: string;\r\n    duration: number;   // In centuries\r\n    seaLevel: number;   // Target sea level (0-10)\r\n}\r\n\r\n/** Current geological state */\r\nexport interface GeologyState {\r\n    currentSeaLevel: number;        // Current water level (0-10)\r\n    periodIndex: number;            // Current geological period index\r\n    centuriesInPeriod: number;      // Centuries spent in current period\r\n    lastUpdateYear: number;         // Last year water was checked\r\n    tilesFlooded: number;           // Count of tiles lost to rising water\r\n    tilesDrained: number;           // Count of tiles gained from receding water\r\n    currentPeriodName: string;      // Display name of current period\r\n    populationDrowned?: number;     // Total population lost to flooding\r\n}\r\n\r\n/** Elevation system configuration */\r\nexport interface ElevationConfig {\r\n    ENABLED: boolean;\r\n    UPDATE_INTERVAL_YEARS: number;\r\n    SEA_LEVEL_MIN: number;\r\n    SEA_LEVEL_MAX: number;\r\n    FLOOD_WARNING_MARGIN: number;\r\n    COST_THRESHOLD: number;\r\n    COST_INCREASE_PER_LEVEL: number;\r\n    GEOLOGICAL_PERIODS: GeologicalPeriod[];\r\n}\r\n\r\n/** Tile elevation info */\r\nexport interface TileElevationInfo {\r\n    elevation: number;\r\n    seaLevel: number;\r\n    status: 'safe' | 'warning' | 'danger' | 'underwater';\r\n    description: string;\r\n    floodRisk: boolean;\r\n}\r\n\r\n/** Flood event data */\r\nexport interface FloodEvent {\r\n    year: number;\r\n    tilesFlooded: number;\r\n    buildingsLost: number;\r\n    populationDrowned: number;\r\n    periodName: string;\r\n    seaLevel: number;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// DEFAULT CONFIGURATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Default geological periods (based on real ice age cycles) */\r\nexport const DEFAULT_GEOLOGICAL_PERIODS: GeologicalPeriod[] = [\r\n    { name: \"Warm Interglacial\", duration: 100, seaLevel: 3 },   // 10,000 years warmth\r\n    { name: \"Early Glaciation\", duration: 50, seaLevel: 2.5 },   // 5,000 years cooling\r\n    { name: \"Ice Age Peak\", duration: 80, seaLevel: 1.5 },       // 8,000 years of ice\r\n    { name: \"Glacial Melt\", duration: 30, seaLevel: 3.5 },       // 3,000 years of melt\r\n    { name: \"Flood Period\", duration: 20, seaLevel: 4 },         // 2,000 years high water\r\n    { name: \"Stabilization\", duration: 50, seaLevel: 3 }         // 5,000 years normalizing\r\n];\r\n\r\n/** Default elevation system config */\r\nexport const DEFAULT_ELEVATION_CONFIG: ElevationConfig = {\r\n    ENABLED: true,\r\n    UPDATE_INTERVAL_YEARS: 100,\r\n    SEA_LEVEL_MIN: 1,\r\n    SEA_LEVEL_MAX: 6,\r\n    FLOOD_WARNING_MARGIN: 1,\r\n    COST_THRESHOLD: 4,\r\n    COST_INCREASE_PER_LEVEL: 0.10,\r\n    GEOLOGICAL_PERIODS: DEFAULT_GEOLOGICAL_PERIODS\r\n};\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// GEOLOGICAL CYCLE MANAGEMENT\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Create initial geology state\r\n */\r\nexport function createGeologyState(config: ElevationConfig = DEFAULT_ELEVATION_CONFIG): GeologyState {\r\n    const initialPeriod = config.GEOLOGICAL_PERIODS[0];\r\n    return {\r\n        currentSeaLevel: initialPeriod.seaLevel,\r\n        periodIndex: 0,\r\n        centuriesInPeriod: 0,\r\n        lastUpdateYear: 0,\r\n        tilesFlooded: 0,\r\n        tilesDrained: 0,\r\n        currentPeriodName: initialPeriod.name,\r\n        populationDrowned: 0\r\n    };\r\n}\r\n\r\n/**\r\n * Check if geological update should occur\r\n */\r\nexport function shouldUpdateGeology(\r\n    currentYear: number,\r\n    lastUpdateYear: number,\r\n    updateInterval: number\r\n): boolean {\r\n    return currentYear - lastUpdateYear >= updateInterval;\r\n}\r\n\r\n/**\r\n * Advance to next geological period\r\n * Returns new period info or null if staying in current period\r\n */\r\nexport function advanceGeologicalPeriod(\r\n    state: GeologyState,\r\n    periods: GeologicalPeriod[]\r\n): GeologicalPeriod | null {\r\n    state.centuriesInPeriod++;\r\n    \r\n    const currentPeriod = periods[state.periodIndex];\r\n    if (state.centuriesInPeriod >= currentPeriod.duration) {\r\n        // Move to next period\r\n        state.periodIndex = (state.periodIndex + 1) % periods.length;\r\n        state.centuriesInPeriod = 0;\r\n        \r\n        const newPeriod = periods[state.periodIndex];\r\n        state.currentPeriodName = newPeriod.name;\r\n        \r\n        return newPeriod;\r\n    }\r\n    \r\n    return null;\r\n}\r\n\r\n/**\r\n * Calculate sea level change step\r\n * Returns the amount to change sea level by (positive = rising, negative = falling)\r\n */\r\nexport function calculateSeaLevelChange(\r\n    currentLevel: number,\r\n    targetLevel: number,\r\n    config: ElevationConfig\r\n): number {\r\n    const CHANGE_RATE = 0.1; // Per century\r\n    \r\n    if (currentLevel < targetLevel) {\r\n        const newLevel = Math.min(config.SEA_LEVEL_MAX, currentLevel + CHANGE_RATE);\r\n        return newLevel - currentLevel;\r\n    } else if (currentLevel > targetLevel) {\r\n        const newLevel = Math.max(config.SEA_LEVEL_MIN, currentLevel - CHANGE_RATE);\r\n        return newLevel - currentLevel;\r\n    }\r\n    \r\n    return 0;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// FLOOD RISK ASSESSMENT\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Check if a tile is at flood risk\r\n */\r\nexport function isFloodRisk(\r\n    tileElevation: number,\r\n    seaLevel: number,\r\n    warningMargin: number\r\n): boolean {\r\n    return tileElevation <= seaLevel + warningMargin && tileElevation > seaLevel;\r\n}\r\n\r\n/**\r\n * Check if a tile should be flooded\r\n */\r\nexport function shouldFlood(tileElevation: number, seaLevel: number): boolean {\r\n    return tileElevation > 0 && tileElevation < seaLevel;\r\n}\r\n\r\n/**\r\n * Check if a tile should drain (was underwater, now above sea level)\r\n */\r\nexport function shouldDrain(\r\n    tileElevation: number,\r\n    seaLevel: number,\r\n    tileType: string\r\n): boolean {\r\n    // Only drain shallow water tiles (not deep ocean)\r\n    return (\r\n        tileElevation >= seaLevel &&\r\n        (tileType === 'WATER' || tileType === 'DEEP') &&\r\n        tileElevation > 1\r\n    );\r\n}\r\n\r\n/**\r\n * Get elevation info for a tile\r\n */\r\nexport function getTileElevationInfo(\r\n    elevation: number,\r\n    seaLevel: number,\r\n    warningMargin: number\r\n): TileElevationInfo {\r\n    let status: TileElevationInfo['status'];\r\n    let description: string;\r\n    \r\n    if (elevation < seaLevel) {\r\n        status = 'underwater';\r\n        description = 'Underwater';\r\n    } else if (elevation < seaLevel + warningMargin) {\r\n        status = 'danger';\r\n        description = 'Flood risk! Build higher.';\r\n    } else if (elevation < seaLevel + warningMargin * 2) {\r\n        status = 'warning';\r\n        description = 'Low elevation - monitor water levels';\r\n    } else {\r\n        status = 'safe';\r\n        description = 'Safe elevation';\r\n    }\r\n    \r\n    return {\r\n        elevation,\r\n        seaLevel,\r\n        status,\r\n        description,\r\n        floodRisk: status === 'danger' || status === 'warning'\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// ELEVATION COST CALCULATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Calculate cost multiplier for building at elevation\r\n * Higher elevations cost more to build on\r\n */\r\nexport function getElevationCostMultiplier(\r\n    elevation: number,\r\n    costThreshold: number,\r\n    costIncreasePerLevel: number\r\n): number {\r\n    const elev = Math.floor(elevation);\r\n    \r\n    if (elev < costThreshold) return 1.0;\r\n    \r\n    // Each elevation above threshold adds 10% cost\r\n    const levelsAbove = elev - costThreshold;\r\n    return 1.0 + (levelsAbove * costIncreasePerLevel);\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// DISPLAY HELPERS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Get period transition message\r\n */\r\nexport function getPeriodTransitionMessage(\r\n    oldSeaLevel: number,\r\n    newPeriod: GeologicalPeriod\r\n): { icon: string; message: string } {\r\n    const newLevel = newPeriod.seaLevel;\r\n    \r\n    if (newLevel > oldSeaLevel) {\r\n        return {\r\n            icon: 'ğŸŒŠ',\r\n            message: `${newPeriod.name} begins! Waters are rising as ice melts...`\r\n        };\r\n    } else if (newLevel < oldSeaLevel) {\r\n        return {\r\n            icon: 'â„ï¸',\r\n            message: `${newPeriod.name} begins! Waters recede as glaciers grow...`\r\n        };\r\n    } else {\r\n        return {\r\n            icon: 'ğŸŒ',\r\n            message: `${newPeriod.name} begins.`\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Get flood warning message based on severity\r\n */\r\nexport function getFloodWarningMessage(populationLost: number, periodName: string): string {\r\n    if (populationLost > 100) {\r\n        return `ğŸ“° CATASTROPHE! ${populationLost} perished in the great flood! The ${periodName} brought destruction. Where you build matters...`;\r\n    } else if (populationLost > 20) {\r\n        return `ğŸŒŠğŸ’€ ${populationLost} drowned in rising waters! Some areas may be safer than others...`;\r\n    } else {\r\n        return `ğŸŒŠ ${populationLost} lost to rising waters. Perhaps higher ground would be wiser...`;\r\n    }\r\n}\r\n\r\n/**\r\n * Get elevation display color based on flood risk\r\n */\r\nexport function getElevationColor(info: TileElevationInfo): string {\r\n    switch (info.status) {\r\n        case 'underwater': return '#1565C0';  // Deep blue\r\n        case 'danger': return '#F44336';       // Red\r\n        case 'warning': return '#FF9800';      // Orange\r\n        case 'safe': return '#4CAF50';         // Green\r\n        default: return '#9E9E9E';             // Gray\r\n    }\r\n}\r\n","/**\r\n * Civil Zones - Workforce System\r\n * Manages worker assignment to buildings and resource gathering\r\n */\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TYPES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Workforce state for a settlement */\r\nexport interface WorkforceState {\r\n    total: number;           // Total available workers (from residential pop)\r\n    wellWorkers: number;     // Assigned to wells\r\n    roadWorkers: number;     // Assigned to road maintenance  \r\n    comWorkers: number;      // Assigned to commercial buildings\r\n    indWorkers: number;      // Assigned to industrial buildings\r\n    gatherers: number;       // Remaining workers (gather/hunt)\r\n    \r\n    // Calculated needs\r\n    wellsNeeded: number;     // Workers needed for all wells\r\n    roadsNeeded: number;     // Workers needed for all roads\r\n    comNeeded: number;       // Workers needed for all commercial\r\n    indNeeded: number;       // Workers needed for all industrial\r\n    shortage: number;        // Worker shortage (positive = need more)\r\n}\r\n\r\n/** Workforce configuration */\r\nexport interface WorkforceConfig {\r\n    workersPerWell: number;\r\n    workersPerRoadTile: number;\r\n    roadTilesPerWorker: number;  // How many road tiles one worker can maintain\r\n}\r\n\r\n/** Infrastructure counts for workforce calculation */\r\nexport interface InfrastructureCounts {\r\n    wells: number;\r\n    roadTiles: number;\r\n    commercialCapacity: number;\r\n    industrialCapacity: number;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// DEFAULT CONFIGURATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\nexport const DEFAULT_WORKFORCE_CONFIG: WorkforceConfig = {\r\n    workersPerWell: 2,\r\n    workersPerRoadTile: 0.1,    // 1 worker per 10 road tiles\r\n    roadTilesPerWorker: 10\r\n};\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// WORKFORCE CALCULATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Create initial workforce state\r\n */\r\nexport function createWorkforceState(): WorkforceState {\r\n    return {\r\n        total: 0,\r\n        wellWorkers: 0,\r\n        roadWorkers: 0,\r\n        comWorkers: 0,\r\n        indWorkers: 0,\r\n        gatherers: 0,\r\n        wellsNeeded: 0,\r\n        roadsNeeded: 0,\r\n        comNeeded: 0,\r\n        indNeeded: 0,\r\n        shortage: 0\r\n    };\r\n}\r\n\r\n/**\r\n * Calculate workforce allocation based on population and infrastructure\r\n * Workers are assigned in priority order: wells -> roads -> commercial -> industrial -> gatherers\r\n */\r\nexport function calculateWorkforce(\r\n    population: number,\r\n    infrastructure: InfrastructureCounts,\r\n    config: WorkforceConfig = DEFAULT_WORKFORCE_CONFIG\r\n): WorkforceState {\r\n    const state = createWorkforceState();\r\n    \r\n    // Calculate what's needed\r\n    state.wellsNeeded = infrastructure.wells * config.workersPerWell;\r\n    state.roadsNeeded = Math.ceil(infrastructure.roadTiles / config.roadTilesPerWorker);\r\n    state.comNeeded = infrastructure.commercialCapacity;\r\n    state.indNeeded = infrastructure.industrialCapacity;\r\n    \r\n    state.total = population;\r\n    let remaining = population;\r\n    \r\n    // Assign in priority order\r\n    state.wellWorkers = Math.min(state.wellsNeeded, remaining);\r\n    remaining -= state.wellWorkers;\r\n    \r\n    state.roadWorkers = Math.min(state.roadsNeeded, remaining);\r\n    remaining -= state.roadWorkers;\r\n    \r\n    state.comWorkers = Math.min(state.comNeeded, remaining);\r\n    remaining -= state.comWorkers;\r\n    \r\n    state.indWorkers = Math.min(state.indNeeded, remaining);\r\n    remaining -= state.indWorkers;\r\n    \r\n    state.gatherers = remaining;\r\n    \r\n    // Calculate shortage\r\n    const totalNeeded = state.wellsNeeded + state.roadsNeeded + state.comNeeded + state.indNeeded;\r\n    state.shortage = Math.max(0, totalNeeded - population);\r\n    \r\n    return state;\r\n}\r\n\r\n/**\r\n * Calculate efficiency based on worker assignment\r\n * Returns 0.0-1.0 where 1.0 = fully staffed\r\n */\r\nexport function calculateWorkforceEfficiency(state: WorkforceState): {\r\n    wells: number;\r\n    roads: number;\r\n    commercial: number;\r\n    industrial: number;\r\n    overall: number;\r\n} {\r\n    const wellEfficiency = state.wellsNeeded > 0 \r\n        ? state.wellWorkers / state.wellsNeeded \r\n        : 1.0;\r\n        \r\n    const roadEfficiency = state.roadsNeeded > 0 \r\n        ? state.roadWorkers / state.roadsNeeded \r\n        : 1.0;\r\n        \r\n    const comEfficiency = state.comNeeded > 0 \r\n        ? state.comWorkers / state.comNeeded \r\n        : 1.0;\r\n        \r\n    const indEfficiency = state.indNeeded > 0 \r\n        ? state.indWorkers / state.indNeeded \r\n        : 1.0;\r\n    \r\n    // Overall is weighted average\r\n    const totalNeeded = state.wellsNeeded + state.roadsNeeded + state.comNeeded + state.indNeeded;\r\n    const totalAssigned = state.wellWorkers + state.roadWorkers + state.comWorkers + state.indWorkers;\r\n    \r\n    const overall = totalNeeded > 0 ? totalAssigned / totalNeeded : 1.0;\r\n    \r\n    return {\r\n        wells: Math.min(1.0, wellEfficiency),\r\n        roads: Math.min(1.0, roadEfficiency),\r\n        commercial: Math.min(1.0, comEfficiency),\r\n        industrial: Math.min(1.0, indEfficiency),\r\n        overall: Math.min(1.0, overall)\r\n    };\r\n}\r\n\r\n/**\r\n * Calculate resource production based on gatherer count and efficiency\r\n */\r\nexport function calculateGathererProduction(\r\n    gathererCount: number,\r\n    gatheringMultiplier: number = 1.0,\r\n    biomeModifier: number = 1.0\r\n): {\r\n    foodPerYear: number;\r\n    woodPerYear: number;\r\n    metalPerYear: number;\r\n} {\r\n    // Base rates per gatherer per year\r\n    const BASE_FOOD = 5;\r\n    const BASE_WOOD = 3;\r\n    const BASE_METAL = 0.5;\r\n    \r\n    const multiplier = gatheringMultiplier * biomeModifier;\r\n    \r\n    return {\r\n        foodPerYear: gathererCount * BASE_FOOD * multiplier,\r\n        woodPerYear: gathererCount * BASE_WOOD * multiplier,\r\n        metalPerYear: gathererCount * BASE_METAL * multiplier\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// DISPLAY HELPERS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Get workforce status text\r\n */\r\nexport function getWorkforceStatusText(state: WorkforceState): string {\r\n    if (state.shortage > 0) {\r\n        return `Need ${state.shortage} more workers!`;\r\n    } else if (state.gatherers === 0 && state.total > 0) {\r\n        return 'All workers assigned - no gatherers';\r\n    } else if (state.gatherers > 0) {\r\n        return `${state.gatherers} gatherers available`;\r\n    }\r\n    return 'No workers';\r\n}\r\n\r\n/**\r\n * Get workforce efficiency color\r\n */\r\nexport function getEfficiencyColor(efficiency: number): string {\r\n    if (efficiency >= 0.9) return '#4CAF50';  // Green\r\n    if (efficiency >= 0.7) return '#8BC34A';  // Light green\r\n    if (efficiency >= 0.5) return '#FFC107';  // Amber\r\n    if (efficiency >= 0.3) return '#FF9800';  // Orange\r\n    return '#F44336';                          // Red\r\n}\r\n\r\n/**\r\n * Format workforce breakdown for display\r\n */\r\nexport function formatWorkforceBreakdown(state: WorkforceState): string[] {\r\n    const lines: string[] = [];\r\n    \r\n    if (state.wellWorkers > 0 || state.wellsNeeded > 0) {\r\n        lines.push(`Wells: ${state.wellWorkers}/${state.wellsNeeded}`);\r\n    }\r\n    if (state.roadWorkers > 0 || state.roadsNeeded > 0) {\r\n        lines.push(`Roads: ${state.roadWorkers}/${state.roadsNeeded}`);\r\n    }\r\n    if (state.comWorkers > 0 || state.comNeeded > 0) {\r\n        lines.push(`Commerce: ${state.comWorkers}/${state.comNeeded}`);\r\n    }\r\n    if (state.indWorkers > 0 || state.indNeeded > 0) {\r\n        lines.push(`Industry: ${state.indWorkers}/${state.indNeeded}`);\r\n    }\r\n    if (state.gatherers > 0) {\r\n        lines.push(`Gatherers: ${state.gatherers}`);\r\n    }\r\n    \r\n    return lines;\r\n}\r\n","/**\r\n * Civil Zones - Needs System\r\n * Tracks population needs satisfaction (housing, water, food, jobs, paths)\r\n */\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TYPES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Individual need tracking */\r\nexport interface Need {\r\n    have: number;       // Current amount satisfied\r\n    need: number;       // Total needed\r\n    satisfied: number;  // Ratio 0.0-1.0\r\n}\r\n\r\n/** All population needs */\r\nexport interface NeedsState {\r\n    housing: Need;\r\n    water: Need;\r\n    food: Need;\r\n    jobs: Need;\r\n    paths: Need;\r\n    overall: number;    // Combined satisfaction (0.0 - 1.0)\r\n}\r\n\r\n/** Resource production/consumption rates */\r\nexport interface ResourceRates {\r\n    foodPerPop: number;     // Food consumed per person per year\r\n    waterPerPop: number;    // Water consumed per person per year\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// DEFAULT CONFIGURATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\nexport const DEFAULT_RESOURCE_RATES: ResourceRates = {\r\n    foodPerPop: 1,      // 1 food per person per year\r\n    waterPerPop: 2      // 2 water per person per year\r\n};\r\n\r\n// Need weights for overall satisfaction calculation\r\nconst NEED_WEIGHTS = {\r\n    housing: 0.3,\r\n    water: 0.25,\r\n    food: 0.25,\r\n    jobs: 0.15,\r\n    paths: 0.05\r\n};\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// NEEDS CALCULATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Create initial needs state\r\n */\r\nexport function createNeedsState(): NeedsState {\r\n    return {\r\n        housing: { have: 0, need: 0, satisfied: 1.0 },\r\n        water: { have: 0, need: 0, satisfied: 1.0 },\r\n        food: { have: 0, need: 0, satisfied: 1.0 },\r\n        jobs: { have: 0, need: 0, satisfied: 1.0 },\r\n        paths: { have: 0, need: 0, satisfied: 1.0 },\r\n        overall: 1.0\r\n    };\r\n}\r\n\r\n/**\r\n * Calculate housing need satisfaction\r\n */\r\nexport function calculateHousingNeed(\r\n    population: number,\r\n    housingCapacity: number\r\n): Need {\r\n    const need = population;\r\n    const have = Math.min(housingCapacity, population);\r\n    const satisfied = need > 0 ? have / need : 1.0;\r\n    \r\n    return { have, need, satisfied: Math.min(1.0, satisfied) };\r\n}\r\n\r\n/**\r\n * Calculate water need satisfaction\r\n */\r\nexport function calculateWaterNeed(\r\n    population: number,\r\n    waterAvailable: number,\r\n    rates: ResourceRates = DEFAULT_RESOURCE_RATES\r\n): Need {\r\n    const need = population * rates.waterPerPop;\r\n    const have = Math.min(waterAvailable, need);\r\n    const satisfied = need > 0 ? have / need : 1.0;\r\n    \r\n    return { have, need, satisfied: Math.min(1.0, satisfied) };\r\n}\r\n\r\n/**\r\n * Calculate food need satisfaction\r\n */\r\nexport function calculateFoodNeed(\r\n    population: number,\r\n    foodAvailable: number,\r\n    rates: ResourceRates = DEFAULT_RESOURCE_RATES\r\n): Need {\r\n    const need = population * rates.foodPerPop;\r\n    const have = Math.min(foodAvailable, need);\r\n    const satisfied = need > 0 ? have / need : 1.0;\r\n    \r\n    return { have, need, satisfied: Math.min(1.0, satisfied) };\r\n}\r\n\r\n/**\r\n * Calculate job satisfaction\r\n */\r\nexport function calculateJobNeed(\r\n    population: number,\r\n    jobCapacity: number\r\n): Need {\r\n    const need = population;\r\n    const have = Math.min(jobCapacity, population);\r\n    const satisfied = need > 0 ? have / need : 1.0;\r\n    \r\n    return { have, need, satisfied: Math.min(1.0, satisfied) };\r\n}\r\n\r\n/**\r\n * Calculate path/road connectivity satisfaction\r\n * Simplified: based on road tiles per building\r\n */\r\nexport function calculatePathNeed(\r\n    buildingCount: number,\r\n    roadTileCount: number,\r\n    idealRoadsPerBuilding: number = 4\r\n): Need {\r\n    const need = buildingCount * idealRoadsPerBuilding;\r\n    const have = roadTileCount;\r\n    const satisfied = need > 0 ? Math.min(1.0, have / need) : 1.0;\r\n    \r\n    return { have, need, satisfied };\r\n}\r\n\r\n/**\r\n * Calculate overall needs satisfaction\r\n * Uses weighted average of all needs\r\n */\r\nexport function calculateOverallSatisfaction(state: NeedsState): number {\r\n    const weighted = \r\n        state.housing.satisfied * NEED_WEIGHTS.housing +\r\n        state.water.satisfied * NEED_WEIGHTS.water +\r\n        state.food.satisfied * NEED_WEIGHTS.food +\r\n        state.jobs.satisfied * NEED_WEIGHTS.jobs +\r\n        state.paths.satisfied * NEED_WEIGHTS.paths;\r\n    \r\n    return Math.min(1.0, Math.max(0, weighted));\r\n}\r\n\r\n/**\r\n * Calculate all needs at once\r\n */\r\nexport function calculateAllNeeds(\r\n    population: number,\r\n    housingCapacity: number,\r\n    waterAvailable: number,\r\n    foodAvailable: number,\r\n    jobCapacity: number,\r\n    buildingCount: number,\r\n    roadTileCount: number,\r\n    rates: ResourceRates = DEFAULT_RESOURCE_RATES\r\n): NeedsState {\r\n    const state: NeedsState = {\r\n        housing: calculateHousingNeed(population, housingCapacity),\r\n        water: calculateWaterNeed(population, waterAvailable, rates),\r\n        food: calculateFoodNeed(population, foodAvailable, rates),\r\n        jobs: calculateJobNeed(population, jobCapacity),\r\n        paths: calculatePathNeed(buildingCount, roadTileCount),\r\n        overall: 0\r\n    };\r\n    \r\n    state.overall = calculateOverallSatisfaction(state);\r\n    \r\n    return state;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// POPULATION GROWTH\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Calculate population change based on needs satisfaction\r\n * Returns positive for growth, negative for decline\r\n */\r\nexport function calculatePopulationChange(\r\n    currentPop: number,\r\n    needsState: NeedsState,\r\n    baseGrowthRate: number = 0.02,\r\n    maxGrowthRate: number = 0.05,\r\n    declineRate: number = 0.03\r\n): number {\r\n    const satisfaction = needsState.overall;\r\n    \r\n    // Growth requires high satisfaction\r\n    if (satisfaction >= 0.8) {\r\n        // Full growth potential\r\n        const growthRate = baseGrowthRate + (satisfaction - 0.8) * (maxGrowthRate - baseGrowthRate) / 0.2;\r\n        return Math.floor(currentPop * growthRate);\r\n    } else if (satisfaction >= 0.5) {\r\n        // Slow growth\r\n        const growthRate = baseGrowthRate * (satisfaction - 0.5) / 0.3;\r\n        return Math.floor(currentPop * growthRate);\r\n    } else if (satisfaction >= 0.3) {\r\n        // Stagnation\r\n        return 0;\r\n    } else {\r\n        // Population decline\r\n        const lossRate = declineRate * (0.3 - satisfaction) / 0.3;\r\n        return -Math.ceil(currentPop * lossRate);\r\n    }\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// DISPLAY HELPERS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/**\r\n * Get satisfaction level text\r\n */\r\nexport function getSatisfactionLevel(satisfaction: number): string {\r\n    if (satisfaction >= 0.9) return 'Excellent';\r\n    if (satisfaction >= 0.7) return 'Good';\r\n    if (satisfaction >= 0.5) return 'Fair';\r\n    if (satisfaction >= 0.3) return 'Poor';\r\n    return 'Critical';\r\n}\r\n\r\n/**\r\n * Get satisfaction color\r\n */\r\nexport function getSatisfactionColor(satisfaction: number): string {\r\n    if (satisfaction >= 0.9) return '#4CAF50';  // Green\r\n    if (satisfaction >= 0.7) return '#8BC34A';  // Light green\r\n    if (satisfaction >= 0.5) return '#FFC107';  // Amber\r\n    if (satisfaction >= 0.3) return '#FF9800';  // Orange\r\n    return '#F44336';                            // Red\r\n}\r\n\r\n/**\r\n * Get the most critical need\r\n */\r\nexport function getCriticalNeed(state: NeedsState): { name: string; need: Need } | null {\r\n    const needs: [string, Need][] = [\r\n        ['Housing', state.housing],\r\n        ['Water', state.water],\r\n        ['Food', state.food],\r\n        ['Jobs', state.jobs],\r\n        ['Paths', state.paths]\r\n    ];\r\n    \r\n    let critical: [string, Need] | null = null;\r\n    let lowestSatisfaction = 1.0;\r\n    \r\n    for (const [name, need] of needs) {\r\n        if (need.satisfied < lowestSatisfaction && need.satisfied < 0.8) {\r\n            lowestSatisfaction = need.satisfied;\r\n            critical = [name, need];\r\n        }\r\n    }\r\n    \r\n    return critical ? { name: critical[0], need: critical[1] } : null;\r\n}\r\n\r\n/**\r\n * Format need as percentage string\r\n */\r\nexport function formatNeedPercentage(need: Need): string {\r\n    return `${Math.round(need.satisfied * 100)}%`;\r\n}\r\n\r\n/**\r\n * Get need status emoji\r\n */\r\nexport function getNeedEmoji(satisfaction: number): string {\r\n    if (satisfaction >= 0.9) return 'âœ…';\r\n    if (satisfaction >= 0.7) return 'ğŸŸ¢';\r\n    if (satisfaction >= 0.5) return 'ğŸŸ¡';\r\n    if (satisfaction >= 0.3) return 'ğŸŸ ';\r\n    return 'ğŸ”´';\r\n}\r\n","/**\r\n * Civil Zones - Building Types\r\n * Type definitions for buildings and zones\r\n */\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// BUILDING TYPES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Building tool/type identifier */\r\nexport type BuildingTool = \r\n    | 'RES'           // Residential zone\r\n    | 'COM'           // Commercial zone\r\n    | 'IND'           // Industrial zone\r\n    | 'ROAD'          // Road/path\r\n    | 'WELL'          // Water well\r\n    | 'CHIEF'         // Chief's Hut (2x2)\r\n    | 'CLAN_CHIEF'    // Clan Chief's Hut (2x2, milestone)\r\n    | 'DOCK'          // Dock (3x2, milestone)\r\n    | 'BASKET'        // Basket storage (2x2)\r\n    | 'POTTERY'       // Pottery storage (2x2)\r\n    | 'GRANARY'       // Granary/Resource Pit (2x2)\r\n    | 'PALACE'        // Palace (2x2)\r\n    | 'BULL';         // Bulldozer\r\n\r\n/** Zone type identifier */\r\nexport type ZoneType = 'R' | 'C' | 'I';\r\n\r\n/** Building size configuration */\r\nexport interface BuildingSize {\r\n    w: number;  // Width in tiles\r\n    h: number;  // Height in tiles\r\n}\r\n\r\n/** Building variant (evolution state) */\r\nexport type BuildingVariant = 0 | 1 | 2 | 3;\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// BUILDING INSTANCE\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Building instance data */\r\nexport interface Building {\r\n    t: BuildingTool;          // Building type\r\n    x: number;                // Grid X position\r\n    y: number;                // Grid Y position\r\n    lvl?: number;             // Building level (optional for WELL, etc.)\r\n    efficiency?: number;      // Efficiency multiplier (0.3-2.5)\r\n    age?: number;             // Age in game ticks\r\n    conn?: boolean;           // Road connected\r\n    onDeposit?: boolean;      // Built on resource deposit\r\n    desirability?: number;    // Desirability score (0-1)\r\n    variant?: BuildingVariant; // Visual variant\r\n    population?: number;      // Current population (residential)\r\n    waterProximity?: number;  // Water bonus (0-1)\r\n    forestProximity?: boolean; // Near forest\r\n}\r\n\r\n/** Residential zone building */\r\nexport interface ResidentialBuilding {\r\n    level: number;\r\n    variant: BuildingVariant;\r\n    population?: number;\r\n    desirability?: number;\r\n    growth?: number;\r\n    age?: number;\r\n    lastBirthYear?: number;\r\n    pop?: number;\r\n    capacity?: number;\r\n}\r\n\r\n/** Zone tile data (for tiles[x][y].building) */\r\nexport interface ZoneTile {\r\n    level: number;\r\n    growth: number;\r\n    desirability: number;\r\n    age: number;\r\n    lastBirthYear: number;\r\n    pop: number;\r\n    capacity: number;\r\n    variant: BuildingVariant;\r\n    population?: number;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// BUILDING CONFIGURATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Building level configuration */\r\nexport interface BuildingLevelConfig {\r\n    name: string;\r\n    capacity: number;\r\n    food: number;\r\n    wood?: number;\r\n    stone?: number;\r\n    metal?: number;\r\n    reqPop?: number;\r\n    variants?: BuildingVariantConfig[];\r\n}\r\n\r\n/** Building variant configuration */\r\nexport interface BuildingVariantConfig {\r\n    name: string;\r\n    minDesirability: number;\r\n    maxDesirability: number;\r\n}\r\n\r\n/** Variant display configuration */\r\nexport interface VariantConfig {\r\n    name: string;\r\n    icon: string;\r\n    bonusMult: number;\r\n}\r\n\r\n/** State threshold configuration */\r\nexport interface StateThreshold {\r\n    min: number;\r\n    max: number;\r\n    name: string;\r\n    icon: string;\r\n    incomeClass: string;\r\n    incomeMult?: number;\r\n    lifespanBonus: number;\r\n}\r\n\r\n/** Industrial level configuration */\r\nexport interface IndustrialLevelConfig {\r\n    name: string;\r\n    capacity: number;\r\n    food: number;\r\n    wood: number;\r\n    stone?: number;\r\n    metal?: number;\r\n}\r\n\r\n/** Commercial level configuration */\r\nexport interface CommercialLevelConfig {\r\n    name: string;\r\n    food: number;\r\n    wood: number;\r\n    stone?: number;\r\n    production: number;\r\n}\r\n\r\n/** Storage building configuration */\r\nexport interface StorageBuildingConfig {\r\n    name: string;\r\n    cost: number;\r\n    cap: number;\r\n    reqPop: number;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// ZONE BONUSES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Zone bonus factors */\r\nexport interface ZoneBonusFactors {\r\n    roadAccess: number;\r\n    noRoadPenalty: number;\r\n    waterNearby: number;\r\n    wellNearby: number;\r\n    treeNearby: number;\r\n    stoneNearby: number;\r\n    clusterBonus: number;\r\n    industrialPenalty: number;\r\n    isolationPenalty: number;\r\n    chiefBonus: number;\r\n}\r\n\r\n/** Zone bonus result */\r\nexport interface ZoneBonusResult {\r\n    bonuses: string[];\r\n    penalties: string[];\r\n    total: number;\r\n    text: string;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// ELEVATION SYSTEM\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Elevation cost info */\r\nexport interface ElevationCostInfo {\r\n    multiplier: number;\r\n    text: string;\r\n    elevation: number;\r\n}\r\n\r\n/** Tile elevation info */\r\nexport interface TileElevationInfo {\r\n    elevation: number;\r\n    seaLevel: number;\r\n    status: 'safe' | 'warning' | 'danger' | 'underwater' | 'high';\r\n    description: string;\r\n    heightAboveSea: number;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// BUILDING CONSTANTS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Building sizes by type */\r\nexport const BUILDING_SIZES: Record<BuildingTool, BuildingSize> = {\r\n    RES: { w: 1, h: 1 },\r\n    COM: { w: 1, h: 1 },\r\n    IND: { w: 1, h: 1 },\r\n    ROAD: { w: 1, h: 1 },\r\n    WELL: { w: 1, h: 1 },\r\n    CHIEF: { w: 2, h: 2 },\r\n    CLAN_CHIEF: { w: 2, h: 2 },\r\n    DOCK: { w: 3, h: 2 },\r\n    BASKET: { w: 2, h: 2 },\r\n    POTTERY: { w: 2, h: 2 },\r\n    GRANARY: { w: 2, h: 2 },\r\n    PALACE: { w: 2, h: 2 },\r\n    BULL: { w: 1, h: 1 }\r\n};\r\n\r\n/** Small (1x1) building types */\r\nexport const SMALL_BUILDINGS: BuildingTool[] = ['WELL', 'COM', 'IND', 'RES', 'ROAD'];\r\n\r\n/** Large (2x2) building types */\r\nexport const LARGE_BUILDINGS: BuildingTool[] = ['CHIEF', 'CLAN_CHIEF', 'BASKET', 'POTTERY', 'GRANARY', 'PALACE'];\r\n\r\n/** Storage building types (deprecated) */\r\nexport const STORAGE_PIT_TYPES = ['FOOD_PIT', 'WOOD_PIT', 'STONE_PIT', 'METAL_PIT'] as const;\r\n\r\n/** Default efficiency values */\r\nexport const DEFAULT_EFFICIENCY = {\r\n    MIN: 0.3,\r\n    MAX: 3.0,\r\n    NO_ROAD_PENALTY: 0.5,\r\n    DECAY_RATE: 0.01,\r\n    WATER_BONUS_MAX: 0.3,\r\n    FOREST_BONUS: 0.2\r\n};\r\n\r\n/** Default zone bonus values */\r\nexport const DEFAULT_ZONE_BONUSES = {\r\n    ROAD_ACCESS_BONUS: 0.3,\r\n    NO_ROAD_PENALTY: 0.3,\r\n    RES_WATER_BONUS: 0.2,\r\n    RES_WELL_BONUS: 0.15,\r\n    RES_TREE_BONUS: 0.1,\r\n    RES_CLUSTER_BONUS: 0.05,\r\n    RES_INDUSTRIAL_PENALTY: 0.2,\r\n    COM_ROAD_JUNCTION_BONUS: 0.15,\r\n    COM_RES_NEARBY_BONUS: 0.2,\r\n    COM_ISOLATION_PENALTY: 0.2,\r\n    COM_INDUSTRIAL_NEARBY: 0.1,\r\n    IND_WATER_BONUS: 0.15,\r\n    IND_FOREST_BONUS: 0.2,\r\n    IND_STONE_BONUS: 0.25,\r\n    IND_CLUSTER_BONUS: 0.1,\r\n    IND_RES_NEARBY_PENALTY: 0.15,\r\n    CHIEF_CULTURE_RADIUS: 50,\r\n    CHIEF_BONUS: 0.3\r\n};\r\n","/**\r\n * Civil Zones - Building Validation\r\n * Validates building placement and costs\r\n */\r\n\r\nimport type { \r\n    BuildingTool, \r\n    Building, \r\n    BuildingSize,\r\n    ElevationCostInfo,\r\n    TileElevationInfo \r\n} from './types.js';\r\nimport { BUILDING_SIZES, SMALL_BUILDINGS, STORAGE_PIT_TYPES } from './types.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TILE INTERFACE (minimal for validation)\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\ninterface TileLike {\r\n    type: string;\r\n    explored?: boolean;\r\n    zone?: string | null;\r\n    building?: any;\r\n    road?: boolean;\r\n    stoneDeposit?: any;\r\n    elevation?: number;\r\n}\r\n\r\ninterface GameLike {\r\n    tiles: TileLike[][];\r\n    blds: Building[];\r\n    food: number;\r\n    wood: number;\r\n    stone?: number;\r\n    metal?: number;\r\n    gold?: number;\r\n    pop?: number;\r\n    res?: number;\r\n    simcityMode?: boolean;\r\n    hasClanChief?: boolean;\r\n    hasDock?: boolean;\r\n}\r\n\r\ninterface ConfigLike {\r\n    W: number;\r\n    H: number;\r\n    COST?: { ROAD?: number; WELL?: number; BULL?: number };\r\n    BUILDING_DB?: Record<string, { size?: BuildingSize; cost?: any }>;\r\n    ELEVATION_SYSTEM?: {\r\n        ENABLED?: boolean;\r\n        COST_THRESHOLD?: number;\r\n        COST_INCREASE_PER_LEVEL?: number;\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// SIZE HELPERS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Get building size */\r\nexport function getBuildingSize(tool: BuildingTool): BuildingSize {\r\n    return BUILDING_SIZES[tool] || { w: 1, h: 1 };\r\n}\r\n\r\n/** Check if building is small (1x1) */\r\nexport function isSmallBuilding(tool: BuildingTool): boolean {\r\n    return SMALL_BUILDINGS.includes(tool);\r\n}\r\n\r\n/** Get existing building size from blds array */\r\nexport function getExistingBuildingSize(\r\n    building: Building,\r\n    buildingDB?: Record<string, { size?: BuildingSize }>\r\n): BuildingSize {\r\n    // Check config first\r\n    if (buildingDB?.[building.t]?.size) {\r\n        return buildingDB[building.t].size!;\r\n    }\r\n    \r\n    // Default sizes by type\r\n    if (isSmallBuilding(building.t as BuildingTool)) {\r\n        return { w: 1, h: 1 };\r\n    }\r\n    if (building.t === 'DOCK') {\r\n        return { w: 3, h: 2 };\r\n    }\r\n    return { w: 2, h: 2 };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// PLACEMENT VALIDATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Check if tile type blocks building */\r\nexport function isTileBlocked(tile: TileLike): boolean {\r\n    const t = tile.type;\r\n    return t === 'WATER' || t === 'DEEP' || t === 'RIVER' || t === 'STONE';\r\n}\r\n\r\n/** Check if tile is unexplored */\r\nexport function isUnexplored(tile: TileLike): boolean {\r\n    return !tile.explored;\r\n}\r\n\r\n/** Check if tile has existing structure */\r\nexport function hasExistingStructure(tile: TileLike): boolean {\r\n    return !!(tile.zone || tile.building || tile.road);\r\n}\r\n\r\n/** Check bounds */\r\nexport function isInBounds(\r\n    gx: number, \r\n    gy: number, \r\n    width: number, \r\n    height: number,\r\n    mapWidth: number,\r\n    mapHeight: number\r\n): boolean {\r\n    return gx >= 0 && gy >= 0 && (gx + width) <= mapWidth && (gy + height) <= mapHeight;\r\n}\r\n\r\n/** Check if position overlaps with existing buildings */\r\nexport function overlapsBuildings(\r\n    gx: number,\r\n    gy: number,\r\n    width: number,\r\n    height: number,\r\n    buildings: Building[],\r\n    buildingDB?: Record<string, { size?: BuildingSize }>\r\n): boolean {\r\n    for (const b of buildings) {\r\n        const bSize = getExistingBuildingSize(b, buildingDB);\r\n        \r\n        // AABB overlap check\r\n        if (gx < b.x + bSize.w && gx + width > b.x &&\r\n            gy < b.y + bSize.h && gy + height > b.y) {\r\n            return true;\r\n        }\r\n    }\r\n    return false;\r\n}\r\n\r\n/** Validate building placement */\r\nexport function isValidPlacement(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    gx: number,\r\n    gy: number,\r\n    tool: BuildingTool\r\n): { valid: boolean; reason?: string } {\r\n    const size = getBuildingSize(tool);\r\n    \r\n    // Bounds check\r\n    if (!isInBounds(gx, gy, size.w, size.h, config.W, config.H)) {\r\n        return { valid: false, reason: 'Out of bounds' };\r\n    }\r\n    \r\n    // Check all tiles in footprint\r\n    for (let x = gx; x < gx + size.w; x++) {\r\n        for (let y = gy; y < gy + size.h; y++) {\r\n            const tile = game.tiles[x][y];\r\n            \r\n            if (isTileBlocked(tile)) {\r\n                return { valid: false, reason: \"Can't build on water/stone\" };\r\n            }\r\n            \r\n            if (isUnexplored(tile)) {\r\n                return { valid: false, reason: 'Cannot build in fog - explore first!' };\r\n            }\r\n            \r\n            // Stone deposits block non-industrial\r\n            if (tile.stoneDeposit && tool !== 'IND') {\r\n                return { valid: false, reason: 'Stone deposit blocking' };\r\n            }\r\n            \r\n            if (hasExistingStructure(tile)) {\r\n                return { valid: false, reason: 'Space occupied' };\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Check building overlap\r\n    if (overlapsBuildings(gx, gy, size.w, size.h, game.blds, config.BUILDING_DB)) {\r\n        return { valid: false, reason: 'Building overlap' };\r\n    }\r\n    \r\n    return { valid: true };\r\n}\r\n\r\n/** Validate road placement (single tile) */\r\nexport function isValidRoadPlacement(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    rx: number,\r\n    ry: number\r\n): { valid: boolean; reason?: string } {\r\n    // Bounds check\r\n    if (rx < 0 || rx >= config.W || ry < 0 || ry >= config.H) {\r\n        return { valid: false, reason: 'Out of bounds' };\r\n    }\r\n    \r\n    const tile = game.tiles[rx]?.[ry];\r\n    if (!tile) {\r\n        return { valid: false, reason: 'Invalid tile' };\r\n    }\r\n    \r\n    if (isTileBlocked(tile)) {\r\n        return { valid: false, reason: \"Can't build on water/stone\" };\r\n    }\r\n    \r\n    if (isUnexplored(tile)) {\r\n        return { valid: false, reason: 'Cannot build in fog - explore first!' };\r\n    }\r\n    \r\n    if (tile.stoneDeposit) {\r\n        return { valid: false, reason: 'Stone deposit blocking' };\r\n    }\r\n    \r\n    if (tile.road) {\r\n        return { valid: false, reason: 'Road already exists' };\r\n    }\r\n    \r\n    return { valid: true };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// COST VALIDATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Cost requirement */\r\nexport interface CostRequirement {\r\n    food?: number;\r\n    wood?: number;\r\n    stone?: number;\r\n    metal?: number;\r\n    gold?: number;\r\n}\r\n\r\n/** Check if player can afford cost */\r\nexport function canAfford(game: GameLike, cost: CostRequirement, simcityMode: boolean = false): boolean {\r\n    if (simcityMode) {\r\n        // SimCity mode uses generic \"res\" funds\r\n        const totalCost = (cost.food || 0) + (cost.wood || 0) + (cost.stone || 0) + (cost.metal || 0);\r\n        return (game.res || 0) >= totalCost;\r\n    }\r\n    \r\n    if (cost.food && game.food < cost.food) return false;\r\n    if (cost.wood && game.wood < cost.wood) return false;\r\n    if (cost.stone && (game.stone || 0) < cost.stone) return false;\r\n    if (cost.metal && (game.metal || 0) < cost.metal) return false;\r\n    if (cost.gold && (game.gold || 0) < cost.gold) return false;\r\n    \r\n    return true;\r\n}\r\n\r\n/** Get missing resource for cost */\r\nexport function getMissingResource(game: GameLike, cost: CostRequirement): string | null {\r\n    if (cost.food && game.food < cost.food) return `Need ${cost.food} Food`;\r\n    if (cost.wood && game.wood < cost.wood) return `Need ${cost.wood} Wood`;\r\n    if (cost.stone && (game.stone || 0) < cost.stone) return `Need ${cost.stone} Stone`;\r\n    if (cost.metal && (game.metal || 0) < cost.metal) return `Need ${cost.metal} Metal`;\r\n    if (cost.gold && (game.gold || 0) < cost.gold) return `Need ${cost.gold} Gold`;\r\n    return null;\r\n}\r\n\r\n/** Deduct cost from game resources */\r\nexport function deductCost(game: GameLike, cost: CostRequirement, simcityMode: boolean = false): void {\r\n    if (simcityMode) {\r\n        const totalCost = (cost.food || 0) + (cost.wood || 0) + (cost.stone || 0) + (cost.metal || 0);\r\n        game.res = (game.res || 0) - totalCost;\r\n    } else {\r\n        if (cost.food) game.food -= cost.food;\r\n        if (cost.wood) game.wood -= cost.wood;\r\n        if (cost.stone) game.stone = (game.stone || 0) - cost.stone;\r\n        if (cost.metal) game.metal = (game.metal || 0) - cost.metal;\r\n        if (cost.gold) game.gold = (game.gold || 0) - cost.gold;\r\n    }\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// ELEVATION COST\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Get elevation cost multiplier */\r\nexport function getElevationCostMultiplier(\r\n    tile: TileLike,\r\n    config?: ConfigLike\r\n): number {\r\n    if (!config?.ELEVATION_SYSTEM?.ENABLED) return 1.0;\r\n    \r\n    const threshold = config.ELEVATION_SYSTEM.COST_THRESHOLD || 4;\r\n    const increasePerLevel = config.ELEVATION_SYSTEM.COST_INCREASE_PER_LEVEL || 0.10;\r\n    const elevation = Math.floor(tile.elevation || 0);\r\n    \r\n    if (elevation < threshold) return 1.0;\r\n    \r\n    // Each elevation above threshold adds cost\r\n    const levelsAbove = elevation - threshold;\r\n    return 1.0 + (levelsAbove * increasePerLevel);\r\n}\r\n\r\n/** Get elevation cost info */\r\nexport function getElevationCostInfo(\r\n    tile: TileLike,\r\n    config?: ConfigLike\r\n): ElevationCostInfo {\r\n    const multiplier = getElevationCostMultiplier(tile, config);\r\n    const elevation = Math.floor(tile.elevation || 0);\r\n    \r\n    return {\r\n        multiplier,\r\n        text: '', // Mystery: player doesn't know why some areas cost more\r\n        elevation\r\n    };\r\n}\r\n\r\n/** Apply elevation multiplier to cost */\r\nexport function applyElevationCost(\r\n    baseCost: CostRequirement,\r\n    multiplier: number\r\n): CostRequirement {\r\n    return {\r\n        food: baseCost.food ? Math.ceil(baseCost.food * multiplier) : undefined,\r\n        wood: baseCost.wood ? Math.ceil(baseCost.wood * multiplier) : undefined,\r\n        stone: baseCost.stone ? Math.ceil(baseCost.stone * multiplier) : undefined,\r\n        metal: baseCost.metal ? Math.ceil(baseCost.metal * multiplier) : undefined,\r\n        gold: baseCost.gold // Gold not affected by elevation\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TILE ELEVATION INFO\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Get tile elevation info for UI */\r\nexport function getTileElevationInfo(\r\n    tile: TileLike,\r\n    seaLevel: number\r\n): TileElevationInfo {\r\n    const elevation = tile.elevation || 0;\r\n    \r\n    let status: TileElevationInfo['status'] = 'safe';\r\n    let description = '';\r\n    \r\n    if (elevation < seaLevel) {\r\n        status = 'underwater';\r\n        description = 'Underwater';\r\n    } else if (elevation < seaLevel + 1) {\r\n        status = 'danger';\r\n        description = 'Flood Risk! (coastal)';\r\n    } else if (elevation < seaLevel + 2) {\r\n        status = 'warning';\r\n        description = 'Low ground';\r\n    } else if (elevation >= 8) {\r\n        status = 'high';\r\n        description = 'Mountain peaks';\r\n    } else {\r\n        status = 'safe';\r\n        description = 'Safe elevation';\r\n    }\r\n    \r\n    return {\r\n        elevation,\r\n        seaLevel: Math.floor(seaLevel),\r\n        status,\r\n        description,\r\n        heightAboveSea: elevation - Math.floor(seaLevel)\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// PREREQUISITE CHECKS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Check milestone prerequisites */\r\nexport function checkMilestonePrereq(\r\n    game: GameLike,\r\n    tool: BuildingTool\r\n): { met: boolean; reason?: string } {\r\n    if (tool === 'DOCK') {\r\n        if (!game.hasClanChief) {\r\n            return { met: false, reason: 'Build Clan Chief\\'s Hut first!' };\r\n        }\r\n        if (game.hasDock) {\r\n            return { met: false, reason: 'First Dock already built!' };\r\n        }\r\n    }\r\n    \r\n    if (tool === 'CLAN_CHIEF') {\r\n        if (game.hasClanChief) {\r\n            return { met: false, reason: 'Clan Chief\\'s Hut already built!' };\r\n        }\r\n    }\r\n    \r\n    return { met: true };\r\n}\r\n\r\n/** Check population requirement */\r\nexport function checkPopulationReq(\r\n    game: GameLike,\r\n    requiredPop: number\r\n): { met: boolean; reason?: string } {\r\n    if ((game.pop || 0) < requiredPop) {\r\n        return { met: false, reason: `Need ${requiredPop} Population` };\r\n    }\r\n    return { met: true };\r\n}\r\n","/**\r\n * Civil Zones - Zone Bonuses\r\n * Calculate efficiency bonuses for building placement\r\n */\r\n\r\nimport type { ZoneType, ZoneBonusResult, Building } from './types.js';\r\nimport { DEFAULT_ZONE_BONUSES } from './types.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// TILE/GAME INTERFACE\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\ninterface TileLike {\r\n    type: string;\r\n    road?: boolean;\r\n    zone?: string | null;\r\n    tree?: boolean;\r\n    stoneDeposit?: any;\r\n}\r\n\r\ninterface GameLike {\r\n    tiles: TileLike[][];\r\n    blds: Building[];\r\n    lockedResources?: {\r\n        residential?: boolean;\r\n        commercial?: boolean;\r\n        industrial?: boolean;\r\n    };\r\n}\r\n\r\ninterface ConfigLike {\r\n    W: number;\r\n    H: number;\r\n    ZONE_BONUSES?: typeof DEFAULT_ZONE_BONUSES;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// HELPER FUNCTIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Count tiles matching condition in radius */\r\nexport function countNearbyTiles(\r\n    tiles: TileLike[][],\r\n    gx: number,\r\n    gy: number,\r\n    range: number,\r\n    checkFn: (tile: TileLike) => boolean,\r\n    mapWidth: number,\r\n    mapHeight: number\r\n): number {\r\n    let count = 0;\r\n    for (let dx = -range; dx <= range; dx++) {\r\n        for (let dy = -range; dy <= range; dy++) {\r\n            if (dx === 0 && dy === 0) continue;\r\n            const nx = gx + dx;\r\n            const ny = gy + dy;\r\n            if (nx >= 0 && nx < mapWidth && ny >= 0 && ny < mapHeight) {\r\n                if (checkFn(tiles[nx][ny])) count++;\r\n            }\r\n        }\r\n    }\r\n    return count;\r\n}\r\n\r\n/** Check if any tile matches in radius */\r\nexport function hasNearbyTile(\r\n    tiles: TileLike[][],\r\n    gx: number,\r\n    gy: number,\r\n    range: number,\r\n    checkFn: (tile: TileLike) => boolean,\r\n    mapWidth: number,\r\n    mapHeight: number\r\n): boolean {\r\n    return countNearbyTiles(tiles, gx, gy, range, checkFn, mapWidth, mapHeight) > 0;\r\n}\r\n\r\n/** Check if building is within distance */\r\nexport function isBuildingNearby(\r\n    building: Building,\r\n    gx: number,\r\n    gy: number,\r\n    maxDist: number\r\n): boolean {\r\n    const dist = Math.abs(building.x - gx) + Math.abs(building.y - gy);\r\n    return dist <= maxDist;\r\n}\r\n\r\n/** Check if building is within euclidean distance */\r\nexport function isBuildingInRadius(\r\n    building: Building,\r\n    gx: number,\r\n    gy: number,\r\n    radius: number\r\n): boolean {\r\n    const dist = Math.sqrt(Math.pow(building.x - gx, 2) + Math.pow(building.y - gy, 2));\r\n    return dist <= radius;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// ZONE BONUS CALCULATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Calculate zone bonus for placement */\r\nexport function calculateZoneBonus(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    gx: number,\r\n    gy: number,\r\n    zoneType: ZoneType\r\n): number {\r\n    const B = config.ZONE_BONUSES || DEFAULT_ZONE_BONUSES;\r\n    let bonus = 1.0;\r\n    \r\n    const { tiles, blds } = game;\r\n    const { W, H } = config;\r\n    \r\n    // === ROAD ACCESS (critical for all zones) ===\r\n    const roadCount = countNearbyTiles(tiles, gx, gy, 1, t => !!t.road, W, H);\r\n    if (roadCount > 0) {\r\n        bonus += B.ROAD_ACCESS_BONUS;\r\n        // Extra bonus for road junctions (commercial loves these)\r\n        if (roadCount >= 3 && zoneType === 'C') {\r\n            bonus += B.COM_ROAD_JUNCTION_BONUS;\r\n        }\r\n    } else {\r\n        // Check if road is at least within 3 tiles\r\n        const hasRoadNearby = hasNearbyTile(tiles, gx, gy, 3, t => !!t.road, W, H);\r\n        if (!hasRoadNearby) {\r\n            bonus -= B.NO_ROAD_PENALTY;\r\n        }\r\n    }\r\n    \r\n    // === WATER PROXIMITY ===\r\n    const hasWater = hasNearbyTile(\r\n        tiles, gx, gy, 3,\r\n        t => t.type === 'WATER' || t.type === 'RIVER',\r\n        W, H\r\n    );\r\n    if (hasWater) {\r\n        if (zoneType === 'R') bonus += B.RES_WATER_BONUS;\r\n        else if (zoneType === 'I') bonus += B.IND_WATER_BONUS;\r\n    }\r\n    \r\n    // === WELL PROXIMITY ===\r\n    const wellNearby = blds.some(b => b.t === 'WELL' && isBuildingNearby(b, gx, gy, 3));\r\n    if (wellNearby && zoneType === 'R') {\r\n        bonus += B.RES_WELL_BONUS;\r\n    }\r\n    \r\n    // === TREE/FOREST PROXIMITY ===\r\n    const treeCount = countNearbyTiles(\r\n        tiles, gx, gy, 2,\r\n        t => !!(t.tree || t.type === 'FOREST'),\r\n        W, H\r\n    );\r\n    if (treeCount > 0) {\r\n        if (zoneType === 'R') bonus += B.RES_TREE_BONUS;\r\n        else if (zoneType === 'I') bonus += B.IND_FOREST_BONUS * Math.min(treeCount / 3, 1);\r\n    }\r\n    \r\n    // === STONE PROXIMITY (Industrial loves this) ===\r\n    const stoneNearby = hasNearbyTile(\r\n        tiles, gx, gy, 3,\r\n        t => t.type === 'STONE' || !!t.stoneDeposit,\r\n        W, H\r\n    );\r\n    if (stoneNearby && zoneType === 'I') {\r\n        bonus += B.IND_STONE_BONUS;\r\n    }\r\n    \r\n    // === RESIDENTIAL BONUSES/PENALTIES ===\r\n    if (zoneType === 'R') {\r\n        // Clustering bonus\r\n        const resCount = countNearbyTiles(tiles, gx, gy, 1, t => t.zone === 'R', W, H);\r\n        bonus += resCount * B.RES_CLUSTER_BONUS;\r\n        \r\n        // Industrial penalty (pollution)\r\n        const indNearby = blds.some(b => b.t === 'IND' && isBuildingNearby(b, gx, gy, 2));\r\n        if (indNearby) bonus -= B.RES_INDUSTRIAL_PENALTY;\r\n    }\r\n    \r\n    // === COMMERCIAL BONUSES/PENALTIES ===\r\n    if (zoneType === 'C') {\r\n        // Needs customers (residential)\r\n        const resNearby = countNearbyTiles(tiles, gx, gy, 5, t => t.zone === 'R', W, H);\r\n        if (resNearby >= 3) {\r\n            bonus += B.COM_RES_NEARBY_BONUS;\r\n        } else if (resNearby === 0) {\r\n            bonus -= B.COM_ISOLATION_PENALTY;\r\n        }\r\n        \r\n        // Industrial workers nearby\r\n        const indNearby = blds.some(b => b.t === 'IND' && isBuildingNearby(b, gx, gy, 5));\r\n        if (indNearby) bonus += B.COM_INDUSTRIAL_NEARBY;\r\n    }\r\n    \r\n    // === INDUSTRIAL BONUSES/PENALTIES ===\r\n    if (zoneType === 'I') {\r\n        // Clustering bonus (industrial parks)\r\n        const indCount = blds.filter(b => b.t === 'IND' && isBuildingNearby(b, gx, gy, 2)).length;\r\n        bonus += indCount * B.IND_CLUSTER_BONUS;\r\n        \r\n        // Penalty if too close to residential\r\n        const resTooClose = countNearbyTiles(tiles, gx, gy, 2, t => t.zone === 'R', W, H);\r\n        if (resTooClose > 0) bonus -= B.IND_RES_NEARBY_PENALTY;\r\n    }\r\n    \r\n    // === CHIEF'S HUT BONUS ===\r\n    const chiefNearby = blds.some(b => \r\n        b.t === 'CHIEF' && isBuildingInRadius(b, gx, gy, B.CHIEF_CULTURE_RADIUS)\r\n    );\r\n    if (chiefNearby) bonus += B.CHIEF_BONUS;\r\n    \r\n    // === LOCKED RESOURCE BONUSES (from settlement) ===\r\n    if (game.lockedResources) {\r\n        if (zoneType === 'R' && game.lockedResources.residential) {\r\n            bonus += 0.25; // +25% for having berries locked\r\n        }\r\n        if (zoneType === 'C' && game.lockedResources.commercial) {\r\n            bonus += 0.25; // +25% for having trees locked\r\n        }\r\n        if (zoneType === 'I' && game.lockedResources.industrial) {\r\n            bonus += 0.25; // +25% for having animals locked\r\n        }\r\n    }\r\n    \r\n    // Clamp to reasonable range\r\n    return Math.max(0.3, Math.min(2.5, bonus));\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// ZONE BONUS DESCRIPTION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Get text description of zone bonuses */\r\nexport function getZoneBonusDescription(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    gx: number,\r\n    gy: number,\r\n    zoneType: ZoneType\r\n): ZoneBonusResult {\r\n    const { tiles } = game;\r\n    const { W, H } = config;\r\n    \r\n    const bonuses: string[] = [];\r\n    const penalties: string[] = [];\r\n    \r\n    // Road check\r\n    const roadCount = countNearbyTiles(tiles, gx, gy, 1, t => !!t.road, W, H);\r\n    if (roadCount > 0) {\r\n        bonuses.push('ğŸ›£ï¸ Road Access');\r\n    } else {\r\n        penalties.push('âŒ No Road');\r\n    }\r\n    \r\n    // Water check\r\n    const hasWater = hasNearbyTile(\r\n        tiles, gx, gy, 3,\r\n        t => t.type === 'WATER' || t.type === 'RIVER',\r\n        W, H\r\n    );\r\n    if (hasWater) {\r\n        bonuses.push('ğŸ’§ Near Water');\r\n    }\r\n    \r\n    const totalBonus = calculateZoneBonus(game, config, gx, gy, zoneType);\r\n    const percentage = Math.round((totalBonus - 1) * 100);\r\n    const prefix = percentage >= 0 ? '+' : '';\r\n    \r\n    return {\r\n        bonuses,\r\n        penalties,\r\n        total: totalBonus,\r\n        text: `${prefix}${percentage}% Efficiency`\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// DESIRABILITY CALCULATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Calculate desirability for residential placement */\r\nexport function calculateDesirability(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    x: number,\r\n    y: number,\r\n    size: number = 1,\r\n    chiefRadius: number = 50,\r\n    chiefBonus: number = 1.5\r\n): number {\r\n    const { tiles, blds } = game;\r\n    const { W, H } = config;\r\n    \r\n    let score = 1.0;\r\n    let neighborCount = 0;\r\n    let hasTree = false;\r\n    let hasWater = false;\r\n    let hasChief = false;\r\n    \r\n    // Check neighbors (adjacent residential zones)\r\n    for (let dx = -1; dx <= size; dx++) {\r\n        for (let dy = -1; dy <= size; dy++) {\r\n            if (dx === 0 && dy === 0) continue;\r\n            const checkX = x + dx;\r\n            const checkY = y + dy;\r\n            if (checkX >= 0 && checkX < W && checkY >= 0 && checkY < H) {\r\n                const tile = tiles[checkX][checkY];\r\n                if (tile.zone === 'R') neighborCount++;\r\n                if (tile.tree || tile.type === 'FOREST') hasTree = true;\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Check water proximity (within 3 tiles)\r\n    for (let dx = -3; dx <= 3 + size; dx++) {\r\n        for (let dy = -3; dy <= 3 + size; dy++) {\r\n            const checkX = x + dx;\r\n            const checkY = y + dy;\r\n            if (checkX >= 0 && checkX < W && checkY >= 0 && checkY < H) {\r\n                const tile = tiles[checkX][checkY];\r\n                if (tile.type === 'WATER' || tile.type === 'RIVER') {\r\n                    hasWater = true;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Check Chief's Hut proximity\r\n    for (const chief of blds.filter(b => b.t === 'CHIEF')) {\r\n        if (isBuildingInRadius(chief, x, y, chiefRadius)) {\r\n            hasChief = true;\r\n            break;\r\n        }\r\n    }\r\n    \r\n    // Apply bonuses (using configurable values)\r\n    const neighborBonus = 0.15;\r\n    const treeBonus = 0.25;\r\n    const waterBonus = 0.35;\r\n    const isolationPenalty = 0.3;\r\n    \r\n    score += neighborCount * neighborBonus;\r\n    if (hasTree) score += treeBonus;\r\n    if (hasWater) score += waterBonus;\r\n    if (hasChief) score *= chiefBonus;\r\n    \r\n    // Isolation penalty - check if any buildings within 2 tiles\r\n    let isolated = true;\r\n    for (let dx = -2; dx <= 2 + size; dx++) {\r\n        for (let dy = -2; dy <= 2 + size; dy++) {\r\n            if (dx === 0 && dy === 0) continue;\r\n            const checkX = x + dx;\r\n            const checkY = y + dy;\r\n            \r\n            if (checkX >= 0 && checkX < W && checkY >= 0 && checkY < H) {\r\n                if (tiles[checkX][checkY].zone) {\r\n                    isolated = false;\r\n                    break;\r\n                }\r\n            }\r\n            \r\n            // Check for 2x2 buildings\r\n            const nearBuilding = blds.find(b =>\r\n                checkX >= b.x && checkX < b.x + 2 &&\r\n                checkY >= b.y && checkY < b.y + 2\r\n            );\r\n            if (nearBuilding) {\r\n                isolated = false;\r\n                break;\r\n            }\r\n        }\r\n        if (!isolated) break;\r\n    }\r\n    \r\n    if (isolated) score -= isolationPenalty;\r\n    \r\n    return Math.max(0.5, score);\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// CLUSTER ANALYSIS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Get cluster multiplier based on neighbor count */\r\nexport function getClusterMultiplier(neighbors: number): number {\r\n    // 0 neighbors = 0.3x (very slow)\r\n    // 1 = 0.5x\r\n    // 2 = 0.8x\r\n    // 3 = 1.0x\r\n    // 4+ = 1.5x\r\n    if (neighbors === 0) return 0.3;\r\n    if (neighbors === 1) return 0.5;\r\n    if (neighbors === 2) return 0.8;\r\n    if (neighbors === 3) return 1.0;\r\n    return 1.5;\r\n}\r\n\r\n/** Count residential neighbors for a tile */\r\nexport function countResidentialNeighbors(\r\n    tiles: TileLike[][],\r\n    x: number,\r\n    y: number,\r\n    mapWidth: number,\r\n    mapHeight: number\r\n): number {\r\n    let neighbors = 0;\r\n    for (let dx = -1; dx <= 1; dx++) {\r\n        for (let dy = -1; dy <= 1; dy++) {\r\n            if (dx === 0 && dy === 0) continue;\r\n            const nx = x + dx;\r\n            const ny = y + dy;\r\n            if (nx >= 0 && nx < mapWidth && ny >= 0 && ny < mapHeight) {\r\n                if (tiles[nx][ny].zone === 'R') neighbors++;\r\n            }\r\n        }\r\n    }\r\n    return neighbors;\r\n}\r\n","/**\r\n * Civil Zones - Building Placement\r\n * Functions for placing buildings and roads\r\n */\r\n\r\nimport type { BuildingTool, Building, ZoneTile, BuildingSize } from './types.js';\r\nimport { BUILDING_SIZES } from './types.js';\r\nimport { calculateZoneBonus, getZoneBonusDescription } from './zones.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// INTERFACES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\ninterface TileLike {\r\n    type: string;\r\n    road?: boolean;\r\n    tree?: boolean;\r\n    zone?: string | null;\r\n    building?: ZoneTile | null;\r\n    entity?: any;\r\n    explored?: boolean;\r\n    stoneDeposit?: any;\r\n    elevation?: number;\r\n}\r\n\r\ninterface ConfigLike {\r\n    W: number;\r\n    H: number;\r\n    COST: Record<string, number>;\r\n    BUILDING_LEVELS?: Array<{\r\n        name: string;\r\n        food: number;\r\n        wood?: number;\r\n        stone?: number;\r\n        capacity: number;\r\n    }>;\r\n    ZONE_BONUSES?: any;\r\n}\r\n\r\ninterface GameLike {\r\n    tiles: TileLike[][];\r\n    blds: Building[];\r\n    food: number;\r\n    wood: number;\r\n    stone: number;\r\n    res?: number;\r\n    simcityMode?: boolean;\r\n    roadTileCount?: number;\r\n    year?: number;\r\n    lastRoadPos?: { x: number; y: number } | null;\r\n    lockedResources?: {\r\n        residential?: boolean;\r\n        commercial?: boolean;\r\n        industrial?: boolean;\r\n    };\r\n}\r\n\r\ninterface PlacementResult {\r\n    success: boolean;\r\n    message: string;\r\n    cost?: {\r\n        food: number;\r\n        wood: number;\r\n        stone: number;\r\n    };\r\n    bonusText?: string;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// SIMPLE VALIDATION HELPERS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Check if tile blocks construction */\r\nfunction isTileBlocked(tile: TileLike): boolean {\r\n    return tile.type === 'WATER' || \r\n           tile.type === 'DEEP' || \r\n           tile.type === 'RIVER' || \r\n           tile.type === 'STONE';\r\n}\r\n\r\n/** Check if tile has existing structure */\r\nfunction hasExistingStructure(tile: TileLike): boolean {\r\n    return !!(tile.zone || tile.building || tile.road);\r\n}\r\n\r\n/** Simple validation for single tile placement */\r\nfunction isValidTilePlacement(tile: TileLike): boolean {\r\n    if (isTileBlocked(tile)) return false;\r\n    if (!tile.explored) return false;\r\n    if (tile.zone || tile.building) return false;\r\n    if (tile.road) return false;\r\n    return true;\r\n}\r\n\r\n/** Simple validation for road placement */\r\nfunction isValidRoadTilePlacement(tile: TileLike): boolean {\r\n    if (isTileBlocked(tile)) return false;\r\n    if (!tile.explored) return false;\r\n    if (tile.stoneDeposit) return false;\r\n    if (tile.road) return false;\r\n    return true;\r\n}\r\n\r\n/** Get elevation cost multiplier */\r\nfunction getElevationCostMult(tile: TileLike, threshold: number = 4, rate: number = 0.1): number {\r\n    const elevation = tile.elevation ?? 0;\r\n    if (elevation <= threshold) return 1.0;\r\n    return 1.0 + (elevation - threshold) * rate;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// BRESENHAM LINE ALGORITHM\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\nexport interface Point {\r\n    x: number;\r\n    y: number;\r\n}\r\n\r\n/** Get tiles in a line between two points (Bresenham's algorithm) */\r\nexport function getLineTiles(x0: number, y0: number, x1: number, y1: number): Point[] {\r\n    const tiles: Point[] = [];\r\n    const dx = Math.abs(x1 - x0);\r\n    const dy = Math.abs(y1 - y0);\r\n    const sx = x0 < x1 ? 1 : -1;\r\n    const sy = y0 < y1 ? 1 : -1;\r\n    let err = dx - dy;\r\n    \r\n    let cx = x0;\r\n    let cy = y0;\r\n    \r\n    while (true) {\r\n        tiles.push({ x: cx, y: cy });\r\n        if (cx === x1 && cy === y1) break;\r\n        const e2 = 2 * err;\r\n        if (e2 > -dy) { err -= dy; cx += sx; }\r\n        if (e2 < dx) { err += dx; cy += sy; }\r\n    }\r\n    return tiles;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// ROAD PLACEMENT\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Place a single road tile */\r\nexport function placeRoadTile(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    x: number,\r\n    y: number,\r\n    showError: boolean = false\r\n): PlacementResult {\r\n    // Bounds check\r\n    if (x < 0 || x >= config.W || y < 0 || y >= config.H) {\r\n        return { success: false, message: 'Out of bounds' };\r\n    }\r\n    \r\n    const tile = game.tiles[x]?.[y];\r\n    if (!tile) {\r\n        return { success: false, message: 'Invalid tile' };\r\n    }\r\n    \r\n    // Validation\r\n    if (!isValidRoadTilePlacement(tile)) {\r\n        if (tile.type === 'WATER' || tile.type === 'DEEP' || tile.type === 'RIVER' || tile.type === 'STONE') {\r\n            return { success: false, message: \"Can't build on water/stone\" };\r\n        }\r\n        if (!tile.explored) {\r\n            return { success: false, message: \"Cannot build in fog - explore first!\" };\r\n        }\r\n        if (tile.stoneDeposit) {\r\n            return { success: false, message: 'Stone deposit blocking' };\r\n        }\r\n        if (tile.road) {\r\n            return { success: false, message: 'Road already exists' };\r\n        }\r\n        return { success: false, message: 'Invalid spot for road' };\r\n    }\r\n    \r\n    // Cost check\r\n    const cost = config.COST.ROAD || 1;\r\n    if (game.simcityMode && (game.res || 0) < cost) {\r\n        return { success: false, message: `Need $${cost} funds` };\r\n    } else if (!game.simcityMode && game.food < cost) {\r\n        return { success: false, message: `Need ${cost} food` };\r\n    }\r\n    \r\n    // Place the road\r\n    tile.road = true;\r\n    tile.tree = false;\r\n    if (tile.entity) {\r\n        tile.entity = null; // Roads destroy resources\r\n    }\r\n    \r\n    game.roadTileCount = (game.roadTileCount || 0) + 1;\r\n    \r\n    // Deduct cost\r\n    if (game.simcityMode) {\r\n        game.res = (game.res || 0) - cost;\r\n    } else {\r\n        game.food -= cost;\r\n    }\r\n    \r\n    return { success: true, message: 'ğŸ›£ï¸ Road built', cost: { food: cost, wood: 0, stone: 0 } };\r\n}\r\n\r\n/** Place roads in a line between two points */\r\nexport function placeRoadLine(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    fromX: number,\r\n    fromY: number,\r\n    toX: number,\r\n    toY: number\r\n): { placed: number; total: number; message: string } {\r\n    const tiles = getLineTiles(fromX, fromY, toX, toY);\r\n    let placed = 0;\r\n    \r\n    for (const point of tiles) {\r\n        const result = placeRoadTile(game, config, point.x, point.y, false);\r\n        if (result.success) {\r\n            placed++;\r\n        }\r\n    }\r\n    \r\n    const message = placed > 0 \r\n        ? `ğŸ›£ï¸ ${placed} road tiles placed`\r\n        : 'âŒ No roads placed';\r\n    \r\n    return { placed, total: tiles.length, message };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// ZONE PLACEMENT\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Place a residential zone */\r\nexport function placeResidential(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    gx: number,\r\n    gy: number,\r\n    selectedLevel: number = 0\r\n): PlacementResult {\r\n    // Validation\r\n    const tile = game.tiles[gx]?.[gy];\r\n    if (!tile) {\r\n        return { success: false, message: 'âŒ Invalid tile' };\r\n    }\r\n    \r\n    if (!isValidTilePlacement(tile)) {\r\n        if (tile.type === 'WATER' || tile.type === 'DEEP' || tile.type === 'RIVER') {\r\n            return { success: false, message: \"âŒ Can't build on water!\" };\r\n        }\r\n        if (tile.type === 'STONE') {\r\n            return { success: false, message: \"âŒ Can't build on stone mountains!\" };\r\n        }\r\n        if (tile.zone || tile.building) {\r\n            return { success: false, message: 'âŒ Tile already has a building!' };\r\n        }\r\n        if (tile.road) {\r\n            return { success: false, message: \"âŒ Can't build on roads!\" };\r\n        }\r\n        return { success: false, message: 'âŒ Invalid Spot' };\r\n    }\r\n    \r\n    // Get level config\r\n    const levelConfig = config.BUILDING_LEVELS?.[selectedLevel];\r\n    if (!levelConfig) {\r\n        return { success: false, message: 'âŒ Invalid building level!' };\r\n    }\r\n    \r\n    // Calculate elevation cost\r\n    const elevCostMult = getElevationCostMult(tile, 4, 0.1);\r\n    const adjFoodCost = Math.ceil(levelConfig.food * elevCostMult);\r\n    const adjWoodCost = Math.ceil((levelConfig.wood || 0) * elevCostMult);\r\n    const adjStoneCost = Math.ceil((levelConfig.stone || 0) * elevCostMult);\r\n    \r\n    // Check resources\r\n    if (game.food < adjFoodCost) {\r\n        return { success: false, message: `Need ${adjFoodCost} Food for ${levelConfig.name}` };\r\n    }\r\n    if (adjWoodCost > 0 && game.wood < adjWoodCost) {\r\n        return { success: false, message: `Need ${adjWoodCost} Wood for ${levelConfig.name}` };\r\n    }\r\n    if (adjStoneCost > 0 && game.stone < adjStoneCost) {\r\n        return { success: false, message: `Need ${adjStoneCost} Stone for ${levelConfig.name}` };\r\n    }\r\n    \r\n    // Deduct resources\r\n    game.food -= adjFoodCost;\r\n    if (adjWoodCost > 0) game.wood -= adjWoodCost;\r\n    if (adjStoneCost > 0) game.stone -= adjStoneCost;\r\n    \r\n    // Calculate zone bonus\r\n    const zoneBonus = calculateZoneBonus(game, config, gx, gy, 'R');\r\n    const bonusInfo = getZoneBonusDescription(game, config, gx, gy, 'R');\r\n    \r\n    // Place the zone\r\n    tile.zone = 'R';\r\n    tile.building = {\r\n        level: selectedLevel,\r\n        growth: 0,\r\n        desirability: zoneBonus,\r\n        age: 0,\r\n        lastBirthYear: game.year || 0,\r\n        pop: 0,\r\n        capacity: levelConfig.capacity,\r\n        variant: 1\r\n    };\r\n    tile.tree = false;\r\n    \r\n    return {\r\n        success: true,\r\n        message: `ğŸ  ${levelConfig.name} built! ${bonusInfo.text} Cap: ${levelConfig.capacity}`,\r\n        cost: { food: adjFoodCost, wood: adjWoodCost, stone: adjStoneCost },\r\n        bonusText: bonusInfo.text\r\n    };\r\n}\r\n\r\n/** Place a commercial zone */\r\nexport function placeCommercial(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    gx: number,\r\n    gy: number,\r\n    selectedLevel: number = 0\r\n): PlacementResult {\r\n    const tile = game.tiles[gx]?.[gy];\r\n    if (!tile) {\r\n        return { success: false, message: 'âŒ Invalid tile' };\r\n    }\r\n    \r\n    if (!isValidTilePlacement(tile)) {\r\n        return { success: false, message: 'âŒ Invalid placement' };\r\n    }\r\n    \r\n    // Get building data\r\n    const buildingData = config.BUILDING_LEVELS?.[selectedLevel];\r\n    if (!buildingData) {\r\n        return { success: false, message: 'âŒ Invalid building level!' };\r\n    }\r\n    \r\n    // Calculate elevation cost\r\n    const elevCostMult = getElevationCostMult(tile, 4, 0.1);\r\n    const adjFoodCost = Math.ceil(buildingData.food * elevCostMult);\r\n    const adjWoodCost = Math.ceil((buildingData.wood || 0) * elevCostMult);\r\n    const adjStoneCost = Math.ceil((buildingData.stone || 0) * elevCostMult);\r\n    \r\n    // Check resources\r\n    if (game.food < adjFoodCost) {\r\n        return { success: false, message: `Need ${adjFoodCost} Food` };\r\n    }\r\n    if (adjWoodCost > 0 && game.wood < adjWoodCost) {\r\n        return { success: false, message: `Need ${adjWoodCost} Wood` };\r\n    }\r\n    if (adjStoneCost > 0 && game.stone < adjStoneCost) {\r\n        return { success: false, message: `Need ${adjStoneCost} Stone` };\r\n    }\r\n    \r\n    // Calculate zone bonus\r\n    const zoneBonus = calculateZoneBonus(game, config, gx, gy, 'C');\r\n    const bonusInfo = getZoneBonusDescription(game, config, gx, gy, 'C');\r\n    \r\n    // Deduct resources\r\n    game.food -= adjFoodCost;\r\n    if (adjWoodCost > 0) game.wood -= adjWoodCost;\r\n    if (adjStoneCost > 0) game.stone -= adjStoneCost;\r\n    \r\n    // Clear tree and place\r\n    tile.tree = false;\r\n    \r\n    game.blds.push({\r\n        t: 'COM',\r\n        x: gx,\r\n        y: gy,\r\n        lvl: selectedLevel,\r\n        efficiency: zoneBonus,\r\n        age: 0,\r\n        variant: 1\r\n    });\r\n    \r\n    let costStr = `-${adjFoodCost} food, -${adjWoodCost} wood`;\r\n    if (adjStoneCost > 0) costStr += `, -${adjStoneCost} stone`;\r\n    \r\n    return {\r\n        success: true,\r\n        message: `ğŸª ${buildingData.name} built! ${bonusInfo.text} (${costStr})`,\r\n        cost: { food: adjFoodCost, wood: adjWoodCost, stone: adjStoneCost },\r\n        bonusText: bonusInfo.text\r\n    };\r\n}\r\n\r\n/** Place an industrial zone */\r\nexport function placeIndustrial(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    gx: number,\r\n    gy: number,\r\n    selectedLevel: number = 0\r\n): PlacementResult {\r\n    const tile = game.tiles[gx]?.[gy];\r\n    if (!tile) {\r\n        return { success: false, message: 'âŒ Invalid tile' };\r\n    }\r\n    \r\n    if (!isValidTilePlacement(tile)) {\r\n        return { success: false, message: 'âŒ Invalid placement' };\r\n    }\r\n    \r\n    // Get building data\r\n    const buildingData = config.BUILDING_LEVELS?.[selectedLevel];\r\n    if (!buildingData) {\r\n        return { success: false, message: 'âŒ Invalid building level!' };\r\n    }\r\n    \r\n    // Calculate elevation cost\r\n    const elevCostMult = getElevationCostMult(tile, 4, 0.1);\r\n    const adjFoodCost = Math.ceil(buildingData.food * elevCostMult);\r\n    const adjWoodCost = Math.ceil((buildingData.wood || 0) * elevCostMult);\r\n    const adjStoneCost = Math.ceil((buildingData.stone || 0) * elevCostMult);\r\n    \r\n    // Check resources\r\n    if (game.food < adjFoodCost) {\r\n        return { success: false, message: `Need ${adjFoodCost} Food` };\r\n    }\r\n    if (adjWoodCost > 0 && game.wood < adjWoodCost) {\r\n        return { success: false, message: `Need ${adjWoodCost} Wood` };\r\n    }\r\n    if (adjStoneCost > 0 && game.stone < adjStoneCost) {\r\n        return { success: false, message: `Need ${adjStoneCost} Stone` };\r\n    }\r\n    \r\n    // Calculate zone bonus\r\n    const zoneBonus = calculateZoneBonus(game, config, gx, gy, 'I');\r\n    const bonusInfo = getZoneBonusDescription(game, config, gx, gy, 'I');\r\n    \r\n    // Deduct resources\r\n    game.food -= adjFoodCost;\r\n    if (adjWoodCost > 0) game.wood -= adjWoodCost;\r\n    if (adjStoneCost > 0) game.stone -= adjStoneCost;\r\n    \r\n    // Clear tree and place\r\n    tile.tree = false;\r\n    \r\n    game.blds.push({\r\n        t: 'IND',\r\n        x: gx,\r\n        y: gy,\r\n        lvl: selectedLevel,\r\n        efficiency: zoneBonus,\r\n        age: 0,\r\n        variant: 1\r\n    });\r\n    \r\n    let costStr = `-${adjFoodCost} food, -${adjWoodCost} wood`;\r\n    if (adjStoneCost > 0) costStr += `, -${adjStoneCost} stone`;\r\n    \r\n    return {\r\n        success: true,\r\n        message: `ğŸ­ ${buildingData.name} built! ${bonusInfo.text} (${costStr})`,\r\n        cost: { food: adjFoodCost, wood: adjWoodCost, stone: adjStoneCost },\r\n        bonusText: bonusInfo.text\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// SPECIAL BUILDINGS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Place a well (1x1 building) */\r\nexport function placeWell(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    gx: number,\r\n    gy: number\r\n): PlacementResult {\r\n    const tile = game.tiles[gx]?.[gy];\r\n    if (!tile) {\r\n        return { success: false, message: 'âŒ Invalid tile' };\r\n    }\r\n    \r\n    if (!isValidTilePlacement(tile)) {\r\n        return { success: false, message: 'âŒ Invalid placement' };\r\n    }\r\n    \r\n    const cost = config.COST.WELL || 5;\r\n    if (game.food < cost) {\r\n        return { success: false, message: `Need ${cost} Food for Well` };\r\n    }\r\n    \r\n    game.food -= cost;\r\n    tile.tree = false;\r\n    \r\n    game.blds.push({\r\n        t: 'WELL',\r\n        x: gx,\r\n        y: gy\r\n    });\r\n    \r\n    return {\r\n        success: true,\r\n        message: `ğŸ’§ Well built! (-${cost} food)`,\r\n        cost: { food: cost, wood: 0, stone: 0 }\r\n    };\r\n}\r\n\r\n/** Place a 2x2 building (Chief's Hut, Storage, etc.) */\r\nexport function placeLargeBuilding(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    gx: number,\r\n    gy: number,\r\n    buildingType: BuildingTool,\r\n    foodCost: number,\r\n    woodCost: number = 0,\r\n    stoneCost: number = 0\r\n): PlacementResult {\r\n    // Check all 4 tiles\r\n    for (let dx = 0; dx < 2; dx++) {\r\n        for (let dy = 0; dy < 2; dy++) {\r\n            const tx = gx + dx;\r\n            const ty = gy + dy;\r\n            if (tx >= config.W || ty >= config.H) {\r\n                return { success: false, message: 'âŒ Building would extend beyond map!' };\r\n            }\r\n            const tile = game.tiles[tx]?.[ty];\r\n            if (!tile || !isValidTilePlacement(tile)) {\r\n                return { success: false, message: 'âŒ Invalid placement for one or more tiles!' };\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Check resources\r\n    if (game.food < foodCost) {\r\n        return { success: false, message: `Need ${foodCost} Food` };\r\n    }\r\n    if (woodCost > 0 && game.wood < woodCost) {\r\n        return { success: false, message: `Need ${woodCost} Wood` };\r\n    }\r\n    if (stoneCost > 0 && game.stone < stoneCost) {\r\n        return { success: false, message: `Need ${stoneCost} Stone` };\r\n    }\r\n    \r\n    // Deduct resources\r\n    game.food -= foodCost;\r\n    if (woodCost > 0) game.wood -= woodCost;\r\n    if (stoneCost > 0) game.stone -= stoneCost;\r\n    \r\n    // Clear trees on all 4 tiles\r\n    for (let dx = 0; dx < 2; dx++) {\r\n        for (let dy = 0; dy < 2; dy++) {\r\n            game.tiles[gx + dx][gy + dy].tree = false;\r\n        }\r\n    }\r\n    \r\n    game.blds.push({\r\n        t: buildingType,\r\n        x: gx,\r\n        y: gy\r\n    });\r\n    \r\n    let costStr = `-${foodCost} food`;\r\n    if (woodCost > 0) costStr += `, -${woodCost} wood`;\r\n    if (stoneCost > 0) costStr += `, -${stoneCost} stone`;\r\n    \r\n    return {\r\n        success: true,\r\n        message: `${buildingType} built! (${costStr})`,\r\n        cost: { food: foodCost, wood: woodCost, stone: stoneCost }\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// DEMOLITION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\ninterface DemolishResult {\r\n    success: boolean;\r\n    message: string;\r\n    refund?: {\r\n        food: number;\r\n        wood: number;\r\n        stone: number;\r\n    };\r\n}\r\n\r\n/** Demolish building at position */\r\nexport function demolish(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    gx: number,\r\n    gy: number\r\n): DemolishResult {\r\n    const tile = game.tiles[gx]?.[gy];\r\n    if (!tile) {\r\n        return { success: false, message: 'Invalid tile' };\r\n    }\r\n    \r\n    // Check for road\r\n    if (tile.road) {\r\n        tile.road = false;\r\n        game.roadTileCount = Math.max(0, (game.roadTileCount || 0) - 1);\r\n        return { success: true, message: 'ğŸ›£ï¸ Road demolished' };\r\n    }\r\n    \r\n    // Check for buildings in blds array\r\n    let bldHit = -1;\r\n    for (let i = 0; i < game.blds.length; i++) {\r\n        const b = game.blds[i];\r\n        // COM, IND, WELL are 1x1, others are 2x2\r\n        const bz = (b.t === 'WELL' || b.t === 'COM' || b.t === 'IND') ? 1 : 2;\r\n        if (gx >= b.x && gx < b.x + bz && gy >= b.y && gy < b.y + bz) {\r\n            bldHit = i;\r\n            break;\r\n        }\r\n    }\r\n    \r\n    if (bldHit !== -1) {\r\n        const removedBld = game.blds[bldHit];\r\n        game.blds.splice(bldHit, 1);\r\n        return { success: true, message: `ğŸ”¨ ${removedBld.t} demolished` };\r\n    }\r\n    \r\n    // Check for zoned buildings\r\n    if (tile.zone || tile.building) {\r\n        const bld = tile.building;\r\n        let refund = { food: 0, wood: 0, stone: 0 };\r\n        \r\n        // 10% salvage rate\r\n        if (bld && bld.level !== undefined && config.BUILDING_LEVELS) {\r\n            const levelConfig = config.BUILDING_LEVELS[bld.level];\r\n            if (levelConfig) {\r\n                const refundRate = 0.10;\r\n                refund.food = Math.floor(levelConfig.food * refundRate);\r\n                refund.wood = Math.floor((levelConfig.wood || 0) * refundRate);\r\n                refund.stone = Math.floor((levelConfig.stone || 0) * refundRate);\r\n                \r\n                game.food += refund.food;\r\n                game.wood += refund.wood;\r\n                game.stone += refund.stone;\r\n            }\r\n        }\r\n        \r\n        tile.zone = null;\r\n        tile.building = null;\r\n        \r\n        const hasRefund = refund.food > 0 || refund.wood > 0 || refund.stone > 0;\r\n        if (hasRefund) {\r\n            const parts: string[] = [];\r\n            if (refund.food > 0) parts.push(`${refund.food} food`);\r\n            if (refund.wood > 0) parts.push(`${refund.wood} wood`);\r\n            if (refund.stone > 0) parts.push(`${refund.stone} stone`);\r\n            return { \r\n                success: true, \r\n                message: `â™»ï¸ Salvaged 10%: ${parts.join(', ')}`,\r\n                refund\r\n            };\r\n        }\r\n        \r\n        return { success: true, message: 'ğŸ”¨ Demolished (no salvage value)' };\r\n    }\r\n    \r\n    return { success: false, message: 'Nothing to demolish here' };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// UTILITY FUNCTIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Get building size for a type */\r\nexport function getBuildingSize(buildingType: string): BuildingSize {\r\n    const key = buildingType.toUpperCase() as BuildingTool;\r\n    return BUILDING_SIZES[key] || { w: 1, h: 1 };\r\n}\r\n\r\n/** Check if position overlaps with existing building */\r\nexport function checkBuildingOverlap(\r\n    blds: Building[],\r\n    gx: number,\r\n    gy: number,\r\n    width: number = 1,\r\n    height: number = 1\r\n): Building | null {\r\n    for (const b of blds) {\r\n        const bSize = getBuildingSize(b.t);\r\n        // Check if rectangles overlap\r\n        if (gx < b.x + bSize.w && gx + width > b.x &&\r\n            gy < b.y + bSize.h && gy + height > b.y) {\r\n            return b;\r\n        }\r\n    }\r\n    return null;\r\n}\r\n","/**\r\n * Civil Zones - Building Evolution\r\n * Building variant evolution based on desirability\r\n */\r\n\r\nimport type { ZoneTile, Building } from './types.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// INTERFACES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\ninterface TileLike {\r\n    type: string;\r\n    road?: boolean;\r\n    tree?: boolean;\r\n    water?: boolean;\r\n    zone?: string | null;\r\n    building?: ZoneTile | null;\r\n    entity?: any;\r\n    explored?: boolean;\r\n    stoneDeposit?: any;\r\n    elevation?: number;\r\n}\r\n\r\ninterface WorkforceLike {\r\n    roadWorkers?: number;\r\n    roadsNeeded?: number;\r\n}\r\n\r\ninterface GameLike {\r\n    tiles: TileLike[][];\r\n    blds: Building[];\r\n    workforce?: WorkforceLike;\r\n    evolutionFrameCounter?: number;\r\n    gameState?: string;\r\n}\r\n\r\ninterface ConfigLike {\r\n    W: number;\r\n    H: number;\r\n    BUILDING_LEVELS?: Array<{\r\n        name: string;\r\n        variants?: Array<{ name: string; icon: string; bonusMult: number }>;\r\n    }>;\r\n}\r\n\r\ninterface VariantConfig {\r\n    name: string;\r\n    icon: string;\r\n    bonusMult: number;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// VARIANT DETERMINATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Desirability thresholds for variants */\r\nexport const VARIANT_THRESHOLDS = {\r\n    ABANDONED: 0.1,\r\n    LOW: 0.4,\r\n    MEDIUM: 0.7\r\n};\r\n\r\n/** Get variant (0-3) based on desirability */\r\nexport function getVariantFromDesirability(desirability: number): number {\r\n    if (desirability < VARIANT_THRESHOLDS.ABANDONED) return 0; // Abandoned\r\n    if (desirability < VARIANT_THRESHOLDS.LOW) return 1; // Low\r\n    if (desirability < VARIANT_THRESHOLDS.MEDIUM) return 2; // Medium\r\n    return 3; // High\r\n}\r\n\r\n/** Get variant name from config */\r\nexport function getVariantName(\r\n    config: ConfigLike,\r\n    buildingLevel: number,\r\n    variant: number\r\n): string {\r\n    const levelConfig = config.BUILDING_LEVELS?.[buildingLevel];\r\n    if (levelConfig?.variants && levelConfig.variants[variant]) {\r\n        return levelConfig.variants[variant].name;\r\n    }\r\n    return 'Building';\r\n}\r\n\r\n/** Get variant icons for state display */\r\nexport const VARIANT_ICONS = ['ğŸ•³ï¸', 'ğŸšï¸', 'ğŸ ', 'ğŸ˜ï¸'];\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// LEVEL 1 DESIRABILITY (Special Calculation)\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Calculate desirability for Level 1 buildings */\r\nexport function calculateLevel1Desirability(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    x: number,\r\n    y: number\r\n): number {\r\n    const { tiles, blds, workforce } = game;\r\n    const { W, H } = config;\r\n    \r\n    let score = 0.25; // Lower baseline for Level 1\r\n    \r\n    // === WATER PROXIMITY (+0.15 bonus) ===\r\n    let waterDist = 999;\r\n    waterLoop: \r\n    for (let dx = -5; dx <= 5; dx++) {\r\n        for (let dy = -5; dy <= 5; dy++) {\r\n            const nx = x + dx, ny = y + dy;\r\n            if (nx < 0 || nx >= W || ny < 0 || ny >= H) continue;\r\n            const tile = tiles[nx][ny];\r\n            if (tile.type === 'WATER' || tile.type === 'RIVER' || tile.water) {\r\n                const dist = Math.abs(dx) + Math.abs(dy);\r\n                waterDist = Math.min(waterDist, dist);\r\n                if (dist === 0) break waterLoop;\r\n            }\r\n        }\r\n    }\r\n    if (waterDist <= 3) score += 0.15;\r\n    else if (waterDist <= 5) score += 0.08;\r\n    \r\n    // === ROAD PROXIMITY (+0.10 bonus scaled by maintenance) ===\r\n    let hasAdjacentRoad = false;\r\n    for (let dx = -1; dx <= 1 && !hasAdjacentRoad; dx++) {\r\n        for (let dy = -1; dy <= 1 && !hasAdjacentRoad; dy++) {\r\n            if (dx === 0 && dy === 0) continue;\r\n            const nx = x + dx, ny = y + dy;\r\n            if (nx < 0 || nx >= W || ny < 0 || ny >= H) continue;\r\n            if (tiles[nx][ny].road) {\r\n                hasAdjacentRoad = true;\r\n            }\r\n        }\r\n    }\r\n    if (hasAdjacentRoad) {\r\n        let roadMaintenance = 1.0;\r\n        if (workforce && workforce.roadsNeeded && workforce.roadsNeeded > 0) {\r\n            roadMaintenance = Math.min(1.0, (workforce.roadWorkers || 0) / workforce.roadsNeeded);\r\n        }\r\n        score += 0.10 * roadMaintenance;\r\n    }\r\n    \r\n    // === COMMERCIAL NEARBY (+0.08 bonus within 8 tiles) ===\r\n    const commercialNearby = blds.some(b => \r\n        b.t === 'COM' && Math.abs(b.x - x) + Math.abs(b.y - y) <= 8\r\n    );\r\n    if (commercialNearby) score += 0.08;\r\n    \r\n    // === INDUSTRIAL NEARBY (+0.15 bonus - primitive people want to live near butcher/hunter) ===\r\n    const industrialNearby = blds.some(b => \r\n        b.t === 'IND' && Math.abs(b.x - x) + Math.abs(b.y - y) <= 8\r\n    );\r\n    if (industrialNearby) score += 0.15;\r\n    \r\n    // === BERRIES NEARBY (+0.20 bonus) ===\r\n    let berryCount = 0;\r\n    for (let dx = -3; dx <= 3; dx++) {\r\n        for (let dy = -3; dy <= 3; dy++) {\r\n            const nx = x + dx, ny = y + dy;\r\n            if (nx < 0 || nx >= W || ny < 0 || ny >= H) continue;\r\n            if (tiles[nx][ny].type === 'BERRY') berryCount++;\r\n        }\r\n    }\r\n    if (berryCount >= 1) score += 0.20;\r\n    \r\n    return Math.max(0, Math.min(1, score));\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// STANDARD DESIRABILITY (Levels 2+)\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Calculate desirability for standard buildings */\r\nexport function calculateTileDesirability(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    x: number,\r\n    y: number,\r\n    buildingLevel?: number\r\n): number {\r\n    // Use Level 1 special calculation\r\n    if (buildingLevel === 1) {\r\n        return calculateLevel1Desirability(game, config, x, y);\r\n    }\r\n    \r\n    const { tiles, blds } = game;\r\n    const { W, H } = config;\r\n    \r\n    let score = 0.35; // Base score\r\n    \r\n    // === WATER PROXIMITY (+0.30 max) ===\r\n    let waterDist = 999;\r\n    waterLoop:\r\n    for (let dx = -5; dx <= 5; dx++) {\r\n        for (let dy = -5; dy <= 5; dy++) {\r\n            const nx = x + dx, ny = y + dy;\r\n            if (nx >= 0 && nx < W && ny >= 0 && ny < H) {\r\n                const tile = tiles[nx][ny];\r\n                if (tile.type === 'WATER' || tile.type === 'RIVER' || tile.water) {\r\n                    const dist = Math.abs(dx) + Math.abs(dy);\r\n                    waterDist = Math.min(waterDist, dist);\r\n                    if (dist === 0) break waterLoop;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    if (waterDist <= 5) {\r\n        score += 0.30 * (1 - (waterDist / 6));\r\n    }\r\n    \r\n    // === WELL PROXIMITY (+0.25 max) ===\r\n    let nearestWell = 999;\r\n    for (const well of blds) {\r\n        if (well.t !== 'WELL') continue;\r\n        const dist = Math.abs(x - well.x) + Math.abs(y - well.y);\r\n        if (dist > 8) continue;\r\n        nearestWell = Math.min(nearestWell, dist);\r\n        if (dist === 0) break;\r\n    }\r\n    if (nearestWell <= 8) {\r\n        score += 0.25 * (1 - (nearestWell / 9));\r\n    }\r\n    \r\n    // === ROAD CONNECTIVITY (+0.20 max) ===\r\n    let roadDist = 999;\r\n    roadLoop:\r\n    for (let dx = -2; dx <= 2; dx++) {\r\n        for (let dy = -2; dy <= 2; dy++) {\r\n            const nx = x + dx, ny = y + dy;\r\n            if (nx >= 0 && nx < W && ny >= 0 && ny < H) {\r\n                if (tiles[nx][ny].road) {\r\n                    const dist = Math.abs(dx) + Math.abs(dy);\r\n                    roadDist = Math.min(roadDist, dist);\r\n                    if (dist === 0) break roadLoop;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    if (roadDist <= 2) {\r\n        score += 0.20 * (1 - (roadDist / 3));\r\n    }\r\n    \r\n    // === COMMERCIAL PROXIMITY (+0.12 max) ===\r\n    let nearestCom = 999;\r\n    for (const com of blds) {\r\n        if (com.t !== 'COM') continue;\r\n        const dist = Math.abs(x - com.x) + Math.abs(y - com.y);\r\n        if (dist > 10) continue;\r\n        nearestCom = Math.min(nearestCom, dist);\r\n        if (dist === 0) break;\r\n    }\r\n    if (nearestCom <= 10) {\r\n        score += 0.12 * (1 - (nearestCom / 11));\r\n    }\r\n    \r\n    // === INDUSTRIAL DISTANCE (Pollution penalty: up to -0.20) ===\r\n    let nearestInd = 999;\r\n    for (const ind of blds) {\r\n        if (ind.t !== 'IND') continue;\r\n        const dist = Math.abs(x - ind.x) + Math.abs(y - ind.y);\r\n        if (dist >= 15) continue;\r\n        nearestInd = Math.min(nearestInd, dist);\r\n    }\r\n    if (nearestInd < 15) {\r\n        const penalty = nearestInd < 3 ? -0.20 : -0.20 * (1 - ((nearestInd - 3) / 12));\r\n        score += penalty;\r\n    }\r\n    \r\n    // === POPULATION DENSITY (+0.08 max, penalties for isolation/overcrowding) ===\r\n    let neighbors = 0;\r\n    for (let dx = -2; dx <= 2 && neighbors <= 10; dx++) {\r\n        for (let dy = -2; dy <= 2 && neighbors <= 10; dy++) {\r\n            if (dx === 0 && dy === 0) continue;\r\n            const nx = x + dx, ny = y + dy;\r\n            if (nx >= 0 && nx < W && ny >= 0 && ny < H) {\r\n                if (tiles[nx][ny].zone === 'R') {\r\n                    neighbors++;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Sweet spot: 2-6 neighbors\r\n    if (neighbors >= 2 && neighbors <= 6) {\r\n        score += 0.08;\r\n    } else if (neighbors > 6) {\r\n        score -= Math.min(0.10, (neighbors - 6) * 0.02);\r\n    } else if (neighbors === 0) {\r\n        score -= 0.15; // Isolation penalty\r\n    }\r\n    \r\n    // === TREES (+0.05 max) ===\r\n    let trees = 0;\r\n    for (let dx = -1; dx <= 1; dx++) {\r\n        for (let dy = -1; dy <= 1; dy++) {\r\n            const nx = x + dx, ny = y + dy;\r\n            if (nx >= 0 && nx < W && ny >= 0 && ny < H) {\r\n                if (tiles[nx][ny].tree) trees++;\r\n            }\r\n        }\r\n    }\r\n    score += Math.min(0.05, trees * 0.015);\r\n    \r\n    return Math.max(0, Math.min(1, score));\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// POPULATION SCALING\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Calculate Level 1 population based on variant and desirability */\r\nexport function calculateLevel1Population(desirability: number, variant: number): number {\r\n    let newPopulation: number;\r\n    \r\n    if (variant === 0) {\r\n        // Abandoned: 0 people\r\n        newPopulation = 0;\r\n    } else if (variant === 1) {\r\n        // Small Nest: 1-5 people\r\n        newPopulation = 1 + Math.floor((desirability - 0.1) / 0.3 * 4);\r\n    } else if (variant === 2) {\r\n        // Tree Platform: 6-10 people\r\n        newPopulation = 6 + Math.floor((desirability - 0.4) / 0.3 * 4);\r\n    } else {\r\n        // Sturdy Treehouse: 11-15 people\r\n        newPopulation = 11 + Math.floor((desirability - 0.7) / 0.3 * 4);\r\n    }\r\n    \r\n    return Math.max(0, Math.min(15, newPopulation));\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// EVOLUTION UPDATE\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\ninterface EvolutionResult {\r\n    x: number;\r\n    y: number;\r\n    oldVariant: number;\r\n    newVariant: number;\r\n    upgraded: boolean;\r\n    variantName: string;\r\n}\r\n\r\n/** Update building evolution for all residential tiles */\r\nexport function updateBuildingEvolution(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    maxChecksPerFrame: number = 20\r\n): EvolutionResult[] {\r\n    const results: EvolutionResult[] = [];\r\n    const { tiles } = game;\r\n    const { W, H } = config;\r\n    \r\n    // Frame counter for optimization\r\n    if (!game.evolutionFrameCounter) game.evolutionFrameCounter = 0;\r\n    game.evolutionFrameCounter++;\r\n    \r\n    // Only update every 300 frames (5 seconds at 60fps)\r\n    if (game.evolutionFrameCounter < 300) return results;\r\n    game.evolutionFrameCounter = 0;\r\n    \r\n    // Don't run in nomad mode\r\n    if (game.gameState !== 'CITY') return results;\r\n    \r\n    let checksThisFrame = 0;\r\n    \r\n    for (let x = 0; x < W && checksThisFrame < maxChecksPerFrame; x++) {\r\n        for (let y = 0; y < H && checksThisFrame < maxChecksPerFrame; y++) {\r\n            const tile = tiles[x][y];\r\n            if (tile.zone !== 'R' || !tile.building) continue;\r\n            \r\n            checksThisFrame++;\r\n            const bld = tile.building;\r\n            \r\n            // Calculate local desirability\r\n            const desirability = calculateTileDesirability(game, config, x, y, bld.level);\r\n            \r\n            // Store desirability\r\n            bld.desirability = desirability;\r\n            \r\n            // Determine variant\r\n            const oldVariant = bld.variant || 0;\r\n            let newVariant: number;\r\n            \r\n            if (bld.level === 1) {\r\n                // Level 1 special thresholds\r\n                newVariant = getVariantFromDesirability(desirability);\r\n                // Calculate population for Level 1\r\n                bld.population = calculateLevel1Population(desirability, newVariant);\r\n            } else {\r\n                // Standard variant calculation\r\n                newVariant = getVariantFromDesirability(desirability);\r\n            }\r\n            \r\n            // Check if variant changed\r\n            if (newVariant !== oldVariant) {\r\n                bld.variant = newVariant as 0 | 1 | 2 | 3;\r\n                \r\n                const variantName = getVariantName(config, bld.level || 1, newVariant);\r\n                \r\n                results.push({\r\n                    x,\r\n                    y,\r\n                    oldVariant,\r\n                    newVariant,\r\n                    upgraded: newVariant > oldVariant,\r\n                    variantName\r\n                });\r\n            }\r\n        }\r\n    }\r\n    \r\n    return results;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// BONUS MULTIPLIERS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Get bonus multiplier for a variant */\r\nexport function getVariantBonusMultiplier(variant: number): number {\r\n    switch (variant) {\r\n        case 0: return 0;     // Abandoned - no bonus\r\n        case 1: return 0.5;   // Low - 50%\r\n        case 2: return 1.0;   // Medium - 100%\r\n        case 3: return 1.5;   // High - 150%\r\n        default: return 1.0;\r\n    }\r\n}\r\n\r\n/** Get income multiplier for a variant */\r\nexport function getVariantIncomeMultiplier(variant: number): number {\r\n    switch (variant) {\r\n        case 0: return 0;\r\n        case 1: return 0.5;\r\n        case 2: return 1.0;\r\n        case 3: return 1.5;\r\n        default: return 1.0;\r\n    }\r\n}\r\n\r\n/** Get lifespan bonus for a variant */\r\nexport function getVariantLifespanBonus(variant: number): number {\r\n    switch (variant) {\r\n        case 0: return 0;\r\n        case 1: return 0;\r\n        case 2: return 1;\r\n        case 3: return 2;\r\n        default: return 0;\r\n    }\r\n}\r\n","/**\r\n * Civil Zones - Entity Types\r\n * Type definitions for animals, nomads, and berries\r\n */\r\n\r\n// Import base types from canonical locations\r\nimport type { TerrainType, TileEntity as BaseTileEntity } from '../types/tiles.js';\r\n\r\n// Re-export for convenience (with original names for internal use)\r\nexport type { TerrainType, BaseTileEntity };\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// ANIMAL TYPES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Animal type names */\r\nexport type AnimalTypeName = 'DEER' | 'BISON' | 'MAMMOTH' | 'TURTLE' | 'WOLF';\r\n\r\n/** Animal type configuration */\r\nexport interface AnimalTypeConfig {\r\n    name: AnimalTypeName;\r\n    hitToKill: number;           // Hits required to defeat\r\n    foodReward: number | [number, number]; // Fixed or [min, max] range\r\n    popCost: number;             // Population cost to kill (wolves cost pop)\r\n    color: string;               // Display color\r\n    speed: number;               // Movement speed (0.1-1.0)\r\n    spawnRate: number;           // Spawn weight (0.0-1.0)\r\n    terrain: TerrainType[];      // Valid spawn terrain\r\n}\r\n\r\n/** Animal instance (entity-specific) */\r\nexport interface EntityAnimal {\r\n    x: number;\r\n    y: number;\r\n    hits: number;                // Damage taken\r\n    type: AnimalTypeName;\r\n    moving?: boolean;            // Currently moving\r\n    targetX?: number;            // Movement target\r\n    targetY?: number;\r\n}\r\n\r\n/** Animal combat result */\r\nexport interface AnimalCombatResult {\r\n    defeated: boolean;\r\n    foodGained: number;\r\n    popLost: number;\r\n    herdDamage: number;\r\n    message: string;\r\n    isHerd: boolean;\r\n    gameOver?: boolean;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// NOMAD TYPES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Nomad encounter type */\r\nexport type NomadEncounterType = 'FRIENDLY' | 'HOSTILE' | 'NEUTRAL';\r\n\r\n/** Nomad instance */\r\nexport interface Nomad {\r\n    x: number;\r\n    y: number;\r\n    encountered?: boolean;\r\n    type?: NomadEncounterType;\r\n}\r\n\r\n/** Nomad encounter result */\r\nexport interface NomadEncounterResult {\r\n    type: NomadEncounterType;\r\n    popGained: number;\r\n    popLost: number;\r\n    loot: {\r\n        food: number;\r\n        wood: number;\r\n        stone: number;\r\n    };\r\n    mapReveal: boolean;\r\n    message: string;\r\n}\r\n\r\n/** Loot range configuration */\r\nexport interface LootRange {\r\n    min: number;\r\n    max: number;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// BERRY TYPES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Berry bush instance */\r\nexport interface BerryBush {\r\n    x: number;\r\n    y: number;\r\n    depleted?: boolean;\r\n}\r\n\r\n/** Berry gathering result */\r\nexport interface BerryGatherResult {\r\n    success: boolean;\r\n    poisoned: boolean;\r\n    foodGained: number;\r\n    popLost: number;\r\n    message: string;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// ENTITY TILE DATA\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Entity data stored on a tile (entity-specific) */\r\nexport interface EntityTileData {\r\n    type: 'BERRY' | 'NOMAD' | 'WOLF';\r\n    depleted?: boolean;\r\n    encountered?: boolean;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// CONFIGURATION CONSTANTS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Default animal configurations */\r\nexport const DEFAULT_ANIMAL_TYPES: AnimalTypeConfig[] = [\r\n    { \r\n        name: 'DEER', \r\n        hitToKill: 2, \r\n        foodReward: [1, 30], \r\n        popCost: 0, \r\n        color: '#C89858', \r\n        speed: 1, \r\n        spawnRate: 0.45, \r\n        terrain: ['GRASS', 'FOREST'] \r\n    },\r\n    { \r\n        name: 'BISON', \r\n        hitToKill: 3, \r\n        foodReward: [5, 30], \r\n        popCost: 0, \r\n        color: '#A06830', \r\n        speed: 0.5, \r\n        spawnRate: 0.30, \r\n        terrain: ['GRASS', 'FOREST'] \r\n    },\r\n    { \r\n        name: 'MAMMOTH', \r\n        hitToKill: 5, \r\n        foodReward: [15, 30], \r\n        popCost: 0, \r\n        color: '#806040', \r\n        speed: 0.3, \r\n        spawnRate: 0.10, \r\n        terrain: ['GRASS', 'FOREST'] \r\n    },\r\n    { \r\n        name: 'TURTLE', \r\n        hitToKill: 1, \r\n        foodReward: [3, 15], \r\n        popCost: 0, \r\n        color: '#4A7A4A', \r\n        speed: 0.1, \r\n        spawnRate: 0.15, \r\n        terrain: ['SAND'] \r\n    },\r\n    { \r\n        name: 'WOLF', \r\n        hitToKill: 2, \r\n        foodReward: 5, \r\n        popCost: 1, \r\n        color: '#666666', \r\n        speed: 1.5, \r\n        spawnRate: 0, // Wolves spawn separately\r\n        terrain: ['GRASS', 'FOREST'] \r\n    }\r\n];\r\n\r\n/** Default animal spawn configuration */\r\nexport const DEFAULT_ANIMAL_CONFIG = {\r\n    SPAWN_COUNT: 1064,          // Total animals on map\r\n    PACK_DAMAGE: 1,             // Pop lost when fighting herd\r\n    BEACH_SPAWN_COUNT: 150      // Extra turtles on beaches\r\n};\r\n\r\n/** Default nomad configuration */\r\nexport const DEFAULT_NOMAD_CONFIG = {\r\n    SPAWN_COUNT: 1500,          // Total nomads on map\r\n    FRIENDLY_CHANCE: 0.84,      // 84% friendly\r\n    HOSTILE_CHANCE: 0.16,       // 16% hostile\r\n    POP_GAIN: 1,                // Population gained from friendly\r\n    HOSTILE_DAMAGE: { min: 1, max: 3 }, // Pop lost to hostile\r\n    LOOT_FOOD: { min: 5, max: 25 },\r\n    LOOT_WOOD: { min: 0, max: 15 },\r\n    LOOT_STONE: { min: 0, max: 5 },\r\n    MAP_REVEAL_RADIUS: 15       // Tiles revealed on friendly encounter\r\n};\r\n\r\n/** Default berry configuration */\r\nexport const DEFAULT_BERRY_CONFIG = {\r\n    SPAWN_COUNT: 400,           // Berry bushes on map\r\n    FOOD_VALUE: 10,             // Food gained (90% chance)\r\n    POISON_CHANCE: 0.10,        // 10% chance of poison\r\n    POISON_DAMAGE: 1            // Pop lost if poisoned\r\n};\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// HELPER TYPES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Spawn position with validation */\r\nexport interface SpawnPosition {\r\n    x: number;\r\n    y: number;\r\n    valid: boolean;\r\n    terrain?: TerrainType;\r\n}\r\n\r\n/** Entity spawn options */\r\nexport interface SpawnOptions {\r\n    minDistanceFromPlayer?: number;\r\n    maxAttempts?: number;\r\n    allowOverlap?: boolean;\r\n    terrainFilter?: TerrainType[];\r\n}\r\n","/**\r\n * Civil Zones - Entity Spawning\r\n * Functions for spawning animals, nomads, and berries\r\n */\r\n\r\nimport type { \r\n    EntityAnimal, \r\n    AnimalTypeName, \r\n    AnimalTypeConfig, \r\n    Nomad, \r\n    BerryBush,\r\n    SpawnPosition,\r\n    SpawnOptions \r\n} from './types.js';\r\nimport type { TerrainType } from '../types/tiles.js';\r\nimport { DEFAULT_ANIMAL_TYPES, DEFAULT_ANIMAL_CONFIG } from './types.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// INTERFACES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\ninterface TileLike {\r\n    type: string;\r\n    explored?: boolean;\r\n    entity?: any;\r\n}\r\n\r\ninterface PlayerLike {\r\n    x: number;\r\n    y: number;\r\n}\r\n\r\ninterface ConfigLike {\r\n    W: number;\r\n    H: number;\r\n    ANIMALS?: {\r\n        SPAWN_COUNT: number;\r\n        TYPES: AnimalTypeConfig[];\r\n        BEACH_SPAWN_COUNT?: number;\r\n    };\r\n    NOMAD?: {\r\n        SPAWN_COUNT: number;\r\n    };\r\n    BERRIES?: {\r\n        SPAWN_COUNT: number;\r\n    };\r\n}\r\n\r\ninterface GameLike {\r\n    tiles: TileLike[][];\r\n    player: PlayerLike;\r\n    animals: EntityAnimal[];\r\n    nomads?: Nomad[];\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// SPAWN POSITION HELPERS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Get random spawn position */\r\nexport function getRandomPosition(\r\n    config: ConfigLike\r\n): { x: number; y: number } {\r\n    return {\r\n        x: Math.floor(Math.random() * config.W),\r\n        y: Math.floor(Math.random() * config.H)\r\n    };\r\n}\r\n\r\n/** Check if position is valid for spawning */\r\nexport function isValidSpawnPosition(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    x: number,\r\n    y: number,\r\n    options: SpawnOptions = {}\r\n): SpawnPosition {\r\n    const {\r\n        minDistanceFromPlayer = 10,\r\n        allowOverlap = false,\r\n        terrainFilter\r\n    } = options;\r\n    \r\n    // Bounds check\r\n    if (x < 0 || x >= config.W || y < 0 || y >= config.H) {\r\n        return { x, y, valid: false };\r\n    }\r\n    \r\n    const tile = game.tiles[x]?.[y];\r\n    if (!tile) {\r\n        return { x, y, valid: false };\r\n    }\r\n    \r\n    // Distance from player check\r\n    const dist = Math.abs(x - game.player.x) + Math.abs(y - game.player.y);\r\n    if (dist <= minDistanceFromPlayer) {\r\n        return { x, y, valid: false };\r\n    }\r\n    \r\n    // Terrain filter check\r\n    const terrain = tile.type as TerrainType;\r\n    if (terrainFilter && !terrainFilter.includes(terrain)) {\r\n        return { x, y, valid: false };\r\n    }\r\n    \r\n    // Overlap check for animals\r\n    if (!allowOverlap) {\r\n        const occupied = game.animals.some(a => a.x === x && a.y === y);\r\n        if (occupied) {\r\n            return { x, y, valid: false };\r\n        }\r\n    }\r\n    \r\n    return { x, y, valid: true, terrain };\r\n}\r\n\r\n/** Get valid terrain types for an animal type */\r\nexport function getValidTerrain(\r\n    animalType: AnimalTypeName,\r\n    animalTypes: AnimalTypeConfig[] = DEFAULT_ANIMAL_TYPES\r\n): TerrainType[] {\r\n    const config = animalTypes.find(a => a.name === animalType);\r\n    if (config?.terrain) {\r\n        return config.terrain;\r\n    }\r\n    // Default terrain for animals without explicit terrain\r\n    return ['GRASS', 'FOREST'];\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// ANIMAL SPAWNING\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Select random animal type based on spawn rates and terrain */\r\nexport function selectAnimalType(\r\n    validTypes: AnimalTypeConfig[]\r\n): AnimalTypeName {\r\n    if (validTypes.length === 0) {\r\n        return 'DEER'; // Fallback\r\n    }\r\n    \r\n    // Calculate total spawn rate\r\n    const totalRate = validTypes.reduce((sum, type) => sum + type.spawnRate, 0);\r\n    \r\n    // Random selection weighted by spawn rate\r\n    const rand = Math.random() * totalRate;\r\n    let cumulative = 0;\r\n    \r\n    for (const type of validTypes) {\r\n        cumulative += type.spawnRate;\r\n        if (rand < cumulative) {\r\n            return type.name;\r\n        }\r\n    }\r\n    \r\n    return validTypes[0].name;\r\n}\r\n\r\n/** Get valid animal types for a terrain */\r\nexport function getValidAnimalTypes(\r\n    terrain: string,\r\n    animalTypes: AnimalTypeConfig[] = DEFAULT_ANIMAL_TYPES\r\n): AnimalTypeConfig[] {\r\n    return animalTypes.filter(type => {\r\n        if (type.terrain) {\r\n            return type.terrain.includes(terrain as TerrainType);\r\n        }\r\n        // Default: spawn on GRASS or FOREST\r\n        return terrain === 'GRASS' || terrain === 'FOREST';\r\n    });\r\n}\r\n\r\n/** Spawn animals on the map */\r\nexport function spawnAnimals(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    count: number = DEFAULT_ANIMAL_CONFIG.SPAWN_COUNT\r\n): number {\r\n    const animalTypes = config.ANIMALS?.TYPES || DEFAULT_ANIMAL_TYPES;\r\n    let spawned = 0;\r\n    const maxAttempts = count * 20;\r\n    \r\n    for (let attempt = 0; attempt < maxAttempts && spawned < count; attempt++) {\r\n        const pos = getRandomPosition(config);\r\n        const tile = game.tiles[pos.x]?.[pos.y];\r\n        if (!tile) continue;\r\n        \r\n        const terrain = tile.type;\r\n        const dist = Math.abs(pos.x - game.player.x) + Math.abs(pos.y - game.player.y);\r\n        \r\n        // Check if tile is already occupied\r\n        const tileOccupied = game.animals.some(a => a.x === pos.x && a.y === pos.y);\r\n        \r\n        // Get valid animal types for this terrain\r\n        const validTypes = getValidAnimalTypes(terrain, animalTypes);\r\n        \r\n        if (validTypes.length > 0 && dist > 10 && !tileOccupied) {\r\n            const animalType = selectAnimalType(validTypes);\r\n            \r\n            game.animals.push({\r\n                x: pos.x,\r\n                y: pos.y,\r\n                hits: 0,\r\n                type: animalType\r\n            });\r\n            spawned++;\r\n        }\r\n    }\r\n    \r\n    return spawned;\r\n}\r\n\r\n/** Spawn beach turtles specifically on sand tiles */\r\nexport function spawnBeachTurtles(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    count: number = DEFAULT_ANIMAL_CONFIG.BEACH_SPAWN_COUNT\r\n): number {\r\n    let spawned = 0;\r\n    const maxAttempts = count * 30;\r\n    \r\n    for (let attempt = 0; attempt < maxAttempts && spawned < count; attempt++) {\r\n        const pos = getRandomPosition(config);\r\n        const tile = game.tiles[pos.x]?.[pos.y];\r\n        \r\n        // Only spawn on SAND tiles\r\n        if (!tile || tile.type !== 'SAND') continue;\r\n        \r\n        // Check if already occupied\r\n        const tileOccupied = game.animals.some(a => a.x === pos.x && a.y === pos.y);\r\n        if (tileOccupied) continue;\r\n        \r\n        // Distance check from player\r\n        const dist = Math.abs(pos.x - game.player.x) + Math.abs(pos.y - game.player.y);\r\n        if (dist <= 5) continue;\r\n        \r\n        game.animals.push({\r\n            x: pos.x,\r\n            y: pos.y,\r\n            hits: 0,\r\n            type: 'TURTLE'\r\n        });\r\n        spawned++;\r\n    }\r\n    \r\n    return spawned;\r\n}\r\n\r\n/** Initialize all animals on map */\r\nexport function initializeAnimals(\r\n    game: GameLike,\r\n    config: ConfigLike\r\n): { total: number; turtles: number } {\r\n    // Clear existing animals\r\n    game.animals = [];\r\n    \r\n    // Spawn main animals\r\n    const mainCount = config.ANIMALS?.SPAWN_COUNT || DEFAULT_ANIMAL_CONFIG.SPAWN_COUNT;\r\n    const spawned = spawnAnimals(game, config, mainCount);\r\n    \r\n    // Spawn beach turtles\r\n    const turtleCount = config.ANIMALS?.BEACH_SPAWN_COUNT || DEFAULT_ANIMAL_CONFIG.BEACH_SPAWN_COUNT;\r\n    const turtles = spawnBeachTurtles(game, config, turtleCount);\r\n    \r\n    return { total: spawned + turtles, turtles };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// NOMAD SPAWNING\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Spawn nomads on the map */\r\nexport function spawnNomads(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    count: number\r\n): number {\r\n    if (!game.nomads) game.nomads = [];\r\n    \r\n    let spawned = 0;\r\n    const maxAttempts = count * 20;\r\n    \r\n    for (let attempt = 0; attempt < maxAttempts && spawned < count; attempt++) {\r\n        const pos = getRandomPosition(config);\r\n        const tile = game.tiles[pos.x]?.[pos.y];\r\n        \r\n        if (!tile) continue;\r\n        \r\n        // Only spawn on walkable terrain\r\n        if (tile.type === 'WATER' || tile.type === 'DEEP' || \r\n            tile.type === 'RIVER' || tile.type === 'STONE') {\r\n            continue;\r\n        }\r\n        \r\n        // Distance from player\r\n        const dist = Math.abs(pos.x - game.player.x) + Math.abs(pos.y - game.player.y);\r\n        if (dist <= 10) continue;\r\n        \r\n        // Check overlap with other nomads\r\n        const occupied = game.nomads.some(n => n.x === pos.x && n.y === pos.y);\r\n        if (occupied) continue;\r\n        \r\n        game.nomads.push({\r\n            x: pos.x,\r\n            y: pos.y,\r\n            encountered: false\r\n        });\r\n        spawned++;\r\n    }\r\n    \r\n    return spawned;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// BERRY SPAWNING\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Spawn berry bushes on the map (stored in tiles) */\r\nexport function spawnBerries(\r\n    game: GameLike,\r\n    config: ConfigLike,\r\n    count: number\r\n): number {\r\n    let spawned = 0;\r\n    const maxAttempts = count * 20;\r\n    \r\n    for (let attempt = 0; attempt < maxAttempts && spawned < count; attempt++) {\r\n        const pos = getRandomPosition(config);\r\n        const tile = game.tiles[pos.x]?.[pos.y];\r\n        \r\n        if (!tile) continue;\r\n        \r\n        // Only spawn on grass or forest\r\n        if (tile.type !== 'GRASS' && tile.type !== 'FOREST') continue;\r\n        \r\n        // Don't overwrite existing entities\r\n        if (tile.entity) continue;\r\n        \r\n        // Distance from player\r\n        const dist = Math.abs(pos.x - game.player.x) + Math.abs(pos.y - game.player.y);\r\n        if (dist <= 5) continue;\r\n        \r\n        tile.entity = { type: 'BERRY', depleted: false };\r\n        spawned++;\r\n    }\r\n    \r\n    return spawned;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// UTILITY FUNCTIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Get animal at position */\r\nexport function getAnimalAt(\r\n    animals: EntityAnimal[],\r\n    x: number,\r\n    y: number\r\n): { animal: EntityAnimal; index: number } | null {\r\n    const index = animals.findIndex(a => a.x === x && a.y === y);\r\n    if (index === -1) return null;\r\n    return { animal: animals[index], index };\r\n}\r\n\r\n/** Get animals adjacent to position (for herd detection) */\r\nexport function getAdjacentAnimals(\r\n    animals: EntityAnimal[],\r\n    x: number,\r\n    y: number,\r\n    excludeIndex?: number\r\n): EntityAnimal[] {\r\n    return animals.filter((a, idx) => {\r\n        if (excludeIndex !== undefined && idx === excludeIndex) return false;\r\n        const dx = Math.abs(a.x - x);\r\n        const dy = Math.abs(a.y - y);\r\n        return dx <= 1 && dy <= 1;\r\n    });\r\n}\r\n\r\n/** Check if position has a herd (multiple animals nearby) */\r\nexport function isHerdLocation(\r\n    animals: EntityAnimal[],\r\n    x: number,\r\n    y: number,\r\n    targetIndex?: number\r\n): boolean {\r\n    const adjacent = getAdjacentAnimals(animals, x, y, targetIndex);\r\n    return adjacent.length > 0;\r\n}\r\n\r\n/** Count animals by type */\r\nexport function countAnimalsByType(\r\n    animals: EntityAnimal[]\r\n): Record<AnimalTypeName, number> {\r\n    const counts: Partial<Record<AnimalTypeName, number>> = {};\r\n    \r\n    for (const animal of animals) {\r\n        counts[animal.type] = (counts[animal.type] || 0) + 1;\r\n    }\r\n    \r\n    return counts as Record<AnimalTypeName, number>;\r\n}\r\n","/**\r\n * Civil Zones - Animal Combat\r\n * Functions for attacking and defeating animals\r\n */\r\n\r\nimport type { \r\n    EntityAnimal, \r\n    AnimalTypeName, \r\n    AnimalTypeConfig, \r\n    AnimalCombatResult \r\n} from './types.js';\r\nimport { DEFAULT_ANIMAL_TYPES, DEFAULT_ANIMAL_CONFIG } from './types.js';\r\nimport { getAdjacentAnimals, isHerdLocation } from './spawning.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// INTERFACES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\ninterface InventoryLike {\r\n    food: number;\r\n    wood: number;\r\n    stone: number;\r\n    metal: number;\r\n    capacity: number;\r\n}\r\n\r\ninterface GameLike {\r\n    animals: EntityAnimal[];\r\n    pop: number;\r\n    food: number;\r\n    inventory: InventoryLike;\r\n    totalFoodCollected: number;\r\n    gameState: string;\r\n    loreSeen?: Record<string, boolean>;\r\n}\r\n\r\ninterface ConfigLike {\r\n    ANIMALS?: {\r\n        TYPES: AnimalTypeConfig[];\r\n        PACK_DAMAGE?: number;\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// ANIMAL CONFIG HELPERS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Get animal type configuration */\r\nexport function getAnimalConfig(\r\n    animalType: AnimalTypeName,\r\n    config?: ConfigLike\r\n): AnimalTypeConfig | undefined {\r\n    const types = config?.ANIMALS?.TYPES || DEFAULT_ANIMAL_TYPES;\r\n    return types.find(a => a.name === animalType);\r\n}\r\n\r\n/** Format animal name for display */\r\nexport function formatAnimalName(type: AnimalTypeName): string {\r\n    return type.charAt(0) + type.slice(1).toLowerCase();\r\n}\r\n\r\n/** Calculate food reward for an animal */\r\nexport function calculateFoodReward(\r\n    animalConfig: AnimalTypeConfig\r\n): number {\r\n    const reward = animalConfig.foodReward;\r\n    \r\n    if (Array.isArray(reward)) {\r\n        // Random range [min, max]\r\n        const [min, max] = reward;\r\n        return min + Math.floor(Math.random() * (max - min + 1));\r\n    }\r\n    \r\n    // Fixed value\r\n    return reward;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// COMBAT FUNCTIONS\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Hit an animal (increment damage) */\r\nexport function hitAnimal(\r\n    animal: EntityAnimal\r\n): { hits: number; defeated: boolean; hitsToKill: number } {\r\n    animal.hits++;\r\n    \r\n    const config = DEFAULT_ANIMAL_TYPES.find(a => a.name === animal.type);\r\n    const hitsToKill = config?.hitToKill || 2;\r\n    \r\n    return {\r\n        hits: animal.hits,\r\n        defeated: animal.hits >= hitsToKill,\r\n        hitsToKill\r\n    };\r\n}\r\n\r\n/** Calculate herd damage when fighting near other animals */\r\nexport function calculateHerdDamage(\r\n    game: GameLike,\r\n    animalIndex: number,\r\n    config?: ConfigLike\r\n): number {\r\n    const animal = game.animals[animalIndex];\r\n    if (!animal) return 0;\r\n    \r\n    // Only apply herd damage in WANDER mode\r\n    if (game.gameState !== 'WANDER') return 0;\r\n    \r\n    // Check for nearby animals\r\n    const nearbyAnimals = getAdjacentAnimals(\r\n        game.animals, \r\n        animal.x, \r\n        animal.y, \r\n        animalIndex\r\n    );\r\n    \r\n    if (nearbyAnimals.length === 0) return 0;\r\n    \r\n    // Random herd damage 1-3\r\n    const packDamage = config?.ANIMALS?.PACK_DAMAGE || DEFAULT_ANIMAL_CONFIG.PACK_DAMAGE;\r\n    return packDamage + Math.floor(Math.random() * 3);\r\n}\r\n\r\n/** Attack an animal and process combat */\r\nexport function attackAnimal(\r\n    game: GameLike,\r\n    animalIndex: number,\r\n    config?: ConfigLike\r\n): AnimalCombatResult {\r\n    const animal = game.animals[animalIndex];\r\n    if (!animal) {\r\n        return {\r\n            defeated: false,\r\n            foodGained: 0,\r\n            popLost: 0,\r\n            herdDamage: 0,\r\n            message: 'âŒ No animal found',\r\n            isHerd: false\r\n        };\r\n    }\r\n    \r\n    const animalConfig = getAnimalConfig(animal.type, config);\r\n    if (!animalConfig) {\r\n        return {\r\n            defeated: false,\r\n            foodGained: 0,\r\n            popLost: 0,\r\n            herdDamage: 0,\r\n            message: 'âŒ Unknown animal type',\r\n            isHerd: false\r\n        };\r\n    }\r\n    \r\n    const animalName = formatAnimalName(animal.type);\r\n    \r\n    // Hit the animal\r\n    const hitResult = hitAnimal(animal);\r\n    \r\n    // Not defeated yet - just hit\r\n    if (!hitResult.defeated) {\r\n        return {\r\n            defeated: false,\r\n            foodGained: 0,\r\n            popLost: 0,\r\n            herdDamage: 0,\r\n            message: `ğŸ’¥ Hit ${animalName.toLowerCase()}! (${hitResult.hits}/${hitResult.hitsToKill})`,\r\n            isHerd: false\r\n        };\r\n    }\r\n    \r\n    // Animal defeated!\r\n    const isHerd = isHerdLocation(game.animals, animal.x, animal.y, animalIndex);\r\n    let herdDamage = 0;\r\n    let popCost = animalConfig.popCost || 0;\r\n    let foodReward = calculateFoodReward(animalConfig);\r\n    let foodGained = 0;\r\n    let gameOver = false;\r\n    \r\n    // Calculate herd damage\r\n    if (isHerd && game.gameState === 'WANDER') {\r\n        herdDamage = 1 + Math.floor(Math.random() * 3);\r\n        game.pop = Math.max(0, game.pop - herdDamage);\r\n        \r\n        if (game.pop === 0) {\r\n            game.animals.splice(animalIndex, 1);\r\n            return {\r\n                defeated: true,\r\n                foodGained: 0,\r\n                popLost: herdDamage,\r\n                herdDamage,\r\n                message: 'ğŸ’€ Your tribe has perished attacking a herd!',\r\n                isHerd: true,\r\n                gameOver: true\r\n            };\r\n        }\r\n    }\r\n    \r\n    // Apply base population cost (wolves cost pop)\r\n    if (popCost > 0 && game.pop > 0) {\r\n        game.pop = Math.max(0, game.pop - popCost);\r\n        \r\n        if (game.pop === 0) {\r\n            gameOver = true;\r\n        }\r\n    }\r\n    \r\n    // Calculate total pop lost\r\n    const totalPopLost = popCost + herdDamage;\r\n    \r\n    // Award food\r\n    if (game.gameState === 'WANDER') {\r\n        // Check inventory capacity\r\n        const totalInventory = game.inventory.food + game.inventory.wood + \r\n                               game.inventory.metal + game.inventory.stone;\r\n        const spaceAvailable = game.inventory.capacity - totalInventory;\r\n        \r\n        if (spaceAvailable >= foodReward) {\r\n            game.inventory.food += foodReward;\r\n            foodGained = foodReward;\r\n        } else if (spaceAvailable > 0) {\r\n            game.inventory.food += spaceAvailable;\r\n            foodGained = spaceAvailable;\r\n        }\r\n    } else {\r\n        // City mode - add to main food storage\r\n        game.food += foodReward;\r\n        foodGained = foodReward;\r\n    }\r\n    \r\n    game.totalFoodCollected += foodGained;\r\n    \r\n    // Remove the animal\r\n    game.animals.splice(animalIndex, 1);\r\n    \r\n    // Build message\r\n    let message = `ğŸ¯ ${animalName} defeated!`;\r\n    if (totalPopLost > 0) {\r\n        message += ` (-${totalPopLost} Pop)`;\r\n    }\r\n    if (foodGained > 0) {\r\n        message += ` +${foodGained} Food`;\r\n    } else if (foodGained < foodReward) {\r\n        message += ` Food lost - Inventory Full!`;\r\n    }\r\n    if (!isHerd) {\r\n        message += ' (Safe hunt!)';\r\n    }\r\n    message += ' ğŸ–';\r\n    \r\n    return {\r\n        defeated: true,\r\n        foodGained,\r\n        popLost: totalPopLost,\r\n        herdDamage,\r\n        message,\r\n        isHerd,\r\n        gameOver\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// LORE TRACKING\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Check and trigger first kill lore */\r\nexport function checkFirstKillLore(\r\n    game: GameLike,\r\n    animalType: AnimalTypeName\r\n): { trigger: string | null } {\r\n    if (!game.loreSeen) game.loreSeen = {};\r\n    \r\n    // First kill ever\r\n    if (!game.loreSeen.FIRST_KILL) {\r\n        game.loreSeen.FIRST_KILL = true;\r\n        return { trigger: 'FIRST_KILL' };\r\n    }\r\n    \r\n    // First turtle kill\r\n    if (animalType === 'TURTLE' && !game.loreSeen.FIRST_TURTLE) {\r\n        game.loreSeen.FIRST_TURTLE = true;\r\n        return { trigger: 'FIRST_TURTLE' };\r\n    }\r\n    \r\n    return { trigger: null };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// COMBAT UTILITIES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Check if player can attack (has population) */\r\nexport function canAttack(game: GameLike): boolean {\r\n    return game.pop > 0;\r\n}\r\n\r\n/** Get danger level of attacking at a position */\r\nexport function getAttackDangerLevel(\r\n    animals: EntityAnimal[],\r\n    x: number,\r\n    y: number\r\n): 'safe' | 'herd' | 'dangerous' {\r\n    const adjacent = getAdjacentAnimals(animals, x, y);\r\n    \r\n    if (adjacent.length === 0) return 'safe';\r\n    if (adjacent.length <= 2) return 'herd';\r\n    return 'dangerous';\r\n}\r\n\r\n/** Preview combat outcome (for AI/UI) */\r\nexport function previewCombat(\r\n    game: GameLike,\r\n    animalIndex: number,\r\n    config?: ConfigLike\r\n): {\r\n    animal: EntityAnimal;\r\n    hitsRemaining: number;\r\n    potentialHerdDamage: [number, number];\r\n    potentialFood: [number, number];\r\n    isHerd: boolean;\r\n} | null {\r\n    const animal = game.animals[animalIndex];\r\n    if (!animal) return null;\r\n    \r\n    const animalConfig = getAnimalConfig(animal.type, config);\r\n    if (!animalConfig) return null;\r\n    \r\n    const isHerd = isHerdLocation(game.animals, animal.x, animal.y, animalIndex);\r\n    const hitsRemaining = animalConfig.hitToKill - animal.hits;\r\n    \r\n    // Food range\r\n    const foodReward = animalConfig.foodReward;\r\n    const potentialFood: [number, number] = Array.isArray(foodReward) \r\n        ? foodReward \r\n        : [foodReward, foodReward];\r\n    \r\n    // Herd damage range (1-3 if herd)\r\n    const potentialHerdDamage: [number, number] = isHerd ? [1, 3] : [0, 0];\r\n    \r\n    return {\r\n        animal,\r\n        hitsRemaining,\r\n        potentialHerdDamage,\r\n        potentialFood,\r\n        isHerd\r\n    };\r\n}\r\n","/**\r\n * Civil Zones - Nomad Interactions\r\n * Functions for nomad encounters and rewards\r\n */\r\n\r\nimport type { \r\n    Nomad, \r\n    NomadEncounterType, \r\n    NomadEncounterResult,\r\n    LootRange \r\n} from './types.js';\r\nimport { DEFAULT_NOMAD_CONFIG } from './types.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// INTERFACES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\ninterface InventoryLike {\r\n    food: number;\r\n    wood: number;\r\n    stone: number;\r\n    metal: number;\r\n    capacity: number;\r\n}\r\n\r\ninterface GameLike {\r\n    pop: number;\r\n    inventory: InventoryLike;\r\n    totalFoodCollected: number;\r\n    nomadsFound: number;\r\n    loreSeen?: Record<string, boolean>;\r\n}\r\n\r\ninterface ConfigLike {\r\n    NOMAD?: {\r\n        FRIENDLY_CHANCE?: number;\r\n        HOSTILE_CHANCE?: number;\r\n        POP_GAIN?: number;\r\n        HOSTILE_DAMAGE?: LootRange;\r\n        LOOT_FOOD?: LootRange;\r\n        LOOT_WOOD?: LootRange;\r\n        LOOT_STONE?: LootRange;\r\n        MAP_REVEAL_RADIUS?: number;\r\n        CAPACITY_GAIN?: number;\r\n    };\r\n}\r\n\r\ninterface TileEntityNomad {\r\n    type: 'NOMAD';\r\n    is_hostile: boolean;\r\n    damage: number;\r\n    pop: number;\r\n    loot: {\r\n        food: number;\r\n        wood: number;\r\n        metal: number;\r\n        stone?: number;\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// NOMAD GENERATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Generate random value in range */\r\nfunction randomInRange(range: LootRange): number {\r\n    return range.min + Math.floor(Math.random() * (range.max - range.min + 1));\r\n}\r\n\r\n/** Determine if nomad is hostile */\r\nexport function isNomadHostile(config?: ConfigLike): boolean {\r\n    const hostileChance = config?.NOMAD?.HOSTILE_CHANCE || DEFAULT_NOMAD_CONFIG.HOSTILE_CHANCE;\r\n    return Math.random() < hostileChance;\r\n}\r\n\r\n/** Generate nomad encounter data */\r\nexport function generateNomadEncounter(\r\n    config?: ConfigLike\r\n): TileEntityNomad {\r\n    const cfg = config?.NOMAD || DEFAULT_NOMAD_CONFIG;\r\n    const isHostile = isNomadHostile(config);\r\n    \r\n    if (isHostile) {\r\n        const damage = randomInRange(cfg.HOSTILE_DAMAGE || DEFAULT_NOMAD_CONFIG.HOSTILE_DAMAGE);\r\n        return {\r\n            type: 'NOMAD',\r\n            is_hostile: true,\r\n            damage,\r\n            pop: 0,\r\n            loot: { food: 0, wood: 0, metal: 0, stone: 0 }\r\n        };\r\n    }\r\n    \r\n    // Friendly nomad with loot\r\n    const foodRange = cfg.LOOT_FOOD || DEFAULT_NOMAD_CONFIG.LOOT_FOOD;\r\n    const woodRange = cfg.LOOT_WOOD || DEFAULT_NOMAD_CONFIG.LOOT_WOOD;\r\n    const stoneRange = cfg.LOOT_STONE || DEFAULT_NOMAD_CONFIG.LOOT_STONE;\r\n    \r\n    return {\r\n        type: 'NOMAD',\r\n        is_hostile: false,\r\n        damage: 0,\r\n        pop: cfg.POP_GAIN || DEFAULT_NOMAD_CONFIG.POP_GAIN,\r\n        loot: {\r\n            food: randomInRange(foodRange),\r\n            wood: randomInRange(woodRange),\r\n            metal: Math.floor(Math.random() * 10), // 0-9 metal\r\n            stone: randomInRange(stoneRange)\r\n        }\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// NOMAD ENCOUNTER PROCESSING\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Process hostile nomad encounter */\r\nexport function processHostileEncounter(\r\n    game: GameLike,\r\n    damage: number\r\n): NomadEncounterResult {\r\n    game.pop = Math.max(0, game.pop - damage);\r\n    \r\n    return {\r\n        type: 'HOSTILE',\r\n        popGained: 0,\r\n        popLost: damage,\r\n        loot: { food: 0, wood: 0, stone: 0 },\r\n        mapReveal: false,\r\n        message: `âš”ï¸ HOSTILE NOMAD! Ambush! -${damage} Population`\r\n    };\r\n}\r\n\r\n/** Process friendly nomad encounter */\r\nexport function processFriendlyEncounter(\r\n    game: GameLike,\r\n    entity: TileEntityNomad,\r\n    config?: ConfigLike\r\n): NomadEncounterResult {\r\n    // Increment counters\r\n    game.nomadsFound++;\r\n    game.pop += entity.pop;\r\n    \r\n    // Calculate total loot\r\n    const totalLoot = entity.loot.food + entity.loot.wood + \r\n                      entity.loot.metal + (entity.loot.stone || 0);\r\n    const currentInventory = game.inventory.food + game.inventory.wood + \r\n                             game.inventory.metal + game.inventory.stone;\r\n    const spaceAvailable = game.inventory.capacity - currentInventory;\r\n    \r\n    // Transfer what fits (priority: food > wood > metal > stone)\r\n    let foodAdded = 0, woodAdded = 0, metalAdded = 0, stoneAdded = 0;\r\n    \r\n    if (spaceAvailable >= totalLoot) {\r\n        // All loot fits\r\n        game.inventory.food += entity.loot.food;\r\n        game.totalFoodCollected += entity.loot.food;\r\n        game.inventory.wood += entity.loot.wood;\r\n        game.inventory.metal += entity.loot.metal;\r\n        game.inventory.stone += entity.loot.stone || 0;\r\n        foodAdded = entity.loot.food;\r\n        woodAdded = entity.loot.wood;\r\n        metalAdded = entity.loot.metal;\r\n        stoneAdded = entity.loot.stone || 0;\r\n    } else if (spaceAvailable > 0) {\r\n        // Partial loot - prioritize food > wood > metal > stone\r\n        let remaining = spaceAvailable;\r\n        \r\n        foodAdded = Math.min(entity.loot.food, remaining);\r\n        game.inventory.food += foodAdded;\r\n        game.totalFoodCollected += foodAdded;\r\n        remaining -= foodAdded;\r\n        \r\n        if (remaining > 0) {\r\n            woodAdded = Math.min(entity.loot.wood, remaining);\r\n            game.inventory.wood += woodAdded;\r\n            remaining -= woodAdded;\r\n        }\r\n        if (remaining > 0) {\r\n            metalAdded = Math.min(entity.loot.metal, remaining);\r\n            game.inventory.metal += metalAdded;\r\n            remaining -= metalAdded;\r\n        }\r\n        if (remaining > 0) {\r\n            stoneAdded = Math.min(entity.loot.stone || 0, remaining);\r\n            game.inventory.stone += stoneAdded;\r\n        }\r\n    }\r\n    \r\n    // Increase capacity (+100 per nomad)\r\n    const capacityGain = config?.NOMAD?.CAPACITY_GAIN || 100;\r\n    game.inventory.capacity += capacityGain;\r\n    \r\n    const lootMsg = spaceAvailable >= totalLoot \r\n        ? `+${foodAdded}F +${woodAdded}W +${metalAdded}M +${stoneAdded}S` \r\n        : `+${foodAdded}F +${woodAdded}W +${metalAdded}M +${stoneAdded}S (Inventory was full!)`;\r\n    \r\n    return {\r\n        type: 'FRIENDLY',\r\n        popGained: entity.pop,\r\n        popLost: 0,\r\n        loot: { food: foodAdded, wood: woodAdded, stone: stoneAdded },\r\n        mapReveal: true,\r\n        message: `ğŸ‘¤ OOGA BOOGA! Nomad joined! +${entity.pop} Pop, ${lootMsg}, Capacity: ${game.inventory.capacity}`\r\n    };\r\n}\r\n\r\n/** Process nomad encounter (main function) */\r\nexport function encounterNomad(\r\n    game: GameLike,\r\n    entity: TileEntityNomad,\r\n    config?: ConfigLike\r\n): NomadEncounterResult {\r\n    if (entity.is_hostile) {\r\n        return processHostileEncounter(game, entity.damage);\r\n    }\r\n    return processFriendlyEncounter(game, entity, config);\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// LORE TRACKING\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Check and trigger first nomad lore */\r\nexport function checkFirstNomadLore(\r\n    game: GameLike\r\n): { trigger: string | null } {\r\n    if (!game.loreSeen) game.loreSeen = {};\r\n    \r\n    if (!game.loreSeen.FIRST_NOMAD) {\r\n        game.loreSeen.FIRST_NOMAD = true;\r\n        return { trigger: 'FIRST_NOMAD' };\r\n    }\r\n    \r\n    return { trigger: null };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// NOMAD UTILITIES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Get encounter type description */\r\nexport function getEncounterTypeDescription(type: NomadEncounterType): string {\r\n    switch (type) {\r\n        case 'FRIENDLY': return 'A friendly wanderer approaches';\r\n        case 'HOSTILE': return 'An aggressive stranger appears!';\r\n        case 'NEUTRAL': return 'A mysterious figure watches';\r\n        default: return 'An unknown presence';\r\n    }\r\n}\r\n\r\n/** Preview nomad encounter (for UI) */\r\nexport function previewNomadEncounter(\r\n    isHostile: boolean,\r\n    config?: ConfigLike\r\n): {\r\n    type: NomadEncounterType;\r\n    potentialPopChange: [number, number];\r\n    potentialLoot: boolean;\r\n    danger: 'safe' | 'risky';\r\n} {\r\n    const cfg = config?.NOMAD || DEFAULT_NOMAD_CONFIG;\r\n    \r\n    if (isHostile) {\r\n        const dmgRange = cfg.HOSTILE_DAMAGE || DEFAULT_NOMAD_CONFIG.HOSTILE_DAMAGE;\r\n        return {\r\n            type: 'HOSTILE',\r\n            potentialPopChange: [-dmgRange.max, -dmgRange.min],\r\n            potentialLoot: false,\r\n            danger: 'risky'\r\n        };\r\n    }\r\n    \r\n    const popGain = cfg.POP_GAIN || DEFAULT_NOMAD_CONFIG.POP_GAIN;\r\n    return {\r\n        type: 'FRIENDLY',\r\n        potentialPopChange: [popGain, popGain],\r\n        potentialLoot: true,\r\n        danger: 'safe'\r\n    };\r\n}\r\n\r\n/** Calculate nomad encounter odds for display */\r\nexport function getNomadOdds(config?: ConfigLike): {\r\n    friendlyPercent: number;\r\n    hostilePercent: number;\r\n} {\r\n    const friendly = config?.NOMAD?.FRIENDLY_CHANCE || DEFAULT_NOMAD_CONFIG.FRIENDLY_CHANCE;\r\n    const hostile = config?.NOMAD?.HOSTILE_CHANCE || DEFAULT_NOMAD_CONFIG.HOSTILE_CHANCE;\r\n    \r\n    return {\r\n        friendlyPercent: Math.round(friendly * 100),\r\n        hostilePercent: Math.round(hostile * 100)\r\n    };\r\n}\r\n","/**\r\n * Civil Zones - Berry Gathering\r\n * Functions for berry bush interactions\r\n */\r\n\r\nimport type { BerryGatherResult } from './types.js';\r\nimport { DEFAULT_BERRY_CONFIG } from './types.js';\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// INTERFACES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\ninterface InventoryLike {\r\n    food: number;\r\n    wood: number;\r\n    stone: number;\r\n    metal: number;\r\n    capacity: number;\r\n}\r\n\r\ninterface GameLike {\r\n    pop: number;\r\n    inventory: InventoryLike;\r\n    totalFoodCollected: number;\r\n    loreSeen?: Record<string, boolean>;\r\n}\r\n\r\ninterface ConfigLike {\r\n    BERRIES?: {\r\n        FOOD_VALUE?: number;\r\n        POISON_CHANCE?: number;\r\n        POISON_DAMAGE?: number;\r\n    };\r\n}\r\n\r\ninterface TileEntityBerry {\r\n    type: 'BERRY';\r\n    amount: number;\r\n    is_poisonous: boolean;\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// BERRY GENERATION\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Determine if berry is poisonous */\r\nexport function isBerryPoisonous(config?: ConfigLike): boolean {\r\n    const poisonChance = config?.BERRIES?.POISON_CHANCE || DEFAULT_BERRY_CONFIG.POISON_CHANCE;\r\n    return Math.random() < poisonChance;\r\n}\r\n\r\n/** Generate berry entity data */\r\nexport function generateBerryEntity(\r\n    config?: ConfigLike\r\n): TileEntityBerry {\r\n    const cfg = config?.BERRIES || DEFAULT_BERRY_CONFIG;\r\n    const isPoisonous = isBerryPoisonous(config);\r\n    \r\n    return {\r\n        type: 'BERRY',\r\n        amount: cfg.FOOD_VALUE || DEFAULT_BERRY_CONFIG.FOOD_VALUE,\r\n        is_poisonous: isPoisonous\r\n    };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// BERRY GATHERING\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Process poisonous berry encounter */\r\nexport function processPoisonBerry(\r\n    game: GameLike,\r\n    config?: ConfigLike\r\n): BerryGatherResult {\r\n    const damage = config?.BERRIES?.POISON_DAMAGE || DEFAULT_BERRY_CONFIG.POISON_DAMAGE;\r\n    game.pop = Math.max(0, game.pop - damage);\r\n    \r\n    return {\r\n        success: false,\r\n        poisoned: true,\r\n        foodGained: 0,\r\n        popLost: damage,\r\n        message: `â˜ ï¸ POISON BERRY! -${damage} Population - YUCK!`\r\n    };\r\n}\r\n\r\n/** Process safe berry gathering */\r\nexport function processSafeBerry(\r\n    game: GameLike,\r\n    amount: number\r\n): BerryGatherResult {\r\n    const totalInventory = game.inventory.food + game.inventory.wood + \r\n                           game.inventory.metal + game.inventory.stone;\r\n    const spaceAvailable = game.inventory.capacity - totalInventory;\r\n    \r\n    // Check if inventory is completely full\r\n    if (spaceAvailable <= 0) {\r\n        return {\r\n            success: false,\r\n            poisoned: false,\r\n            foodGained: 0,\r\n            popLost: 0,\r\n            message: `âš ï¸ Inventory full! (${Math.floor(totalInventory)}/${game.inventory.capacity}) - Cannot collect berry`\r\n        };\r\n    }\r\n    \r\n    // Collect as much as possible\r\n    const foodToCollect = Math.min(amount, spaceAvailable);\r\n    game.inventory.food += foodToCollect;\r\n    game.totalFoodCollected += foodToCollect;\r\n    \r\n    const message = foodToCollect === amount\r\n        ? `ğŸ« Found Berry! +${amount} food (${Math.floor(game.inventory.food)}/${game.inventory.capacity}) - YUM!`\r\n        : `ğŸ« Found Berry! +${foodToCollect}/${amount} food (Inventory Full!) - YUM!`;\r\n    \r\n    return {\r\n        success: true,\r\n        poisoned: false,\r\n        foodGained: foodToCollect,\r\n        popLost: 0,\r\n        message\r\n    };\r\n}\r\n\r\n/** Gather from a berry bush (main function) */\r\nexport function gatherBerry(\r\n    game: GameLike,\r\n    entity: TileEntityBerry,\r\n    config?: ConfigLike\r\n): BerryGatherResult {\r\n    if (entity.is_poisonous) {\r\n        return processPoisonBerry(game, config);\r\n    }\r\n    return processSafeBerry(game, entity.amount);\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// LORE TRACKING\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Check and trigger first berry lore */\r\nexport function checkFirstBerryLore(\r\n    game: GameLike\r\n): { trigger: string | null } {\r\n    if (!game.loreSeen) game.loreSeen = {};\r\n    \r\n    if (!game.loreSeen.FIRST_BERRY) {\r\n        game.loreSeen.FIRST_BERRY = true;\r\n        return { trigger: 'FIRST_BERRY' };\r\n    }\r\n    \r\n    return { trigger: null };\r\n}\r\n\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n// BERRY UTILITIES\r\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\r\n\r\n/** Check if inventory has space for berries */\r\nexport function canGatherBerry(game: GameLike): boolean {\r\n    const totalInventory = game.inventory.food + game.inventory.wood + \r\n                           game.inventory.metal + game.inventory.stone;\r\n    return game.inventory.capacity > totalInventory;\r\n}\r\n\r\n/** Get berry gathering preview (for UI) */\r\nexport function previewBerryGather(\r\n    entity: TileEntityBerry,\r\n    game: GameLike,\r\n    config?: ConfigLike\r\n): {\r\n    potentialFood: number;\r\n    poisonRisk: number;\r\n    spaceAvailable: number;\r\n    willFit: boolean;\r\n} {\r\n    const totalInventory = game.inventory.food + game.inventory.wood + \r\n                           game.inventory.metal + game.inventory.stone;\r\n    const spaceAvailable = game.inventory.capacity - totalInventory;\r\n    const poisonChance = config?.BERRIES?.POISON_CHANCE || DEFAULT_BERRY_CONFIG.POISON_CHANCE;\r\n    \r\n    return {\r\n        potentialFood: entity.amount,\r\n        poisonRisk: Math.round(poisonChance * 100),\r\n        spaceAvailable,\r\n        willFit: spaceAvailable >= entity.amount\r\n    };\r\n}\r\n\r\n/** Get berry odds for display */\r\nexport function getBerryOdds(config?: ConfigLike): {\r\n    safePercent: number;\r\n    poisonPercent: number;\r\n    foodValue: number;\r\n    poisonDamage: number;\r\n} {\r\n    const cfg = config?.BERRIES || DEFAULT_BERRY_CONFIG;\r\n    const poisonChance = cfg.POISON_CHANCE || DEFAULT_BERRY_CONFIG.POISON_CHANCE;\r\n    \r\n    return {\r\n        safePercent: Math.round((1 - poisonChance) * 100),\r\n        poisonPercent: Math.round(poisonChance * 100),\r\n        foodValue: cfg.FOOD_VALUE || DEFAULT_BERRY_CONFIG.FOOD_VALUE,\r\n        poisonDamage: cfg.POISON_DAMAGE || DEFAULT_BERRY_CONFIG.POISON_DAMAGE\r\n    };\r\n}\r\n"],"names":["assignPopulationToResidential","game","buildingLevels","residentials","x","y","tile","buildingLevel","levelConfig","capacity","overflowCapacity","totalPop","res","a","b","assign","currentPop","extraSpace","assignPopulationToZones","availablePop","commercialLevels","industrialLevels","commercials","industrials","bld","com","ind","calculateWorkforce","population","wellCount","roadTileCount","commercialCapacity","industrialCapacity","wellsNeeded","roadsNeeded","total","wellWorkers","remaining","roadWorkers","comWorkers","indWorkers","gatherers","totalNeeded","shortage","calculateBuildingVariant","stateThresholds","i","threshold","ratio","calculateActivityVariant","activityRatio","JOBS_PER_COMMERCIAL","JOBS_PER_INDUSTRIAL","IDEAL_COMMERCIAL_RATIO","IDEAL_INDUSTRIAL_RATIO","calculateRCIDemand","zones","popData","resCount","comCount","indCount","pop","housingCap","totalZones","jobCapacity","unemployed","housingNeed","rDemand","calculateResidentialDemand","cDemand","calculateCommercialDemand","iDemand","calculateIndustrialDemand","clamp","customersPerCom","goodsSupply","actualRatio","DEMAND_COLORS","getDemandBarHeight","demand","maxHeight","getDemandDescription","type","level","value","min","max","DEFAULT_GEOLOGICAL_PERIODS","DEFAULT_ELEVATION_CONFIG","createGeologyState","config","initialPeriod","shouldUpdateGeology","currentYear","lastUpdateYear","updateInterval","advanceGeologicalPeriod","state","periods","currentPeriod","newPeriod","calculateSeaLevelChange","currentLevel","targetLevel","isFloodRisk","tileElevation","seaLevel","warningMargin","shouldFlood","shouldDrain","tileType","getTileElevationInfo","elevation","status","description","getElevationCostMultiplier","costThreshold","costIncreasePerLevel","elev","getPeriodTransitionMessage","oldSeaLevel","newLevel","getFloodWarningMessage","populationLost","periodName","getElevationColor","info","DEFAULT_WORKFORCE_CONFIG","createWorkforceState","infrastructure","calculateWorkforceEfficiency","wellEfficiency","roadEfficiency","comEfficiency","indEfficiency","totalAssigned","overall","calculateGathererProduction","gathererCount","gatheringMultiplier","biomeModifier","multiplier","getWorkforceStatusText","getEfficiencyColor","efficiency","formatWorkforceBreakdown","lines","DEFAULT_RESOURCE_RATES","NEED_WEIGHTS","createNeedsState","calculateHousingNeed","housingCapacity","need","have","satisfied","calculateWaterNeed","waterAvailable","rates","calculateFoodNeed","foodAvailable","calculateJobNeed","calculatePathNeed","buildingCount","idealRoadsPerBuilding","calculateOverallSatisfaction","weighted","calculateAllNeeds","calculatePopulationChange","needsState","baseGrowthRate","maxGrowthRate","declineRate","satisfaction","growthRate","lossRate","getSatisfactionLevel","getSatisfactionColor","getCriticalNeed","needs","critical","lowestSatisfaction","name","formatNeedPercentage","getNeedEmoji","BUILDING_SIZES","SMALL_BUILDINGS","LARGE_BUILDINGS","DEFAULT_EFFICIENCY","DEFAULT_ZONE_BONUSES","getBuildingSize","tool","isSmallBuilding","getExistingBuildingSize","building","buildingDB","isTileBlocked","isUnexplored","hasExistingStructure","isInBounds","gx","gy","width","height","mapWidth","mapHeight","overlapsBuildings","buildings","bSize","isValidPlacement","size","isValidRoadPlacement","rx","ry","canAfford","cost","simcityMode","totalCost","getMissingResource","deductCost","increasePerLevel","getElevationCostInfo","applyElevationCost","baseCost","checkMilestonePrereq","checkPopulationReq","requiredPop","countNearbyTiles","tiles","range","checkFn","count","dx","dy","nx","ny","hasNearbyTile","isBuildingNearby","maxDist","isBuildingInRadius","radius","calculateZoneBonus","zoneType","B","bonus","blds","W","H","roadCount","t","treeCount","resNearby","getZoneBonusDescription","bonuses","penalties","totalBonus","percentage","prefix","calculateDesirability","chiefRadius","chiefBonus","score","neighborCount","hasTree","hasWater","hasChief","checkX","checkY","chief","neighborBonus","treeBonus","waterBonus","isolationPenalty","isolated","getClusterMultiplier","neighbors","countResidentialNeighbors","isValidTilePlacement","isValidRoadTilePlacement","getElevationCostMult","rate","getLineTiles","x0","y0","x1","y1","sx","sy","err","cx","cy","e2","placeRoadTile","showError","placeRoadLine","fromX","fromY","toX","toY","placed","point","message","placeResidential","selectedLevel","elevCostMult","adjFoodCost","adjWoodCost","adjStoneCost","zoneBonus","bonusInfo","placeCommercial","buildingData","costStr","placeIndustrial","placeWell","placeLargeBuilding","buildingType","foodCost","woodCost","stoneCost","tx","ty","demolish","bldHit","bz","removedBld","refund","parts","key","checkBuildingOverlap","VARIANT_THRESHOLDS","getVariantFromDesirability","desirability","getVariantName","variant","VARIANT_ICONS","calculateLevel1Desirability","workforce","waterDist","waterLoop","dist","hasAdjacentRoad","roadMaintenance","berryCount","calculateTileDesirability","nearestWell","well","roadDist","roadLoop","nearestCom","nearestInd","penalty","trees","calculateLevel1Population","newPopulation","updateBuildingEvolution","maxChecksPerFrame","results","checksThisFrame","oldVariant","newVariant","variantName","getVariantBonusMultiplier","getVariantIncomeMultiplier","getVariantLifespanBonus","DEFAULT_ANIMAL_TYPES","DEFAULT_ANIMAL_CONFIG","DEFAULT_NOMAD_CONFIG","DEFAULT_BERRY_CONFIG","getRandomPosition","isValidSpawnPosition","options","minDistanceFromPlayer","allowOverlap","terrainFilter","terrain","getValidTerrain","animalType","animalTypes","selectAnimalType","validTypes","totalRate","sum","rand","cumulative","getValidAnimalTypes","spawnAnimals","spawned","maxAttempts","attempt","pos","tileOccupied","spawnBeachTurtles","initializeAnimals","mainCount","turtleCount","turtles","spawnNomads","n","spawnBerries","getAnimalAt","animals","index","getAdjacentAnimals","excludeIndex","idx","isHerdLocation","targetIndex","countAnimalsByType","counts","animal","getAnimalConfig","formatAnimalName","calculateFoodReward","animalConfig","reward","hitAnimal","hitsToKill","calculateHerdDamage","animalIndex","attackAnimal","animalName","hitResult","isHerd","herdDamage","popCost","foodReward","foodGained","gameOver","totalPopLost","totalInventory","spaceAvailable","checkFirstKillLore","canAttack","getAttackDangerLevel","adjacent","previewCombat","hitsRemaining","potentialFood","randomInRange","isNomadHostile","hostileChance","generateNomadEncounter","cfg","foodRange","woodRange","stoneRange","processHostileEncounter","damage","processFriendlyEncounter","entity","totalLoot","currentInventory","foodAdded","woodAdded","metalAdded","stoneAdded","capacityGain","lootMsg","encounterNomad","checkFirstNomadLore","getEncounterTypeDescription","previewNomadEncounter","isHostile","dmgRange","popGain","getNomadOdds","friendly","hostile","isBerryPoisonous","poisonChance","generateBerryEntity","isPoisonous","processPoisonBerry","processSafeBerry","amount","foodToCollect","gatherBerry","checkFirstBerryLore","canGatherBerry","previewBerryGather","getBerryOdds"],"mappings":"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"}